<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="mF8D_kM2nUO6Po-tR0x7qj3EJd3yONi479P3xl-0cLE" >
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ç§‘æŠ€å­¸æœƒ - Science and technology club</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid rgba(93, 92, 222, 0.1);
            border-radius: 50%;
            border-top: 3px solid #5D5CDE;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .dark .modal-content {
            background: #2a2a2a;
            color: #E5E5E5;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¼¸å…¥æ¡†è‡³å°‘16pxé¿å…æ‰‹æ©Ÿç¸®æ”¾ */
        input, select, textarea {
            font-size: 16px !important;
        }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
        }

        .toast.active {
            display: block;
        }

        .dark .toast {
            background: #2a2a2a;
            color: #E5E5E5;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* æŒ‰éˆ• */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(93, 92, 222, 0.3);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .dark .card {
            background: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        /* æ·±è‰²æ¨¡å¼ */
        .dark {
            background-color: #181818;
            color: #E5E5E5;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- è¼‰å…¥è¦†è“‹å±¤ -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center" style="display: none;">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-white text-lg" id="loadingText">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="toast">
        <p id="toastMessage"></p>
    </div>

    <!-- å…¬å‘Šæ¬„ï¼ˆå›ºå®šåœ¨é ‚éƒ¨ï¼‰ -->
    <div id="announcementBar" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 px-4 hidden fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto flex items-center justify-center">
            <div class="flex items-center space-x-3 overflow-hidden">
                <span id="announcementLabel" class="flex-shrink-0 bg-white/20 px-2 py-0.5 rounded text-xs font-bold">ğŸŸ¢ æœ€æ–°</span>
                <div class="flex-1 overflow-hidden relative">
                    <p id="announcementText" class="text-sm truncate transition-all duration-500"></p>
                </div>
                <!-- å…¬å‘Šæ•¸é‡æŒ‡ç¤ºå™¨ -->
                <div id="announcementIndicator" class="flex-shrink-0 flex items-center space-x-1 ml-2">
                    <span id="announcementCurrent" class="text-xs">1</span>
                    <span class="text-xs">/</span>
                    <span id="announcementTotal" class="text-xs">1</span>
                </div>
                <!-- å°èˆªæŒ‰éˆ• -->
                <button id="prevAnnouncementBtn" class="flex-shrink-0 p-1 hover:bg-white/20 rounded transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button id="nextAnnouncementBtn" class="flex-shrink-0 p-1 hover:bg-white/20 rounded transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-purple-600 dark:text-purple-400">
                        <i class="fas fa-microchip mr-2"></i>
                        <span id="navTitle">ç§‘æŠ€å­¸æœƒ</span>
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- èªè¨€é¸æ“‡å™¨ -->
                    <select id="languageSelector" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-2 rounded-lg border-none focus:ring-2 focus:ring-purple-500 text-base">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="en">English</option>
                    </select>

                    <!-- ä¸»é¡Œåˆ‡æ› -->
                    <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>

                    <!-- ç™»å…¥æŒ‰éˆ•ï¼ˆæœªç™»å…¥æ™‚é¡¯ç¤ºï¼‰ -->
                    <button id="loginBtn" class="btn-primary relative flex flex-col items-center">
                        <div class="flex items-center">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            <span id="loginBtnText">ç™»å…¥</span>
                        </div>
                        <span class="text-xs opacity-75">ç®¡ç†å“¡å°ˆå±¬</span>
                    </button>

                    <!-- ç”¨æˆ¶èœå–®ï¼ˆå·²ç™»å…¥æ™‚é¡¯ç¤ºï¼‰ -->
                    <div id="userMenu" style="display: none;" class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 bg-purple-100 dark:bg-purple-900 px-4 py-2 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition">
                            <i class="fas fa-user-circle text-purple-600 dark:text-purple-400"></i>
                            <span id="userDisplayName" class="text-gray-800 dark:text-gray-200"></span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>
                        <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden">
                            <button onclick="showAdminPanel()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                <i class="fas fa-cog mr-2"></i>
                                <span id="adminPanelText">ç®¡ç†å¾Œå°</span>
                            </button>
                            <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-red-600">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                <span id="logoutText">ç™»å‡º</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <section class="text-center mb-16 fade-in">
            <h2 class="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent" id="heroTitle">
                æ­¡è¿ä¾†åˆ°ç§‘æŠ€å­¸æœƒ
            </h2>
            <p class="text-xl text-gray-600 dark:text-gray-400" id="heroSubtitle">
                æ¢ç´¢ç§‘æŠ€ï¼Œå‰µæ–°æœªä¾†
            </p>
        </section>

        <!-- æœƒæ­Œå€å¡Š -->
        <section class="mb-16 fade-in">
            <div class="max-w-2xl mx-auto">
                <div class="card text-center">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                        <i class="fas fa-music mr-3 text-purple-600"></i>
                        <span id="anthemTitle">ç§‘æŠ€å­¸æœƒæœƒæ­Œ</span>
                    </h3>
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-8">
                        <div class="flex items-center justify-center mb-4">
                            <i class="fas fa-compact-disc text-6xl text-purple-600 dark:text-purple-400 animate-pulse"></i>
                        </div>
                        <audio id="anthemAudio" controls class="w-full" style="filter: hue-rotate(270deg);">
                            <source src="https://pfst.cf2.poecdn.net/base/video/0549e0697b2edaf333eb086ceb0eb0af607f19135f7ae796092f17df73c5d288" type="video/mp4">
                            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³é »æ’­æ”¾ã€‚
                        </audio>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-4" id="anthemDescription">
                            è†è½æˆ‘å€‘çš„æœƒæ­Œï¼Œæ„Ÿå—ç§‘æŠ€å­¸æœƒçš„ç²¾ç¥èˆ‡ç†±æƒ…
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ´»å‹•å€å¡Š -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200">
                <i class="fas fa-calendar-alt mr-3 text-purple-600"></i>
                <span id="activitiesTitle">æœ€æ–°æ´»å‹•</span>
            </h3>
            <div id="activitiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- æ´»å‹•å°‡å‹•æ…‹åŠ è¼‰ -->
            </div>
        </section>

        <!-- é …ç›®å€å¡Š -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200">
                <i class="fas fa-project-diagram mr-3 text-purple-600"></i>
                <span id="projectsTitle">ç²¾é¸é …ç›®</span>
            </h3>
            <div id="projectsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- é …ç›®å°‡å‹•æ…‹åŠ è¼‰ -->
            </div>
        </section>

        <!-- åœ˜éšŠå€å¡Š -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200">
                <i class="fas fa-users mr-3 text-purple-600"></i>
                <span id="teamTitle">åœ˜éšŠæˆå“¡</span>
            </h3>
            <div id="teamContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- åœ˜éšŠæˆå“¡å°‡å‹•æ…‹åŠ è¼‰ -->
            </div>
        </section>

        <!-- è¯çµ¡å€å¡Š -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center text-gray-800 dark:text-gray-200">
                <i class="fas fa-envelope mr-3 text-purple-600"></i>
                <span id="contactTitle">è¯çµ¡æˆ‘å€‘</span>
            </h3>

            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- è¯çµ¡ä¿¡æ¯ -->
                <div id="contactInfo" class="card">
                    <!-- è¯çµ¡ä¿¡æ¯å°‡å‹•æ…‹åŠ è¼‰ -->
                </div>

                <!-- è¯çµ¡è¡¨å–® -->
                <div class="card">
                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                        <i class="fas fa-paper-plane mr-2 text-purple-600"></i>
                        <span id="sendMessageTitle">ç™¼é€è¨Šæ¯</span>
                    </h4>
                    <form id="contactForm" onsubmit="handleContactSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">
                                <span id="yourEmailLabel">æ‚¨çš„é›»éƒµ</span><span class="text-red-500">*</span>
                            </label>
                            <input type="email" id="contactEmail" required
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                        </div>

                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">
                                <span id="subjectLabel">ä¸»æ—¨</span><span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="contactSubject" required
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                        </div>

                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">
                                <span id="contentLabel">å…§å®¹</span><span class="text-red-500">*</span>
                            </label>
                            <textarea id="contactMessage" required rows="5"
                                      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 resize-none text-base"></textarea>
                        </div>

                        <button type="submit" class="w-full btn-primary">
                            <i class="fas fa-paper-plane mr-2"></i>
                            <span id="sendButtonText">ç™¼é€è¨Šæ¯</span>
                        </button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- ç™»å…¥æ¨¡æ…‹æ¡† -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-sign-in-alt mr-2 text-purple-600"></i>
                <span id="loginModalTitle">ç®¡ç†å¾Œå°ç™»å…¥</span>
            </h2>

            <form id="loginForm" onsubmit="handleLogin(event); return false;">
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="usernameOrEmailLabel">ç”¨æˆ¶å</label>
                    <input type="text" id="loginUsername" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="passwordLabel">å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                </div>

                <div class="flex justify-between items-center mb-6">
                    <button type="button" onclick="showForgotPassword()" class="text-purple-600 hover:text-purple-700 text-sm" id="forgotPasswordBtn">
                        å¿˜è¨˜å¯†ç¢¼ï¼Ÿ
                    </button>
                    <button type="button" onclick="showForgotUsername()" class="text-purple-600 hover:text-purple-700 text-sm" id="forgotUsernameBtn">
                        å¿˜è¨˜ç”¨æˆ¶åï¼Ÿ
                    </button>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <span id="loginSubmitBtn">ç™»å…¥</span>
                    </button>
                    <button type="button" onclick="closeLoginModal()" class="flex-1 btn-secondary">
                        <span id="cancelBtn">å–æ¶ˆ</span>
                    </button>
                </div>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-2" id="noAccountText">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</p>
                <button onclick="showRegisterModal()" class="text-purple-600 hover:text-purple-700 font-medium" id="registerLinkBtn">
                    ç«‹å³è¨»å†Š
                </button>
            </div>
        </div>
    </div>

    <!-- è¨»å†Šæ¨¡æ…‹æ¡† -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-user-plus mr-2 text-purple-600"></i>
                <span id="registerModalTitle">ç”¨æˆ¶è¨»å†Š</span>
            </h2>

            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regUsernameLabel">ç”¨æˆ¶å</label>
                    <input type="text" id="registerUsername" required minlength="3"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="è«‹è¨­å®šç”¨æˆ¶åï¼ˆè‡³å°‘3å€‹å­—ç¬¦ï¼‰">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regEmailLabel">é›»å­éƒµä»¶</label>
                    <input type="email" id="registerEmail" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="your@email.com">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regNameLabel">å§“å</label>
                    <input type="text" id="registerName" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regPasswordLabel">å¯†ç¢¼</label>
                    <input type="password" id="registerPassword" required minlength="6"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="passwordHint">å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦</p>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <span id="registerSubmitBtn">ç™¼é€é©—è­‰ç¢¼</span>
                    </button>
                    <button type="button" onclick="closeRegisterModal()" class="flex-1 btn-secondary">
                        <span id="regCancelBtn">å–æ¶ˆ</span>
                    </button>
                </div>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-2" id="hasAccountText">å·²æœ‰å¸³è™Ÿï¼Ÿ</p>
                <button onclick="showLoginModal()" class="text-purple-600 hover:text-purple-700 font-medium" id="loginLinkBtn">
                    ç«‹å³ç™»å…¥
                </button>
            </div>
        </div>
    </div>

    <!-- é©—è­‰ç¢¼æ¨¡æ…‹æ¡† -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-shield-alt mr-2 text-purple-600"></i>
                <span id="verificationModalTitle">éƒµç®±é©—è­‰</span>
            </h2>

            <p class="mb-6 text-gray-600 dark:text-gray-400" id="verificationInstructions">
                æˆ‘å€‘å·²å‘æ‚¨çš„éƒµç®±ç™¼é€äº†ä¸€å€‹ 6 ä½æ•¸é©—è­‰ç¢¼ï¼Œè«‹è¼¸å…¥ä»¥å®Œæˆé©—è­‰ã€‚
            </p>

            <form id="verificationForm" onsubmit="handleVerification(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="verificationCodeLabel">é©—è­‰ç¢¼</label>
                    <input type="text" id="verificationCode" required maxlength="6" pattern="[0-9]{6}"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-center text-2xl tracking-widest text-base"
                           placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="codeExpiryText">é©—è­‰ç¢¼å°‡åœ¨ 10 åˆ†é˜å¾ŒéæœŸ</p>

                    <!-- æ”¶ä¸åˆ°é©—è­‰ç¢¼æç¤º -->
                    <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <p class="text-xs text-blue-700 dark:text-blue-300">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="noCodeTip">æ”¶ä¸åˆ°é©—è­‰ç¢¼ï¼Ÿ</span>
                        </p>
                        <ul class="text-xs text-blue-600 dark:text-blue-400 mt-2 ml-5 list-disc space-y-1">
                            <li id="checkSpamTip">è«‹æª¢æŸ¥åƒåœ¾éƒµä»¶ç®±</li>
                            <li id="checkEmailTip">ç¢ºèªéƒµç®±åœ°å€æ˜¯å¦æ­£ç¢º</li>
                            <li id="waitTip">ç­‰å¾…å¹¾åˆ†é˜å¾Œå†è©¦</li>
                            <li id="resendCodeTip">é»æ“Šä¸‹æ–¹ã€Œé‡æ–°ç™¼é€ã€æŒ‰éˆ•</li>
                        </ul>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <span id="verifyBtn">é©—è­‰</span>
                    </button>
                    <button type="button" id="resendCodeButton" onclick="resendVerificationCode()" class="flex-1 btn-secondary">
                        <span id="resendBtn">é‡æ–°ç™¼é€</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¿˜è¨˜å¯†ç¢¼æ¨¡æ…‹æ¡† -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-key mr-2 text-purple-600"></i>
                <span id="forgotPasswordTitle">å¿˜è¨˜å¯†ç¢¼</span>
            </h2>

            <div id="forgotPasswordStep1">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="forgotPasswordInstructions">
                    è«‹è¼¸å…¥æ‚¨çš„è¨»å†Šéƒµç®±ï¼Œæˆ‘å€‘å°‡ç™¼é€é©—è­‰ç¢¼åˆ°æ‚¨çš„éƒµç®±ã€‚
                </p>

                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fpEmailLabel">é›»å­éƒµä»¶</label>
                        <input type="email" id="forgotPasswordEmail" required
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                               placeholder="your@email.com">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="sendCodeBtn">ç™¼é€é©—è­‰ç¢¼</span>
                        </button>
                        <button type="button" onclick="closeForgotPasswordModal()" class="flex-1 btn-secondary">
                            <span id="fpCancelBtn">å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="forgotPasswordStep2" style="display: none;">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="fpStep2Instructions">
                    è«‹è¼¸å…¥ç™¼é€åˆ°æ‚¨éƒµç®±çš„é©—è­‰ç¢¼å’Œæ–°å¯†ç¢¼ã€‚
                </p>

                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fpCodeLabel">é©—è­‰ç¢¼</label>
                        <input type="text" id="resetPasswordCode" required maxlength="6" pattern="[0-9]{6}"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-center text-2xl tracking-widest text-base"
                               placeholder="000000">
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="newPasswordLabel">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPassword" required minlength="6"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="resetPasswordBtn">é‡è¨­å¯†ç¢¼</span>
                        </button>
                        <button type="button" onclick="closeForgotPasswordModal()" class="flex-1 btn-secondary">
                            <span id="fpStep2CancelBtn">å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å¿˜è¨˜ç”¨æˆ¶åæ¨¡æ…‹æ¡† -->
    <div id="forgotUsernameModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-user-circle mr-2 text-purple-600"></i>
                <span id="forgotUsernameTitle">å¿˜è¨˜ç”¨æˆ¶å</span>
            </h2>

            <div id="forgotUsernameStep1">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="forgotUsernameInstructions">
                    è«‹è¼¸å…¥æ‚¨çš„è¨»å†Šéƒµç®±ï¼Œæˆ‘å€‘å°‡ç™¼é€é©—è­‰ç¢¼å’Œæ‚¨çš„ç”¨æˆ¶ååˆ°æ‚¨çš„éƒµç®±ã€‚
                </p>

                <form id="forgotUsernameForm" onsubmit="handleForgotUsername(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fuEmailLabel">é›»å­éƒµä»¶</label>
                        <input type="email" id="forgotUsernameEmail" required
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                               placeholder="your@email.com">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="sendUsernameCodeBtn">ç™¼é€é©—è­‰ç¢¼</span>
                        </button>
                        <button type="button" onclick="closeForgotUsernameModal()" class="flex-1 btn-secondary">
                            <span id="fuCancelBtn">å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="forgotUsernameStep2" style="display: none;">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="fuStep2Instructions">
                    è«‹è¼¸å…¥ç™¼é€åˆ°æ‚¨éƒµç®±çš„é©—è­‰ç¢¼ï¼Œæˆ‘å€‘å°‡é¡¯ç¤ºæ‚¨çš„ç”¨æˆ¶åã€‚
                </p>

                <form id="verifyUsernameForm" onsubmit="handleVerifyUsername(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fuCodeLabel">é©—è­‰ç¢¼</label>
                        <input type="text" id="verifyUsernameCode" required maxlength="6" pattern="[0-9]{6}"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-center text-2xl tracking-widest text-base"
                               placeholder="000000">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="verifyUsernameBtn">é©—è­‰ä¸¦é¡¯ç¤º</span>
                        </button>
                        <button type="button" onclick="closeForgotUsernameModal()" class="flex-1 btn-secondary">
                            <span id="fuStep2CancelBtn">å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="forgotUsernameStep3" style="display: none;">
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-2xl mr-3"></i>
                        <h3 class="text-lg font-bold text-green-800 dark:text-green-300" id="usernameFoundTitle">æ‰¾åˆ°æ‚¨çš„å¸³è™Ÿ</h3>
                    </div>
                    <div class="mb-2">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1" id="yourUsernameLabel">æ‚¨çš„ç”¨æˆ¶åï¼ˆé›»éƒµï¼‰ï¼š</p>
                        <p class="text-xl font-bold text-gray-800 dark:text-gray-200" id="displayFoundUsername"></p>
                    </div>
                </div>

                <button type="button" onclick="closeForgotUsernameModal(); showLoginModal();" class="w-full btn-primary">
                    <span id="backToLoginBtn">è¿”å›ç™»å…¥</span>
                </button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šç”¨æˆ¶åæ¨¡æ…‹æ¡†ï¼ˆé¦–æ¬¡ç™»å…¥å¿…é ˆè¨­å®šï¼‰ -->
    <div id="setUsernameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-user-plus mr-2 text-purple-600"></i>
                <span id="setUsernameTitle">è¨­å®šç”¨æˆ¶å</span>
            </h2>

            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800 dark:text-blue-300" id="setUsernameNotice">
                    <i class="fas fa-info-circle mr-2"></i>
                    æ‚¨çš„å¸³è™Ÿå°šæœªè¨­å®šç”¨æˆ¶åã€‚è«‹è¨­å®šä¸€å€‹ç”¨æˆ¶åä»¥ç¹¼çºŒä½¿ç”¨ç³»çµ±ã€‚
                </p>
            </div>

            <form id="setUsernameForm" onsubmit="handleSetUsername(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="suUsernameLabel">ç”¨æˆ¶å</label>
                    <input type="text" id="newUsername" required minlength="3" maxlength="20"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åï¼ˆ3-20å€‹å­—ç¬¦ï¼‰">
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400" id="suUsernameHint">
                        ç”¨æˆ¶åå¯åŒ…å«å­—æ¯ã€æ•¸å­—ã€åº•ç·šå’Œé€£å­—è™Ÿ
                    </p>
                </div>

                <button type="submit" class="w-full btn-primary">
                    <span id="setUsernameBtn">è¨­å®šç”¨æˆ¶å</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // å¤šèªè¨€é…ç½® (Inline - åŸ translations.js)
        // ========================================
        const translations = window.translations || {
    'zh-TW': {nav: {home: 'é¦–é ', about: 'é—œæ–¼æˆ‘å€‘', activities: 'æ´»å‹•', projects: 'å°ˆæ¡ˆ', team: 'åœ˜éšŠ', contact: 'è¯çµ¡æˆ‘å€‘', admin: 'ç®¡ç†å¾Œå°', login: 'ç™»å…¥', register: 'è¨»å†Š', logout: 'ç™»å‡º', title: 'ç§‘æŠ€å­¸æœƒ'}, messages: {loading: 'è¼‰å…¥ä¸­...', loginSuccess: 'ç™»å…¥æˆåŠŸï¼', loginError: 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥éƒµç®±å’Œå¯†ç¢¼', registerSuccess: 'æˆ‘å€‘å·²æ”¶åˆ°ä½ çš„è¨»å†Šç”³è«‹ï¼Œç®¡ç†å“¡å°‡æœƒå¯©æ‰¹ï¼Œä¸¦æ–¼ä¸‰å€‹å·¥ä½œå¤©å…§ï¼Œé€éé›»éƒµå›è¦†ä½ ', registerError: 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', verificationSent: 'é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„éƒµç®±', verificationError: 'é©—è­‰ç¢¼éŒ¯èª¤æˆ–å·²éæœŸ', passwordResetError: 'é‡è¨­å¯†ç¢¼å¤±æ•—'}, hero: {title: 'æ­¡è¿ä¾†åˆ°ç§‘æŠ€å­¸æœƒ', subtitle: 'æ¢ç´¢ç§‘æŠ€ï¼Œå‰µé€ æœªä¾†', viewActivities: 'æŸ¥çœ‹æ´»å‹•', joinUs: 'åŠ å…¥æˆ‘å€‘'}, anthem: {title: 'ç§‘æŠ€å­¸æœƒæœƒæ­Œ', description: 'è†è½æˆ‘å€‘çš„æœƒæ­Œï¼Œæ„Ÿå—ç§‘æŠ€å­¸æœƒçš„ç²¾ç¥èˆ‡ç†±æƒ…'}, about: {title: 'é—œæ–¼æˆ‘å€‘', innovation: 'å‰µæ–°æ€ç¶­', innovationDesc: 'åŸ¹é¤Šå‰µæ–°ç²¾ç¥ï¼Œé¼“å‹µæˆå“¡æ¢ç´¢å‰æ²¿ç§‘æŠ€ï¼ŒæŒ‘æˆ°å‚³çµ±æ€ç¶­ï¼Œé–‹å‰µæ–°çš„å¯èƒ½æ€§ã€‚', teamwork: 'åœ˜éšŠå”ä½œ', teamworkDesc: 'æ‰“é€ äº’åŠ©å­¸ç¿’çš„ç’°å¢ƒï¼Œé€šéåœ˜éšŠé …ç›®å¢é€²åˆä½œèƒ½åŠ›ï¼Œå…±åŒæˆé•·é€²æ­¥ã€‚', knowledge: 'çŸ¥è­˜åˆ†äº«', knowledgeDesc: 'å®šæœŸèˆ‰è¾¦è¬›åº§å’Œå·¥ä½œåŠï¼Œåˆ†äº«æœ€æ–°æŠ€è¡“è¶¨å‹¢å’Œå¯¦ç”¨æŠ€èƒ½ï¼Œä¿ƒé€²çŸ¥è­˜äº¤æµã€‚'}, activities: {title: 'è¿‘æœŸæ´»å‹•', loading: 'è¼‰å…¥ä¸­...', empty: 'ç›®å‰æ²’æœ‰æ´»å‹•', learnMore: 'äº†è§£æ›´å¤š'}, projects: {title: 'ç²¾é¸å°ˆæ¡ˆ', loading: 'è¼‰å…¥ä¸­...', empty: 'ç›®å‰æ²’æœ‰å°ˆæ¡ˆ', status: {ongoing: 'é€²è¡Œä¸­', completed: 'å·²å®Œæˆ', planned: 'è¨ˆåŠƒä¸­'}, members: 'ä½æˆå“¡åƒèˆ‡', viewProject: 'æŸ¥çœ‹å°ˆæ¡ˆ'}, team: {title: 'æ ¸å¿ƒåœ˜éšŠ'}, contact: {title: 'è¯çµ¡æˆ‘å€‘', name: 'å§“å', namePlaceholder: 'è«‹è¼¸å…¥æ‚¨çš„å§“å', email: 'é›»å­éƒµä»¶', emailPlaceholder: 'your@email.com', subject: 'ä¸»æ—¨', subjectPlaceholder: 'è«‹è¼¸å…¥ä¸»æ—¨', message: 'è¨Šæ¯', messagePlaceholder: 'è«‹è¼¸å…¥æ‚¨çš„è¨Šæ¯', send: 'é€å‡ºè¨Šæ¯', success: 'æˆ‘å€‘å·²æ”¶åˆ°ä½ è¨Šæ¯ï¼Œä¸¦æ–¼ä¸‰å€‹å·¥ä½œå¤©å…§é€éé›»éƒµå›è¦†ä½ ', sendMessageTitle: 'ç™¼é€è¨Šæ¯', yourEmail: 'æ‚¨çš„é›»éƒµ', content: 'å…§å®¹', contentPlaceholder: 'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œæˆ–å»ºè­°...', sendButton: 'ç™¼é€è¨Šæ¯', emailLabel: 'é›»å­éƒµä»¶', address: 'åœ°å€', hours: 'é–‹æ”¾æ™‚é–“', hoursValue: 'é€±ä¸€è‡³é€±äº” 9:00-18:00', error: 'ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'}, login: {title: 'ç®¡ç†å¾Œå°ç™»å…¥', subtitle: 'è«‹ç™»å…¥ä»¥ç¹¼çºŒ', username: 'ç”¨æˆ¶å', usernameOrEmail: 'ç”¨æˆ¶å', usernamePlaceholder: 'è«‹è¼¸å…¥ç”¨æˆ¶å', email: 'é›»å­éƒµä»¶', emailPlaceholder: 'è«‹è¼¸å…¥é›»å­éƒµä»¶', password: 'å¯†ç¢¼', passwordPlaceholder: 'è«‹è¼¸å…¥å¯†ç¢¼', loginBtn: 'ç™»å…¥', forgotPassword: 'å¿˜è¨˜å¯†ç¢¼ï¼Ÿ', forgotUsername: 'å¿˜è¨˜ç”¨æˆ¶åï¼Ÿ', noAccount: 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ', registerNow: 'ç«‹å³è¨»å†Š', error: 'ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤', pending: 'æ‚¨çš„å¸³è™Ÿæ­£åœ¨ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸'}, register: {title: 'è¨»å†Šæ–°å¸³è™Ÿ', subtitle: 'åŠ å…¥ç§‘æŠ€å­¸æœƒç®¡ç†åœ˜éšŠ', fullName: 'çœŸå¯¦å§“å', fullNamePlaceholder: 'è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å', username: 'ç”¨æˆ¶å', usernamePlaceholder: 'è«‹è¨­å®šç”¨æˆ¶å', email: 'é›»å­éƒµä»¶', emailPlaceholder: 'è«‹è¼¸å…¥é›»å­éƒµä»¶', password: 'å¯†ç¢¼', passwordPlaceholder: 'è«‹è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰', confirmPassword: 'ç¢ºèªå¯†ç¢¼', confirmPasswordPlaceholder: 'è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼', registerBtn: 'è¨»å†Š', hasAccount: 'å·²æœ‰å¸³è™Ÿï¼Ÿ', loginNow: 'ç«‹å³ç™»å…¥', success: 'è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚', passwordMismatch: 'å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', emailExists: 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Š'}, forgotPassword: {title: 'é‡è¨­å¯†ç¢¼', subtitle: 'æˆ‘å€‘æœƒç™¼é€é©—è­‰ç¢¼åˆ°æ‚¨çš„é›»å­éƒµä»¶', email: 'é›»å­éƒµä»¶', emailPlaceholder: 'è«‹è¼¸å…¥è¨»å†Šæ™‚ä½¿ç”¨çš„é›»å­éƒµä»¶', sendCode: 'ç™¼é€é©—è­‰ç¢¼', verificationCode: 'é©—è­‰ç¢¼', verificationCodePlaceholder: 'è«‹è¼¸å…¥6ä½é©—è­‰ç¢¼', newPassword: 'æ–°å¯†ç¢¼', newPasswordPlaceholder: 'è«‹è¨­å®šæ–°å¯†ç¢¼', confirmPassword: 'ç¢ºèªæ–°å¯†ç¢¼', confirmPasswordPlaceholder: 'è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼', resetPassword: 'é‡è¨­å¯†ç¢¼', backToLogin: 'è¿”å›ç™»å…¥', codeSent: 'é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„éƒµç®±', success: 'å¯†ç¢¼é‡è¨­æˆåŠŸï¼', invalidCode: 'é©—è­‰ç¢¼éŒ¯èª¤', emailNotFound: 'æ‰¾ä¸åˆ°æ­¤é›»å­éƒµä»¶'}, forgotUsername: {title: 'å¿˜è¨˜ç”¨æˆ¶å', subtitle: 'æˆ‘å€‘æœƒç™¼é€é©—è­‰ç¢¼åˆ°æ‚¨çš„é›»å­éƒµä»¶', email: 'é›»å­éƒµä»¶', sendCode: 'ç™¼é€é©—è­‰ç¢¼', verificationCode: 'é©—è­‰ç¢¼', verify: 'é©—è­‰ä¸¦é¡¯ç¤º', found: 'æ‰¾åˆ°æ‚¨çš„å¸³è™Ÿ', yourUsername: 'æ‚¨çš„ç”¨æˆ¶åï¼ˆé›»éƒµï¼‰ï¼š', backToLogin: 'è¿”å›ç™»å…¥', notRegistered: 'æ­¤é›»å­éƒµä»¶å°šæœªè¨»å†Šï¼Œè«‹å…ˆè¨»å†Šå¸³è™Ÿã€‚'}, admin: {welcome: 'æ­¡è¿å›ä¾†', dashboard: 'ç®¡ç†å¾Œå°', returnFront: 'è¿”å›å‰å°', activities: 'æ´»å‹•ç®¡ç†', projects: 'å°ˆæ¡ˆç®¡ç†', team: 'åœ˜éšŠç®¡ç†', users: 'ç”¨æˆ¶ç®¡ç†', settings: 'ç¶²ç«™è¨­ç½®', add: 'æ–°å¢', edit: 'ç·¨è¼¯', delete: 'åˆªé™¤', save: 'å„²å­˜', cancel: 'å–æ¶ˆ', confirm: 'ç¢ºå®š', loading: 'è¼‰å…¥ä¸­...', empty: 'æš«ç„¡è³‡æ–™', deleteConfirm: 'ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', success: 'æ“ä½œæˆåŠŸï¼', error: 'æ“ä½œå¤±æ•—', activityTitle: 'æ´»å‹•æ¨™é¡Œ', activityDate: 'æ´»å‹•æ—¥æœŸ', activityDescription: 'æ´»å‹•æè¿°', activityLink: 'æ´»å‹•é€£çµ', projectTitle: 'å°ˆæ¡ˆæ¨™é¡Œ', projectStatus: 'å°ˆæ¡ˆç‹€æ…‹', projectDescription: 'å°ˆæ¡ˆæè¿°', projectTechnologies: 'ä½¿ç”¨æŠ€è¡“', projectMembers: 'åƒèˆ‡æˆå“¡æ•¸', projectLink: 'å°ˆæ¡ˆé€£çµ', memberName: 'æˆå“¡å§“å', memberPosition: 'è·ä½', memberBio: 'å€‹äººç°¡ä»‹', memberAvatar: 'é ­åƒé€£çµ', memberGithub: 'GitHub é€£çµ', memberEmail: 'é›»å­éƒµä»¶', userName: 'ç”¨æˆ¶å', userEmail: 'é›»å­éƒµä»¶', userRole: 'è§’è‰²', userStatus: 'ç‹€æ…‹', approve: 'æ‰¹å‡†', reject: 'æ‹’çµ•', pending: 'å¾…å¯©æ ¸', approved: 'å·²æ‰¹å‡†', rejected: 'å·²æ‹’çµ•', siteEmail: 'è¯çµ¡éƒµç®±', sitePhone: 'è¯çµ¡é›»è©±', siteAddress: 'åœ°å€', siteFacebook: 'Facebook', siteTwitter: 'Twitter', siteGithub: 'GitHub'}, common: {language: 'èªè¨€', loading: 'è¼‰å…¥ä¸­...', error: 'ç™¼ç”ŸéŒ¯èª¤', success: 'æˆåŠŸ', confirm: 'ç¢ºå®š', cancel: 'å–æ¶ˆ', save: 'å„²å­˜', delete: 'åˆªé™¤', edit: 'ç·¨è¼¯', add: 'æ–°å¢', search: 'æœå°‹', filter: 'ç¯©é¸', all: 'å…¨éƒ¨'}},
    'zh-CN': {nav: {home: 'é¦–é¡µ', about: 'å…³äºæˆ‘ä»¬', activities: 'æ´»åŠ¨', projects: 'é¡¹ç›®', team: 'å›¢é˜Ÿ', contact: 'è”ç³»æˆ‘ä»¬', admin: 'ç®¡ç†åå°', login: 'ç™»å½•', register: 'æ³¨å†Œ', logout: 'ç™»å‡º', title: 'ç§‘æŠ€å­¦ä¼š'}, messages: {loading: 'åŠ è½½ä¸­...', loginSuccess: 'ç™»å½•æˆåŠŸï¼', loginError: 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ', registerSuccess: 'æˆ‘ä»¬å·²æ”¶åˆ°ä½ çš„æ³¨å†Œç”³è¯·ï¼Œç®¡ç†å‘˜å°†ä¼šå®¡æ‰¹ï¼Œå¹¶äºä¸‰ä¸ªå·¥ä½œæ—¥å†…ï¼Œé€è¿‡ç”µé‚®å›å¤ä½ ', registerError: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', verificationSent: 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±', verificationError: 'éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ', passwordResetError: 'é‡ç½®å¯†ç å¤±è´¥'}, hero: {title: 'æ¬¢è¿æ¥åˆ°ç§‘æŠ€å­¦ä¼š', subtitle: 'æ¢ç´¢ç§‘æŠ€ï¼Œåˆ›é€ æœªæ¥', viewActivities: 'æŸ¥çœ‹æ´»åŠ¨', joinUs: 'åŠ å…¥æˆ‘ä»¬'}, anthem: {title: 'ç§‘æŠ€å­¦ä¼šä¼šæ­Œ', description: 'è†å¬æˆ‘ä»¬çš„ä¼šæ­Œï¼Œæ„Ÿå—ç§‘æŠ€å­¦ä¼šçš„ç²¾ç¥ä¸çƒ­æƒ…'}, about: {title: 'å…³äºæˆ‘ä»¬', innovation: 'åˆ›æ–°æ€ç»´', innovationDesc: 'åŸ¹å…»åˆ›æ–°ç²¾ç¥ï¼Œé¼“åŠ±æˆå‘˜æ¢ç´¢å‰æ²¿ç§‘æŠ€ï¼ŒæŒ‘æˆ˜ä¼ ç»Ÿæ€ç»´ï¼Œå¼€åˆ›æ–°çš„å¯èƒ½æ€§ã€‚', teamwork: 'å›¢é˜Ÿåä½œ', teamworkDesc: 'æ‰“é€ äº’åŠ©å­¦ä¹ çš„ç¯å¢ƒï¼Œé€šè¿‡å›¢é˜Ÿé¡¹ç›®å¢è¿›åˆä½œèƒ½åŠ›ï¼Œå…±åŒæˆé•¿è¿›æ­¥ã€‚', knowledge: 'çŸ¥è¯†åˆ†äº«', knowledgeDesc: 'å®šæœŸä¸¾åŠè®²åº§å’Œå·¥ä½œåŠï¼Œåˆ†äº«æœ€æ–°æŠ€æœ¯è¶‹åŠ¿å’Œå®ç”¨æŠ€èƒ½ï¼Œä¿ƒè¿›çŸ¥è¯†äº¤æµã€‚'}, activities: {title: 'è¿‘æœŸæ´»åŠ¨', loading: 'åŠ è½½ä¸­...', empty: 'ç›®å‰æ²¡æœ‰æ´»åŠ¨', learnMore: 'äº†è§£æ›´å¤š'}, projects: {title: 'ç²¾é€‰é¡¹ç›®', loading: 'åŠ è½½ä¸­...', empty: 'ç›®å‰æ²¡æœ‰é¡¹ç›®', status: {ongoing: 'è¿›è¡Œä¸­', completed: 'å·²å®Œæˆ', planned: 'è®¡åˆ’ä¸­'}, members: 'ä½æˆå‘˜å‚ä¸', viewProject: 'æŸ¥çœ‹é¡¹ç›®'}, team: {title: 'æ ¸å¿ƒå›¢é˜Ÿ'}, contact: {title: 'è”ç³»æˆ‘ä»¬', name: 'å§“å', namePlaceholder: 'è¯·è¾“å…¥æ‚¨çš„å§“å', email: 'ç”µå­é‚®ä»¶', emailPlaceholder: 'your@email.com', subject: 'ä¸»é¢˜', subjectPlaceholder: 'è¯·è¾“å…¥ä¸»é¢˜', message: 'æ¶ˆæ¯', messagePlaceholder: 'è¯·è¾“å…¥æ‚¨çš„æ¶ˆæ¯', send: 'å‘é€æ¶ˆæ¯', success: 'æˆ‘ä»¬å·²æ”¶åˆ°ä½ è®¯æ¯ï¼Œå¹¶äºä¸‰ä¸ªå·¥ä½œæ—¥å†…é€è¿‡ç”µé‚®å›å¤ä½ ', sendMessageTitle: 'å‘é€æ¶ˆæ¯', yourEmail: 'æ‚¨çš„é‚®ç®±', content: 'å†…å®¹', contentPlaceholder: 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–å»ºè®®...', sendButton: 'å‘é€æ¶ˆæ¯', emailLabel: 'ç”µå­é‚®ä»¶', address: 'åœ°å€', hours: 'å¼€æ”¾æ—¶é—´', hoursValue: 'å‘¨ä¸€è‡³å‘¨äº” 9:00-18:00', error: 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•'}, login: {title: 'ç®¡ç†åå°ç™»å½•', subtitle: 'è¯·ç™»å½•ä»¥ç»§ç»­', username: 'ç”¨æˆ·å', usernameOrEmail: 'ç”¨æˆ·å', usernamePlaceholder: 'è¯·è¾“å…¥ç”¨æˆ·å', email: 'ç”µå­é‚®ä»¶', emailPlaceholder: 'è¯·è¾“å…¥ç”µå­é‚®ä»¶', password: 'å¯†ç ', passwordPlaceholder: 'è¯·è¾“å…¥å¯†ç ', loginBtn: 'ç™»å½•', forgotPassword: 'å¿˜è®°å¯†ç ï¼Ÿ', forgotUsername: 'å¿˜è®°ç”¨æˆ·åï¼Ÿ', noAccount: 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ', registerNow: 'ç«‹å³æ³¨å†Œ', error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', pending: 'æ‚¨çš„è´¦å·æ­£åœ¨ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸'}, register: {title: 'æ³¨å†Œæ–°è´¦å·', subtitle: 'åŠ å…¥ç§‘æŠ€å­¦ä¼šç®¡ç†å›¢é˜Ÿ', fullName: 'çœŸå®å§“å', fullNamePlaceholder: 'è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å', username: 'ç”¨æˆ·å', usernamePlaceholder: 'è¯·è®¾å®šç”¨æˆ·å', email: 'ç”µå­é‚®ä»¶', emailPlaceholder: 'è¯·è¾“å…¥ç”µå­é‚®ä»¶', password: 'å¯†ç ', passwordPlaceholder: 'è¯·è®¾å®šå¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰', confirmPassword: 'ç¡®è®¤å¯†ç ', confirmPasswordPlaceholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ', registerBtn: 'æ³¨å†Œ', hasAccount: 'å·²æœ‰è´¦å·ï¼Ÿ', loginNow: 'ç«‹å³ç™»å½•', success: 'æ³¨å†ŒæˆåŠŸï¼è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚', passwordMismatch: 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', emailExists: 'æ­¤ç”µå­é‚®ä»¶å·²è¢«æ³¨å†Œ'}, forgotPassword: {title: 'é‡ç½®å¯†ç ', subtitle: 'æˆ‘ä»¬ä¼šå‘é€éªŒè¯ç åˆ°æ‚¨çš„ç”µå­é‚®ä»¶', email: 'ç”µå­é‚®ä»¶', emailPlaceholder: 'è¯·è¾“å…¥æ³¨å†Œæ—¶ä½¿ç”¨çš„ç”µå­é‚®ä»¶', sendCode: 'å‘é€éªŒè¯ç ', verificationCode: 'éªŒè¯ç ', verificationCodePlaceholder: 'è¯·è¾“å…¥6ä½éªŒè¯ç ', newPassword: 'æ–°å¯†ç ', newPasswordPlaceholder: 'è¯·è®¾å®šæ–°å¯†ç ', confirmPassword: 'ç¡®è®¤æ–°å¯†ç ', confirmPasswordPlaceholder: 'è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ', resetPassword: 'é‡ç½®å¯†ç ', backToLogin: 'è¿”å›ç™»å½•', codeSent: 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±', success: 'å¯†ç é‡ç½®æˆåŠŸï¼', invalidCode: 'éªŒè¯ç é”™è¯¯', emailNotFound: 'æ‰¾ä¸åˆ°æ­¤ç”µå­é‚®ä»¶'}, forgotUsername: {title: 'å¿˜è®°ç”¨æˆ·å', subtitle: 'æˆ‘ä»¬ä¼šå‘é€éªŒè¯ç åˆ°æ‚¨çš„ç”µå­é‚®ä»¶', email: 'ç”µå­é‚®ä»¶', sendCode: 'å‘é€éªŒè¯ç ', verificationCode: 'éªŒè¯ç ', verify: 'éªŒè¯å¹¶æ˜¾ç¤º', found: 'æ‰¾åˆ°æ‚¨çš„è´¦å·', yourUsername: 'æ‚¨çš„ç”¨æˆ·åï¼ˆé‚®ç®±ï¼‰ï¼š', backToLogin: 'è¿”å›ç™»å½•', notRegistered: 'æ­¤ç”µå­é‚®ä»¶å°šæœªæ³¨å†Œï¼Œè¯·å…ˆæ³¨å†Œè´¦å·ã€‚'}, admin: {welcome: 'æ¬¢è¿å›æ¥', dashboard: 'ç®¡ç†åå°', returnFront: 'è¿”å›å‰å°', activities: 'æ´»åŠ¨ç®¡ç†', projects: 'é¡¹ç›®ç®¡ç†', team: 'å›¢é˜Ÿç®¡ç†', users: 'ç”¨æˆ·ç®¡ç†', settings: 'ç½‘ç«™è®¾ç½®', add: 'æ–°å¢', edit: 'ç¼–è¾‘', delete: 'åˆ é™¤', save: 'ä¿å­˜', cancel: 'å–æ¶ˆ', confirm: 'ç¡®å®š', loading: 'åŠ è½½ä¸­...', empty: 'æš‚æ— èµ„æ–™', deleteConfirm: 'ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', success: 'æ“ä½œæˆåŠŸï¼', error: 'æ“ä½œå¤±è´¥', activityTitle: 'æ´»åŠ¨æ ‡é¢˜', activityDate: 'æ´»åŠ¨æ—¥æœŸ', activityDescription: 'æ´»åŠ¨æè¿°', activityLink: 'æ´»åŠ¨é“¾æ¥', projectTitle: 'é¡¹ç›®æ ‡é¢˜', projectStatus: 'é¡¹ç›®çŠ¶æ€', projectDescription: 'é¡¹ç›®æè¿°', projectTechnologies: 'ä½¿ç”¨æŠ€æœ¯', projectMembers: 'å‚ä¸æˆå‘˜æ•°', projectLink: 'é¡¹ç›®é“¾æ¥', memberName: 'æˆå‘˜å§“å', memberPosition: 'èŒä½', memberBio: 'ä¸ªäººç®€ä»‹', memberAvatar: 'å¤´åƒé“¾æ¥', memberGithub: 'GitHub é“¾æ¥', memberEmail: 'ç”µå­é‚®ä»¶', userName: 'ç”¨æˆ·å', userEmail: 'ç”µå­é‚®ä»¶', userRole: 'è§’è‰²', userStatus: 'çŠ¶æ€', approve: 'æ‰¹å‡†', reject: 'æ‹’ç»', pending: 'å¾…å®¡æ ¸', approved: 'å·²æ‰¹å‡†', rejected: 'å·²æ‹’ç»', siteEmail: 'è”ç³»é‚®ç®±', sitePhone: 'è”ç³»ç”µè¯', siteAddress: 'åœ°å€', siteFacebook: 'Facebook', siteTwitter: 'Twitter', siteGithub: 'GitHub'}, common: {language: 'è¯­è¨€', loading: 'åŠ è½½ä¸­...', error: 'å‘ç”Ÿé”™è¯¯', success: 'æˆåŠŸ', confirm: 'ç¡®å®š', cancel: 'å–æ¶ˆ', save: 'ä¿å­˜', delete: 'åˆ é™¤', edit: 'ç¼–è¾‘', add: 'æ–°å¢', search: 'æœç´¢', filter: 'ç­›é€‰', all: 'å…¨éƒ¨'}},
    'en': {nav: {home: 'Home', about: 'About', activities: 'Activities', projects: 'Projects', team: 'Team', contact: 'Contact', admin: 'Admin Panel', login: 'Login', register: 'Register', logout: 'Logout', title: 'Science and technology club'}, messages: {loading: 'Loading...', loginSuccess: 'Login successful!', loginError: 'Login failed, please check your email and password', registerSuccess: 'We have received your registration application. The administrator will review it and reply to you via email within three working days.', registerError: 'Registration failed, please try again later', verificationSent: 'Verification code sent to your email', verificationError: 'Verification code is incorrect or expired', passwordResetError: 'Password reset failed'}, hero: {title: 'Welcome to Science and technology club', subtitle: 'Explore Technology, Create Future', viewActivities: 'View Activities', joinUs: 'Join Us'}, anthem: {title: 'Science and Technology Club Anthem', description: 'Listen to our anthem and feel the spirit and passion of the Science and Technology Club'}, about: {title: 'About Us', innovation: 'Innovation', innovationDesc: 'Foster innovation, encourage members to explore cutting-edge technology, challenge traditional thinking, and create new possibilities.', teamwork: 'Teamwork', teamworkDesc: 'Build a collaborative learning environment, enhance cooperation through team projects, and grow together.', knowledge: 'Knowledge Sharing', knowledgeDesc: 'Regularly hold lectures and workshops, share latest technology trends and practical skills, promote knowledge exchange.'}, activities: {title: 'Recent Activities', loading: 'Loading...', empty: 'No activities available', learnMore: 'Learn More'}, projects: {title: 'Featured Projects', loading: 'Loading...', empty: 'No projects available', status: {ongoing: 'Ongoing', completed: 'Completed', planned: 'Planned'}, members: 'Members', viewProject: 'View Project'}, team: {title: 'Core Team'}, contact: {title: 'Contact Us', name: 'Name', namePlaceholder: 'Enter your name', email: 'Email', emailPlaceholder: 'your@email.com', subject: 'Subject', subjectPlaceholder: 'Enter subject', message: 'Message', messagePlaceholder: 'Enter your message', send: 'Send Message', success: 'We have received your message and will reply to you via email within three working days', sendMessageTitle: 'Send Message', yourEmail: 'Your Email', content: 'Content', contentPlaceholder: 'Please enter your questions or suggestions...', sendButton: 'Send Message', emailLabel: 'Email', address: 'Address', hours: 'Opening Hours', hoursValue: 'Monday - Friday 9:00-18:00', error: 'Failed to send, please try again later'}, login: {title: 'Admin Login', subtitle: 'Please login to continue', username: 'Username', usernameOrEmail: 'Username', usernamePlaceholder: 'Enter username', email: 'Email', emailPlaceholder: 'Enter email', password: 'Password', passwordPlaceholder: 'Enter password', loginBtn: 'Login', forgotPassword: 'Forgot Password?', forgotUsername: 'Forgot Username?', noAccount: "Don't have an account?", registerNow: 'Register Now', error: 'Invalid username or password', pending: 'Your account is pending admin approval'}, register: {title: 'Register New Account', subtitle: 'Join Science and technology club Management Team', fullName: 'Full Name', fullNamePlaceholder: 'Enter your full name', username: 'Username', usernamePlaceholder: 'Set your username', email: 'Email', emailPlaceholder: 'Enter email', password: 'Password', passwordPlaceholder: 'Set password (at least 6 characters)', confirmPassword: 'Confirm Password', confirmPasswordPlaceholder: 'Enter password again', registerBtn: 'Register', hasAccount: 'Already have an account?', loginNow: 'Login Now', success: 'Registration successful! Please wait for admin approval.', passwordMismatch: 'Passwords do not match', emailExists: 'This email is already registered'}, forgotPassword: {title: 'Reset Password', subtitle: 'We will send a verification code to your email', email: 'Email', emailPlaceholder: 'Enter your registered email', sendCode: 'Send Code', verificationCode: 'Verification Code', verificationCodePlaceholder: 'Enter 6-digit code', newPassword: 'New Password', newPasswordPlaceholder: 'Set new password', confirmPassword: 'Confirm Password', confirmPasswordPlaceholder: 'Enter new password again', resetPassword: 'Reset Password', backToLogin: 'Back to Login', codeSent: 'Verification code sent to your email', success: 'Password reset successful!', invalidCode: 'Invalid verification code', emailNotFound: 'Email not found'}, forgotUsername: {title: 'Forgot Username', subtitle: 'We will send a verification code to your email', email: 'Email', sendCode: 'Send Code', verificationCode: 'Verification Code', verify: 'Verify and Show', found: 'Account Found', yourUsername: 'Your Username (Email):', backToLogin: 'Back to Login', notRegistered: 'This email is not registered. Please register first.'}, admin: {welcome: 'Welcome back', dashboard: 'Admin Dashboard', returnFront: 'Return to Site', activities: 'Activities', projects: 'Projects', team: 'Team', users: 'Users', settings: 'Settings', add: 'Add', edit: 'Edit', delete: 'Delete', save: 'Save', cancel: 'Cancel', confirm: 'Confirm', loading: 'Loading...', empty: 'No data', deleteConfirm: 'Are you sure you want to delete?', success: 'Success!', error: 'Error occurred', activityTitle: 'Activity Title', activityDate: 'Activity Date', activityDescription: 'Description', activityLink: 'Link', projectTitle: 'Project Title', projectStatus: 'Status', projectDescription: 'Description', projectTechnologies: 'Technologies', projectMembers: 'Members', projectLink: 'Link', memberName: 'Name', memberPosition: 'Position', memberBio: 'Bio', memberAvatar: 'Avatar URL', memberGithub: 'GitHub', memberEmail: 'Email', userName: 'Username', userEmail: 'Email', userRole: 'Role', userStatus: 'Status', approve: 'Approve', reject: 'Reject', pending: 'Pending', approved: 'Approved', rejected: 'Rejected', siteEmail: 'Contact Email', sitePhone: 'Phone', siteAddress: 'Address', siteFacebook: 'Facebook', siteTwitter: 'Twitter', siteGithub: 'GitHub'}, common: {language: 'Language', loading: 'Loading...', error: 'Error', success: 'Success', confirm: 'Confirm', cancel: 'Cancel', save: 'Save', delete: 'Delete', edit: 'Edit', add: 'Add', search: 'Search', filter: 'Filter', all: 'All'}}
};

        // èªè¨€åˆ‡æ›å·¥å…·
        class I18n {
            constructor() {
                this.currentLang = 'zh-TW';
            }
            setLanguage(lang) {
                if (translations[lang]) {
                    this.currentLang = lang;
                    document.documentElement.lang = lang;
                    return true;
                }
                return false;
            }
            t(key) {
                const keys = key.split('.');
                let value = translations[this.currentLang];
                for (const k of keys) {
                    if (value && value[k] !== undefined) {
                        value = value[k];
                    } else {
                        console.warn(`Translation key not found: ${key}`);
                        return key;
                    }
                }
                return value;
            }
            getCurrentLanguage() {
                return this.currentLang;
            }
            getAvailableLanguages() {
                return [
                    { code: 'zh-TW', name: 'ç¹é«”ä¸­æ–‡' },
                    { code: 'zh-CN', name: 'ç®€ä½“ä¸­æ–‡' },
                    { code: 'en', name: 'English' }
                ];
            }
        }

        // å°å‡ºä¾›å…¶ä»–è…³æœ¬ä½¿ç”¨
        if (typeof window !== 'undefined') {
            window.I18n = I18n;
            window.i18n = new I18n();
            console.log('âœ“ Translations loaded successfully (inline)');
        }

        // ========================================
        // é…ç½®
        // ========================================
        // ç‰ˆæœ¬: 2025-01-23 v4.5.5 - æ–°å¢å–®ä¸€è£ç½®ç™»å…¥ã€è‡ªå‹•ç™»å‡ºã€è¨ªå®¢é™åˆ¶æ’éšŠç³»çµ±

        const firebaseConfig = {
            apiKey: "AIzaSyCCXmBJkesxRi3ufdCRucd5vcmg-Ls_3Ks",
            authDomain: "tech-society-566dc.firebaseapp.com",
            projectId: "tech-society-566dc",
            storageBucket: "tech-society-566dc.firebasestorage.app",
            messagingSenderId: "1098408063649",
            appId: "1:1098408063649:web:ec07e23e03c43f92c7f6e0",
            measurementId: "G-05127H92FQ"
        };

        const emailJSConfig = {
            publicKey: 'wSb5w9ZOF2-9HGCu1',
            serviceId: 'ats-ç§‘æŠ€å­¸æœƒ',
            templates: {
                'zh-TW': 'template_nhcptbe',
                'en': 'template_34emldj'
            }
        };

        const SUPER_ADMIN_UID = 'vdNBS7qPdRV9qpV7CLgXwBflCf23';

        // æœƒè©±ç®¡ç†é…ç½®
        const SESSION_CONFIG = {
            inactivityTimeout: 30 * 60 * 1000, // 30åˆ†é˜ç„¡æ´»å‹•è‡ªå‹•ç™»å‡ºï¼ˆå·²ç™»å…¥ç”¨æˆ¶ï¼‰
            visitorInactivityTimeout: 10 * 60 * 1000, // 10åˆ†é˜ç„¡æ´»å‹•è¸¢å‡ºè¨ªå®¢
            activityUpdateInterval: 30 * 1000, // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
            visitorHeartbeatInterval: 30 * 1000, // æ¯30ç§’æ›´æ–°ä¸€æ¬¡è¨ªå®¢å¿ƒè·³
            warningAt5Min: 5 * 60 * 1000, // å‰©é¤˜5åˆ†é˜æ™‚æé†’
            warningAt1Min: 1 * 60 * 1000  // å‰©é¤˜1åˆ†é˜æ™‚æé†’
        };

        // è¿½è¹¤æ˜¯å¦å·²é¡¯ç¤ºéè­¦å‘Š
        let shownWarning5Min = false;
        let shownWarning1Min = false;
        let countdownTimer = null;
        let countdownElement = null;

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // åˆå§‹åŒ– EmailJS
        emailjs.init(emailJSConfig.publicKey);

        // ========================================
        // æœƒè©±èˆ‡è¨ªå®¢ç®¡ç†
        // ========================================

        let currentSessionId = null;
        let activityTimer = null;
        let lastActivityTime = Date.now();
        let visitorId = null;
        let visitorHeartbeatTimer = null;
        let isInQueue = false;

        // ç”Ÿæˆå”¯ä¸€æœƒè©±ID
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ç”Ÿæˆè¨ªå®¢ID
        function generateVisitorId() {
            return 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // æ›´æ–°ç”¨æˆ¶æ´»å‹•æ™‚é–“ï¼ˆä½¿ç”¨ç¯€æµé¿å…é »ç¹æ›´æ–°ï¼‰
        let activityThrottleTimer = null;
        function updateActivityTime() {
            if (activityThrottleTimer) return; // ç¯€æµï¼šæ¯5ç§’æœ€å¤šæ›´æ–°ä¸€æ¬¡
            activityThrottleTimer = setTimeout(() => {
                activityThrottleTimer = null;
            }, 5000);

            lastActivityTime = Date.now();
            // é‡ç½®è­¦å‘Šç‹€æ…‹
            shownWarning5Min = false;
            shownWarning1Min = false;
            // éš±è—å€’æ•¸è¨ˆæ™‚å™¨
            hideCountdown();
            console.log('[æ´»å‹•ç›£æ§] åµæ¸¬åˆ°ç”¨æˆ¶æ´»å‹•ï¼Œé‡ç½®è¨ˆæ™‚å™¨');
        }

        // é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚å™¨
        function showCountdown(remainingMs) {
            if (!countdownElement) {
                countdownElement = document.createElement('div');
                countdownElement.id = 'logoutCountdown';
                countdownElement.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] flex items-center space-x-3';
                countdownElement.innerHTML = `
                    <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-semibold">ä½ çš„å¸³æˆ¶å°‡æ–¼ <span id="countdownTime" class="text-yellow-300 font-bold"></span> å¾Œè‡ªå‹•ç™»å‡º</p>
                        <p class="text-xs opacity-80">ç§»å‹•æ»‘é¼ æˆ–é»æ“Šä»»æ„ä½ç½®ä»¥ä¿æŒç™»å…¥</p>
                    </div>
                `;
                document.body.appendChild(countdownElement);
            }

            // æ ¼å¼åŒ–å‰©é¤˜æ™‚é–“
            const totalSeconds = Math.ceil(remainingMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const timeString = minutes > 0
                ? `${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`
                : `${seconds}ç§’`;

            document.getElementById('countdownTime').textContent = timeString;
            countdownElement.style.display = 'flex';
        }

        // éš±è—å€’æ•¸è¨ˆæ™‚å™¨
        function hideCountdown() {
            if (countdownElement) {
                countdownElement.style.display = 'none';
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        }

        // é–‹å§‹å€’æ•¸è¨ˆæ™‚
        function startCountdown() {
            if (countdownTimer) return; // å·²ç¶“åœ¨å€’æ•¸ä¸­

            // æ¯ç§’æ›´æ–°ä¸€æ¬¡å€’æ•¸
            countdownTimer = setInterval(() => {
                const now = Date.now();
                const elapsed = now - lastActivityTime;
                const remaining = Math.max(0, SESSION_CONFIG.inactivityTimeout - elapsed);

                if (remaining > 0 && remaining <= SESSION_CONFIG.warningAt5Min && auth.currentUser) {
                    showCountdown(remaining);
                } else {
                    hideCountdown();
                }
            }, 1000);
        }

        // æª¢æŸ¥æ˜¯å¦è¶…æ™‚
        function checkInactivityTimeout() {
            const now = Date.now();
            const elapsed = now - lastActivityTime;
            const remaining = Math.max(0, SESSION_CONFIG.inactivityTimeout - elapsed);

            // å‰©é¤˜5åˆ†é˜æ™‚é–‹å§‹å€’æ•¸
            if (remaining <= SESSION_CONFIG.warningAt5Min && remaining > 0 && auth.currentUser) {
                if (!shownWarning5Min) {
                    shownWarning5Min = true;
                    startCountdown();
                    console.log('[æ´»å‹•ç›£æ§] é–‹å§‹5åˆ†é˜å€’æ•¸');
                }
            }

            // è¶…æ™‚è‡ªå‹•ç™»å‡º
            if (elapsed >= SESSION_CONFIG.inactivityTimeout && auth.currentUser) {
                console.log('[æ´»å‹•ç›£æ§] ç”¨æˆ¶ç„¡æ´»å‹•è¶…æ™‚ï¼ŒåŸ·è¡Œè‡ªå‹•ç™»å‡º');
                hideCountdown();
                stopActivityMonitoring(); // åœæ­¢ç›£æ§é¿å…é‡è¤‡è§¸ç™¼
                showToast('ä½ çš„å¸³æˆ¶å·²ç¶“è‡ªå‹•ç™»å‡ºï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
                logout();
            }
        }

        // é–‹å§‹æ´»å‹•ç›£æ§
        function startActivityMonitoring() {
            // é‡ç½®æœ€å¾Œæ´»å‹•æ™‚é–“
            lastActivityTime = Date.now();

            // ç›£è½ç”¨æˆ¶æ´»å‹•ï¼ˆåªç›£è½æ˜ç¢ºçš„ç”¨æˆ¶æ“ä½œï¼Œä¸ç›£è½ mousemoveï¼‰
            const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, updateActivityTime, { passive: true });
            });

            // å®šæœŸæª¢æŸ¥è¶…æ™‚
            if (activityTimer) {
                clearInterval(activityTimer);
            }
            activityTimer = setInterval(checkInactivityTimeout, SESSION_CONFIG.activityUpdateInterval);

            console.log('âœ“ æ´»å‹•ç›£æ§å·²å•Ÿå‹•ï¼Œè¶…æ™‚æ™‚é–“:', SESSION_CONFIG.inactivityTimeout / 1000, 'ç§’');
            console.log('âœ“ æª¢æŸ¥é–“éš”:', SESSION_CONFIG.activityUpdateInterval / 1000, 'ç§’');
        }

        // åœæ­¢æ´»å‹•ç›£æ§
        function stopActivityMonitoring() {
            if (activityTimer) {
                clearInterval(activityTimer);
                activityTimer = null;
            }
        }

        // å‰µå»ºæœƒè©±
        async function createSession(userId) {
            const sessionId = generateSessionId();

            try {
                // å…ˆæª¢æŸ¥ä¸¦æ¸…é™¤å…¶ä»–æœƒè©±
                const existingSessions = await db.collection('sessions')
                    .where('userId', '==', userId)
                    .where('active', '==', true)
                    .get();

                // æ¨™è¨˜å…¶ä»–æœƒè©±ç‚ºéæ´»èº
                const batch = db.batch();
                existingSessions.forEach(doc => {
                    batch.update(doc.ref, {
                        active: false,
                        endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        endReason: 'new_login'
                    });
                });
                await batch.commit();

                // å‰µå»ºæ–°æœƒè©±
                await db.collection('sessions').doc(sessionId).set({
                    userId,
                    sessionId,
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    platform: navigator.platform || 'unknown'
                });

                currentSessionId = sessionId;
                console.log('âœ“ æ–°æœƒè©±å·²å‰µå»º:', sessionId);

                // é–‹å§‹æ´»å‹•ç›£æ§
                startActivityMonitoring();

                return sessionId;
            } catch (error) {
                console.error('å‰µå»ºæœƒè©±å¤±æ•—:', error);
                throw error;
            }
        }

        // é©—è­‰æœƒè©±
        async function validateSession(userId) {
            if (!currentSessionId) return false;

            try {
                const sessionDoc = await db.collection('sessions').doc(currentSessionId).get();

                if (!sessionDoc.exists) {
                    return false;
                }

                const sessionData = sessionDoc.data();

                // æª¢æŸ¥æœƒè©±æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                if (!sessionData.active || sessionData.userId !== userId) {
                    return false;
                }

                // æ›´æ–°æœ€å¾Œæ´»å‹•æ™‚é–“
                await db.collection('sessions').doc(currentSessionId).update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });

                return true;
            } catch (error) {
                console.error('é©—è­‰æœƒè©±å¤±æ•—:', error);
                return false;
            }
        }

        // çµæŸæœƒè©±
        async function endSession() {
            if (!currentSessionId) return;

            try {
                await db.collection('sessions').doc(currentSessionId).update({
                    active: false,
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    endReason: 'logout'
                });

                console.log('âœ“ æœƒè©±å·²çµæŸ:', currentSessionId);
            } catch (error) {
                console.error('çµæŸæœƒè©±å¤±æ•—:', error);
            }

            currentSessionId = null;
            stopActivityMonitoring();
        }

        // ç›£è½æœƒè©±è®ŠåŒ–ï¼ˆè¢«å…¶ä»–è£ç½®è¸¢ä¸‹ç·šï¼‰
        function listenToSessionChanges(userId) {
            if (!currentSessionId) return;

            return db.collection('sessions').doc(currentSessionId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (!data.active && data.endReason === 'new_login') {
                            showToast({
                                'zh-TW': 'æ‚¨çš„å¸³è™Ÿå·²åœ¨å…¶ä»–è£ç½®ç™»å…¥ï¼Œæ­¤è£ç½®å·²è¢«ç™»å‡º',
                                'zh-CN': 'æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œæ­¤è®¾å¤‡å·²è¢«ç™»å‡º',
                                'en': 'Your account has logged in on another device. This device has been logged out.'
                            }[i18n.currentLang] || 'æ‚¨çš„å¸³è™Ÿå·²åœ¨å…¶ä»–è£ç½®ç™»å…¥');
                            auth.signOut();
                        }
                    }
                });
        }

        // ========================================
        // è¨ªå®¢è¿½è¹¤èˆ‡æ’éšŠç³»çµ±
        // ========================================

        // è¨˜éŒ„ç•¶å‰è¨ªå®¢é€²å…¥æ’éšŠçš„æ™‚é–“
        let visitorQueueTime = null;
        let visitorLastActivity = Date.now(); // è¨ªå®¢æœ€å¾Œæ´»å‹•æ™‚é–“
        let visitorActivityTimer = null; // è¨ªå®¢æ´»å‹•ç›£æ§è¨ˆæ™‚å™¨

        // è¨»å†Šè¨ªå®¢
        async function registerVisitor() {
            visitorId = generateVisitorId();
            visitorQueueTime = Date.now(); // è¨˜éŒ„é€²å…¥æ™‚é–“
            visitorLastActivity = Date.now(); // åˆå§‹åŒ–æ´»å‹•æ™‚é–“

            try {
                await db.collection('visitors').doc(visitorId).set({
                    visitorId,
                    enteredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    queueEnteredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    active: true,
                    inQueue: false, // åˆå§‹ç‚º falseï¼Œéœ€è¦æ’éšŠæ™‚è¨­ç‚º true
                    userAgent: navigator.userAgent,
                    platform: navigator.platform || 'unknown'
                });

                // è¨˜éŒ„æ­·å²è¨ªå•
                await db.collection('visit_history').add({
                    visitorId,
                    visitedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString().split('T')[0] // YYYY-MM-DD
                });

                // é–‹å§‹å¿ƒè·³
                startVisitorHeartbeat();

                // é–‹å§‹è¨ªå®¢æ´»å‹•ç›£æ§
                startVisitorActivityMonitoring();

                console.log('âœ“ è¨ªå®¢å·²è¨»å†Š:', visitorId);
                return visitorId;
            } catch (error) {
                console.error('è¨»å†Šè¨ªå®¢å¤±æ•—:', error);
                return null;
            }
        }

        // ========================================
        // è¸¢å‡ºè­¦å‘Šç›£è½åŠŸèƒ½
        // ========================================

        let kickWarningListener = null;
        let kickWarningTimer = null;
        let kickWarningElement = null;
        let kickWarningConfirmed = false;

        // é–‹å§‹ç›£è½è¸¢å‡ºè­¦å‘Š
        function startKickWarningListener() {
            if (kickWarningListener) return;

            kickWarningListener = db.collection('settings').doc('kick_warning')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.active && data.kickTime) {
                            const kickTime = data.kickTime.toDate ? data.kickTime.toDate() : new Date(data.kickTime);
                            const now = new Date();

                            if (kickTime > now && !kickWarningConfirmed) {
                                // é¡¯ç¤ºè­¦å‘Šå€’æ•¸
                                showKickWarningModal(kickTime);
                            }
                        } else {
                            // è­¦å‘Šå·²å–æ¶ˆ
                            hideKickWarningModal();
                        }
                    }
                });
        }

        // é¡¯ç¤ºè¸¢å‡ºè­¦å‘Šæ¨¡æ…‹æ¡†
        function showKickWarningModal(kickTime) {
            if (kickWarningElement) return;

            kickWarningElement = document.createElement('div');
            kickWarningElement.id = 'kickWarningModal';
            kickWarningElement.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-[10001]';

            const texts = {
                'zh-TW': {
                    title: 'âš ï¸ ç·Šæ€¥é€šçŸ¥',
                    message: 'ç®¡ç†å“¡è¦æ±‚æ‰€æœ‰è¨ªå®¢ç¢ºèªåœ¨ç·šç‹€æ…‹',
                    hint: 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç¢ºèªæ‚¨ä»åœ¨ä½¿ç”¨ç¶²ç«™ï¼Œå¦å‰‡å°‡è¢«è‡ªå‹•è¸¢å‡ºã€‚',
                    countdown: 'å‰©é¤˜æ™‚é–“ï¼š',
                    confirmBtn: 'æˆ‘é‚„åœ¨ï¼ç¢ºèªç¹¼çºŒ'
                },
                'zh-CN': {
                    title: 'âš ï¸ ç´§æ€¥é€šçŸ¥',
                    message: 'ç®¡ç†å‘˜è¦æ±‚æ‰€æœ‰è®¿å®¢ç¡®è®¤åœ¨çº¿çŠ¶æ€',
                    hint: 'è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç¡®è®¤æ‚¨ä»åœ¨ä½¿ç”¨ç½‘ç«™ï¼Œå¦åˆ™å°†è¢«è‡ªåŠ¨è¸¢å‡ºã€‚',
                    countdown: 'å‰©ä½™æ—¶é—´ï¼š',
                    confirmBtn: 'æˆ‘è¿˜åœ¨ï¼ç¡®è®¤ç»§ç»­'
                },
                'en': {
                    title: 'âš ï¸ Urgent Notice',
                    message: 'Admin requires all visitors to confirm online status',
                    hint: 'Please click the button below to confirm you are still using the website, otherwise you will be kicked out.',
                    countdown: 'Time remaining: ',
                    confirmBtn: "I'm here! Confirm"
                }
            };

            const lang = texts[i18n.currentLang] || texts['zh-TW'];

            kickWarningElement.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 text-center shadow-2xl">
                    <div class="text-5xl mb-4">âš ï¸</div>
                    <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">${lang.title}</h2>
                    <p class="text-lg text-gray-700 dark:text-gray-300 mb-2">${lang.message}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">${lang.hint}</p>
                    <div class="bg-red-100 dark:bg-red-900/30 rounded-lg p-4 mb-6">
                        <p class="text-sm text-red-600 dark:text-red-400">${lang.countdown}</p>
                        <p class="text-3xl font-bold text-red-600 dark:text-red-400" id="kickWarningCountdown">60</p>
                    </div>
                    <button id="confirmStayBtn" class="w-full px-6 py-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-lg transition-colors">
                        ${lang.confirmBtn}
                    </button>
                </div>
            `;

            document.body.appendChild(kickWarningElement);

            // ç¶å®šç¢ºèªæŒ‰éˆ•
            document.getElementById('confirmStayBtn').addEventListener('click', () => {
                kickWarningConfirmed = true;
                hideKickWarningModal();
                showToast('å·²ç¢ºèªï¼Œæ‚¨å¯ä»¥ç¹¼çºŒä½¿ç”¨ç¶²ç«™');
            });

            // é–‹å§‹å€’æ•¸
            startKickWarningCountdown(kickTime);
        }

        // å€’æ•¸è¨ˆæ™‚
        function startKickWarningCountdown(kickTime) {
            if (kickWarningTimer) clearInterval(kickWarningTimer);

            kickWarningTimer = setInterval(() => {
                const now = new Date();
                const remaining = Math.max(0, Math.ceil((kickTime - now) / 1000));
                const countdownEl = document.getElementById('kickWarningCountdown');

                if (countdownEl) {
                    countdownEl.textContent = remaining + 'ç§’';
                }

                if (remaining <= 0 && !kickWarningConfirmed) {
                    // æ™‚é–“åˆ°ï¼Œè¸¢å‡º
                    clearInterval(kickWarningTimer);
                    hideKickWarningModal();
                    kickOutInactiveVisitor();
                }
            }, 1000);
        }

        // éš±è—è¸¢å‡ºè­¦å‘Šæ¨¡æ…‹æ¡†
        function hideKickWarningModal() {
            if (kickWarningTimer) {
                clearInterval(kickWarningTimer);
                kickWarningTimer = null;
            }
            if (kickWarningElement) {
                kickWarningElement.remove();
                kickWarningElement = null;
            }
        }

        // ç›£è¯è¢«è¸¢å‡ºç‹€æ…‹
        function listenToKickStatus() {
            if (!visitorId) return;

            db.collection('visitors').doc(visitorId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.active === false && data.kickReason === 'admin_kick_all') {
                            // è¢«ç®¡ç†å“¡è¸¢å‡º
                            showKickedOutPage();
                        }
                    }
                });
        }

        // ========================================
        // å…¬å‘Šæ¬„åŠŸèƒ½ï¼ˆæ”¯æŒå¤šæ¢å…¬å‘Šè¼ªæ’­ï¼‰
        // ========================================

        let announcementListener = null;
        let announcements = []; // å­˜å„²æ‰€æœ‰å•Ÿç”¨çš„å…¬å‘Š
        let currentAnnouncementIndex = 0;
        let announcementAutoplayTimer = null;
        const ANNOUNCEMENT_AUTOPLAY_INTERVAL = 5000; // 5ç§’è‡ªå‹•åˆ‡æ›

        // é–‹å§‹ç›£è½å…¬å‘Š
        function startAnnouncementListener() {
            if (announcementListener) return;

            console.log('[å…¬å‘Š] é–‹å§‹ç›£è½å…¬å‘Š...');

            announcementListener = db.collection('announcements')
                .where('active', '==', true)
                .onSnapshot((snapshot) => {
                    console.log('[å…¬å‘Š] æ”¶åˆ°å¿«ç…§ï¼Œæ–‡ä»¶æ•¸é‡:', snapshot.size);

                    if (!snapshot.empty) {
                        // æ”¶é›†æ‰€æœ‰å•Ÿç”¨çš„å…¬å‘Š
                        const allAnnouncements = [];
                        const now = new Date();

                        snapshot.docs.forEach(doc => {
                            const data = doc.data();

                            // æª¢æŸ¥å®šæ™‚ç™¼å¸ƒ - å°šæœªé–‹å§‹çš„ä¸é¡¯ç¤º
                            if (data.startTime) {
                                const startDate = data.startTime.seconds ? new Date(data.startTime.seconds * 1000) : new Date(data.startTime);
                                if (startDate > now) {
                                    console.log('[å…¬å‘Š] è·³éå°šæœªé–‹å§‹çš„å…¬å‘Š:', data.title);
                                    return;
                                }
                            }

                            // æª¢æŸ¥å®šæ™‚çµæŸ - å·²çµæŸçš„ä¸é¡¯ç¤º
                            if (data.endTime) {
                                const endDate = data.endTime.seconds ? new Date(data.endTime.seconds * 1000) : new Date(data.endTime);
                                if (endDate < now) {
                                    console.log('[å…¬å‘Š] è·³éå·²çµæŸçš„å…¬å‘Š:', data.title);
                                    return;
                                }
                            }

                            const createdAt = data.createdAt;
                            let timestamp = 0;

                            if (createdAt) {
                                if (createdAt.seconds) {
                                    timestamp = createdAt.seconds * 1000;
                                } else if (createdAt instanceof Date) {
                                    timestamp = createdAt.getTime();
                                } else {
                                    timestamp = new Date(createdAt).getTime();
                                }
                            }

                            // åˆ†é¡æ¨™ç±¤å°æ‡‰
                            const categoryStyles = {
                                'general': { icon: 'ğŸŸ¢', gradient: 'from-blue-600 to-purple-600' },
                                'important': { icon: 'ğŸŸ¡', gradient: 'from-yellow-500 to-orange-500' },
                                'urgent': { icon: 'ğŸ”´', gradient: 'from-red-600 to-pink-600' },
                                'event': { icon: 'ğŸ”µ', gradient: 'from-cyan-500 to-blue-500' }
                            };
                            const category = data.category || 'general';
                            const categoryStyle = categoryStyles[category] || categoryStyles['general'];

                            allAnnouncements.push({
                                id: doc.id,
                                title: data.title || '',
                                content: data.content || '',
                                imageUrl: data.imageUrl || '',
                                category: category,
                                categoryIcon: categoryStyle.icon,
                                gradient: categoryStyle.gradient,
                                pinned: data.pinned || false,
                                timestamp: timestamp
                            });
                        });

                        // æŒ‰ç½®é ‚å„ªå…ˆï¼Œç„¶å¾ŒæŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        allAnnouncements.sort((a, b) => {
                            if (a.pinned && !b.pinned) return -1;
                            if (!a.pinned && b.pinned) return 1;
                            return b.timestamp - a.timestamp;
                        });

                        announcements = allAnnouncements;
                        console.log('[å…¬å‘Š] å…±æœ‰', announcements.length, 'æ¢æœ‰æ•ˆå…¬å‘Š');

                        // é¡¯ç¤ºå…¬å‘Š
                        showAnnouncements();
                    } else {
                        console.log('[å…¬å‘Š] æ²’æœ‰å•Ÿç”¨çš„å…¬å‘Š');
                        announcements = [];
                        hideAnnouncement();
                    }
                }, (error) => {
                    console.error('[å…¬å‘Š] ç›£è½éŒ¯èª¤:', error);
                    loadAnnouncementFallback();
                });
        }

        // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ getDocs è¼‰å…¥å…¬å‘Š
        async function loadAnnouncementFallback() {
            try {
                console.log('[å…¬å‘Š] ä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆè¼‰å…¥...');
                const snapshot = await db.collection('announcements').get();

                const allAnnouncements = [];
                const now = new Date();

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.active) {
                        // æª¢æŸ¥å®šæ™‚ç™¼å¸ƒ
                        if (data.startTime) {
                            const startDate = data.startTime.seconds ? new Date(data.startTime.seconds * 1000) : new Date(data.startTime);
                            if (startDate > now) return;
                        }
                        if (data.endTime) {
                            const endDate = data.endTime.seconds ? new Date(data.endTime.seconds * 1000) : new Date(data.endTime);
                            if (endDate < now) return;
                        }

                        const createdAt = data.createdAt;
                        let timestamp = 0;

                        if (createdAt) {
                            if (createdAt.seconds) {
                                timestamp = createdAt.seconds * 1000;
                            } else if (createdAt instanceof Date) {
                                timestamp = createdAt.getTime();
                            }
                        }

                        const categoryStyles = {
                            'general': { icon: 'ğŸŸ¢', gradient: 'from-blue-600 to-purple-600' },
                            'important': { icon: 'ğŸŸ¡', gradient: 'from-yellow-500 to-orange-500' },
                            'urgent': { icon: 'ğŸ”´', gradient: 'from-red-600 to-pink-600' },
                            'event': { icon: 'ğŸ”µ', gradient: 'from-cyan-500 to-blue-500' }
                        };
                        const category = data.category || 'general';
                        const categoryStyle = categoryStyles[category] || categoryStyles['general'];

                        allAnnouncements.push({
                            id: doc.id,
                            title: data.title || '',
                            content: data.content || '',
                            imageUrl: data.imageUrl || '',
                            category: category,
                            categoryIcon: categoryStyle.icon,
                            gradient: categoryStyle.gradient,
                            pinned: data.pinned || false,
                            timestamp: timestamp
                        });
                    }
                });

                // æŒ‰ç½®é ‚å„ªå…ˆï¼Œç„¶å¾ŒæŒ‰æ™‚é–“æ’åº
                allAnnouncements.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return b.timestamp - a.timestamp;
                });
                announcements = allAnnouncements;

                if (announcements.length > 0) {
                    showAnnouncements();
                }
            } catch (error) {
                console.error('[å…¬å‘Š] å‚™ç”¨æ–¹æ¡ˆéŒ¯èª¤:', error);
            }
        }

        // é¡¯ç¤ºå…¬å‘Šï¼ˆå¤šæ¢è¼ªæ’­ï¼‰
        function showAnnouncements() {
            if (announcements.length === 0) {
                hideAnnouncement();
                return;
            }

            const bar = document.getElementById('announcementBar');
            const textEl = document.getElementById('announcementText');
            const currentEl = document.getElementById('announcementCurrent');
            const totalEl = document.getElementById('announcementTotal');
            const indicatorEl = document.getElementById('announcementIndicator');
            const prevBtn = document.getElementById('prevAnnouncementBtn');
            const nextBtn = document.getElementById('nextAnnouncementBtn');

            if (bar && textEl) {
                bar.classList.remove('hidden');

                // æ›´æ–°ç¸½æ•¸
                if (totalEl) totalEl.textContent = announcements.length;

                // å¦‚æœåªæœ‰ä¸€æ¢å…¬å‘Šï¼Œéš±è—å°èˆª
                if (announcements.length === 1) {
                    if (indicatorEl) indicatorEl.classList.add('hidden');
                    if (prevBtn) prevBtn.classList.add('hidden');
                    if (nextBtn) nextBtn.classList.add('hidden');
                } else {
                    if (indicatorEl) indicatorEl.classList.remove('hidden');
                    if (prevBtn) prevBtn.classList.remove('hidden');
                    if (nextBtn) nextBtn.classList.remove('hidden');
                }

                // é¡¯ç¤ºç•¶å‰å…¬å‘Š
                updateAnnouncementDisplay();

                // é–‹å§‹è‡ªå‹•æ’­æ”¾
                startAnnouncementAutoplay();

                // èª¿æ•´å°èˆªæ¬„ä½ç½®
                setTimeout(adjustNavPosition, 50);
            }
        }

        // æ›´æ–°å…¬å‘Šé¡¯ç¤º
        function updateAnnouncementDisplay() {
            const bar = document.getElementById('announcementBar');
            const textEl = document.getElementById('announcementText');
            const currentEl = document.getElementById('announcementCurrent');
            const labelEl = document.getElementById('announcementLabel');

            if (announcements.length === 0) return;

            // ç¢ºä¿ç´¢å¼•åœ¨ç¯„åœå…§
            if (currentAnnouncementIndex >= announcements.length) {
                currentAnnouncementIndex = 0;
            }
            if (currentAnnouncementIndex < 0) {
                currentAnnouncementIndex = announcements.length - 1;
            }

            const announcement = announcements[currentAnnouncementIndex];

            // æ›´æ–°å…¬å‘Šæ¬„èƒŒæ™¯é¡è‰²
            if (bar) {
                // ç§»é™¤èˆŠçš„æ¼¸è®Šé¡
                bar.className = bar.className.replace(/from-\S+\s+to-\S+/g, '');
                // æ·»åŠ æ–°çš„æ¼¸è®Š
                const gradient = announcement.gradient || 'from-blue-600 to-purple-600';
                bar.className = `bg-gradient-to-r ${gradient} text-white py-2 px-4 fixed top-0 left-0 right-0 z-50`;
            }

            // æ›´æ–°æ¨™ç±¤é¡¯ç¤º
            if (labelEl) {
                const pinnedIcon = announcement.pinned ? 'ğŸ“Œ ' : '';
                const categoryIcon = announcement.categoryIcon || '';
                labelEl.innerHTML = `${pinnedIcon}${categoryIcon} æœ€æ–°`;
            }

            // æ§‹å»ºé¡¯ç¤ºæ–‡å­—
            const displayText = announcement.title ? `${announcement.title}: ${announcement.content}` : announcement.content;

            if (textEl) {
                // æ·»åŠ å‹•ç•«æ•ˆæœ
                textEl.style.opacity = '0';
                setTimeout(() => {
                    textEl.textContent = displayText;
                    textEl.style.opacity = '1';
                }, 150);
            }

            if (currentEl) {
                currentEl.textContent = currentAnnouncementIndex + 1;
            }
        }

        // ä¸Šä¸€æ¢å…¬å‘Š
        function prevAnnouncement() {
            currentAnnouncementIndex--;
            updateAnnouncementDisplay();
            restartAnnouncementAutoplay();
        }

        // ä¸‹ä¸€æ¢å…¬å‘Š
        function nextAnnouncement() {
            currentAnnouncementIndex++;
            updateAnnouncementDisplay();
            restartAnnouncementAutoplay();
        }

        // é–‹å§‹è‡ªå‹•æ’­æ”¾
        function startAnnouncementAutoplay() {
            if (announcementAutoplayTimer) return;
            if (announcements.length <= 1) return;

            announcementAutoplayTimer = setInterval(() => {
                currentAnnouncementIndex++;
                updateAnnouncementDisplay();
            }, ANNOUNCEMENT_AUTOPLAY_INTERVAL);
        }

        // é‡å•Ÿè‡ªå‹•æ’­æ”¾
        function restartAnnouncementAutoplay() {
            if (announcementAutoplayTimer) {
                clearInterval(announcementAutoplayTimer);
                announcementAutoplayTimer = null;
            }
            startAnnouncementAutoplay();
        }

        // åœæ­¢è‡ªå‹•æ’­æ”¾
        function stopAnnouncementAutoplay() {
            if (announcementAutoplayTimer) {
                clearInterval(announcementAutoplayTimer);
                announcementAutoplayTimer = null;
            }
        }

        // éš±è—å…¬å‘Š
        function hideAnnouncement() {
            const bar = document.getElementById('announcementBar');
            if (bar) {
                bar.classList.add('hidden');
            }
            stopAnnouncementAutoplay();
            adjustNavPosition();
        }

        // ç¶å®šå…¬å‘Šæ¬„æŒ‰éˆ•
        function initAnnouncementCloseButton() {
            const prevBtn = document.getElementById('prevAnnouncementBtn');
            const nextBtn = document.getElementById('nextAnnouncementBtn');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    prevAnnouncement();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    nextAnnouncement();
                });
            }
        }

        // èª¿æ•´å°èˆªæ¬„ä½ç½®ï¼ˆç•¶å…¬å‘Šæ¬„é¡¯ç¤ºæ™‚ï¼‰
        function adjustNavPosition() {
            const announcementBar = document.getElementById('announcementBar');
            const nav = document.querySelector('nav');

            if (announcementBar && nav) {
                if (!announcementBar.classList.contains('hidden')) {
                    const barHeight = announcementBar.offsetHeight;
                    nav.style.top = barHeight + 'px';
                } else {
                    nav.style.top = '0';
                }
            }
        }

        // ========================================
        // ç¶²ç«™åœç”¨åŠŸèƒ½
        // ========================================

        let isWebsiteDisabled = false;

        // æª¢æŸ¥ç¶²ç«™æ˜¯å¦åœç”¨
        async function checkWebsiteStatus() {
            try {
                const doc = await db.collection('settings').doc('website').get();
                if (doc.exists) {
                    const data = doc.data();
                    isWebsiteDisabled = data.disabled === true;
                    console.log('[ç¶²ç«™ç‹€æ…‹] åœç”¨ç‹€æ…‹:', isWebsiteDisabled);
                    return isWebsiteDisabled;
                }
                return false;
            } catch (error) {
                console.error('æª¢æŸ¥ç¶²ç«™ç‹€æ…‹å¤±æ•—:', error);
                return false;
            }
        }

        // é¡¯ç¤ºç¶²ç«™åœç”¨é é¢
        function showDisabledPage() {
            const disabledPage = document.createElement('div');
            disabledPage.id = 'disabledPage';
            disabledPage.className = 'fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 z-[9998] flex items-center justify-center';

            const texts = {
                'zh-TW': {
                    title: 'ç¶²ç«™æš«æ™‚åœç”¨',
                    message: 'ç¶²ç«™ç›®å‰æ­£åœ¨ç¶­è­·ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
                    hint: 'å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚',
                    adminLogin: 'ç®¡ç†å“¡ç™»å…¥',
                    adminHint: 'ç®¡ç†å“¡å¯ç›´æ¥é€²å…¥'
                },
                'zh-CN': {
                    title: 'ç½‘ç«™æš‚æ—¶åœç”¨',
                    message: 'ç½‘ç«™ç›®å‰æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•ã€‚',
                    hint: 'å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚',
                    adminLogin: 'ç®¡ç†å‘˜ç™»å½•',
                    adminHint: 'ç®¡ç†å‘˜å¯ç›´æ¥è¿›å…¥'
                },
                'en': {
                    title: 'Website Temporarily Disabled',
                    message: 'The website is currently under maintenance. Please try again later.',
                    hint: 'If you have any questions, please contact the administrator.',
                    adminLogin: 'Admin Login',
                    adminHint: 'Admins can enter directly'
                }
            };

            const lang = texts[i18n.currentLang] || texts['zh-TW'];

            disabledPage.innerHTML = `
                <div class="text-center text-white p-8 max-w-lg">
                    <div class="mb-8">
                        <i class="fas fa-tools text-6xl mb-4 text-yellow-400 animate-pulse"></i>
                        <h1 class="text-3xl font-bold mb-4">${lang.title}</h1>
                        <p class="text-lg opacity-80 mb-2">${lang.message}</p>
                        <p class="text-sm opacity-60">${lang.hint}</p>
                    </div>
                    <div class="border-t border-white/20 pt-6">
                        <button id="disabledAdminLoginBtn" class="px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 mx-auto">
                            <i class="fas fa-user-shield"></i>
                            <span>${lang.adminLogin}</span>
                        </button>
                        <p class="text-xs opacity-50 mt-2">${lang.adminHint}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(disabledPage);

            // ç¶å®šç®¡ç†å“¡ç™»å…¥æŒ‰éˆ•
            document.getElementById('disabledAdminLoginBtn').addEventListener('click', () => {
                showLoginModal();
            });
        }

        // éš±è—ç¶²ç«™åœç”¨é é¢
        function hideDisabledPage() {
            const disabledPage = document.getElementById('disabledPage');
            if (disabledPage) {
                disabledPage.style.display = 'none';
            }
        }

        // ========================================

        // æ›´æ–°è¨ªå®¢æ’éšŠç‹€æ…‹
        async function updateVisitorQueueStatus(inQueue) {
            if (!visitorId) return;
            try {
                await db.collection('visitors').doc(visitorId).update({
                    inQueue: inQueue,
                    queueEnteredAt: inQueue ? firebase.firestore.FieldValue.serverTimestamp() : null
                });
            } catch (error) {
                console.error('æ›´æ–°æ’éšŠç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // ç²å–å‰æ–¹ç­‰å¾…äººæ•¸ï¼ˆæ¯”æˆ‘æ—©é€²å…¥æ’éšŠä¸”ä»åœ¨æ’éšŠçš„äººæ•¸ï¼‰
        async function getQueuePosition() {
            if (!visitorId) return 0;

            try {
                // ä½¿ç”¨ç•¶å‰è¨ªå®¢é€²å…¥ç¶²ç«™çš„æ™‚é–“ä½œç‚ºæ¯”è¼ƒåŸºæº–
                const myTimeMs = visitorQueueTime || Date.now();

                // ç²å–æ‰€æœ‰æ­£åœ¨æ’éšŠçš„è¨ªå®¢ï¼ˆinQueue = true è¡¨ç¤ºåœ¨æ’éšŠä¸­ï¼‰
                const snapshot = await db.collection('visitors')
                    .where('inQueue', '==', true)
                    .where('active', '==', true)
                    .get();

                // è¨ˆç®—æ¯”æˆ‘æ—©é€²å…¥æ’éšŠçš„äººæ•¸
                let aheadCount = 0;
                let totalInQueue = 0;

                snapshot.forEach(doc => {
                    if (doc.id === visitorId) return; // è·³éè‡ªå·±

                    const data = doc.data();

                    // ç¢ºèªå¿ƒè·³é‚„æœ‰æ•ˆï¼ˆ2åˆ†é˜å…§ï¼‰
                    if (data.lastHeartbeat && data.lastHeartbeat.toDate) {
                        const heartbeatTime = data.lastHeartbeat.toDate().getTime();
                        if (heartbeatTime > Date.now() - 120000) {
                            totalInQueue++;

                            // å–å¾—å°æ–¹é€²å…¥ç¶²ç«™çš„æ™‚é–“
                            const theirEnteredAt = data.enteredAt;
                            if (theirEnteredAt && theirEnteredAt.toDate) {
                                const theirTimeMs = theirEnteredAt.toDate().getTime();
                                // æ¯”æˆ‘æ—©é€²å…¥çš„äºº
                                if (theirTimeMs < myTimeMs) {
                                    aheadCount++;
                                }
                            }
                        }
                    }
                });

                console.log('[æ’éšŠç³»çµ±] æˆ‘çš„é€²å…¥æ™‚é–“:', new Date(myTimeMs).toLocaleTimeString());
                console.log('[æ’éšŠç³»çµ±] ç¸½æ’éšŠäººæ•¸:', totalInQueue);
                console.log('[æ’éšŠç³»çµ±] å‰æ–¹ç­‰å¾…äººæ•¸:', aheadCount);
                return aheadCount;
            } catch (error) {
                console.error('ç²å–æ’éšŠä½ç½®å¤±æ•—:', error);
                return 0;
            }
        }

        // è¨ªå®¢å¿ƒè·³
        function startVisitorHeartbeat() {
            if (visitorHeartbeatTimer) {
                clearInterval(visitorHeartbeatTimer);
            }

            visitorHeartbeatTimer = setInterval(async () => {
                if (visitorId) {
                    try {
                        await db.collection('visitors').doc(visitorId).update({
                            lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (error) {
                        console.error('æ›´æ–°è¨ªå®¢å¿ƒè·³å¤±æ•—:', error);
                    }
                }
            }, SESSION_CONFIG.visitorHeartbeatInterval);
        }

        // åœæ­¢è¨ªå®¢å¿ƒè·³
        function stopVisitorHeartbeat() {
            if (visitorHeartbeatTimer) {
                clearInterval(visitorHeartbeatTimer);
                visitorHeartbeatTimer = null;
            }
        }

        // è¨ªå®¢æ´»å‹•ç›£æ§ - è¿½è¹¤è¨ªå®¢æ´»å‹•ä¸¦åœ¨ç„¡æ´»å‹•æ™‚è¸¢å‡º
        let visitorActivityThrottle = null;

        function updateVisitorActivity() {
            // ç¯€æµï¼šæ¯5ç§’æœ€å¤šæ›´æ–°ä¸€æ¬¡
            if (visitorActivityThrottle) return;
            visitorActivityThrottle = setTimeout(() => {
                visitorActivityThrottle = null;
            }, 5000);

            visitorLastActivity = Date.now();

            // éš±è—å€’æ•¸è¨ˆæ™‚å™¨ï¼ˆå¦‚æœæ­£åœ¨é¡¯ç¤ºï¼‰
            hideVisitorCountdown();

            // æ›´æ–° Firestore ä¸­çš„æ´»å‹•æ™‚é–“
            if (visitorId) {
                db.collection('visitors').doc(visitorId).update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => console.error('æ›´æ–°è¨ªå®¢æ´»å‹•æ™‚é–“å¤±æ•—:', err));
            }
        }

        function startVisitorActivityMonitoring() {
            // ç›£è½ç”¨æˆ¶æ´»å‹•äº‹ä»¶
            const activityEvents = ['click', 'scroll', 'keydown', 'touchstart'];
            activityEvents.forEach(event => {
                document.addEventListener(event, updateVisitorActivity, { passive: true });
            });

            // å®šæœŸæª¢æŸ¥è¨ªå®¢æ˜¯å¦è¶…æ™‚ï¼ˆæ¯10ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
            visitorActivityTimer = setInterval(() => {
                checkVisitorInactivity();
            }, 10000); // æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡

            console.log('âœ“ è¨ªå®¢æ´»å‹•ç›£æ§å·²å•Ÿå‹•ï¼Œè¶…æ™‚æ™‚é–“:', SESSION_CONFIG.visitorInactivityTimeout / 1000 / 60, 'åˆ†é˜');
        }

        function stopVisitorActivityMonitoring() {
            if (visitorActivityTimer) {
                clearInterval(visitorActivityTimer);
                visitorActivityTimer = null;
            }

            // ç§»é™¤äº‹ä»¶ç›£è½
            const activityEvents = ['click', 'scroll', 'keydown', 'touchstart'];
            activityEvents.forEach(event => {
                document.removeEventListener(event, updateVisitorActivity);
            });

            // éš±è—å€’æ•¸è¨ˆæ™‚å™¨
            hideVisitorCountdown();
        }

        // è¨ªå®¢å€’æ•¸è¨ˆæ™‚å™¨
        let visitorCountdownTimer = null;
        let visitorCountdownElement = null;

        function showVisitorCountdown(remainingMs) {
            if (!visitorCountdownElement) {
                visitorCountdownElement = document.createElement('div');
                visitorCountdownElement.id = 'visitorCountdown';
                visitorCountdownElement.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-orange-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] flex items-center space-x-3';

                const texts = {
                    'zh-TW': { label: 'é€£ç·šå°‡æ–¼', suffix: 'å¾Œä¸­æ–·', hint: 'ç§»å‹•æ»‘é¼ æˆ–é»æ“Šä»»æ„ä½ç½®ä»¥ä¿æŒé€£ç·š' },
                    'zh-CN': { label: 'è¿çº¿å°†äº', suffix: 'åä¸­æ–­', hint: 'ç§»åŠ¨é¼ æ ‡æˆ–ç‚¹å‡»ä»»æ„ä½ç½®ä»¥ä¿æŒè¿çº¿' },
                    'en': { label: 'Connection will end in', suffix: '', hint: 'Move mouse or click anywhere to stay connected' }
                };
                const lang = texts[i18n.currentLang] || texts['zh-TW'];

                visitorCountdownElement.innerHTML = `
                    <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-semibold"><span id="visitorCountdownLabel">${lang.label}</span> <span id="visitorCountdownTime" class="text-yellow-300 font-bold"></span> <span id="visitorCountdownSuffix">${lang.suffix}</span></p>
                        <p class="text-xs opacity-80" id="visitorCountdownHint">${lang.hint}</p>
                    </div>
                `;
                document.body.appendChild(visitorCountdownElement);
            }

            const totalSeconds = Math.ceil(remainingMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const timeString = minutes > 0
                ? `${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`
                : `${seconds}ç§’`;

            document.getElementById('visitorCountdownTime').textContent = timeString;
            visitorCountdownElement.style.display = 'flex';
        }

        function hideVisitorCountdown() {
            if (visitorCountdownElement) {
                visitorCountdownElement.style.display = 'none';
            }
            if (visitorCountdownTimer) {
                clearInterval(visitorCountdownTimer);
                visitorCountdownTimer = null;
            }
        }

        function startVisitorCountdown() {
            if (visitorCountdownTimer) return;
            visitorCountdownTimer = setInterval(() => {
                const elapsed = Date.now() - visitorLastActivity;
                const remaining = Math.max(0, SESSION_CONFIG.visitorInactivityTimeout - elapsed);
                const warningThreshold = 5 * 60 * 1000; // 5åˆ†é˜

                if (remaining > 0 && remaining <= warningThreshold) {
                    showVisitorCountdown(remaining);
                } else {
                    hideVisitorCountdown();
                }
            }, 1000); // æ¯ç§’æ›´æ–°å€’æ•¸
        }

        function checkVisitorInactivity() {
            const elapsed = Date.now() - visitorLastActivity;
            const remaining = SESSION_CONFIG.visitorInactivityTimeout - elapsed;
            const warningThreshold = 5 * 60 * 1000; // 5åˆ†é˜

            // å‰©é¤˜5åˆ†é˜æ™‚é–‹å§‹å€’æ•¸
            if (remaining <= warningThreshold && remaining > 0) {
                startVisitorCountdown();
            }

            // è¶…æ™‚è¸¢å‡º
            if (elapsed >= SESSION_CONFIG.visitorInactivityTimeout) {
                console.log('[è¨ªå®¢ç›£æ§] è¨ªå®¢ç„¡æ´»å‹•è¶…æ™‚ï¼ŒåŸ·è¡Œè¸¢å‡º');
                hideVisitorCountdown();
                kickOutInactiveVisitor();
            }
        }

        async function kickOutInactiveVisitor() {
            // åœæ­¢æ‰€æœ‰ç›£æ§
            stopVisitorHeartbeat();
            stopVisitorActivityMonitoring();

            // æ›´æ–° Firestore ç‹€æ…‹
            if (visitorId) {
                try {
                    await db.collection('visitors').doc(visitorId).update({
                        active: false,
                        kickedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        kickReason: 'inactivity'
                    });
                } catch (error) {
                    console.error('è¸¢å‡ºè¨ªå®¢å¤±æ•—:', error);
                }
            }

            // é¡¯ç¤ºè¢«è¸¢å‡ºé é¢
            showKickedOutPage();
        }

        function showKickedOutPage() {
            // å»ºç«‹è¸¢å‡ºé é¢
            const kickedPage = document.createElement('div');
            kickedPage.id = 'kickedOutPage';
            kickedPage.className = 'fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 z-[9999] flex items-center justify-center';

            const texts = {
                'zh-TW': {
                    title: 'é€£ç·šå·²ä¸­æ–·',
                    message: 'ç”±æ–¼é•·æ™‚é–“æ²’æœ‰æ´»å‹•ï¼Œæ‚¨çš„é€£ç·šå·²è¢«ä¸­æ–·ã€‚',
                    hint: 'è«‹é‡æ–°æ•´ç†é é¢ä»¥ç¹¼çºŒç€è¦½ã€‚',
                    button: 'é‡æ–°æ•´ç†'
                },
                'zh-CN': {
                    title: 'è¿çº¿å·²ä¸­æ–­',
                    message: 'ç”±äºé•¿æ—¶é—´æ²¡æœ‰æ´»åŠ¨ï¼Œæ‚¨çš„è¿çº¿å·²è¢«ä¸­æ–­ã€‚',
                    hint: 'è¯·åˆ·æ–°é¡µé¢ä»¥ç»§ç»­æµè§ˆã€‚',
                    button: 'åˆ·æ–°é¡µé¢'
                },
                'en': {
                    title: 'Connection Terminated',
                    message: 'Your connection has been terminated due to inactivity.',
                    hint: 'Please refresh the page to continue browsing.',
                    button: 'Refresh Page'
                }
            };

            const lang = texts[i18n.currentLang] || texts['zh-TW'];

            kickedPage.innerHTML = `
                <div class="text-center text-white p-8 max-w-lg">
                    <div class="mb-8">
                        <i class="fas fa-plug text-6xl mb-4 text-gray-400"></i>
                        <h1 class="text-3xl font-bold mb-4">${lang.title}</h1>
                        <p class="text-lg opacity-80 mb-2">${lang.message}</p>
                        <p class="text-sm opacity-60">${lang.hint}</p>
                    </div>
                    <button onclick="location.reload()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all duration-200 font-semibold">
                        <i class="fas fa-sync-alt mr-2"></i>
                        ${lang.button}
                    </button>
                </div>
            `;

            document.body.appendChild(kickedPage);
        }

        // è¨ªå®¢é›¢é–‹
        async function unregisterVisitor() {
            if (!visitorId) return;

            try {
                await db.collection('visitors').doc(visitorId).update({
                    active: false,
                    leftAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('âœ“ è¨ªå®¢å·²é›¢é–‹:', visitorId);
            } catch (error) {
                console.error('è¨ªå®¢é›¢é–‹è¨˜éŒ„å¤±æ•—:', error);
            }

            stopVisitorHeartbeat();
            stopVisitorActivityMonitoring();
            visitorId = null;
        }

        // ç²å–ç•¶å‰åœ¨ç·šè¨ªå®¢æ•¸
        async function getOnlineVisitorCount() {
            try {
                // è¨ˆç®—2åˆ†é˜å…§æœ‰å¿ƒè·³çš„è¨ªå®¢ç‚ºåœ¨ç·šï¼ˆä½¿ç”¨ Firestore Timestampï¼‰
                const twoMinutesAgo = firebase.firestore.Timestamp.fromDate(new Date(Date.now() - 120000));
                const snapshot = await db.collection('visitors')
                    .where('active', '==', true)
                    .where('lastHeartbeat', '>', twoMinutesAgo)
                    .get();

                console.log('[æ’éšŠç³»çµ±] åœ¨ç·šè¨ªå®¢æ•¸:', snapshot.size);
                return snapshot.size;
            } catch (error) {
                console.error('ç²å–åœ¨ç·šè¨ªå®¢æ•¸å¤±æ•—:', error);
                // å¦‚æœæŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½å› ç‚ºç¼ºå°‘ç´¢å¼•ï¼‰ï¼Œå˜—è©¦ç°¡åŒ–æŸ¥è©¢
                try {
                    const simpleSnapshot = await db.collection('visitors')
                        .where('active', '==', true)
                        .get();

                    // æ‰‹å‹•éæ¿¾å¿ƒè·³æ™‚é–“
                    const twoMinutesAgoMs = Date.now() - 120000;
                    let activeCount = 0;
                    simpleSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.lastHeartbeat && data.lastHeartbeat.toDate) {
                            const heartbeatTime = data.lastHeartbeat.toDate().getTime();
                            if (heartbeatTime > twoMinutesAgoMs) {
                                activeCount++;
                            }
                        }
                    });
                    console.log('[æ’éšŠç³»çµ±] åœ¨ç·šè¨ªå®¢æ•¸ï¼ˆå‚™ç”¨æ–¹æ³•ï¼‰:', activeCount);
                    return activeCount;
                } catch (fallbackError) {
                    console.error('å‚™ç”¨æŸ¥è©¢ä¹Ÿå¤±æ•—:', fallbackError);
                    return 0;
                }
            }
        }

        // ç²å–è¨ªå®¢é™åˆ¶è¨­å®š
        async function getVisitorLimit() {
            try {
                const settingsDoc = await db.collection('settings').doc('visitor').get();
                if (settingsDoc.exists) {
                    const maxVisitors = settingsDoc.data().maxVisitors || 0;
                    console.log('[æ’éšŠç³»çµ±] è¨ªå®¢é™åˆ¶:', maxVisitors);
                    return maxVisitors; // 0 è¡¨ç¤ºç„¡é™åˆ¶
                }
                console.log('[æ’éšŠç³»çµ±] ç„¡è¨ªå®¢è¨­å®šï¼Œé è¨­ç„¡é™åˆ¶');
                return 0;
            } catch (error) {
                console.error('ç²å–è¨ªå®¢é™åˆ¶å¤±æ•—:', error);
                return 0;
            }
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ’éšŠ
        async function checkQueue() {
            console.log('[æ’éšŠç³»çµ±] é–‹å§‹æª¢æŸ¥æ’éšŠ...');
            const limit = await getVisitorLimit();

            if (limit === 0) {
                // ç„¡é™åˆ¶
                console.log('[æ’éšŠç³»çµ±] è¨ªå®¢é™åˆ¶ç‚º 0ï¼Œç„¡éœ€æ’éšŠ');
                await updateVisitorQueueStatus(false);
                hideQueuePage();
                return false;
            }

            const currentCount = await getOnlineVisitorCount();
            console.log('[æ’éšŠç³»çµ±] ç•¶å‰è¨ªå®¢:', currentCount, '/ é™åˆ¶:', limit);

            // ä½¿ç”¨ > è€Œé >=ï¼Œå› ç‚ºç•¶å‰è¨ªå®¢å·²è¢«è¨ˆå…¥ currentCount
            // è¨­å®šé™åˆ¶ç‚º 1 æ™‚ï¼Œç¬¬ 1 å€‹è¨ªå®¢å¯é€²å…¥ï¼Œç¬¬ 2 å€‹é–‹å§‹æ’éšŠ
            if (currentCount > limit) {
                console.log('[æ’éšŠç³»çµ±] éœ€è¦æ’éšŠï¼é¡¯ç¤ºæ’éšŠé é¢');
                await updateVisitorQueueStatus(true);
                const aheadCount = await getQueuePosition();
                showQueuePage(currentCount, limit, aheadCount);
                return true;
            } else {
                console.log('[æ’éšŠç³»çµ±] ç„¡éœ€æ’éšŠï¼Œæ­£å¸¸é€²å…¥');
                await updateVisitorQueueStatus(false);
                hideQueuePage();
                return false;
            }
        }

        // é¡¯ç¤ºæ’éšŠé é¢
        async function showQueuePage(currentCount, limit, aheadCount = 0) {
            isInQueue = true;

            // è¼‰å…¥è‡ªå®šç¾©æ’éšŠè¨­ç½®
            let customMessage = '';
            let customImageUrl = '';
            let waitTimePerPerson = 2;

            try {
                const queueSettingsDoc = await db.collection('settings').doc('queue').get();
                if (queueSettingsDoc.exists) {
                    const settings = queueSettingsDoc.data();
                    customMessage = settings.customMessage || '';
                    customImageUrl = settings.imageUrl || '';
                    waitTimePerPerson = settings.waitTimePerPerson || 2;
                }
            } catch (e) {
                console.error('è¼‰å…¥æ’éšŠè¨­ç½®å¤±æ•—:', e);
            }

            const estimatedWaitTime = aheadCount * waitTimePerPerson;

            let queuePage = document.getElementById('queuePage');
            if (!queuePage) {
                queuePage = document.createElement('div');
                queuePage.id = 'queuePage';
                queuePage.className = 'fixed inset-0 bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 z-[9999] flex items-center justify-center';
                queuePage.innerHTML = `
                    <div class="text-center text-white p-8 max-w-lg">
                        ${customImageUrl ? `<div class="mb-6"><img src="${customImageUrl}" alt="Queue" class="max-h-32 mx-auto rounded-lg shadow-lg"></div>` : ''}
                        <div class="mb-8">
                            <i class="fas fa-users text-6xl mb-4 animate-pulse"></i>
                            <h1 class="text-3xl font-bold mb-4" id="queueTitle">ç¶²ç«™è¨ªå®¢å·²æ»¿</h1>
                            <p class="text-lg opacity-80 mb-4" id="queueMessage">
                                ç›®å‰è¨ªå•äººæ•¸å·²é”ä¸Šé™ï¼Œè«‹ç¨å€™...
                            </p>
                            ${customMessage ? `<p class="text-base opacity-90 bg-white/10 rounded-lg p-3 mb-4" id="queueCustomMessage">${customMessage}</p>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-sm opacity-70 mb-1" id="queueStatusLabel">ç›®å‰ç‹€æ…‹</p>
                                <p class="text-2xl font-bold">
                                    <span id="queueCurrentCount">${currentCount}</span> / <span id="queueLimit">${limit}</span>
                                </p>
                                <p class="text-sm opacity-70 mt-1" id="queueWaitingLabel">è¨ªå®¢æ•¸é‡</p>
                            </div>
                            <div class="bg-yellow-500/20 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-sm opacity-70 mb-1" id="queueAheadLabel">æ‚¨çš„æ’éšŠä½ç½®</p>
                                <p class="text-2xl font-bold text-yellow-300">
                                    <span id="queueAheadCount">${aheadCount}</span> <span class="text-base opacity-80" id="queueAheadUnit">äººåœ¨å‰é¢</span>
                                </p>
                                <p class="text-sm opacity-70 mt-1" id="queuePositionHint">è¼ªåˆ°æ‚¨æ™‚è‡ªå‹•é€²å…¥</p>
                            </div>
                        </div>
                        <div class="bg-green-500/20 backdrop-blur-sm rounded-xl p-3 mb-4">
                            <p class="text-sm opacity-70" id="queueEstimatedLabel">é è¨ˆç­‰å¾…æ™‚é–“</p>
                            <p class="text-xl font-bold text-green-300">
                                <span id="queueEstimatedTime">${estimatedWaitTime}</span> <span id="queueEstimatedUnit">åˆ†é˜</span>
                            </p>
                        </div>
                        <div class="flex items-center justify-center space-x-2 text-sm opacity-70 mb-6">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            <span id="queueWaitText">ç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨åˆ·æ–°...</span>
                        </div>
                        <div class="border-t border-white/20 pt-6">
                            <button id="queueAdminLoginBtn" class="px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 mx-auto">
                                <i class="fas fa-user-shield"></i>
                                <span id="queueAdminLoginText">ç®¡ç†å“¡ç™»å…¥</span>
                            </button>
                            <p class="text-xs opacity-50 mt-2" id="queueAdminHint">ç®¡ç†å“¡å¯è·³éæ’éšŠ</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(queuePage);

                // ç¶å®šç®¡ç†å“¡ç™»å…¥æŒ‰éˆ•
                document.getElementById('queueAdminLoginBtn').addEventListener('click', () => {
                    showLoginModal();
                });
            } else {
                document.getElementById('queueCurrentCount').textContent = currentCount;
                document.getElementById('queueLimit').textContent = limit;
                document.getElementById('queueAheadCount').textContent = aheadCount;
                const estimatedTimeEl = document.getElementById('queueEstimatedTime');
                if (estimatedTimeEl) estimatedTimeEl.textContent = estimatedWaitTime;
                queuePage.style.display = 'flex';
            }

            // æ›´æ–°å¤šèªè¨€æ–‡å­—
            const texts = {
                'zh-TW': {
                    title: 'ç¶²ç«™è¨ªå®¢å·²æ»¿',
                    message: 'ç›®å‰è¨ªå•äººæ•¸å·²é”ä¸Šé™ï¼Œè«‹ç¨å€™...',
                    statusLabel: 'ç›®å‰ç‹€æ…‹',
                    waitingLabel: 'è¨ªå®¢æ•¸é‡',
                    aheadLabel: 'æ‚¨çš„æ’éšŠä½ç½®',
                    aheadUnit: 'äººåœ¨å‰é¢',
                    positionHint: 'è¼ªåˆ°æ‚¨æ™‚è‡ªå‹•é€²å…¥',
                    waitText: 'ç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨åˆ·æ–°...',
                    adminLogin: 'ç®¡ç†å“¡ç™»å…¥',
                    adminHint: 'ç®¡ç†å“¡å¯è·³éæ’éšŠ'
                },
                'zh-CN': {
                    title: 'ç½‘ç«™è®¿å®¢å·²æ»¡',
                    message: 'ç›®å‰è®¿é—®äººæ•°å·²è¾¾ä¸Šé™ï¼Œè¯·ç¨å€™...',
                    statusLabel: 'ç›®å‰çŠ¶æ€',
                    waitingLabel: 'è®¿å®¢æ•°é‡',
                    aheadLabel: 'æ‚¨çš„æ’é˜Ÿä½ç½®',
                    aheadUnit: 'äººåœ¨å‰é¢',
                    positionHint: 'è½®åˆ°æ‚¨æ—¶è‡ªåŠ¨è¿›å…¥',
                    waitText: 'ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ‚¨åˆ·æ–°...',
                    adminLogin: 'ç®¡ç†å‘˜ç™»å½•',
                    adminHint: 'ç®¡ç†å‘˜å¯è·³è¿‡æ’é˜Ÿ'
                },
                'en': {
                    title: 'Website at Full Capacity',
                    message: 'The maximum number of visitors has been reached. Please wait...',
                    statusLabel: 'Current Status',
                    waitingLabel: 'Visitor Count',
                    aheadLabel: 'Your Queue Position',
                    aheadUnit: 'ahead',
                    positionHint: 'Auto-enter when ready',
                    waitText: 'The system will automatically refresh for you...',
                    adminLogin: 'Admin Login',
                    adminHint: 'Admins can skip the queue'
                }
            };

            const lang = texts[i18n.currentLang] || texts['zh-TW'];
            document.getElementById('queueTitle').textContent = lang.title;
            document.getElementById('queueMessage').textContent = lang.message;
            document.getElementById('queueStatusLabel').textContent = lang.statusLabel;
            document.getElementById('queueWaitingLabel').textContent = lang.waitingLabel;
            document.getElementById('queueAheadLabel').textContent = lang.aheadLabel;
            document.getElementById('queueAheadUnit').textContent = lang.aheadUnit;
            document.getElementById('queuePositionHint').textContent = lang.positionHint;
            document.getElementById('queueWaitText').textContent = lang.waitText;
            document.getElementById('queueAdminLoginText').textContent = lang.adminLogin;
            document.getElementById('queueAdminHint').textContent = lang.adminHint;

            // æ¯10ç§’é‡æ–°æª¢æŸ¥
            setTimeout(async () => {
                if (isInQueue) {
                    await checkQueue();
                }
            }, 10000);
        }

        // éš±è—æ’éšŠé é¢
        function hideQueuePage() {
            const wasInQueue = isInQueue;
            isInQueue = false;
            const queuePage = document.getElementById('queuePage');
            if (queuePage) {
                queuePage.style.display = 'none';
            }
            // å¦‚æœä¹‹å‰åœ¨æ’éšŠï¼Œç¾åœ¨å¯ä»¥é€²å…¥äº†ï¼Œé¡¯ç¤ºæç¤º
            if (wasInQueue) {
                showToast('æ’éšŠå®Œæˆï¼Œæ­¡è¿é€²å…¥ç¶²ç«™ï¼');
                console.log('[æ’éšŠç³»çµ±] æ’éšŠå®Œæˆï¼Œå·²é€²å…¥ç¶²ç«™');
            }
        }

        // é é¢å¸è¼‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', () => {
            unregisterVisitor();
            if (currentSessionId) {
                // ä½¿ç”¨ sendBeacon ç¢ºä¿è³‡æ–™èƒ½ç™¼é€
                navigator.sendBeacon && navigator.sendBeacon('/api/cleanup', JSON.stringify({
                    sessionId: currentSessionId,
                    visitorId
                }));
            }
        });

        // ========================================
        // I18N ç®¡ç†å™¨
        // ========================================

        // ä½¿ç”¨ translations.js ä¸­å·²ç¶“å‰µå»ºçš„ i18n å¯¦ä¾‹
        const i18n = window.i18n;

        // ========================================
        // ä¸»é¡Œç®¡ç†
        // ========================================

        // ä½¿ç”¨å…§å­˜è®Šé‡ä»£æ›¿ localStorage
        let savedTheme = null;

        function initTheme() {
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (!savedTheme) {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            });
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            savedTheme = isDark ? 'dark' : 'light';
        }

        // ========================================
        // UI è¼”åŠ©å‡½æ•¸
        // ========================================

        function showLoading(message = null) {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (message) {
                text.textContent = message;
            } else {
                text.textContent = i18n.t('messages.loading');
            }
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('active');

            setTimeout(() => {
                toast.classList.remove('active');
            }, duration);
        }

        function showLoginModal() {
            closeRegisterModal();
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginForm').reset();
        }

        function showRegisterModal() {
            closeLoginModal();
            document.getElementById('registerModal').classList.add('active');
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
        }

        function showVerificationModal() {
            document.getElementById('verificationModal').classList.add('active');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.remove('active');
            document.getElementById('verificationForm').reset();
        }

        function showForgotPassword() {
            closeLoginModal();
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            document.getElementById('forgotPasswordStep2').style.display = 'none';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('forgotPasswordForm').reset();
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            document.getElementById('forgotPasswordStep2').style.display = 'none';
        }

        function showForgotUsername() {
            closeLoginModal();
            document.getElementById('forgotUsernameModal').classList.add('active');
            document.getElementById('forgotUsernameStep1').style.display = 'block';
            document.getElementById('forgotUsernameStep2').style.display = 'none';
            document.getElementById('forgotUsernameStep3').style.display = 'none';
        }

        function closeForgotUsernameModal() {
            document.getElementById('forgotUsernameModal').classList.remove('active');
            document.getElementById('forgotUsernameForm').reset();
            document.getElementById('verifyUsernameForm').reset();
            document.getElementById('forgotUsernameStep1').style.display = 'block';
            document.getElementById('forgotUsernameStep2').style.display = 'none';
            document.getElementById('forgotUsernameStep3').style.display = 'none';
        }

        function showSetUsernameModal() {
            const modal = document.getElementById('setUsernameModal');
            modal.style.display = 'flex';
            modal.classList.add('active');
        }

        function closeSetUsernameModal() {
            const modal = document.getElementById('setUsernameModal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            document.getElementById('setUsernameForm').reset();
        }

        // ========================================
        // é©—è­‰ç¢¼ç®¡ç†
        // ========================================

        let currentVerificationData = null;

        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function sendVerificationEmail(email, code, purpose = 'register') {
            try {
                const lang = i18n.currentLang === 'zh-CN' ? 'zh-TW' : i18n.currentLang;
                const templateId = emailJSConfig.templates[lang];

                const templateParams = {
                    to_email: email,
                    user_name: email.split('@')[0],
                    verification_code: code,
                    site_name: i18n.t('nav.title')
                };

                await emailjs.send(
                    emailJSConfig.serviceId,
                    templateId,
                    templateParams
                );

                currentVerificationData = {
                    email,
                    code,
                    purpose,
                    timestamp: Date.now(),
                    expiresIn: 10 * 60 * 1000
                };

                return true;
            } catch (error) {
                console.error('Error sending verification email:', error);
                return false;
            }
        }

        function verifyCode(inputCode) {
            if (!currentVerificationData) {
                console.error('No verification data found');
                return false;
            }

            const now = Date.now();
            const elapsed = now - currentVerificationData.timestamp;

            console.log('Verification check:', {
                inputCode: inputCode,
                storedCode: currentVerificationData.code,
                elapsed: elapsed,
                expiresIn: currentVerificationData.expiresIn,
                expired: elapsed > currentVerificationData.expiresIn
            });

            // æª¢æŸ¥æ˜¯å¦éæœŸ
            if (elapsed > currentVerificationData.expiresIn) {
                console.error('Verification code expired');
                showToast(i18n.t('messages.verificationError'));
                return false;
            }

            // æ¸…ç†è¼¸å…¥ï¼šç§»é™¤ç©ºæ ¼ä¸¦è½‰æ›ç‚ºå­—ç¬¦ä¸²
            const cleanInput = String(inputCode).trim();
            const cleanStored = String(currentVerificationData.code).trim();

            console.log('Comparing codes:', {
                cleanInput: cleanInput,
                cleanStored: cleanStored,
                match: cleanInput === cleanStored
            });

            return cleanInput === cleanStored;
        }

        // ========================================
        // èº«ä»½é©—è­‰
        // ========================================

        let currentUser = null;
        let isCurrentUserAdmin = false;

        // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºå·²ç™»å…¥çš„ç®¡ç†å“¡
        async function checkIfLoggedInAdmin() {
            return new Promise((resolve) => {
                // ç­‰å¾… auth ç‹€æ…‹ç¢ºå®š
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    unsubscribe(); // åªéœ€è¦ä¸€æ¬¡æª¢æŸ¥

                    if (user) {
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                const isAdmin = userData.role === 'admin' || userData.role === 'superadmin' || user.uid === SUPER_ADMIN_UID;
                                isCurrentUserAdmin = isAdmin;
                                resolve(isAdmin);
                            } else {
                                resolve(false);
                            }
                        } catch (error) {
                            console.error('æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—:', error);
                            resolve(false);
                        }
                    } else {
                        resolve(false);
                    }
                });
            });
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();

                    if (userData.status === 'pending') {
                        showToast('æ‚¨çš„å¸³è™Ÿæ­£åœ¨ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸');
                        auth.signOut();
                        return;
                    } else if (userData.status === 'rejected') {
                        showToast('æ‚¨çš„å¸³è™Ÿå·²è¢«æ‹’çµ•');
                        auth.signOut();
                        return;
                    }

                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userMenu').style.display = 'block';
                    document.getElementById('userDisplayName').textContent = userData.name || user.email;

                    // å¦‚æœç”¨æˆ¶å·²ç™»å…¥ä½†æ²’æœ‰æœƒè©±ï¼Œå‰µå»ºæœƒè©±ä¸¦å•Ÿå‹•æ´»å‹•ç›£æ§
                    if (!currentSessionId) {
                        console.log('[è‡ªå‹•ç™»å‡ºæ¸¬è©¦] åµæ¸¬åˆ°å·²ç™»å…¥ç”¨æˆ¶ï¼Œå•Ÿå‹•æ´»å‹•ç›£æ§');
                        await createSession(user.uid);
                        listenToSessionChanges(user.uid);
                    }

                    // æª¢æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å“¡
                    const isAdmin = userData.role === 'admin' || userData.role === 'superadmin' || user.uid === SUPER_ADMIN_UID;

                    // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œå–æ¶ˆè¨ªå®¢è¨»å†Šï¼ˆä¸è¨ˆå…¥è¨ªå®¢æ•¸ï¼‰
                    if (isAdmin) {
                        console.log('[ç®¡ç†å“¡] ç®¡ç†å“¡ç™»å…¥ï¼Œå–æ¶ˆè¨ªå®¢è¨»å†Š');
                        await unregisterVisitor();
                    }

                    // å¦‚æœæ˜¯ç®¡ç†å“¡ä¸”ç¶²ç«™å·²åœç”¨ï¼Œéš±è—åœç”¨é é¢
                    if (isAdmin && isWebsiteDisabled) {
                        console.log('[ç¶²ç«™ç‹€æ…‹] ç®¡ç†å“¡ç™»å…¥ï¼Œè·³éåœç”¨é é¢');
                        hideDisabledPage();
                        showToast('ç®¡ç†å“¡èº«ä»½ç¢ºèªï¼Œå·²é€²å…¥ç¶²ç«™');
                    }

                    // å¦‚æœæ˜¯ç®¡ç†å“¡ä¸”æ­£åœ¨æ’éšŠé é¢ï¼Œå‰‡è·³éæ’éšŠ
                    if (isAdmin && isInQueue) {
                        console.log('[æ’éšŠç³»çµ±] ç®¡ç†å“¡ç™»å…¥ï¼Œè·³éæ’éšŠ');
                        hideQueuePage();
                        showToast('ç®¡ç†å“¡èº«ä»½ç¢ºèªï¼Œå·²è·³éæ’éšŠ');
                    }
                } else {
                    auth.signOut();
                }
            } else {
                currentUser = null;
                currentSessionId = null;
                stopActivityMonitoring();
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('userMenu').style.display = 'none';
            }
        });

        async function handleLogin(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('=== Login form submitted on main site ===');

            const usernameOrEmail = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            console.log('Username or Email:', usernameOrEmail);

            showLoading();

            try {
                let email = usernameOrEmail;

                // åˆ¤æ–·è¼¸å…¥çš„æ˜¯é›»éƒµé‚„æ˜¯ç”¨æˆ¶åï¼ˆé›»éƒµåŒ…å«@ç¬¦è™Ÿï¼‰
                const isEmail = usernameOrEmail.includes('@');

                if (!isEmail) {
                    // å¦‚æœä¸æ˜¯é›»éƒµï¼Œæ ¹æ“šç”¨æˆ¶åæŸ¥è©¢å°æ‡‰çš„é›»å­éƒµä»¶
                    console.log('Input is username, looking up email...');
                    const usersSnapshot = await db.collection('users').where('username', '==', usernameOrEmail).get();

                    if (usersSnapshot.empty) {
                        throw { code: 'auth/user-not-found', message: 'ç”¨æˆ¶åä¸å­˜åœ¨' };
                    }

                    // ç²å–ç”¨æˆ¶çš„é›»å­éƒµä»¶
                    const userData = usersSnapshot.docs[0].data();
                    email = userData.email;
                    console.log('Found email for username:', email);
                } else {
                    console.log('Input is email, logging in directly...');
                }

                // ä½¿ç”¨é›»å­éƒµä»¶å’Œå¯†ç¢¼ç™»å…¥
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰è¨­å®šç”¨æˆ¶å
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();

                // å¦‚æœç”¨æˆ¶æ²’æœ‰ç”¨æˆ¶åï¼Œè¦æ±‚è¨­å®š
                if (!userData.username) {
                    console.log('User has no username, prompting to set...');
                    closeLoginModal();
                    showSetUsernameModal();
                    return;
                }

                // å‰µå»ºæ–°æœƒè©±ï¼ˆå–®ä¸€è£ç½®ç™»å…¥é™åˆ¶ï¼‰
                await createSession(user.uid);

                // ç›£è½æœƒè©±è®ŠåŒ–ï¼ˆè¢«å…¶ä»–è£ç½®è¸¢ä¸‹ç·šï¼‰
                listenToSessionChanges(user.uid);

                closeLoginModal();
                showToast(i18n.t('messages.loginSuccess'));
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                // æ ¹æ“šä¸åŒçš„éŒ¯èª¤ä»£ç¢¼é¡¯ç¤ºå…·é«”çš„éŒ¯èª¤è¨Šæ¯
                let errorMessage = '';

                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = {
                            'zh-TW': 'ç”¨æˆ¶åä¸å­˜åœ¨ã€‚è«‹å…ˆè¨»å†Šã€‚',
                            'zh-CN': 'ç”¨æˆ·åä¸å­˜åœ¨ã€‚è¯·å…ˆæ³¨å†Œã€‚',
                            'en': 'Username not found. Please register first.'
                        }[i18n.currentLang] || 'ç”¨æˆ¶åä¸å­˜åœ¨ã€‚';
                        break;

                    case 'auth/wrong-password':
                        errorMessage = {
                            'zh-TW': 'å¯†ç¢¼éŒ¯èª¤ã€‚è«‹ä½¿ç”¨ã€Œå¿˜è¨˜å¯†ç¢¼ï¼Ÿã€é‡è¨­å¯†ç¢¼ã€‚',
                            'zh-CN': 'å¯†ç é”™è¯¯ã€‚è¯·ä½¿ç”¨ã€Œå¿˜è®°å¯†ç ï¼Ÿã€é‡ç½®å¯†ç ã€‚',
                            'en': 'Wrong password. Please use "Forgot Password?" to reset.'
                        }[i18n.currentLang] || 'å¯†ç¢¼éŒ¯èª¤ã€‚';
                        break;

                    case 'auth/invalid-email':
                        errorMessage = {
                            'zh-TW': 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚',
                            'zh-CN': 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚',
                            'en': 'System error, please contact admin.'
                        }[i18n.currentLang] || 'ç³»çµ±éŒ¯èª¤ã€‚';
                        break;

                    case 'auth/user-disabled':
                        errorMessage = {
                            'zh-TW': 'æ­¤å¸³è™Ÿå·²è¢«åœç”¨ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ã€‚',
                            'zh-CN': 'æ­¤è´¦å·å·²è¢«åœç”¨ã€‚è¯·è”ç³»ç®¡ç†å‘˜ã€‚',
                            'en': 'This account has been disabled. Please contact admin.'
                        }[i18n.currentLang] || 'æ­¤å¸³è™Ÿå·²è¢«åœç”¨ã€‚';
                        break;

                    case 'auth/too-many-requests':
                        errorMessage = {
                            'zh-TW': 'ç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
                            'zh-CN': 'ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•ã€‚',
                            'en': 'Too many login attempts. Please try again later.'
                        }[i18n.currentLang] || 'ç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤šã€‚';
                        break;

                    case 'auth/network-request-failed':
                        errorMessage = {
                            'zh-TW': 'ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²çµ¡é€£æ¥ã€‚',
                            'zh-CN': 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚',
                            'en': 'Network error. Please check your connection.'
                        }[i18n.currentLang] || 'ç¶²çµ¡é€£æ¥å¤±æ•—ã€‚';
                        break;

                    default:
                        errorMessage = i18n.t('messages.loginError') + ` (${error.code})`;
                }

                showToast(errorMessage);
            } finally {
                hideLoading();
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;

            showLoading();

            try {
                // æª¢æŸ¥ç”¨æˆ¶åæ˜¯å¦å·²è¢«ä½¿ç”¨
                const usernameCheck = await db.collection('users').where('username', '==', username).get();
                if (!usernameCheck.empty) {
                    hideLoading();
                    const errorMsg = {
                        'zh-TW': 'æ­¤ç”¨æˆ¶åå·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–ç”¨æˆ¶åã€‚',
                        'zh-CN': 'æ­¤ç”¨æˆ·åå·²è¢«ä½¿ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·åã€‚',
                        'en': 'This username is already taken. Please choose another one.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    return;
                }

                // æª¢æŸ¥é›»å­éƒµä»¶æ˜¯å¦å·²è¢«ä½¿ç”¨
                const emailCheck = await db.collection('users').where('email', '==', email).get();
                if (!emailCheck.empty) {
                    hideLoading();
                    const errorMsg = {
                        'zh-TW': 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚',
                        'zh-CN': 'æ­¤ç”µå­é‚®ä»¶å·²è¢«æ³¨å†Œã€‚',
                        'en': 'This email is already registered.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    return;
                }

                const code = generateVerificationCode();
                const emailSent = await sendVerificationEmail(email, code, 'register');

                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                currentVerificationData.registerData = { username, email, name, password };

                closeRegisterModal();
                showVerificationModal();
                showToast(i18n.t('messages.verificationSent'));
            } catch (error) {
                console.error('Registration error:', error);
                showToast(i18n.t('messages.registerError'));
            } finally {
                hideLoading();
            }
        }

        async function handleVerification(event) {
            event.preventDefault();

            const code = document.getElementById('verificationCode').value;

            if (!verifyCode(code)) {
                showToast(i18n.t('messages.verificationError'));
                return;
            }

            showLoading();

            try {
                const { username, email, name, password } = currentVerificationData.registerData;

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await db.collection('users').doc(user.uid).set({
                    username,
                    email,
                    name,
                    status: 'pending',
                    role: 'user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await auth.signOut();

                closeVerificationModal();
                showToast(i18n.t('messages.registerSuccess'));

                currentVerificationData = null;
            } catch (error) {
                console.error('Verification error:', error);
                showToast(i18n.t('messages.verificationError'));
            } finally {
                hideLoading();
            }
        }

        // é‡æ–°ç™¼é€é©—è­‰ç¢¼å†·å»æ™‚é–“ï¼ˆ10åˆ†é˜ = 600000æ¯«ç§’ï¼‰
        let resendCooldown = null;
        let resendTimer = null;

        async function resendVerificationCode() {
            if (!currentVerificationData) {
                return;
            }

            const button = document.getElementById('resendCodeButton');
            const buttonText = document.getElementById('resendBtn');

            // æª¢æŸ¥å†·å»æ™‚é–“
            if (resendCooldown && Date.now() < resendCooldown) {
                const remainingSeconds = Math.ceil((resendCooldown - Date.now()) / 1000);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                showToast(`è«‹ç­‰å¾… ${minutes} åˆ† ${seconds} ç§’å¾Œå†é‡æ–°ç™¼é€`);
                return;
            }

            showLoading();

            const { email, purpose } = currentVerificationData;
            const newCode = generateVerificationCode();

            const sent = await sendVerificationEmail(email, newCode, purpose);

            hideLoading();

            if (sent) {
                showToast(i18n.t('messages.verificationSent'));

                // è¨­å®š10åˆ†é˜å†·å»æ™‚é–“
                resendCooldown = Date.now() + 600000; // 10åˆ†é˜
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');

                // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
                if (resendTimer) {
                    clearInterval(resendTimer);
                }

                // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºå€’è¨ˆæ™‚
                resendTimer = setInterval(() => {
                    const remainingSeconds = Math.ceil((resendCooldown - Date.now()) / 1000);

                    if (remainingSeconds <= 0) {
                        clearInterval(resendTimer);
                        resendTimer = null;
                        resendCooldown = null;
                        button.disabled = false;
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                        buttonText.textContent = i18n.t('forgotPassword.sendCode') || 'é‡æ–°ç™¼é€';
                    } else {
                        const minutes = Math.floor(remainingSeconds / 60);
                        const seconds = remainingSeconds % 60;
                        buttonText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            } else {
                showToast('ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();

            const email = document.getElementById('forgotPasswordEmail').value;

            showLoading();

            try {
                const usersSnapshot = await db.collection('users').where('email', '==', email).get();

                if (usersSnapshot.empty) {
                    throw new Error('User not found');
                }

                const code = generateVerificationCode();
                const emailSent = await sendVerificationEmail(email, code, 'resetPassword');

                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                currentVerificationData.resetEmail = email;

                document.getElementById('forgotPasswordStep1').style.display = 'none';
                document.getElementById('forgotPasswordStep2').style.display = 'block';

                showToast(i18n.t('messages.verificationSent'));
            } catch (error) {
                console.error('Forgot password error:', error);
                showToast('ç”¨æˆ¶ä¸å­˜åœ¨æˆ–ç™¼é€å¤±æ•—');
            } finally {
                hideLoading();
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();

            const code = document.getElementById('resetPasswordCode').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!verifyCode(code)) {
                showToast(i18n.t('messages.verificationError'));
                return;
            }

            showLoading();

            try {
                const resetEmail = currentVerificationData.resetEmail;

                // ä½¿ç”¨ Firebase Auth é‡è¨­å¯†ç¢¼
                const user = auth.currentUser;
                if (user && user.email === resetEmail) {
                    await user.updatePassword(newPassword);
                    showToast('å¯†ç¢¼é‡è¨­æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚');
                } else {
                    // å¦‚æœç”¨æˆ¶æ²’æœ‰ç™»å…¥ï¼Œç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶
                    await auth.sendPasswordResetEmail(resetEmail);
                    showToast('å¯†ç¢¼é‡è¨­é€£çµå·²ç™¼é€åˆ°æ‚¨çš„éƒµç®±ï¼Œè«‹æŸ¥æ”¶ã€‚');
                }

                closeForgotPasswordModal();
                currentVerificationData = null;
            } catch (error) {
                console.error('Reset password error:', error);
                showToast(i18n.t('messages.passwordResetError'));
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // å¿˜è¨˜ç”¨æˆ¶ååŠŸèƒ½
        // ========================================

        async function handleForgotUsername(event) {
            event.preventDefault();

            const email = document.getElementById('forgotUsernameEmail').value;

            showLoading();

            try {
                // æª¢æŸ¥éƒµç®±æ˜¯å¦å·²è¨»å†Š
                const usersSnapshot = await db.collection('users').where('email', '==', email).get();

                if (usersSnapshot.empty) {
                    hideLoading();
                    const errorMsg = {
                        'zh-TW': 'æ­¤é›»å­éƒµä»¶å°šæœªè¨»å†Šï¼Œè«‹å…ˆè¨»å†Šå¸³è™Ÿã€‚',
                        'zh-CN': 'æ­¤ç”µå­é‚®ä»¶å°šæœªæ³¨å†Œï¼Œè¯·å…ˆæ³¨å†Œè´¦å·ã€‚',
                        'en': 'This email is not registered. Please register first.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    return;
                }

                // ç”Ÿæˆä¸¦ç™¼é€é©—è­‰ç¢¼
                const code = generateVerificationCode();
                const emailSent = await sendVerificationEmail(email, code, 'forgotUsername');

                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                // ä¿å­˜éƒµç®±ä¿¡æ¯
                currentVerificationData.forgotUsernameEmail = email;

                document.getElementById('forgotUsernameStep1').style.display = 'none';
                document.getElementById('forgotUsernameStep2').style.display = 'block';

                showToast(i18n.t('messages.verificationSent'));
            } catch (error) {
                console.error('Forgot username error:', error);
                const errorMsg = {
                    'zh-TW': 'ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦',
                    'zh-CN': 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•',
                    'en': 'Failed to send, please try again later'
                };
                showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
            } finally {
                hideLoading();
            }
        }

        async function handleVerifyUsername(event) {
            event.preventDefault();

            const code = document.getElementById('verifyUsernameCode').value;

            if (!verifyCode(code)) {
                showToast(i18n.t('messages.verificationError'));
                return;
            }

            showLoading();

            try {
                const email = currentVerificationData.forgotUsernameEmail;

                // é¡¯ç¤ºç”¨æˆ¶åï¼ˆå³ç‚ºéƒµç®±ï¼‰
                document.getElementById('displayFoundUsername').textContent = email;

                document.getElementById('forgotUsernameStep2').style.display = 'none';
                document.getElementById('forgotUsernameStep3').style.display = 'block';

                currentVerificationData = null;
            } catch (error) {
                console.error('Verify username error:', error);
                showToast(i18n.t('messages.verificationError'));
            } finally {
                hideLoading();
            }
        }

        async function handleSetUsername(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value.trim();

            // é©—è­‰ç”¨æˆ¶åæ ¼å¼
            const usernameRegex = /^[a-zA-Z0-9_-]{3,20}$/;
            if (!usernameRegex.test(username)) {
                const errorMsg = {
                    'zh-TW': 'ç”¨æˆ¶ååªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—ã€åº•ç·šå’Œé€£å­—è™Ÿï¼Œé•·åº¦ç‚º3-20å€‹å­—ç¬¦ã€‚',
                    'zh-CN': 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€åº•çº¿å’Œè¿å­—å·ï¼Œé•¿åº¦ä¸º3-20ä¸ªå­—ç¬¦ã€‚',
                    'en': 'Username can only contain letters, numbers, underscores and hyphens, 3-20 characters long.'
                };
                showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                return;
            }

            showLoading();

            try {
                // æª¢æŸ¥ç”¨æˆ¶åæ˜¯å¦å·²è¢«ä½¿ç”¨
                const usernameCheck = await db.collection('users').where('username', '==', username).get();
                if (!usernameCheck.empty) {
                    const errorMsg = {
                        'zh-TW': 'æ­¤ç”¨æˆ¶åå·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–ç”¨æˆ¶åã€‚',
                        'zh-CN': 'æ­¤ç”¨æˆ·åå·²è¢«ä½¿ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·åã€‚',
                        'en': 'This username is already taken. Please choose another one.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    hideLoading();
                    return;
                }

                // æ›´æ–°ç•¶å‰ç”¨æˆ¶çš„ç”¨æˆ¶å
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('ç”¨æˆ¶æœªç™»å…¥');
                }

                await db.collection('users').doc(user.uid).update({
                    username: username,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const successMsg = {
                    'zh-TW': 'ç”¨æˆ¶åè¨­å®šæˆåŠŸï¼',
                    'zh-CN': 'ç”¨æˆ·åè®¾å®šæˆåŠŸï¼',
                    'en': 'Username set successfully!'
                };
                showToast(successMsg[i18n.currentLang] || successMsg['zh-TW']);

                closeSetUsernameModal();

                // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°ç”¨æˆ¶ç•Œé¢
                setTimeout(() => {
                    location.reload();
                }, 1000);

            } catch (error) {
                console.error('Set username error:', error);
                const errorMsg = {
                    'zh-TW': 'è¨­å®šç”¨æˆ¶åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
                    'zh-CN': 'è®¾å®šç”¨æˆ·åå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚',
                    'en': 'Failed to set username. Please try again later.'
                };
                showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            // çµæŸæœƒè©±
            await endSession();
            await auth.signOut();
            showToast('å·²ç™»å‡º');
        }

        function showAdminPanel() {
            window.location.href = 'admin.html';
        }

        // ========================================
        // å…§å®¹åŠ è¼‰
        // ========================================

        async function loadHero() {
            try {
                const doc = await db.collection('settings').doc('hero').get();

                if (!doc.exists) {
                    console.log('Hero settings document does not exist');
                    return;
                }

                const data = doc.data();
                console.log('Hero data loaded:', data);
                console.log('Current language:', i18n.currentLang);

                // æ›´æ–° Hero æ¨™é¡Œå’Œå‰¯æ¨™é¡Œï¼Œæ ¹æ“šç•¶å‰èªè¨€é¸æ“‡å°æ‡‰çš„æ–‡å­—
                const heroTitle = document.getElementById('heroTitle');
                const heroSubtitle = document.getElementById('heroSubtitle');

                // å°‡èªè¨€ä»£ç¢¼è½‰æ›ç‚ºå¾Œå°ä½¿ç”¨çš„éµåæ ¼å¼
                // 'zh-TW' -> 'zhTW', 'zh-CN' -> 'zhCN', 'en' -> 'en'
                const langKey = i18n.currentLang.replace(/-/g, '');
                console.log('Language key:', langKey);

                if (heroTitle && data.title) {
                    // æª¢æŸ¥ data.title æ˜¯å¦ç‚ºç‰©ä»¶
                    if (typeof data.title === 'object' && data.title !== null) {
                        // å˜—è©¦æŒ‰é †åºæŸ¥æ‰¾ï¼šç•¶å‰èªè¨€ -> ç¹é«”ä¸­æ–‡ -> ç°¡é«”ä¸­æ–‡ -> è‹±æ–‡
                        const title = data.title[langKey] || data.title.zhTW || data.title.zhCN || data.title.en || '';
                        console.log('Setting hero title to:', title);
                        // åªåœ¨æœ‰å¯¦éš›å…§å®¹æ™‚æ‰æ›´æ–°ï¼Œå¦å‰‡ä¿ç•™ HTML é»˜èªå€¼
                        if (title && title.trim() !== '') {
                            heroTitle.textContent = title;
                        } else {
                            console.log('Hero title is empty, keeping default HTML value');
                        }
                    } else if (typeof data.title === 'string') {
                        // èˆŠæ ¼å¼ï¼šç›´æ¥æ˜¯å­—ç¬¦ä¸²
                        console.log('Setting hero title (old format) to:', data.title);
                        if (data.title.trim() !== '') {
                            heroTitle.textContent = data.title;
                        }
                    }
                }

                if (heroSubtitle && data.subtitle) {
                    // æª¢æŸ¥ data.subtitle æ˜¯å¦ç‚ºç‰©ä»¶
                    if (typeof data.subtitle === 'object' && data.subtitle !== null) {
                        // å˜—è©¦æŒ‰é †åºæŸ¥æ‰¾ï¼šç•¶å‰èªè¨€ -> ç¹é«”ä¸­æ–‡ -> ç°¡é«”ä¸­æ–‡ -> è‹±æ–‡
                        const subtitle = data.subtitle[langKey] || data.subtitle.zhTW || data.subtitle.zhCN || data.subtitle.en || '';
                        console.log('Setting hero subtitle to:', subtitle);
                        // åªåœ¨æœ‰å¯¦éš›å…§å®¹æ™‚æ‰æ›´æ–°ï¼Œå¦å‰‡ä¿ç•™ HTML é»˜èªå€¼
                        if (subtitle && subtitle.trim() !== '') {
                            heroSubtitle.textContent = subtitle;
                        } else {
                            console.log('Hero subtitle is empty, keeping default HTML value');
                        }
                    } else if (typeof data.subtitle === 'string') {
                        // èˆŠæ ¼å¼ï¼šç›´æ¥æ˜¯å­—ç¬¦ä¸²
                        console.log('Setting hero subtitle (old format) to:', data.subtitle);
                        if (data.subtitle.trim() !== '') {
                            heroSubtitle.textContent = data.subtitle;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading hero settings:', error);
            }
        }

        async function loadAnthem() {
            try {
                const doc = await db.collection('settings').doc('anthem').get();

                const currentLang = i18n.currentLanguage;

                if (doc.exists) {
                    const data = doc.data();

                    // Load title based on language
                    const titleEl = document.getElementById('anthemTitle');
                    if (data[`title_${currentLang.replace('-', '_')}`]) {
                        titleEl.textContent = data[`title_${currentLang.replace('-', '_')}`];
                    }

                    // Load description based on language
                    const descEl = document.getElementById('anthemDescription');
                    if (data[`description_${currentLang.replace('-', '_')}`]) {
                        descEl.textContent = data[`description_${currentLang.replace('-', '_')}`];
                    }
                }
            } catch (error) {
                console.error('Error loading anthem settings:', error);
            }
        }

        async function loadContent() {
            await Promise.all([
                loadHero(),
                loadAnthem(),
                loadActivities(),
                loadProjects(),
                loadTeam(),
                loadContact()
            ]);
        }

        async function loadActivities() {
            try {
                const snapshot = await db.collection('activities')
                    .orderBy('createdAt', 'desc')
                    .limit(6)
                    .get();

                const container = document.getElementById('activitiesContainer');

                if (snapshot.empty) {
                    const emptyMessages = {
                        'zh-TW': 'æš«ç„¡æ´»å‹•',
                        'zh-CN': 'æš‚æ— æ´»åŠ¨',
                        'en': 'No activities available'
                    };
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">${emptyMessages[i18n.currentLang] || emptyMessages['zh-TW']}</p>`;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();

                    // å°‡èªè¨€ä»£ç¢¼è½‰æ›ç‚ºéµåæ ¼å¼ï¼ˆ'zh-TW' -> 'zhTW'ï¼‰
                    const langKey = i18n.currentLang.replace(/-/g, '');
                    console.log('Loading activity, langKey:', langKey, 'title data:', data.title);

                    // ç²å–å¤šèªè¨€å­—æ®µï¼ˆæ”¯æŒæ–°èˆŠæ ¼å¼ï¼‰
                    const title = typeof data.title === 'string'
                        ? data.title
                        : (data.title?.[langKey] || data.title?.zhTW || data.title?.zhCN || data.title?.en || '');
                    const description = typeof data.description === 'string'
                        ? data.description
                        : (data.description?.[langKey] || data.description?.zhTW || data.description?.zhCN || data.description?.en || '');
                    const location = typeof data.location === 'string'
                        ? data.location
                        : (data.location?.[langKey] || data.location?.zhTW || data.location?.zhCN || data.location?.en || '');

                    console.log('Activity title:', title, 'description:', description);

                    // è™•ç†æ—¥æœŸ
                    let date = '';
                    if (data.date) {
                        if (data.date.toDate) {
                            date = data.date.toDate().toLocaleDateString(i18n.currentLang);
                        } else if (typeof data.date === 'string') {
                            date = data.date;
                        }
                    }

                    return `
                        <div class="card fade-in">
                            <div class="mb-4">
                                ${date ? `
                                    <div class="text-sm text-purple-600 dark:text-purple-400 font-medium mb-2">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${date}
                                    </div>
                                ` : ''}
                                <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                                    ${title}
                                </h4>
                                <p class="text-gray-600 dark:text-gray-400">
                                    ${description}
                                </p>
                            </div>
                            ${location ? `
                                <div class="text-sm text-gray-500 dark:text-gray-500">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    ${location}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading activities:', error);
                const errorMessages = {
                    'zh-TW': 'è¼‰å…¥å¤±æ•—',
                    'zh-CN': 'åŠ è½½å¤±è´¥',
                    'en': 'Loading failed'
                };
                document.getElementById('activitiesContainer').innerHTML =
                    `<p class="text-red-500 col-span-full text-center">${errorMessages[i18n.currentLang] || errorMessages['zh-TW']}</p>`;
            }
        }

        async function loadProjects() {
            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .limit(6)
                    .get();

                const container = document.getElementById('projectsContainer');

                if (snapshot.empty) {
                    const emptyMessages = {
                        'zh-TW': 'æš«ç„¡é …ç›®',
                        'zh-CN': 'æš‚æ— é¡¹ç›®',
                        'en': 'No projects available'
                    };
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">${emptyMessages[i18n.currentLang] || emptyMessages['zh-TW']}</p>`;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();

                    // å°‡èªè¨€ä»£ç¢¼è½‰æ›ç‚ºéµåæ ¼å¼ï¼ˆ'zh-TW' -> 'zhTW'ï¼‰
                    const langKey = i18n.currentLang.replace(/-/g, '');
                    console.log('Loading project, langKey:', langKey, 'title data:', data.title);

                    // ç²å–å¤šèªè¨€å­—æ®µï¼ˆæ”¯æŒæ–°èˆŠæ ¼å¼ï¼‰
                    const title = typeof data.title === 'string'
                        ? data.title
                        : (data.title?.[langKey] || data.title?.zhTW || data.title?.zhCN || data.title?.en || '');
                    const description = typeof data.description === 'string'
                        ? data.description
                        : (data.description?.[langKey] || data.description?.zhTW || data.description?.zhCN || data.description?.en || '');

                    console.log('Project title:', title, 'description:', description);

                    return `
                        <div class="card fade-in">
                            <div class="mb-4">
                                <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                                    ${title}
                                </h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">
                                    ${description}
                                </p>
                                ${data.technologies ? `
                                    <div class="flex flex-wrap gap-2">
                                        ${data.technologies.map(tech => `
                                            <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-xs rounded-full">
                                                ${tech}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading projects:', error);
                const errorMessages = {
                    'zh-TW': 'è¼‰å…¥å¤±æ•—',
                    'zh-CN': 'åŠ è½½å¤±è´¥',
                    'en': 'Loading failed'
                };
                document.getElementById('projectsContainer').innerHTML =
                    `<p class="text-red-500 col-span-full text-center">${errorMessages[i18n.currentLang] || errorMessages['zh-TW']}</p>`;
            }
        }

        async function loadTeam() {
            try {
                const snapshot = await db.collection('team')
                    .orderBy('order', 'asc')
                    .get();

                const container = document.getElementById('teamContainer');

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">æš«ç„¡åœ˜éšŠæˆå“¡</p>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const nameField = `name_${i18n.currentLang.replace('-', '')}`;
                    const positionField = `position_${i18n.currentLang.replace('-', '')}`;

                    return `
                        <div class="card text-center fade-in">
                            <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-3xl font-bold">
                                ${(data[nameField] || data.name || '?')[0].toUpperCase()}
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-1">
                                ${data[nameField] || data.name || 'Unknown'}
                            </h4>
                            <p class="text-sm text-purple-600 dark:text-purple-400 mb-3">
                                ${data[positionField] || data.position || ''}
                            </p>
                            ${data.email ? `
                                <a href="mailto:${data.email}" class="text-gray-500 hover:text-purple-600 dark:text-gray-400 dark:hover:text-purple-400 text-sm">
                                    <i class="fas fa-envelope"></i>
                                </a>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading team:', error);
                document.getElementById('teamContainer').innerHTML =
                    '<p class="text-red-500 col-span-full text-center">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function loadContact() {
            try {
                const doc = await db.collection('settings').doc('contact').get();

                const container = document.getElementById('contactInfo');

                if (!doc.exists) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">æš«ç„¡è¯çµ¡ä¿¡æ¯</p>';
                    return;
                }

                const data = doc.data();

                container.innerHTML = `
                    <div class="space-y-4 text-left">
                        ${data.address ? `
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-map-marker-alt text-purple-600 dark:text-purple-400 mt-1"></i>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-200">åœ°å€</p>
                                    <p class="text-gray-600 dark:text-gray-400">${data.address}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${data.phone ? `
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-phone text-purple-600 dark:text-purple-400 mt-1"></i>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-200">é›»è©±</p>
                                    <a href="tel:${data.phone}" class="text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300">
                                        ${data.phone}
                                    </a>
                                </div>
                            </div>
                        ` : ''}

                        ${data.email ? `
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-envelope text-purple-600 dark:text-purple-400 mt-1"></i>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-200">éƒµç®±</p>
                                    <a href="mailto:${data.email}" class="text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300">
                                        ${data.email}
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading contact:', error);
                document.getElementById('contactInfo').innerHTML =
                    '<p class="text-red-500">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // ========================================
        // è¯çµ¡è¡¨å–®
        // ========================================

        async function handleContactSubmit(event) {
            event.preventDefault();

            const email = document.getElementById('contactEmail').value;
            const subject = document.getElementById('contactSubject').value;
            const message = document.getElementById('contactMessage').value;

            showLoading();

            try {
                await db.collection('contact_submissions').add({
                    email,
                    subject,
                    message,
                    status: 'unread',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    repliedAt: null,
                    reply: null
                });

                document.getElementById('contactForm').reset();
                showToast(i18n.t('contact.success'));
            } catch (error) {
                console.error('Error submitting contact form:', error);
                showToast(i18n.t('contact.error'));
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // èªè¨€åˆ‡æ›
        // ========================================

        function updateLanguage() {
            // æ›´æ–°å°èˆªæ¬„
            const titleMap = {
                'zh-TW': 'ç§‘æŠ€å­¸æœƒ',
                'zh-CN': 'ç§‘æŠ€å­¦ä¼š',
                'en': 'Science and technology club'
            };
            const navTitleElement = document.getElementById('navTitle');
            if (navTitleElement) {
                const titleText = titleMap[i18n.currentLang] || 'ç§‘æŠ€å­¸æœƒ';
                console.log('Setting navTitle to:', titleText);
                navTitleElement.textContent = titleText;
            } else {
                console.error('navTitle element not found!');
            }

            document.getElementById('loginBtnText').textContent = i18n.t('nav.login');
            document.getElementById('adminPanelText').textContent = i18n.t('nav.admin');
            document.getElementById('logoutText').textContent = i18n.t('nav.logout');

            // Hero å€å¡Šæœƒç”± loadHero() å‡½æ•¸å¾å¾Œå°è¨­ç½®è¼‰å…¥ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦è¨­å®š
            // æœƒæ­Œå€å¡Šæœƒç”± loadAnthem() å‡½æ•¸å¾å¾Œå°è¨­ç½®è¼‰å…¥
            loadAnthem();

            // æ›´æ–°å€å¡Šæ¨™é¡Œ
            console.log('Updating section titles, current language:', i18n.currentLang);
            console.log('activities.title translation:', i18n.t('activities.title'));
            console.log('projects.title translation:', i18n.t('projects.title'));

            document.getElementById('activitiesTitle').textContent = i18n.t('activities.title');
            document.getElementById('projectsTitle').textContent = i18n.t('projects.title');
            document.getElementById('teamTitle').textContent = i18n.t('team.title');
            document.getElementById('contactTitle').textContent = i18n.t('contact.title');

            // æ›´æ–°è¯çµ¡è¡¨å–®
            document.getElementById('sendMessageTitle').textContent = i18n.t('contact.sendMessageTitle');
            document.getElementById('yourEmailLabel').textContent = i18n.t('contact.yourEmail');
            document.getElementById('subjectLabel').textContent = i18n.t('contact.subject');
            document.getElementById('contentLabel').textContent = i18n.t('contact.content');
            document.getElementById('sendButtonText').textContent = i18n.t('contact.sendButton');

            // æ›´æ–° placeholder
            document.getElementById('contactEmail').placeholder = i18n.t('contact.emailPlaceholder');
            document.getElementById('contactSubject').placeholder = i18n.t('contact.subjectPlaceholder');
            document.getElementById('contactMessage').placeholder = i18n.t('contact.contentPlaceholder');

            // æ›´æ–°ç™»å…¥æ¨¡æ…‹æ¡†
            document.getElementById('loginModalTitle').textContent = i18n.t('login.title');
            document.getElementById('usernameOrEmailLabel').textContent = i18n.t('login.usernameOrEmail');
            document.getElementById('passwordLabel').textContent = i18n.t('login.password');
            document.getElementById('forgotPasswordBtn').textContent = i18n.t('login.forgotPassword');
            document.getElementById('loginSubmitBtn').textContent = i18n.t('login.loginBtn');
            document.getElementById('cancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('noAccountText').textContent = i18n.t('login.noAccount');
            document.getElementById('registerLinkBtn').textContent = i18n.t('login.registerNow');

            // æ›´æ–°è¨»å†Šæ¨¡æ…‹æ¡†
            document.getElementById('registerModalTitle').textContent = i18n.t('register.title');
            document.getElementById('regUsernameLabel').textContent = i18n.t('register.username');
            document.getElementById('regEmailLabel').textContent = i18n.t('register.email');
            document.getElementById('regNameLabel').textContent = i18n.t('register.fullName');
            document.getElementById('regPasswordLabel').textContent = i18n.t('register.password');
            document.getElementById('passwordHint').textContent = i18n.t('register.passwordPlaceholder');
            document.getElementById('registerSubmitBtn').textContent = i18n.t('common.confirm');
            document.getElementById('regCancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('hasAccountText').textContent = i18n.t('register.hasAccount');
            document.getElementById('loginLinkBtn').textContent = i18n.t('register.loginNow');

            // æ›´æ–°é©—è­‰ç¢¼æ¨¡æ…‹æ¡†
            document.getElementById('verificationModalTitle').textContent = i18n.t('forgotPassword.verificationCode');
            document.getElementById('verificationInstructions').textContent = 'æˆ‘å€‘å·²å‘æ‚¨çš„éƒµç®±ç™¼é€äº†ä¸€å€‹ 6 ä½æ•¸é©—è­‰ç¢¼ï¼Œè«‹è¼¸å…¥ä»¥å®Œæˆé©—è­‰ã€‚';
            document.getElementById('verificationCodeLabel').textContent = i18n.t('forgotPassword.verificationCode');
            document.getElementById('codeExpiryText').textContent = 'é©—è­‰ç¢¼å°‡åœ¨ 10 åˆ†é˜å¾ŒéæœŸ';
            document.getElementById('verifyBtn').textContent = i18n.t('common.confirm');
            document.getElementById('resendBtn').textContent = 'é‡æ–°ç™¼é€';

            // æ›´æ–°å¿˜è¨˜å¯†ç¢¼æ¨¡æ…‹æ¡†
            document.getElementById('forgotPasswordTitle').textContent = i18n.t('forgotPassword.title');
            document.getElementById('forgotPasswordInstructions').textContent = i18n.t('forgotPassword.subtitle');
            document.getElementById('fpEmailLabel').textContent = i18n.t('forgotPassword.email');
            document.getElementById('sendCodeBtn').textContent = i18n.t('forgotPassword.sendCode');
            document.getElementById('fpCancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('fpStep2Instructions').textContent = 'è«‹è¼¸å…¥ç™¼é€åˆ°æ‚¨éƒµç®±çš„é©—è­‰ç¢¼å’Œæ–°å¯†ç¢¼ã€‚';
            document.getElementById('fpCodeLabel').textContent = i18n.t('forgotPassword.verificationCode');
            document.getElementById('newPasswordLabel').textContent = i18n.t('forgotPassword.newPassword');
            document.getElementById('resetPasswordBtn').textContent = i18n.t('forgotPassword.resetPassword');
            document.getElementById('fpStep2CancelBtn').textContent = i18n.t('common.cancel');

            // æ›´æ–°å¿˜è¨˜ç”¨æˆ¶åæ¨¡æ…‹æ¡†
            document.getElementById('forgotUsernameTitle').textContent = i18n.t('forgotUsername.title');
            document.getElementById('forgotUsernameInstructions').textContent = i18n.t('forgotUsername.subtitle');
            document.getElementById('fuEmailLabel').textContent = i18n.t('forgotUsername.email');
            document.getElementById('sendUsernameCodeBtn').textContent = i18n.t('forgotUsername.sendCode');
            document.getElementById('fuCancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('fuStep2Instructions').textContent = 'è«‹è¼¸å…¥ç™¼é€åˆ°æ‚¨éƒµç®±çš„é©—è­‰ç¢¼ï¼Œæˆ‘å€‘å°‡é¡¯ç¤ºæ‚¨çš„ç”¨æˆ¶åã€‚';
            document.getElementById('fuCodeLabel').textContent = i18n.t('forgotUsername.verificationCode');
            document.getElementById('verifyUsernameBtn').textContent = i18n.t('forgotUsername.verify');
            document.getElementById('fuStep2CancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('usernameFoundTitle').textContent = i18n.t('forgotUsername.found');
            document.getElementById('yourUsernameLabel').textContent = i18n.t('forgotUsername.yourUsername');
            document.getElementById('backToLoginBtn').textContent = i18n.t('forgotUsername.backToLogin');
            document.getElementById('forgotUsernameBtn').textContent = i18n.t('login.forgotUsername');

            // æ›´æ–°è¨­å®šç”¨æˆ¶åæ¨¡æ…‹æ¡†
            const setUsernameTitle = document.getElementById('setUsernameTitle');
            const setUsernameNotice = document.getElementById('setUsernameNotice');
            const suUsernameLabel = document.getElementById('suUsernameLabel');
            const suUsernameHint = document.getElementById('suUsernameHint');
            const setUsernameBtn = document.getElementById('setUsernameBtn');

            if (setUsernameTitle) {
                const titleTexts = {
                    'zh-TW': 'è¨­å®šç”¨æˆ¶å',
                    'zh-CN': 'è®¾å®šç”¨æˆ·å',
                    'en': 'Set Username'
                };
                setUsernameTitle.textContent = titleTexts[i18n.currentLang] || titleTexts['zh-TW'];
            }

            if (setUsernameNotice) {
                const noticeTexts = {
                    'zh-TW': 'æ‚¨çš„å¸³è™Ÿå°šæœªè¨­å®šç”¨æˆ¶åã€‚è«‹è¨­å®šä¸€å€‹ç”¨æˆ¶åä»¥ç¹¼çºŒä½¿ç”¨ç³»çµ±ã€‚',
                    'zh-CN': 'æ‚¨çš„è´¦å·å°šæœªè®¾å®šç”¨æˆ·åã€‚è¯·è®¾å®šä¸€ä¸ªç”¨æˆ·åä»¥ç»§ç»­ä½¿ç”¨ç³»ç»Ÿã€‚',
                    'en': 'Your account does not have a username yet. Please set a username to continue using the system.'
                };
                setUsernameNotice.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${noticeTexts[i18n.currentLang] || noticeTexts['zh-TW']}`;
            }

            if (suUsernameLabel) {
                const labelTexts = {
                    'zh-TW': 'ç”¨æˆ¶å',
                    'zh-CN': 'ç”¨æˆ·å',
                    'en': 'Username'
                };
                suUsernameLabel.textContent = labelTexts[i18n.currentLang] || labelTexts['zh-TW'];
            }

            if (suUsernameHint) {
                const hintTexts = {
                    'zh-TW': 'ç”¨æˆ¶åå¯åŒ…å«å­—æ¯ã€æ•¸å­—ã€åº•ç·šå’Œé€£å­—è™Ÿ',
                    'zh-CN': 'ç”¨æˆ·åå¯åŒ…å«å­—æ¯ã€æ•°å­—ã€åº•çº¿å’Œè¿å­—å·',
                    'en': 'Username can contain letters, numbers, underscores and hyphens'
                };
                suUsernameHint.textContent = hintTexts[i18n.currentLang] || hintTexts['zh-TW'];
            }

            if (setUsernameBtn) {
                const btnTexts = {
                    'zh-TW': 'è¨­å®šç”¨æˆ¶å',
                    'zh-CN': 'è®¾å®šç”¨æˆ·å',
                    'en': 'Set Username'
                };
                setUsernameBtn.textContent = btnTexts[i18n.currentLang] || btnTexts['zh-TW'];
            }

            // é‡æ–°åŠ è¼‰å…§å®¹
            loadContent();
        }

        // ========================================
        // åˆå§‹åŒ–
        // ========================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== DOM Content Loaded ===');
            console.log('i18n object:', window.i18n);
            console.log('Current language:', i18n.currentLang);

            // å…ˆæª¢æŸ¥ç¶²ç«™æ˜¯å¦åœç”¨
            const websiteDisabled = await checkWebsiteStatus();
            if (websiteDisabled) {
                console.log('[ç¶²ç«™ç‹€æ…‹] ç¶²ç«™å·²åœç”¨ï¼Œé¡¯ç¤ºåœç”¨é é¢');
                showDisabledPage();
                // ä»ç„¶å…è¨±ç®¡ç†å“¡ç™»å…¥ï¼Œæ‰€ä»¥ä¸è¦ return
            }

            // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºå·²ç™»å…¥çš„ç®¡ç†å“¡
            const isLoggedInAdmin = await checkIfLoggedInAdmin();

            // è¨»å†Šè¨ªå®¢ä¸¦æª¢æŸ¥æ’éšŠï¼ˆåªæœ‰åœ¨ç¶²ç«™æœªåœç”¨æ™‚æ‰æª¢æŸ¥æ’éšŠï¼Œä¸”éç®¡ç†å“¡ï¼‰
            if (!websiteDisabled && !isLoggedInAdmin) {
                await registerVisitor();
                const needsQueue = await checkQueue();

                if (!needsQueue) {
                    // æ­£å¸¸è¼‰å…¥é é¢
                    console.log('âœ“ è¨ªå®¢å·²é€²å…¥ç¶²ç«™');
                }

                // å•Ÿå‹•è¸¢å‡ºè­¦å‘Šç›£è½
                startKickWarningListener();
                listenToKickStatus();
            } else if (isLoggedInAdmin) {
                console.log('[ç®¡ç†å“¡] ç®¡ç†å“¡ç”¨æˆ¶ï¼Œè·³éè¨ªå®¢è¨»å†Šå’Œæ’éšŠ');
            }

            // å•Ÿå‹•å…¬å‘Šç›£è½ï¼ˆç„¡è«–ç¶²ç«™æ˜¯å¦åœç”¨éƒ½è¦é¡¯ç¤ºï¼‰
            startAnnouncementListener();
            initAnnouncementCloseButton();

            // åŒæ­¥èªè¨€é¸æ“‡å™¨çš„å€¼
            const languageSelector = document.getElementById('languageSelector');
            const loginBtn = document.getElementById('loginBtn');
            const userMenuBtn = document.getElementById('userMenuBtn');

            console.log('languageSelector element:', languageSelector);
            console.log('loginBtn element:', loginBtn);
            console.log('userMenuBtn element:', userMenuBtn);

            if (languageSelector) {
                languageSelector.value = i18n.currentLang;

                // ç¶å®šèªè¨€é¸æ“‡å™¨changeäº‹ä»¶
                languageSelector.addEventListener('change', (e) => {
                    console.log('Language changed to:', e.target.value);
                    i18n.setLanguage(e.target.value);
                    updateLanguage();
                });
                console.log('âœ“ Language selector event listener attached');
            } else {
                console.error('âœ— languageSelector element not found!');
            }

            // ç¶å®šç™»å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    console.log('Login button clicked!');
                    showLoginModal();
                });
                console.log('âœ“ Login button event listener attached');
            } else {
                console.error('âœ— loginBtn element not found!');
            }

            // ç¶å®šç”¨æˆ¶èœå–®é»æ“Šäº‹ä»¶
            if (userMenuBtn) {
                userMenuBtn.addEventListener('click', () => {
                    console.log('User menu button clicked!');
                    document.getElementById('userDropdown').classList.toggle('hidden');
                });
                console.log('âœ“ User menu button event listener attached');
            }

            // é»æ“Šå¤–éƒ¨é—œé–‰ç”¨æˆ¶èœå–®
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenu');
                if (userMenu && !userMenu.contains(e.target)) {
                    document.getElementById('userDropdown').classList.add('hidden');
                }
            });

            console.log('Initializing theme...');
            initTheme();

            console.log('Updating language...');
            updateLanguage();

            console.log('Loading content...');
            loadContent();

            console.log('=== Initialization Complete ===');
        });
    </script>

    <!-- ç‰ˆæœ¬è™Ÿé¡¯ç¤º -->
    <div class="fixed bottom-2 right-2 text-xs text-gray-400 dark:text-gray-500 bg-white/50 dark:bg-gray-800/50 px-3 py-1 rounded-full shadow-sm">
        v5.2.1 - å‰å°
    </div>
</body>
</html>
