<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="mF8D_kM2nUO6Po-tR0x7qj3EJd3yONi479P3xl-0cLE" >
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>科技學會 - Science and technology club</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid rgba(93, 92, 222, 0.1);
            border-radius: 50%;
            border-top: 3px solid #5D5CDE;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* 模態框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .dark .modal-content {
            background: #2a2a2a;
            color: #E5E5E5;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 輸入框至少16px避免手機縮放 */
        input, select, textarea {
            font-size: 16px !important;
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
        }

        .toast.active {
            display: block;
        }

        .dark .toast {
            background: #2a2a2a;
            color: #E5E5E5;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 按鈕 */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(93, 92, 222, 0.3);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* 卡片 */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .dark .card {
            background: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        /* 深色模式 */
        .dark {
            background-color: #181818;
            color: #E5E5E5;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- 載入覆蓋層 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center" style="display: none;">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-white text-lg" id="loadingText">載入中...</p>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast">
        <p id="toastMessage"></p>
    </div>

    <!-- 導航欄 -->
    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-purple-600 dark:text-purple-400">
                        <i class="fas fa-microchip mr-2"></i>
                        <span id="navTitle">科技學會</span>
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- 語言選擇器 -->
                    <select id="languageSelector" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-2 rounded-lg border-none focus:ring-2 focus:ring-purple-500 text-base">
                        <option value="zh-TW">繁體中文</option>
                        <option value="zh-CN">简体中文</option>
                        <option value="en">English</option>
                    </select>

                    <!-- 主題切換 -->
                    <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>

                    <!-- 登入按鈕（未登入時顯示） -->
                    <button id="loginBtn" class="btn-primary relative flex flex-col items-center">
                        <div class="flex items-center">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            <span id="loginBtnText">登入</span>
                        </div>
                        <span class="text-xs opacity-75">管理員專屬</span>
                    </button>

                    <!-- 用戶菜單（已登入時顯示） -->
                    <div id="userMenu" style="display: none;" class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 bg-purple-100 dark:bg-purple-900 px-4 py-2 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition">
                            <i class="fas fa-user-circle text-purple-600 dark:text-purple-400"></i>
                            <span id="userDisplayName" class="text-gray-800 dark:text-gray-200"></span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>
                        <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden">
                            <button onclick="showAdminPanel()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                <i class="fas fa-cog mr-2"></i>
                                <span id="adminPanelText">管理後台</span>
                            </button>
                            <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-red-600">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                <span id="logoutText">登出</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <section class="text-center mb-16 fade-in">
            <h2 class="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent" id="heroTitle">
                歡迎來到科技學會
            </h2>
            <p class="text-xl text-gray-600 dark:text-gray-400" id="heroSubtitle">
                探索科技，創新未來
            </p>
        </section>

        <!-- 會歌區塊 -->
        <section class="mb-16 fade-in">
            <div class="max-w-2xl mx-auto">
                <div class="card text-center">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                        <i class="fas fa-music mr-3 text-purple-600"></i>
                        <span id="anthemTitle">科技學會會歌</span>
                    </h3>
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-8">
                        <div class="flex items-center justify-center mb-4">
                            <i class="fas fa-compact-disc text-6xl text-purple-600 dark:text-purple-400 animate-pulse"></i>
                        </div>
                        <audio id="anthemAudio" controls class="w-full" style="filter: hue-rotate(270deg);">
                            <source src="https://pfst.cf2.poecdn.net/base/video/0549e0697b2edaf333eb086ceb0eb0af607f19135f7ae796092f17df73c5d288" type="video/mp4">
                            您的瀏覽器不支援音頻播放。
                        </audio>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-4" id="anthemDescription">
                            聆聽我們的會歌，感受科技學會的精神與熱情
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 活動區塊 -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200">
                <i class="fas fa-calendar-alt mr-3 text-purple-600"></i>
                <span id="activitiesTitle">最新活動</span>
            </h3>
            <div id="activitiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 活動將動態加載 -->
            </div>
        </section>

        <!-- 項目區塊 -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200">
                <i class="fas fa-project-diagram mr-3 text-purple-600"></i>
                <span id="projectsTitle">精選項目</span>
            </h3>
            <div id="projectsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 項目將動態加載 -->
            </div>
        </section>

        <!-- 團隊區塊 -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-gray-800 dark:text-gray-200">
                <i class="fas fa-users mr-3 text-purple-600"></i>
                <span id="teamTitle">團隊成員</span>
            </h3>
            <div id="teamContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- 團隊成員將動態加載 -->
            </div>
        </section>

        <!-- 聯絡區塊 -->
        <section class="mb-16">
            <h3 class="text-3xl font-bold mb-8 text-center text-gray-800 dark:text-gray-200">
                <i class="fas fa-envelope mr-3 text-purple-600"></i>
                <span id="contactTitle">聯絡我們</span>
            </h3>

            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 聯絡信息 -->
                <div id="contactInfo" class="card">
                    <!-- 聯絡信息將動態加載 -->
                </div>

                <!-- 聯絡表單 -->
                <div class="card">
                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                        <i class="fas fa-paper-plane mr-2 text-purple-600"></i>
                        <span id="sendMessageTitle">發送訊息</span>
                    </h4>
                    <form id="contactForm" onsubmit="handleContactSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">
                                <span id="yourEmailLabel">您的電郵</span><span class="text-red-500">*</span>
                            </label>
                            <input type="email" id="contactEmail" required
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                        </div>

                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">
                                <span id="subjectLabel">主旨</span><span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="contactSubject" required
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                        </div>

                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">
                                <span id="contentLabel">內容</span><span class="text-red-500">*</span>
                            </label>
                            <textarea id="contactMessage" required rows="5"
                                      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 resize-none text-base"></textarea>
                        </div>

                        <button type="submit" class="w-full btn-primary">
                            <i class="fas fa-paper-plane mr-2"></i>
                            <span id="sendButtonText">發送訊息</span>
                        </button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- 登入模態框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-sign-in-alt mr-2 text-purple-600"></i>
                <span id="loginModalTitle">管理後台登入</span>
            </h2>

            <form id="loginForm" onsubmit="handleLogin(event); return false;">
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="usernameOrEmailLabel">用戶名</label>
                    <input type="text" id="loginUsername" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="請輸入用戶名">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="passwordLabel">密碼</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                </div>

                <div class="flex justify-between items-center mb-6">
                    <button type="button" onclick="showForgotPassword()" class="text-purple-600 hover:text-purple-700 text-sm" id="forgotPasswordBtn">
                        忘記密碼？
                    </button>
                    <button type="button" onclick="showForgotUsername()" class="text-purple-600 hover:text-purple-700 text-sm" id="forgotUsernameBtn">
                        忘記用戶名？
                    </button>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <span id="loginSubmitBtn">登入</span>
                    </button>
                    <button type="button" onclick="closeLoginModal()" class="flex-1 btn-secondary">
                        <span id="cancelBtn">取消</span>
                    </button>
                </div>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-2" id="noAccountText">還沒有帳號？</p>
                <button onclick="showRegisterModal()" class="text-purple-600 hover:text-purple-700 font-medium" id="registerLinkBtn">
                    立即註冊
                </button>
            </div>
        </div>
    </div>

    <!-- 註冊模態框 -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-user-plus mr-2 text-purple-600"></i>
                <span id="registerModalTitle">用戶註冊</span>
            </h2>

            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regUsernameLabel">用戶名</label>
                    <input type="text" id="registerUsername" required minlength="3"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="請設定用戶名（至少3個字符）">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regEmailLabel">電子郵件</label>
                    <input type="email" id="registerEmail" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="your@email.com">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regNameLabel">姓名</label>
                    <input type="text" id="registerName" required
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="regPasswordLabel">密碼</label>
                    <input type="password" id="registerPassword" required minlength="6"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="passwordHint">密碼至少需要 6 個字符</p>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <span id="registerSubmitBtn">發送驗證碼</span>
                    </button>
                    <button type="button" onclick="closeRegisterModal()" class="flex-1 btn-secondary">
                        <span id="regCancelBtn">取消</span>
                    </button>
                </div>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-2" id="hasAccountText">已有帳號？</p>
                <button onclick="showLoginModal()" class="text-purple-600 hover:text-purple-700 font-medium" id="loginLinkBtn">
                    立即登入
                </button>
            </div>
        </div>
    </div>

    <!-- 驗證碼模態框 -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-shield-alt mr-2 text-purple-600"></i>
                <span id="verificationModalTitle">郵箱驗證</span>
            </h2>

            <p class="mb-6 text-gray-600 dark:text-gray-400" id="verificationInstructions">
                我們已向您的郵箱發送了一個 6 位數驗證碼，請輸入以完成驗證。
            </p>

            <form id="verificationForm" onsubmit="handleVerification(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="verificationCodeLabel">驗證碼</label>
                    <input type="text" id="verificationCode" required maxlength="6" pattern="[0-9]{6}"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-center text-2xl tracking-widest text-base"
                           placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="codeExpiryText">驗證碼將在 10 分鐘後過期</p>

                    <!-- 收不到驗證碼提示 -->
                    <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <p class="text-xs text-blue-700 dark:text-blue-300">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="noCodeTip">收不到驗證碼？</span>
                        </p>
                        <ul class="text-xs text-blue-600 dark:text-blue-400 mt-2 ml-5 list-disc space-y-1">
                            <li id="checkSpamTip">請檢查垃圾郵件箱</li>
                            <li id="checkEmailTip">確認郵箱地址是否正確</li>
                            <li id="waitTip">等待幾分鐘後再試</li>
                            <li id="resendCodeTip">點擊下方「重新發送」按鈕</li>
                        </ul>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <span id="verifyBtn">驗證</span>
                    </button>
                    <button type="button" id="resendCodeButton" onclick="resendVerificationCode()" class="flex-1 btn-secondary">
                        <span id="resendBtn">重新發送</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 忘記密碼模態框 -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-key mr-2 text-purple-600"></i>
                <span id="forgotPasswordTitle">忘記密碼</span>
            </h2>

            <div id="forgotPasswordStep1">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="forgotPasswordInstructions">
                    請輸入您的註冊郵箱，我們將發送驗證碼到您的郵箱。
                </p>

                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fpEmailLabel">電子郵件</label>
                        <input type="email" id="forgotPasswordEmail" required
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                               placeholder="your@email.com">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="sendCodeBtn">發送驗證碼</span>
                        </button>
                        <button type="button" onclick="closeForgotPasswordModal()" class="flex-1 btn-secondary">
                            <span id="fpCancelBtn">取消</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="forgotPasswordStep2" style="display: none;">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="fpStep2Instructions">
                    請輸入發送到您郵箱的驗證碼和新密碼。
                </p>

                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fpCodeLabel">驗證碼</label>
                        <input type="text" id="resetPasswordCode" required maxlength="6" pattern="[0-9]{6}"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-center text-2xl tracking-widest text-base"
                               placeholder="000000">
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="newPasswordLabel">新密碼</label>
                        <input type="password" id="newPassword" required minlength="6"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="resetPasswordBtn">重設密碼</span>
                        </button>
                        <button type="button" onclick="closeForgotPasswordModal()" class="flex-1 btn-secondary">
                            <span id="fpStep2CancelBtn">取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 忘記用戶名模態框 -->
    <div id="forgotUsernameModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-user-circle mr-2 text-purple-600"></i>
                <span id="forgotUsernameTitle">忘記用戶名</span>
            </h2>

            <div id="forgotUsernameStep1">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="forgotUsernameInstructions">
                    請輸入您的註冊郵箱，我們將發送驗證碼和您的用戶名到您的郵箱。
                </p>

                <form id="forgotUsernameForm" onsubmit="handleForgotUsername(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fuEmailLabel">電子郵件</label>
                        <input type="email" id="forgotUsernameEmail" required
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                               placeholder="your@email.com">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="sendUsernameCodeBtn">發送驗證碼</span>
                        </button>
                        <button type="button" onclick="closeForgotUsernameModal()" class="flex-1 btn-secondary">
                            <span id="fuCancelBtn">取消</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="forgotUsernameStep2" style="display: none;">
                <p class="mb-6 text-gray-600 dark:text-gray-400" id="fuStep2Instructions">
                    請輸入發送到您郵箱的驗證碼，我們將顯示您的用戶名。
                </p>

                <form id="verifyUsernameForm" onsubmit="handleVerifyUsername(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="fuCodeLabel">驗證碼</label>
                        <input type="text" id="verifyUsernameCode" required maxlength="6" pattern="[0-9]{6}"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-center text-2xl tracking-widest text-base"
                               placeholder="000000">
                    </div>

                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 btn-primary">
                            <span id="verifyUsernameBtn">驗證並顯示</span>
                        </button>
                        <button type="button" onclick="closeForgotUsernameModal()" class="flex-1 btn-secondary">
                            <span id="fuStep2CancelBtn">取消</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="forgotUsernameStep3" style="display: none;">
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-2xl mr-3"></i>
                        <h3 class="text-lg font-bold text-green-800 dark:text-green-300" id="usernameFoundTitle">找到您的帳號</h3>
                    </div>
                    <div class="mb-2">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1" id="yourUsernameLabel">您的用戶名（電郵）：</p>
                        <p class="text-xl font-bold text-gray-800 dark:text-gray-200" id="displayFoundUsername"></p>
                    </div>
                </div>

                <button type="button" onclick="closeForgotUsernameModal(); showLoginModal();" class="w-full btn-primary">
                    <span id="backToLoginBtn">返回登入</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 設定用戶名模態框（首次登入必須設定） -->
    <div id="setUsernameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">
                <i class="fas fa-user-plus mr-2 text-purple-600"></i>
                <span id="setUsernameTitle">設定用戶名</span>
            </h2>

            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800 dark:text-blue-300" id="setUsernameNotice">
                    <i class="fas fa-info-circle mr-2"></i>
                    您的帳號尚未設定用戶名。請設定一個用戶名以繼續使用系統。
                </p>
            </div>

            <form id="setUsernameForm" onsubmit="handleSetUsername(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-base" id="suUsernameLabel">用戶名</label>
                    <input type="text" id="newUsername" required minlength="3" maxlength="20"
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base"
                           placeholder="請輸入用戶名（3-20個字符）">
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400" id="suUsernameHint">
                        用戶名可包含字母、數字、底線和連字號
                    </p>
                </div>

                <button type="submit" class="w-full btn-primary">
                    <span id="setUsernameBtn">設定用戶名</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // 多語言配置 (Inline - 原 translations.js)
        // ========================================
        const translations = window.translations || {
    'zh-TW': {nav: {home: '首頁', about: '關於我們', activities: '活動', projects: '專案', team: '團隊', contact: '聯絡我們', admin: '管理後台', login: '登入', register: '註冊', logout: '登出', title: '科技學會'}, messages: {loading: '載入中...', loginSuccess: '登入成功！', loginError: '登入失敗，請檢查郵箱和密碼', registerSuccess: '我們已收到你的註冊申請，管理員將會審批，並於三個工作天內，透過電郵回覆你', registerError: '註冊失敗，請稍後再試', verificationSent: '驗證碼已發送到您的郵箱', verificationError: '驗證碼錯誤或已過期', passwordResetError: '重設密碼失敗'}, hero: {title: '歡迎來到科技學會', subtitle: '探索科技，創造未來', viewActivities: '查看活動', joinUs: '加入我們'}, anthem: {title: '科技學會會歌', description: '聆聽我們的會歌，感受科技學會的精神與熱情'}, about: {title: '關於我們', innovation: '創新思維', innovationDesc: '培養創新精神，鼓勵成員探索前沿科技，挑戰傳統思維，開創新的可能性。', teamwork: '團隊協作', teamworkDesc: '打造互助學習的環境，通過團隊項目增進合作能力，共同成長進步。', knowledge: '知識分享', knowledgeDesc: '定期舉辦講座和工作坊，分享最新技術趨勢和實用技能，促進知識交流。'}, activities: {title: '近期活動', loading: '載入中...', empty: '目前沒有活動', learnMore: '了解更多'}, projects: {title: '精選專案', loading: '載入中...', empty: '目前沒有專案', status: {ongoing: '進行中', completed: '已完成', planned: '計劃中'}, members: '位成員參與', viewProject: '查看專案'}, team: {title: '核心團隊'}, contact: {title: '聯絡我們', name: '姓名', namePlaceholder: '請輸入您的姓名', email: '電子郵件', emailPlaceholder: 'your@email.com', subject: '主旨', subjectPlaceholder: '請輸入主旨', message: '訊息', messagePlaceholder: '請輸入您的訊息', send: '送出訊息', success: '我們已收到你訊息，並於三個工作天內透過電郵回覆你', sendMessageTitle: '發送訊息', yourEmail: '您的電郵', content: '內容', contentPlaceholder: '請輸入您的問題或建議...', sendButton: '發送訊息', emailLabel: '電子郵件', address: '地址', hours: '開放時間', hoursValue: '週一至週五 9:00-18:00', error: '發送失敗，請稍後再試'}, login: {title: '管理後台登入', subtitle: '請登入以繼續', username: '用戶名', usernameOrEmail: '用戶名', usernamePlaceholder: '請輸入用戶名', email: '電子郵件', emailPlaceholder: '請輸入電子郵件', password: '密碼', passwordPlaceholder: '請輸入密碼', loginBtn: '登入', forgotPassword: '忘記密碼？', forgotUsername: '忘記用戶名？', noAccount: '還沒有帳號？', registerNow: '立即註冊', error: '用戶名或密碼錯誤', pending: '您的帳號正在等待管理員審核'}, register: {title: '註冊新帳號', subtitle: '加入科技學會管理團隊', fullName: '真實姓名', fullNamePlaceholder: '請輸入您的真實姓名', username: '用戶名', usernamePlaceholder: '請設定用戶名', email: '電子郵件', emailPlaceholder: '請輸入電子郵件', password: '密碼', passwordPlaceholder: '請設定密碼（至少6位）', confirmPassword: '確認密碼', confirmPasswordPlaceholder: '請再次輸入密碼', registerBtn: '註冊', hasAccount: '已有帳號？', loginNow: '立即登入', success: '註冊成功！請等待管理員審核。', passwordMismatch: '兩次密碼輸入不一致', emailExists: '此電子郵件已被註冊'}, forgotPassword: {title: '重設密碼', subtitle: '我們會發送驗證碼到您的電子郵件', email: '電子郵件', emailPlaceholder: '請輸入註冊時使用的電子郵件', sendCode: '發送驗證碼', verificationCode: '驗證碼', verificationCodePlaceholder: '請輸入6位驗證碼', newPassword: '新密碼', newPasswordPlaceholder: '請設定新密碼', confirmPassword: '確認新密碼', confirmPasswordPlaceholder: '請再次輸入新密碼', resetPassword: '重設密碼', backToLogin: '返回登入', codeSent: '驗證碼已發送到您的郵箱', success: '密碼重設成功！', invalidCode: '驗證碼錯誤', emailNotFound: '找不到此電子郵件'}, forgotUsername: {title: '忘記用戶名', subtitle: '我們會發送驗證碼到您的電子郵件', email: '電子郵件', sendCode: '發送驗證碼', verificationCode: '驗證碼', verify: '驗證並顯示', found: '找到您的帳號', yourUsername: '您的用戶名（電郵）：', backToLogin: '返回登入', notRegistered: '此電子郵件尚未註冊，請先註冊帳號。'}, admin: {welcome: '歡迎回來', dashboard: '管理後台', returnFront: '返回前台', activities: '活動管理', projects: '專案管理', team: '團隊管理', users: '用戶管理', settings: '網站設置', add: '新增', edit: '編輯', delete: '刪除', save: '儲存', cancel: '取消', confirm: '確定', loading: '載入中...', empty: '暫無資料', deleteConfirm: '確定要刪除嗎？', success: '操作成功！', error: '操作失敗', activityTitle: '活動標題', activityDate: '活動日期', activityDescription: '活動描述', activityLink: '活動連結', projectTitle: '專案標題', projectStatus: '專案狀態', projectDescription: '專案描述', projectTechnologies: '使用技術', projectMembers: '參與成員數', projectLink: '專案連結', memberName: '成員姓名', memberPosition: '職位', memberBio: '個人簡介', memberAvatar: '頭像連結', memberGithub: 'GitHub 連結', memberEmail: '電子郵件', userName: '用戶名', userEmail: '電子郵件', userRole: '角色', userStatus: '狀態', approve: '批准', reject: '拒絕', pending: '待審核', approved: '已批准', rejected: '已拒絕', siteEmail: '聯絡郵箱', sitePhone: '聯絡電話', siteAddress: '地址', siteFacebook: 'Facebook', siteTwitter: 'Twitter', siteGithub: 'GitHub'}, common: {language: '語言', loading: '載入中...', error: '發生錯誤', success: '成功', confirm: '確定', cancel: '取消', save: '儲存', delete: '刪除', edit: '編輯', add: '新增', search: '搜尋', filter: '篩選', all: '全部'}},
    'zh-CN': {nav: {home: '首页', about: '关于我们', activities: '活动', projects: '项目', team: '团队', contact: '联系我们', admin: '管理后台', login: '登录', register: '注册', logout: '登出', title: '科技学会'}, messages: {loading: '加载中...', loginSuccess: '登录成功！', loginError: '登录失败，请检查邮箱和密码', registerSuccess: '我们已收到你的注册申请，管理员将会审批，并于三个工作日内，透过电邮回复你', registerError: '注册失败，请稍后再试', verificationSent: '验证码已发送到您的邮箱', verificationError: '验证码错误或已过期', passwordResetError: '重置密码失败'}, hero: {title: '欢迎来到科技学会', subtitle: '探索科技，创造未来', viewActivities: '查看活动', joinUs: '加入我们'}, anthem: {title: '科技学会会歌', description: '聆听我们的会歌，感受科技学会的精神与热情'}, about: {title: '关于我们', innovation: '创新思维', innovationDesc: '培养创新精神，鼓励成员探索前沿科技，挑战传统思维，开创新的可能性。', teamwork: '团队协作', teamworkDesc: '打造互助学习的环境，通过团队项目增进合作能力，共同成长进步。', knowledge: '知识分享', knowledgeDesc: '定期举办讲座和工作坊，分享最新技术趋势和实用技能，促进知识交流。'}, activities: {title: '近期活动', loading: '加载中...', empty: '目前没有活动', learnMore: '了解更多'}, projects: {title: '精选项目', loading: '加载中...', empty: '目前没有项目', status: {ongoing: '进行中', completed: '已完成', planned: '计划中'}, members: '位成员参与', viewProject: '查看项目'}, team: {title: '核心团队'}, contact: {title: '联系我们', name: '姓名', namePlaceholder: '请输入您的姓名', email: '电子邮件', emailPlaceholder: 'your@email.com', subject: '主题', subjectPlaceholder: '请输入主题', message: '消息', messagePlaceholder: '请输入您的消息', send: '发送消息', success: '我们已收到你讯息，并于三个工作日内透过电邮回复你', sendMessageTitle: '发送消息', yourEmail: '您的邮箱', content: '内容', contentPlaceholder: '请输入您的问题或建议...', sendButton: '发送消息', emailLabel: '电子邮件', address: '地址', hours: '开放时间', hoursValue: '周一至周五 9:00-18:00', error: '发送失败，请稍后再试'}, login: {title: '管理后台登录', subtitle: '请登录以继续', username: '用户名', usernameOrEmail: '用户名', usernamePlaceholder: '请输入用户名', email: '电子邮件', emailPlaceholder: '请输入电子邮件', password: '密码', passwordPlaceholder: '请输入密码', loginBtn: '登录', forgotPassword: '忘记密码？', forgotUsername: '忘记用户名？', noAccount: '还没有账号？', registerNow: '立即注册', error: '用户名或密码错误', pending: '您的账号正在等待管理员审核'}, register: {title: '注册新账号', subtitle: '加入科技学会管理团队', fullName: '真实姓名', fullNamePlaceholder: '请输入您的真实姓名', username: '用户名', usernamePlaceholder: '请设定用户名', email: '电子邮件', emailPlaceholder: '请输入电子邮件', password: '密码', passwordPlaceholder: '请设定密码（至少6位）', confirmPassword: '确认密码', confirmPasswordPlaceholder: '请再次输入密码', registerBtn: '注册', hasAccount: '已有账号？', loginNow: '立即登录', success: '注册成功！请等待管理员审核。', passwordMismatch: '两次密码输入不一致', emailExists: '此电子邮件已被注册'}, forgotPassword: {title: '重置密码', subtitle: '我们会发送验证码到您的电子邮件', email: '电子邮件', emailPlaceholder: '请输入注册时使用的电子邮件', sendCode: '发送验证码', verificationCode: '验证码', verificationCodePlaceholder: '请输入6位验证码', newPassword: '新密码', newPasswordPlaceholder: '请设定新密码', confirmPassword: '确认新密码', confirmPasswordPlaceholder: '请再次输入新密码', resetPassword: '重置密码', backToLogin: '返回登录', codeSent: '验证码已发送到您的邮箱', success: '密码重置成功！', invalidCode: '验证码错误', emailNotFound: '找不到此电子邮件'}, forgotUsername: {title: '忘记用户名', subtitle: '我们会发送验证码到您的电子邮件', email: '电子邮件', sendCode: '发送验证码', verificationCode: '验证码', verify: '验证并显示', found: '找到您的账号', yourUsername: '您的用户名（邮箱）：', backToLogin: '返回登录', notRegistered: '此电子邮件尚未注册，请先注册账号。'}, admin: {welcome: '欢迎回来', dashboard: '管理后台', returnFront: '返回前台', activities: '活动管理', projects: '项目管理', team: '团队管理', users: '用户管理', settings: '网站设置', add: '新增', edit: '编辑', delete: '删除', save: '保存', cancel: '取消', confirm: '确定', loading: '加载中...', empty: '暂无资料', deleteConfirm: '确定要删除吗？', success: '操作成功！', error: '操作失败', activityTitle: '活动标题', activityDate: '活动日期', activityDescription: '活动描述', activityLink: '活动链接', projectTitle: '项目标题', projectStatus: '项目状态', projectDescription: '项目描述', projectTechnologies: '使用技术', projectMembers: '参与成员数', projectLink: '项目链接', memberName: '成员姓名', memberPosition: '职位', memberBio: '个人简介', memberAvatar: '头像链接', memberGithub: 'GitHub 链接', memberEmail: '电子邮件', userName: '用户名', userEmail: '电子邮件', userRole: '角色', userStatus: '状态', approve: '批准', reject: '拒绝', pending: '待审核', approved: '已批准', rejected: '已拒绝', siteEmail: '联系邮箱', sitePhone: '联系电话', siteAddress: '地址', siteFacebook: 'Facebook', siteTwitter: 'Twitter', siteGithub: 'GitHub'}, common: {language: '语言', loading: '加载中...', error: '发生错误', success: '成功', confirm: '确定', cancel: '取消', save: '保存', delete: '删除', edit: '编辑', add: '新增', search: '搜索', filter: '筛选', all: '全部'}},
    'en': {nav: {home: 'Home', about: 'About', activities: 'Activities', projects: 'Projects', team: 'Team', contact: 'Contact', admin: 'Admin Panel', login: 'Login', register: 'Register', logout: 'Logout', title: 'Science and technology club'}, messages: {loading: 'Loading...', loginSuccess: 'Login successful!', loginError: 'Login failed, please check your email and password', registerSuccess: 'We have received your registration application. The administrator will review it and reply to you via email within three working days.', registerError: 'Registration failed, please try again later', verificationSent: 'Verification code sent to your email', verificationError: 'Verification code is incorrect or expired', passwordResetError: 'Password reset failed'}, hero: {title: 'Welcome to Science and technology club', subtitle: 'Explore Technology, Create Future', viewActivities: 'View Activities', joinUs: 'Join Us'}, anthem: {title: 'Science and Technology Club Anthem', description: 'Listen to our anthem and feel the spirit and passion of the Science and Technology Club'}, about: {title: 'About Us', innovation: 'Innovation', innovationDesc: 'Foster innovation, encourage members to explore cutting-edge technology, challenge traditional thinking, and create new possibilities.', teamwork: 'Teamwork', teamworkDesc: 'Build a collaborative learning environment, enhance cooperation through team projects, and grow together.', knowledge: 'Knowledge Sharing', knowledgeDesc: 'Regularly hold lectures and workshops, share latest technology trends and practical skills, promote knowledge exchange.'}, activities: {title: 'Recent Activities', loading: 'Loading...', empty: 'No activities available', learnMore: 'Learn More'}, projects: {title: 'Featured Projects', loading: 'Loading...', empty: 'No projects available', status: {ongoing: 'Ongoing', completed: 'Completed', planned: 'Planned'}, members: 'Members', viewProject: 'View Project'}, team: {title: 'Core Team'}, contact: {title: 'Contact Us', name: 'Name', namePlaceholder: 'Enter your name', email: 'Email', emailPlaceholder: 'your@email.com', subject: 'Subject', subjectPlaceholder: 'Enter subject', message: 'Message', messagePlaceholder: 'Enter your message', send: 'Send Message', success: 'We have received your message and will reply to you via email within three working days', sendMessageTitle: 'Send Message', yourEmail: 'Your Email', content: 'Content', contentPlaceholder: 'Please enter your questions or suggestions...', sendButton: 'Send Message', emailLabel: 'Email', address: 'Address', hours: 'Opening Hours', hoursValue: 'Monday - Friday 9:00-18:00', error: 'Failed to send, please try again later'}, login: {title: 'Admin Login', subtitle: 'Please login to continue', username: 'Username', usernameOrEmail: 'Username', usernamePlaceholder: 'Enter username', email: 'Email', emailPlaceholder: 'Enter email', password: 'Password', passwordPlaceholder: 'Enter password', loginBtn: 'Login', forgotPassword: 'Forgot Password?', forgotUsername: 'Forgot Username?', noAccount: "Don't have an account?", registerNow: 'Register Now', error: 'Invalid username or password', pending: 'Your account is pending admin approval'}, register: {title: 'Register New Account', subtitle: 'Join Science and technology club Management Team', fullName: 'Full Name', fullNamePlaceholder: 'Enter your full name', username: 'Username', usernamePlaceholder: 'Set your username', email: 'Email', emailPlaceholder: 'Enter email', password: 'Password', passwordPlaceholder: 'Set password (at least 6 characters)', confirmPassword: 'Confirm Password', confirmPasswordPlaceholder: 'Enter password again', registerBtn: 'Register', hasAccount: 'Already have an account?', loginNow: 'Login Now', success: 'Registration successful! Please wait for admin approval.', passwordMismatch: 'Passwords do not match', emailExists: 'This email is already registered'}, forgotPassword: {title: 'Reset Password', subtitle: 'We will send a verification code to your email', email: 'Email', emailPlaceholder: 'Enter your registered email', sendCode: 'Send Code', verificationCode: 'Verification Code', verificationCodePlaceholder: 'Enter 6-digit code', newPassword: 'New Password', newPasswordPlaceholder: 'Set new password', confirmPassword: 'Confirm Password', confirmPasswordPlaceholder: 'Enter new password again', resetPassword: 'Reset Password', backToLogin: 'Back to Login', codeSent: 'Verification code sent to your email', success: 'Password reset successful!', invalidCode: 'Invalid verification code', emailNotFound: 'Email not found'}, forgotUsername: {title: 'Forgot Username', subtitle: 'We will send a verification code to your email', email: 'Email', sendCode: 'Send Code', verificationCode: 'Verification Code', verify: 'Verify and Show', found: 'Account Found', yourUsername: 'Your Username (Email):', backToLogin: 'Back to Login', notRegistered: 'This email is not registered. Please register first.'}, admin: {welcome: 'Welcome back', dashboard: 'Admin Dashboard', returnFront: 'Return to Site', activities: 'Activities', projects: 'Projects', team: 'Team', users: 'Users', settings: 'Settings', add: 'Add', edit: 'Edit', delete: 'Delete', save: 'Save', cancel: 'Cancel', confirm: 'Confirm', loading: 'Loading...', empty: 'No data', deleteConfirm: 'Are you sure you want to delete?', success: 'Success!', error: 'Error occurred', activityTitle: 'Activity Title', activityDate: 'Activity Date', activityDescription: 'Description', activityLink: 'Link', projectTitle: 'Project Title', projectStatus: 'Status', projectDescription: 'Description', projectTechnologies: 'Technologies', projectMembers: 'Members', projectLink: 'Link', memberName: 'Name', memberPosition: 'Position', memberBio: 'Bio', memberAvatar: 'Avatar URL', memberGithub: 'GitHub', memberEmail: 'Email', userName: 'Username', userEmail: 'Email', userRole: 'Role', userStatus: 'Status', approve: 'Approve', reject: 'Reject', pending: 'Pending', approved: 'Approved', rejected: 'Rejected', siteEmail: 'Contact Email', sitePhone: 'Phone', siteAddress: 'Address', siteFacebook: 'Facebook', siteTwitter: 'Twitter', siteGithub: 'GitHub'}, common: {language: 'Language', loading: 'Loading...', error: 'Error', success: 'Success', confirm: 'Confirm', cancel: 'Cancel', save: 'Save', delete: 'Delete', edit: 'Edit', add: 'Add', search: 'Search', filter: 'Filter', all: 'All'}}
};

        // 語言切換工具
        class I18n {
            constructor() {
                this.currentLang = 'zh-TW';
            }
            setLanguage(lang) {
                if (translations[lang]) {
                    this.currentLang = lang;
                    document.documentElement.lang = lang;
                    return true;
                }
                return false;
            }
            t(key) {
                const keys = key.split('.');
                let value = translations[this.currentLang];
                for (const k of keys) {
                    if (value && value[k] !== undefined) {
                        value = value[k];
                    } else {
                        console.warn(`Translation key not found: ${key}`);
                        return key;
                    }
                }
                return value;
            }
            getCurrentLanguage() {
                return this.currentLang;
            }
            getAvailableLanguages() {
                return [
                    { code: 'zh-TW', name: '繁體中文' },
                    { code: 'zh-CN', name: '简体中文' },
                    { code: 'en', name: 'English' }
                ];
            }
        }

        // 導出供其他腳本使用
        if (typeof window !== 'undefined') {
            window.I18n = I18n;
            window.i18n = new I18n();
            console.log('✓ Translations loaded successfully (inline)');
        }

        // ========================================
        // 配置
        // ========================================
        // 版本: 2025-01-23 v4.5.5 - 新增單一裝置登入、自動登出、訪客限制排隊系統

        const firebaseConfig = {
            apiKey: "AIzaSyCCXmBJkesxRi3ufdCRucd5vcmg-Ls_3Ks",
            authDomain: "tech-society-566dc.firebaseapp.com",
            projectId: "tech-society-566dc",
            storageBucket: "tech-society-566dc.firebasestorage.app",
            messagingSenderId: "1098408063649",
            appId: "1:1098408063649:web:ec07e23e03c43f92c7f6e0",
            measurementId: "G-05127H92FQ"
        };

        const emailJSConfig = {
            publicKey: 'wSb5w9ZOF2-9HGCu1',
            serviceId: 'ats-科技學會',
            templates: {
                'zh-TW': 'template_nhcptbe',
                'en': 'template_34emldj'
            }
        };

        const SUPER_ADMIN_UID = 'vdNBS7qPdRV9qpV7CLgXwBflCf23';

        // 會話管理配置
        const SESSION_CONFIG = {
            inactivityTimeout: 1 * 60 * 1000, // 1分鐘無活動自動登出（毫秒）- 測試用，正式請改回 2 * 60 * 60 * 1000
            activityUpdateInterval: 10 * 1000, // 每10秒檢查一次（測試用，正式改回 60 * 1000）
            visitorHeartbeatInterval: 30 * 1000 // 每30秒更新一次訪客心跳
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 初始化 EmailJS
        emailjs.init(emailJSConfig.publicKey);

        // ========================================
        // 會話與訪客管理
        // ========================================

        let currentSessionId = null;
        let activityTimer = null;
        let lastActivityTime = Date.now();
        let visitorId = null;
        let visitorHeartbeatTimer = null;
        let isInQueue = false;

        // 生成唯一會話ID
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 生成訪客ID
        function generateVisitorId() {
            return 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 更新用戶活動時間（使用節流避免頻繁更新）
        let activityThrottleTimer = null;
        function updateActivityTime() {
            if (activityThrottleTimer) return; // 節流：每5秒最多更新一次
            activityThrottleTimer = setTimeout(() => {
                activityThrottleTimer = null;
            }, 5000);

            lastActivityTime = Date.now();
            console.log('[活動監控] 偵測到用戶活動，重置計時器');
        }

        // 檢查是否超時
        function checkInactivityTimeout() {
            const now = Date.now();
            const elapsed = now - lastActivityTime;
            const remaining = Math.max(0, SESSION_CONFIG.inactivityTimeout - elapsed);

            console.log(`[活動監控] 檢查超時 - 已閒置: ${Math.floor(elapsed/1000)}秒, 剩餘: ${Math.floor(remaining/1000)}秒`);

            if (elapsed >= SESSION_CONFIG.inactivityTimeout && auth.currentUser) {
                console.log('[活動監控] 用戶無活動超時，執行自動登出');
                stopActivityMonitoring(); // 停止監控避免重複觸發
                showToast({
                    'zh-TW': '您已超時無活動，系統已自動登出',
                    'zh-CN': '您已超时无活动，系统已自动登出',
                    'en': 'You have been logged out due to inactivity'
                }[i18n.currentLang] || '您已超時無活動，系統已自動登出');
                logout();
            }
        }

        // 開始活動監控
        function startActivityMonitoring() {
            // 重置最後活動時間
            lastActivityTime = Date.now();

            // 監聽用戶活動（只監聽明確的用戶操作，不監聽 mousemove）
            const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, updateActivityTime, { passive: true });
            });

            // 定期檢查超時
            if (activityTimer) {
                clearInterval(activityTimer);
            }
            activityTimer = setInterval(checkInactivityTimeout, SESSION_CONFIG.activityUpdateInterval);

            console.log('✓ 活動監控已啟動，超時時間:', SESSION_CONFIG.inactivityTimeout / 1000, '秒');
            console.log('✓ 檢查間隔:', SESSION_CONFIG.activityUpdateInterval / 1000, '秒');
        }

        // 停止活動監控
        function stopActivityMonitoring() {
            if (activityTimer) {
                clearInterval(activityTimer);
                activityTimer = null;
            }
        }

        // 創建會話
        async function createSession(userId) {
            const sessionId = generateSessionId();

            try {
                // 先檢查並清除其他會話
                const existingSessions = await db.collection('sessions')
                    .where('userId', '==', userId)
                    .where('active', '==', true)
                    .get();

                // 標記其他會話為非活躍
                const batch = db.batch();
                existingSessions.forEach(doc => {
                    batch.update(doc.ref, {
                        active: false,
                        endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        endReason: 'new_login'
                    });
                });
                await batch.commit();

                // 創建新會話
                await db.collection('sessions').doc(sessionId).set({
                    userId,
                    sessionId,
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    platform: navigator.platform || 'unknown'
                });

                currentSessionId = sessionId;
                console.log('✓ 新會話已創建:', sessionId);

                // 開始活動監控
                startActivityMonitoring();

                return sessionId;
            } catch (error) {
                console.error('創建會話失敗:', error);
                throw error;
            }
        }

        // 驗證會話
        async function validateSession(userId) {
            if (!currentSessionId) return false;

            try {
                const sessionDoc = await db.collection('sessions').doc(currentSessionId).get();

                if (!sessionDoc.exists) {
                    return false;
                }

                const sessionData = sessionDoc.data();

                // 檢查會話是否仍然有效
                if (!sessionData.active || sessionData.userId !== userId) {
                    return false;
                }

                // 更新最後活動時間
                await db.collection('sessions').doc(currentSessionId).update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });

                return true;
            } catch (error) {
                console.error('驗證會話失敗:', error);
                return false;
            }
        }

        // 結束會話
        async function endSession() {
            if (!currentSessionId) return;

            try {
                await db.collection('sessions').doc(currentSessionId).update({
                    active: false,
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    endReason: 'logout'
                });

                console.log('✓ 會話已結束:', currentSessionId);
            } catch (error) {
                console.error('結束會話失敗:', error);
            }

            currentSessionId = null;
            stopActivityMonitoring();
        }

        // 監聽會話變化（被其他裝置踢下線）
        function listenToSessionChanges(userId) {
            if (!currentSessionId) return;

            return db.collection('sessions').doc(currentSessionId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (!data.active && data.endReason === 'new_login') {
                            showToast({
                                'zh-TW': '您的帳號已在其他裝置登入，此裝置已被登出',
                                'zh-CN': '您的账号已在其他设备登录，此设备已被登出',
                                'en': 'Your account has logged in on another device. This device has been logged out.'
                            }[i18n.currentLang] || '您的帳號已在其他裝置登入');
                            auth.signOut();
                        }
                    }
                });
        }

        // ========================================
        // 訪客追蹤與排隊系統
        // ========================================

        // 註冊訪客
        async function registerVisitor() {
            visitorId = generateVisitorId();

            try {
                await db.collection('visitors').doc(visitorId).set({
                    visitorId,
                    enteredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
                    active: true,
                    userAgent: navigator.userAgent,
                    platform: navigator.platform || 'unknown'
                });

                // 記錄歷史訪問
                await db.collection('visit_history').add({
                    visitorId,
                    visitedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString().split('T')[0] // YYYY-MM-DD
                });

                // 開始心跳
                startVisitorHeartbeat();

                console.log('✓ 訪客已註冊:', visitorId);
                return visitorId;
            } catch (error) {
                console.error('註冊訪客失敗:', error);
                return null;
            }
        }

        // 訪客心跳
        function startVisitorHeartbeat() {
            if (visitorHeartbeatTimer) {
                clearInterval(visitorHeartbeatTimer);
            }

            visitorHeartbeatTimer = setInterval(async () => {
                if (visitorId) {
                    try {
                        await db.collection('visitors').doc(visitorId).update({
                            lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (error) {
                        console.error('更新訪客心跳失敗:', error);
                    }
                }
            }, SESSION_CONFIG.visitorHeartbeatInterval);
        }

        // 停止訪客心跳
        function stopVisitorHeartbeat() {
            if (visitorHeartbeatTimer) {
                clearInterval(visitorHeartbeatTimer);
                visitorHeartbeatTimer = null;
            }
        }

        // 訪客離開
        async function unregisterVisitor() {
            if (!visitorId) return;

            try {
                await db.collection('visitors').doc(visitorId).update({
                    active: false,
                    leftAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✓ 訪客已離開:', visitorId);
            } catch (error) {
                console.error('訪客離開記錄失敗:', error);
            }

            stopVisitorHeartbeat();
            visitorId = null;
        }

        // 獲取當前在線訪客數
        async function getOnlineVisitorCount() {
            try {
                // 計算1分鐘內有心跳的訪客為在線
                const oneMinuteAgo = new Date(Date.now() - 60000);
                const snapshot = await db.collection('visitors')
                    .where('active', '==', true)
                    .where('lastHeartbeat', '>', oneMinuteAgo)
                    .get();

                return snapshot.size;
            } catch (error) {
                console.error('獲取在線訪客數失敗:', error);
                return 0;
            }
        }

        // 獲取訪客限制設定
        async function getVisitorLimit() {
            try {
                const doc = await db.collection('settings').doc('visitor').get();
                if (doc.exists) {
                    return doc.data().maxVisitors || 0; // 0 表示無限制
                }
                return 0;
            } catch (error) {
                console.error('獲取訪客限制失敗:', error);
                return 0;
            }
        }

        // 檢查是否需要排隊
        async function checkQueue() {
            const limit = await getVisitorLimit();

            if (limit === 0) {
                // 無限制
                hideQueuePage();
                return false;
            }

            const currentCount = await getOnlineVisitorCount();

            if (currentCount >= limit) {
                showQueuePage(currentCount, limit);
                return true;
            } else {
                hideQueuePage();
                return false;
            }
        }

        // 顯示排隊頁面
        function showQueuePage(currentCount, limit) {
            isInQueue = true;

            let queuePage = document.getElementById('queuePage');
            if (!queuePage) {
                queuePage = document.createElement('div');
                queuePage.id = 'queuePage';
                queuePage.className = 'fixed inset-0 bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 z-[9999] flex items-center justify-center';
                queuePage.innerHTML = `
                    <div class="text-center text-white p-8 max-w-lg">
                        <div class="mb-8">
                            <i class="fas fa-users text-6xl mb-4 animate-pulse"></i>
                            <h1 class="text-3xl font-bold mb-4" id="queueTitle">網站訪客已滿</h1>
                            <p class="text-lg opacity-80 mb-6" id="queueMessage">
                                目前訪問人數已達上限，請稍候...
                            </p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6">
                            <p class="text-sm opacity-70 mb-2" id="queueStatusLabel">目前狀態</p>
                            <p class="text-2xl font-bold">
                                <span id="queueCurrentCount">${currentCount}</span> / <span id="queueLimit">${limit}</span>
                            </p>
                            <p class="text-sm opacity-70 mt-2" id="queueWaitingLabel">訪客數量</p>
                        </div>
                        <div class="flex items-center justify-center space-x-2 text-sm opacity-70">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            <span id="queueWaitText">系統會自動為您刷新...</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(queuePage);
            } else {
                document.getElementById('queueCurrentCount').textContent = currentCount;
                document.getElementById('queueLimit').textContent = limit;
                queuePage.style.display = 'flex';
            }

            // 更新多語言文字
            const texts = {
                'zh-TW': {
                    title: '網站訪客已滿',
                    message: '目前訪問人數已達上限，請稍候...',
                    statusLabel: '目前狀態',
                    waitingLabel: '訪客數量',
                    waitText: '系統會自動為您刷新...'
                },
                'zh-CN': {
                    title: '网站访客已满',
                    message: '目前访问人数已达上限，请稍候...',
                    statusLabel: '目前状态',
                    waitingLabel: '访客数量',
                    waitText: '系统会自动为您刷新...'
                },
                'en': {
                    title: 'Website at Full Capacity',
                    message: 'The maximum number of visitors has been reached. Please wait...',
                    statusLabel: 'Current Status',
                    waitingLabel: 'Visitor Count',
                    waitText: 'The system will automatically refresh for you...'
                }
            };

            const lang = texts[i18n.currentLang] || texts['zh-TW'];
            document.getElementById('queueTitle').textContent = lang.title;
            document.getElementById('queueMessage').textContent = lang.message;
            document.getElementById('queueStatusLabel').textContent = lang.statusLabel;
            document.getElementById('queueWaitingLabel').textContent = lang.waitingLabel;
            document.getElementById('queueWaitText').textContent = lang.waitText;

            // 每10秒重新檢查
            setTimeout(async () => {
                if (isInQueue) {
                    await checkQueue();
                }
            }, 10000);
        }

        // 隱藏排隊頁面
        function hideQueuePage() {
            isInQueue = false;
            const queuePage = document.getElementById('queuePage');
            if (queuePage) {
                queuePage.style.display = 'none';
            }
        }

        // 頁面卸載時清理
        window.addEventListener('beforeunload', () => {
            unregisterVisitor();
            if (currentSessionId) {
                // 使用 sendBeacon 確保資料能發送
                navigator.sendBeacon && navigator.sendBeacon('/api/cleanup', JSON.stringify({
                    sessionId: currentSessionId,
                    visitorId
                }));
            }
        });

        // ========================================
        // I18N 管理器
        // ========================================

        // 使用 translations.js 中已經創建的 i18n 實例
        const i18n = window.i18n;

        // ========================================
        // 主題管理
        // ========================================

        // 使用內存變量代替 localStorage
        let savedTheme = null;

        function initTheme() {
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (!savedTheme) {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            });
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            savedTheme = isDark ? 'dark' : 'light';
        }

        // ========================================
        // UI 輔助函數
        // ========================================

        function showLoading(message = null) {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (message) {
                text.textContent = message;
            } else {
                text.textContent = i18n.t('messages.loading');
            }
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('active');

            setTimeout(() => {
                toast.classList.remove('active');
            }, duration);
        }

        function showLoginModal() {
            closeRegisterModal();
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginForm').reset();
        }

        function showRegisterModal() {
            closeLoginModal();
            document.getElementById('registerModal').classList.add('active');
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
        }

        function showVerificationModal() {
            document.getElementById('verificationModal').classList.add('active');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.remove('active');
            document.getElementById('verificationForm').reset();
        }

        function showForgotPassword() {
            closeLoginModal();
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            document.getElementById('forgotPasswordStep2').style.display = 'none';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('forgotPasswordForm').reset();
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            document.getElementById('forgotPasswordStep2').style.display = 'none';
        }

        function showForgotUsername() {
            closeLoginModal();
            document.getElementById('forgotUsernameModal').classList.add('active');
            document.getElementById('forgotUsernameStep1').style.display = 'block';
            document.getElementById('forgotUsernameStep2').style.display = 'none';
            document.getElementById('forgotUsernameStep3').style.display = 'none';
        }

        function closeForgotUsernameModal() {
            document.getElementById('forgotUsernameModal').classList.remove('active');
            document.getElementById('forgotUsernameForm').reset();
            document.getElementById('verifyUsernameForm').reset();
            document.getElementById('forgotUsernameStep1').style.display = 'block';
            document.getElementById('forgotUsernameStep2').style.display = 'none';
            document.getElementById('forgotUsernameStep3').style.display = 'none';
        }

        function showSetUsernameModal() {
            const modal = document.getElementById('setUsernameModal');
            modal.style.display = 'flex';
            modal.classList.add('active');
        }

        function closeSetUsernameModal() {
            const modal = document.getElementById('setUsernameModal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            document.getElementById('setUsernameForm').reset();
        }

        // ========================================
        // 驗證碼管理
        // ========================================

        let currentVerificationData = null;

        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function sendVerificationEmail(email, code, purpose = 'register') {
            try {
                const lang = i18n.currentLang === 'zh-CN' ? 'zh-TW' : i18n.currentLang;
                const templateId = emailJSConfig.templates[lang];

                const templateParams = {
                    to_email: email,
                    user_name: email.split('@')[0],
                    verification_code: code,
                    site_name: i18n.t('nav.title')
                };

                await emailjs.send(
                    emailJSConfig.serviceId,
                    templateId,
                    templateParams
                );

                currentVerificationData = {
                    email,
                    code,
                    purpose,
                    timestamp: Date.now(),
                    expiresIn: 10 * 60 * 1000
                };

                return true;
            } catch (error) {
                console.error('Error sending verification email:', error);
                return false;
            }
        }

        function verifyCode(inputCode) {
            if (!currentVerificationData) {
                console.error('No verification data found');
                return false;
            }

            const now = Date.now();
            const elapsed = now - currentVerificationData.timestamp;

            console.log('Verification check:', {
                inputCode: inputCode,
                storedCode: currentVerificationData.code,
                elapsed: elapsed,
                expiresIn: currentVerificationData.expiresIn,
                expired: elapsed > currentVerificationData.expiresIn
            });

            // 檢查是否過期
            if (elapsed > currentVerificationData.expiresIn) {
                console.error('Verification code expired');
                showToast(i18n.t('messages.verificationError'));
                return false;
            }

            // 清理輸入：移除空格並轉換為字符串
            const cleanInput = String(inputCode).trim();
            const cleanStored = String(currentVerificationData.code).trim();

            console.log('Comparing codes:', {
                cleanInput: cleanInput,
                cleanStored: cleanStored,
                match: cleanInput === cleanStored
            });

            return cleanInput === cleanStored;
        }

        // ========================================
        // 身份驗證
        // ========================================

        let currentUser = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();

                    if (userData.status === 'pending') {
                        showToast('您的帳號正在等待管理員審核');
                        auth.signOut();
                        return;
                    } else if (userData.status === 'rejected') {
                        showToast('您的帳號已被拒絕');
                        auth.signOut();
                        return;
                    }

                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userMenu').style.display = 'block';
                    document.getElementById('userDisplayName').textContent = userData.name || user.email;

                    // 如果用戶已登入但沒有會話，創建會話並啟動活動監控
                    if (!currentSessionId) {
                        console.log('[自動登出測試] 偵測到已登入用戶，啟動活動監控');
                        await createSession(user.uid);
                        listenToSessionChanges(user.uid);
                    }
                } else {
                    auth.signOut();
                }
            } else {
                currentUser = null;
                currentSessionId = null;
                stopActivityMonitoring();
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('userMenu').style.display = 'none';
            }
        });

        async function handleLogin(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('=== Login form submitted on main site ===');

            const usernameOrEmail = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            console.log('Username or Email:', usernameOrEmail);

            showLoading();

            try {
                let email = usernameOrEmail;

                // 判斷輸入的是電郵還是用戶名（電郵包含@符號）
                const isEmail = usernameOrEmail.includes('@');

                if (!isEmail) {
                    // 如果不是電郵，根據用戶名查詢對應的電子郵件
                    console.log('Input is username, looking up email...');
                    const usersSnapshot = await db.collection('users').where('username', '==', usernameOrEmail).get();

                    if (usersSnapshot.empty) {
                        throw { code: 'auth/user-not-found', message: '用戶名不存在' };
                    }

                    // 獲取用戶的電子郵件
                    const userData = usersSnapshot.docs[0].data();
                    email = userData.email;
                    console.log('Found email for username:', email);
                } else {
                    console.log('Input is email, logging in directly...');
                }

                // 使用電子郵件和密碼登入
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 檢查用戶是否有設定用戶名
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();

                // 如果用戶沒有用戶名，要求設定
                if (!userData.username) {
                    console.log('User has no username, prompting to set...');
                    closeLoginModal();
                    showSetUsernameModal();
                    return;
                }

                // 創建新會話（單一裝置登入限制）
                await createSession(user.uid);

                // 監聽會話變化（被其他裝置踢下線）
                listenToSessionChanges(user.uid);

                closeLoginModal();
                showToast(i18n.t('messages.loginSuccess'));
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                // 根據不同的錯誤代碼顯示具體的錯誤訊息
                let errorMessage = '';

                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = {
                            'zh-TW': '用戶名不存在。請先註冊。',
                            'zh-CN': '用户名不存在。请先注册。',
                            'en': 'Username not found. Please register first.'
                        }[i18n.currentLang] || '用戶名不存在。';
                        break;

                    case 'auth/wrong-password':
                        errorMessage = {
                            'zh-TW': '密碼錯誤。請使用「忘記密碼？」重設密碼。',
                            'zh-CN': '密码错误。请使用「忘记密码？」重置密码。',
                            'en': 'Wrong password. Please use "Forgot Password?" to reset.'
                        }[i18n.currentLang] || '密碼錯誤。';
                        break;

                    case 'auth/invalid-email':
                        errorMessage = {
                            'zh-TW': '系統錯誤，請聯絡管理員。',
                            'zh-CN': '系统错误，请联系管理员。',
                            'en': 'System error, please contact admin.'
                        }[i18n.currentLang] || '系統錯誤。';
                        break;

                    case 'auth/user-disabled':
                        errorMessage = {
                            'zh-TW': '此帳號已被停用。請聯絡管理員。',
                            'zh-CN': '此账号已被停用。请联系管理员。',
                            'en': 'This account has been disabled. Please contact admin.'
                        }[i18n.currentLang] || '此帳號已被停用。';
                        break;

                    case 'auth/too-many-requests':
                        errorMessage = {
                            'zh-TW': '登入嘗試次數過多，請稍後再試。',
                            'zh-CN': '登录尝试次数过多，请稍后再试。',
                            'en': 'Too many login attempts. Please try again later.'
                        }[i18n.currentLang] || '登入嘗試次數過多。';
                        break;

                    case 'auth/network-request-failed':
                        errorMessage = {
                            'zh-TW': '網絡連接失敗，請檢查您的網絡連接。',
                            'zh-CN': '网络连接失败，请检查您的网络连接。',
                            'en': 'Network error. Please check your connection.'
                        }[i18n.currentLang] || '網絡連接失敗。';
                        break;

                    default:
                        errorMessage = i18n.t('messages.loginError') + ` (${error.code})`;
                }

                showToast(errorMessage);
            } finally {
                hideLoading();
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;

            showLoading();

            try {
                // 檢查用戶名是否已被使用
                const usernameCheck = await db.collection('users').where('username', '==', username).get();
                if (!usernameCheck.empty) {
                    hideLoading();
                    const errorMsg = {
                        'zh-TW': '此用戶名已被使用，請選擇其他用戶名。',
                        'zh-CN': '此用户名已被使用，请选择其他用户名。',
                        'en': 'This username is already taken. Please choose another one.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    return;
                }

                // 檢查電子郵件是否已被使用
                const emailCheck = await db.collection('users').where('email', '==', email).get();
                if (!emailCheck.empty) {
                    hideLoading();
                    const errorMsg = {
                        'zh-TW': '此電子郵件已被註冊。',
                        'zh-CN': '此电子邮件已被注册。',
                        'en': 'This email is already registered.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    return;
                }

                const code = generateVerificationCode();
                const emailSent = await sendVerificationEmail(email, code, 'register');

                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                currentVerificationData.registerData = { username, email, name, password };

                closeRegisterModal();
                showVerificationModal();
                showToast(i18n.t('messages.verificationSent'));
            } catch (error) {
                console.error('Registration error:', error);
                showToast(i18n.t('messages.registerError'));
            } finally {
                hideLoading();
            }
        }

        async function handleVerification(event) {
            event.preventDefault();

            const code = document.getElementById('verificationCode').value;

            if (!verifyCode(code)) {
                showToast(i18n.t('messages.verificationError'));
                return;
            }

            showLoading();

            try {
                const { username, email, name, password } = currentVerificationData.registerData;

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await db.collection('users').doc(user.uid).set({
                    username,
                    email,
                    name,
                    status: 'pending',
                    role: 'user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await auth.signOut();

                closeVerificationModal();
                showToast(i18n.t('messages.registerSuccess'));

                currentVerificationData = null;
            } catch (error) {
                console.error('Verification error:', error);
                showToast(i18n.t('messages.verificationError'));
            } finally {
                hideLoading();
            }
        }

        // 重新發送驗證碼冷卻時間（10分鐘 = 600000毫秒）
        let resendCooldown = null;
        let resendTimer = null;

        async function resendVerificationCode() {
            if (!currentVerificationData) {
                return;
            }

            const button = document.getElementById('resendCodeButton');
            const buttonText = document.getElementById('resendBtn');

            // 檢查冷卻時間
            if (resendCooldown && Date.now() < resendCooldown) {
                const remainingSeconds = Math.ceil((resendCooldown - Date.now()) / 1000);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                showToast(`請等待 ${minutes} 分 ${seconds} 秒後再重新發送`);
                return;
            }

            showLoading();

            const { email, purpose } = currentVerificationData;
            const newCode = generateVerificationCode();

            const sent = await sendVerificationEmail(email, newCode, purpose);

            hideLoading();

            if (sent) {
                showToast(i18n.t('messages.verificationSent'));

                // 設定10分鐘冷卻時間
                resendCooldown = Date.now() + 600000; // 10分鐘
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');

                // 清除之前的計時器
                if (resendTimer) {
                    clearInterval(resendTimer);
                }

                // 更新按鈕顯示倒計時
                resendTimer = setInterval(() => {
                    const remainingSeconds = Math.ceil((resendCooldown - Date.now()) / 1000);

                    if (remainingSeconds <= 0) {
                        clearInterval(resendTimer);
                        resendTimer = null;
                        resendCooldown = null;
                        button.disabled = false;
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                        buttonText.textContent = i18n.t('forgotPassword.sendCode') || '重新發送';
                    } else {
                        const minutes = Math.floor(remainingSeconds / 60);
                        const seconds = remainingSeconds % 60;
                        buttonText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            } else {
                showToast('發送失敗，請稍後再試');
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();

            const email = document.getElementById('forgotPasswordEmail').value;

            showLoading();

            try {
                const usersSnapshot = await db.collection('users').where('email', '==', email).get();

                if (usersSnapshot.empty) {
                    throw new Error('User not found');
                }

                const code = generateVerificationCode();
                const emailSent = await sendVerificationEmail(email, code, 'resetPassword');

                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                currentVerificationData.resetEmail = email;

                document.getElementById('forgotPasswordStep1').style.display = 'none';
                document.getElementById('forgotPasswordStep2').style.display = 'block';

                showToast(i18n.t('messages.verificationSent'));
            } catch (error) {
                console.error('Forgot password error:', error);
                showToast('用戶不存在或發送失敗');
            } finally {
                hideLoading();
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();

            const code = document.getElementById('resetPasswordCode').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!verifyCode(code)) {
                showToast(i18n.t('messages.verificationError'));
                return;
            }

            showLoading();

            try {
                const resetEmail = currentVerificationData.resetEmail;

                // 使用 Firebase Auth 重設密碼
                const user = auth.currentUser;
                if (user && user.email === resetEmail) {
                    await user.updatePassword(newPassword);
                    showToast('密碼重設成功！請使用新密碼登入。');
                } else {
                    // 如果用戶沒有登入，發送密碼重設郵件
                    await auth.sendPasswordResetEmail(resetEmail);
                    showToast('密碼重設連結已發送到您的郵箱，請查收。');
                }

                closeForgotPasswordModal();
                currentVerificationData = null;
            } catch (error) {
                console.error('Reset password error:', error);
                showToast(i18n.t('messages.passwordResetError'));
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // 忘記用戶名功能
        // ========================================

        async function handleForgotUsername(event) {
            event.preventDefault();

            const email = document.getElementById('forgotUsernameEmail').value;

            showLoading();

            try {
                // 檢查郵箱是否已註冊
                const usersSnapshot = await db.collection('users').where('email', '==', email).get();

                if (usersSnapshot.empty) {
                    hideLoading();
                    const errorMsg = {
                        'zh-TW': '此電子郵件尚未註冊，請先註冊帳號。',
                        'zh-CN': '此电子邮件尚未注册，请先注册账号。',
                        'en': 'This email is not registered. Please register first.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    return;
                }

                // 生成並發送驗證碼
                const code = generateVerificationCode();
                const emailSent = await sendVerificationEmail(email, code, 'forgotUsername');

                if (!emailSent) {
                    throw new Error('Failed to send verification email');
                }

                // 保存郵箱信息
                currentVerificationData.forgotUsernameEmail = email;

                document.getElementById('forgotUsernameStep1').style.display = 'none';
                document.getElementById('forgotUsernameStep2').style.display = 'block';

                showToast(i18n.t('messages.verificationSent'));
            } catch (error) {
                console.error('Forgot username error:', error);
                const errorMsg = {
                    'zh-TW': '發送失敗，請稍後再試',
                    'zh-CN': '发送失败，请稍后再试',
                    'en': 'Failed to send, please try again later'
                };
                showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
            } finally {
                hideLoading();
            }
        }

        async function handleVerifyUsername(event) {
            event.preventDefault();

            const code = document.getElementById('verifyUsernameCode').value;

            if (!verifyCode(code)) {
                showToast(i18n.t('messages.verificationError'));
                return;
            }

            showLoading();

            try {
                const email = currentVerificationData.forgotUsernameEmail;

                // 顯示用戶名（即為郵箱）
                document.getElementById('displayFoundUsername').textContent = email;

                document.getElementById('forgotUsernameStep2').style.display = 'none';
                document.getElementById('forgotUsernameStep3').style.display = 'block';

                currentVerificationData = null;
            } catch (error) {
                console.error('Verify username error:', error);
                showToast(i18n.t('messages.verificationError'));
            } finally {
                hideLoading();
            }
        }

        async function handleSetUsername(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value.trim();

            // 驗證用戶名格式
            const usernameRegex = /^[a-zA-Z0-9_-]{3,20}$/;
            if (!usernameRegex.test(username)) {
                const errorMsg = {
                    'zh-TW': '用戶名只能包含字母、數字、底線和連字號，長度為3-20個字符。',
                    'zh-CN': '用户名只能包含字母、数字、底线和连字号，长度为3-20个字符。',
                    'en': 'Username can only contain letters, numbers, underscores and hyphens, 3-20 characters long.'
                };
                showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                return;
            }

            showLoading();

            try {
                // 檢查用戶名是否已被使用
                const usernameCheck = await db.collection('users').where('username', '==', username).get();
                if (!usernameCheck.empty) {
                    const errorMsg = {
                        'zh-TW': '此用戶名已被使用，請選擇其他用戶名。',
                        'zh-CN': '此用户名已被使用，请选择其他用户名。',
                        'en': 'This username is already taken. Please choose another one.'
                    };
                    showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
                    hideLoading();
                    return;
                }

                // 更新當前用戶的用戶名
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('用戶未登入');
                }

                await db.collection('users').doc(user.uid).update({
                    username: username,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const successMsg = {
                    'zh-TW': '用戶名設定成功！',
                    'zh-CN': '用户名设定成功！',
                    'en': 'Username set successfully!'
                };
                showToast(successMsg[i18n.currentLang] || successMsg['zh-TW']);

                closeSetUsernameModal();

                // 重新載入頁面以更新用戶界面
                setTimeout(() => {
                    location.reload();
                }, 1000);

            } catch (error) {
                console.error('Set username error:', error);
                const errorMsg = {
                    'zh-TW': '設定用戶名失敗，請稍後再試。',
                    'zh-CN': '设定用户名失败，请稍后再试。',
                    'en': 'Failed to set username. Please try again later.'
                };
                showToast(errorMsg[i18n.currentLang] || errorMsg['zh-TW']);
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            // 結束會話
            await endSession();
            await auth.signOut();
            showToast('已登出');
        }

        function showAdminPanel() {
            window.location.href = 'admin.html';
        }

        // ========================================
        // 內容加載
        // ========================================

        async function loadHero() {
            try {
                const doc = await db.collection('settings').doc('hero').get();

                if (!doc.exists) {
                    console.log('Hero settings document does not exist');
                    return;
                }

                const data = doc.data();
                console.log('Hero data loaded:', data);
                console.log('Current language:', i18n.currentLang);

                // 更新 Hero 標題和副標題，根據當前語言選擇對應的文字
                const heroTitle = document.getElementById('heroTitle');
                const heroSubtitle = document.getElementById('heroSubtitle');

                // 將語言代碼轉換為後台使用的鍵名格式
                // 'zh-TW' -> 'zhTW', 'zh-CN' -> 'zhCN', 'en' -> 'en'
                const langKey = i18n.currentLang.replace(/-/g, '');
                console.log('Language key:', langKey);

                if (heroTitle && data.title) {
                    // 檢查 data.title 是否為物件
                    if (typeof data.title === 'object' && data.title !== null) {
                        // 嘗試按順序查找：當前語言 -> 繁體中文 -> 簡體中文 -> 英文
                        const title = data.title[langKey] || data.title.zhTW || data.title.zhCN || data.title.en || '';
                        console.log('Setting hero title to:', title);
                        // 只在有實際內容時才更新，否則保留 HTML 默認值
                        if (title && title.trim() !== '') {
                            heroTitle.textContent = title;
                        } else {
                            console.log('Hero title is empty, keeping default HTML value');
                        }
                    } else if (typeof data.title === 'string') {
                        // 舊格式：直接是字符串
                        console.log('Setting hero title (old format) to:', data.title);
                        if (data.title.trim() !== '') {
                            heroTitle.textContent = data.title;
                        }
                    }
                }

                if (heroSubtitle && data.subtitle) {
                    // 檢查 data.subtitle 是否為物件
                    if (typeof data.subtitle === 'object' && data.subtitle !== null) {
                        // 嘗試按順序查找：當前語言 -> 繁體中文 -> 簡體中文 -> 英文
                        const subtitle = data.subtitle[langKey] || data.subtitle.zhTW || data.subtitle.zhCN || data.subtitle.en || '';
                        console.log('Setting hero subtitle to:', subtitle);
                        // 只在有實際內容時才更新，否則保留 HTML 默認值
                        if (subtitle && subtitle.trim() !== '') {
                            heroSubtitle.textContent = subtitle;
                        } else {
                            console.log('Hero subtitle is empty, keeping default HTML value');
                        }
                    } else if (typeof data.subtitle === 'string') {
                        // 舊格式：直接是字符串
                        console.log('Setting hero subtitle (old format) to:', data.subtitle);
                        if (data.subtitle.trim() !== '') {
                            heroSubtitle.textContent = data.subtitle;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading hero settings:', error);
            }
        }

        async function loadAnthem() {
            try {
                const doc = await db.collection('settings').doc('anthem').get();

                const currentLang = i18n.currentLanguage;

                if (doc.exists) {
                    const data = doc.data();

                    // Load title based on language
                    const titleEl = document.getElementById('anthemTitle');
                    if (data[`title_${currentLang.replace('-', '_')}`]) {
                        titleEl.textContent = data[`title_${currentLang.replace('-', '_')}`];
                    }

                    // Load description based on language
                    const descEl = document.getElementById('anthemDescription');
                    if (data[`description_${currentLang.replace('-', '_')}`]) {
                        descEl.textContent = data[`description_${currentLang.replace('-', '_')}`];
                    }
                }
            } catch (error) {
                console.error('Error loading anthem settings:', error);
            }
        }

        async function loadContent() {
            await Promise.all([
                loadHero(),
                loadAnthem(),
                loadActivities(),
                loadProjects(),
                loadTeam(),
                loadContact()
            ]);
        }

        async function loadActivities() {
            try {
                const snapshot = await db.collection('activities')
                    .orderBy('createdAt', 'desc')
                    .limit(6)
                    .get();

                const container = document.getElementById('activitiesContainer');

                if (snapshot.empty) {
                    const emptyMessages = {
                        'zh-TW': '暫無活動',
                        'zh-CN': '暂无活动',
                        'en': 'No activities available'
                    };
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">${emptyMessages[i18n.currentLang] || emptyMessages['zh-TW']}</p>`;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();

                    // 將語言代碼轉換為鍵名格式（'zh-TW' -> 'zhTW'）
                    const langKey = i18n.currentLang.replace(/-/g, '');
                    console.log('Loading activity, langKey:', langKey, 'title data:', data.title);

                    // 獲取多語言字段（支持新舊格式）
                    const title = typeof data.title === 'string'
                        ? data.title
                        : (data.title?.[langKey] || data.title?.zhTW || data.title?.zhCN || data.title?.en || '');
                    const description = typeof data.description === 'string'
                        ? data.description
                        : (data.description?.[langKey] || data.description?.zhTW || data.description?.zhCN || data.description?.en || '');
                    const location = typeof data.location === 'string'
                        ? data.location
                        : (data.location?.[langKey] || data.location?.zhTW || data.location?.zhCN || data.location?.en || '');

                    console.log('Activity title:', title, 'description:', description);

                    // 處理日期
                    let date = '';
                    if (data.date) {
                        if (data.date.toDate) {
                            date = data.date.toDate().toLocaleDateString(i18n.currentLang);
                        } else if (typeof data.date === 'string') {
                            date = data.date;
                        }
                    }

                    return `
                        <div class="card fade-in">
                            <div class="mb-4">
                                ${date ? `
                                    <div class="text-sm text-purple-600 dark:text-purple-400 font-medium mb-2">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${date}
                                    </div>
                                ` : ''}
                                <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                                    ${title}
                                </h4>
                                <p class="text-gray-600 dark:text-gray-400">
                                    ${description}
                                </p>
                            </div>
                            ${location ? `
                                <div class="text-sm text-gray-500 dark:text-gray-500">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    ${location}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading activities:', error);
                const errorMessages = {
                    'zh-TW': '載入失敗',
                    'zh-CN': '加载失败',
                    'en': 'Loading failed'
                };
                document.getElementById('activitiesContainer').innerHTML =
                    `<p class="text-red-500 col-span-full text-center">${errorMessages[i18n.currentLang] || errorMessages['zh-TW']}</p>`;
            }
        }

        async function loadProjects() {
            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .limit(6)
                    .get();

                const container = document.getElementById('projectsContainer');

                if (snapshot.empty) {
                    const emptyMessages = {
                        'zh-TW': '暫無項目',
                        'zh-CN': '暂无项目',
                        'en': 'No projects available'
                    };
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">${emptyMessages[i18n.currentLang] || emptyMessages['zh-TW']}</p>`;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();

                    // 將語言代碼轉換為鍵名格式（'zh-TW' -> 'zhTW'）
                    const langKey = i18n.currentLang.replace(/-/g, '');
                    console.log('Loading project, langKey:', langKey, 'title data:', data.title);

                    // 獲取多語言字段（支持新舊格式）
                    const title = typeof data.title === 'string'
                        ? data.title
                        : (data.title?.[langKey] || data.title?.zhTW || data.title?.zhCN || data.title?.en || '');
                    const description = typeof data.description === 'string'
                        ? data.description
                        : (data.description?.[langKey] || data.description?.zhTW || data.description?.zhCN || data.description?.en || '');

                    console.log('Project title:', title, 'description:', description);

                    return `
                        <div class="card fade-in">
                            <div class="mb-4">
                                <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                                    ${title}
                                </h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">
                                    ${description}
                                </p>
                                ${data.technologies ? `
                                    <div class="flex flex-wrap gap-2">
                                        ${data.technologies.map(tech => `
                                            <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-xs rounded-full">
                                                ${tech}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading projects:', error);
                const errorMessages = {
                    'zh-TW': '載入失敗',
                    'zh-CN': '加载失败',
                    'en': 'Loading failed'
                };
                document.getElementById('projectsContainer').innerHTML =
                    `<p class="text-red-500 col-span-full text-center">${errorMessages[i18n.currentLang] || errorMessages['zh-TW']}</p>`;
            }
        }

        async function loadTeam() {
            try {
                const snapshot = await db.collection('team')
                    .orderBy('order', 'asc')
                    .get();

                const container = document.getElementById('teamContainer');

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">暫無團隊成員</p>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const nameField = `name_${i18n.currentLang.replace('-', '')}`;
                    const positionField = `position_${i18n.currentLang.replace('-', '')}`;

                    return `
                        <div class="card text-center fade-in">
                            <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-3xl font-bold">
                                ${(data[nameField] || data.name || '?')[0].toUpperCase()}
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-1">
                                ${data[nameField] || data.name || 'Unknown'}
                            </h4>
                            <p class="text-sm text-purple-600 dark:text-purple-400 mb-3">
                                ${data[positionField] || data.position || ''}
                            </p>
                            ${data.email ? `
                                <a href="mailto:${data.email}" class="text-gray-500 hover:text-purple-600 dark:text-gray-400 dark:hover:text-purple-400 text-sm">
                                    <i class="fas fa-envelope"></i>
                                </a>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading team:', error);
                document.getElementById('teamContainer').innerHTML =
                    '<p class="text-red-500 col-span-full text-center">載入失敗</p>';
            }
        }

        async function loadContact() {
            try {
                const doc = await db.collection('settings').doc('contact').get();

                const container = document.getElementById('contactInfo');

                if (!doc.exists) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">暫無聯絡信息</p>';
                    return;
                }

                const data = doc.data();

                container.innerHTML = `
                    <div class="space-y-4 text-left">
                        ${data.address ? `
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-map-marker-alt text-purple-600 dark:text-purple-400 mt-1"></i>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-200">地址</p>
                                    <p class="text-gray-600 dark:text-gray-400">${data.address}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${data.phone ? `
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-phone text-purple-600 dark:text-purple-400 mt-1"></i>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-200">電話</p>
                                    <a href="tel:${data.phone}" class="text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300">
                                        ${data.phone}
                                    </a>
                                </div>
                            </div>
                        ` : ''}

                        ${data.email ? `
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-envelope text-purple-600 dark:text-purple-400 mt-1"></i>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-200">郵箱</p>
                                    <a href="mailto:${data.email}" class="text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300">
                                        ${data.email}
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading contact:', error);
                document.getElementById('contactInfo').innerHTML =
                    '<p class="text-red-500">載入失敗</p>';
            }
        }

        // ========================================
        // 聯絡表單
        // ========================================

        async function handleContactSubmit(event) {
            event.preventDefault();

            const email = document.getElementById('contactEmail').value;
            const subject = document.getElementById('contactSubject').value;
            const message = document.getElementById('contactMessage').value;

            showLoading();

            try {
                await db.collection('contact_submissions').add({
                    email,
                    subject,
                    message,
                    status: 'unread',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    repliedAt: null,
                    reply: null
                });

                document.getElementById('contactForm').reset();
                showToast(i18n.t('contact.success'));
            } catch (error) {
                console.error('Error submitting contact form:', error);
                showToast(i18n.t('contact.error'));
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // 語言切換
        // ========================================

        function updateLanguage() {
            // 更新導航欄
            const titleMap = {
                'zh-TW': '科技學會',
                'zh-CN': '科技学会',
                'en': 'Science and technology club'
            };
            const navTitleElement = document.getElementById('navTitle');
            if (navTitleElement) {
                const titleText = titleMap[i18n.currentLang] || '科技學會';
                console.log('Setting navTitle to:', titleText);
                navTitleElement.textContent = titleText;
            } else {
                console.error('navTitle element not found!');
            }

            document.getElementById('loginBtnText').textContent = i18n.t('nav.login');
            document.getElementById('adminPanelText').textContent = i18n.t('nav.admin');
            document.getElementById('logoutText').textContent = i18n.t('nav.logout');

            // Hero 區塊會由 loadHero() 函數從後台設置載入，所以這裡不需要設定
            // 會歌區塊會由 loadAnthem() 函數從後台設置載入
            loadAnthem();

            // 更新區塊標題
            console.log('Updating section titles, current language:', i18n.currentLang);
            console.log('activities.title translation:', i18n.t('activities.title'));
            console.log('projects.title translation:', i18n.t('projects.title'));

            document.getElementById('activitiesTitle').textContent = i18n.t('activities.title');
            document.getElementById('projectsTitle').textContent = i18n.t('projects.title');
            document.getElementById('teamTitle').textContent = i18n.t('team.title');
            document.getElementById('contactTitle').textContent = i18n.t('contact.title');

            // 更新聯絡表單
            document.getElementById('sendMessageTitle').textContent = i18n.t('contact.sendMessageTitle');
            document.getElementById('yourEmailLabel').textContent = i18n.t('contact.yourEmail');
            document.getElementById('subjectLabel').textContent = i18n.t('contact.subject');
            document.getElementById('contentLabel').textContent = i18n.t('contact.content');
            document.getElementById('sendButtonText').textContent = i18n.t('contact.sendButton');

            // 更新 placeholder
            document.getElementById('contactEmail').placeholder = i18n.t('contact.emailPlaceholder');
            document.getElementById('contactSubject').placeholder = i18n.t('contact.subjectPlaceholder');
            document.getElementById('contactMessage').placeholder = i18n.t('contact.contentPlaceholder');

            // 更新登入模態框
            document.getElementById('loginModalTitle').textContent = i18n.t('login.title');
            document.getElementById('usernameOrEmailLabel').textContent = i18n.t('login.usernameOrEmail');
            document.getElementById('passwordLabel').textContent = i18n.t('login.password');
            document.getElementById('forgotPasswordBtn').textContent = i18n.t('login.forgotPassword');
            document.getElementById('loginSubmitBtn').textContent = i18n.t('login.loginBtn');
            document.getElementById('cancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('noAccountText').textContent = i18n.t('login.noAccount');
            document.getElementById('registerLinkBtn').textContent = i18n.t('login.registerNow');

            // 更新註冊模態框
            document.getElementById('registerModalTitle').textContent = i18n.t('register.title');
            document.getElementById('regUsernameLabel').textContent = i18n.t('register.username');
            document.getElementById('regEmailLabel').textContent = i18n.t('register.email');
            document.getElementById('regNameLabel').textContent = i18n.t('register.fullName');
            document.getElementById('regPasswordLabel').textContent = i18n.t('register.password');
            document.getElementById('passwordHint').textContent = i18n.t('register.passwordPlaceholder');
            document.getElementById('registerSubmitBtn').textContent = i18n.t('common.confirm');
            document.getElementById('regCancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('hasAccountText').textContent = i18n.t('register.hasAccount');
            document.getElementById('loginLinkBtn').textContent = i18n.t('register.loginNow');

            // 更新驗證碼模態框
            document.getElementById('verificationModalTitle').textContent = i18n.t('forgotPassword.verificationCode');
            document.getElementById('verificationInstructions').textContent = '我們已向您的郵箱發送了一個 6 位數驗證碼，請輸入以完成驗證。';
            document.getElementById('verificationCodeLabel').textContent = i18n.t('forgotPassword.verificationCode');
            document.getElementById('codeExpiryText').textContent = '驗證碼將在 10 分鐘後過期';
            document.getElementById('verifyBtn').textContent = i18n.t('common.confirm');
            document.getElementById('resendBtn').textContent = '重新發送';

            // 更新忘記密碼模態框
            document.getElementById('forgotPasswordTitle').textContent = i18n.t('forgotPassword.title');
            document.getElementById('forgotPasswordInstructions').textContent = i18n.t('forgotPassword.subtitle');
            document.getElementById('fpEmailLabel').textContent = i18n.t('forgotPassword.email');
            document.getElementById('sendCodeBtn').textContent = i18n.t('forgotPassword.sendCode');
            document.getElementById('fpCancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('fpStep2Instructions').textContent = '請輸入發送到您郵箱的驗證碼和新密碼。';
            document.getElementById('fpCodeLabel').textContent = i18n.t('forgotPassword.verificationCode');
            document.getElementById('newPasswordLabel').textContent = i18n.t('forgotPassword.newPassword');
            document.getElementById('resetPasswordBtn').textContent = i18n.t('forgotPassword.resetPassword');
            document.getElementById('fpStep2CancelBtn').textContent = i18n.t('common.cancel');

            // 更新忘記用戶名模態框
            document.getElementById('forgotUsernameTitle').textContent = i18n.t('forgotUsername.title');
            document.getElementById('forgotUsernameInstructions').textContent = i18n.t('forgotUsername.subtitle');
            document.getElementById('fuEmailLabel').textContent = i18n.t('forgotUsername.email');
            document.getElementById('sendUsernameCodeBtn').textContent = i18n.t('forgotUsername.sendCode');
            document.getElementById('fuCancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('fuStep2Instructions').textContent = '請輸入發送到您郵箱的驗證碼，我們將顯示您的用戶名。';
            document.getElementById('fuCodeLabel').textContent = i18n.t('forgotUsername.verificationCode');
            document.getElementById('verifyUsernameBtn').textContent = i18n.t('forgotUsername.verify');
            document.getElementById('fuStep2CancelBtn').textContent = i18n.t('common.cancel');
            document.getElementById('usernameFoundTitle').textContent = i18n.t('forgotUsername.found');
            document.getElementById('yourUsernameLabel').textContent = i18n.t('forgotUsername.yourUsername');
            document.getElementById('backToLoginBtn').textContent = i18n.t('forgotUsername.backToLogin');
            document.getElementById('forgotUsernameBtn').textContent = i18n.t('login.forgotUsername');

            // 更新設定用戶名模態框
            const setUsernameTitle = document.getElementById('setUsernameTitle');
            const setUsernameNotice = document.getElementById('setUsernameNotice');
            const suUsernameLabel = document.getElementById('suUsernameLabel');
            const suUsernameHint = document.getElementById('suUsernameHint');
            const setUsernameBtn = document.getElementById('setUsernameBtn');

            if (setUsernameTitle) {
                const titleTexts = {
                    'zh-TW': '設定用戶名',
                    'zh-CN': '设定用户名',
                    'en': 'Set Username'
                };
                setUsernameTitle.textContent = titleTexts[i18n.currentLang] || titleTexts['zh-TW'];
            }

            if (setUsernameNotice) {
                const noticeTexts = {
                    'zh-TW': '您的帳號尚未設定用戶名。請設定一個用戶名以繼續使用系統。',
                    'zh-CN': '您的账号尚未设定用户名。请设定一个用户名以继续使用系统。',
                    'en': 'Your account does not have a username yet. Please set a username to continue using the system.'
                };
                setUsernameNotice.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${noticeTexts[i18n.currentLang] || noticeTexts['zh-TW']}`;
            }

            if (suUsernameLabel) {
                const labelTexts = {
                    'zh-TW': '用戶名',
                    'zh-CN': '用户名',
                    'en': 'Username'
                };
                suUsernameLabel.textContent = labelTexts[i18n.currentLang] || labelTexts['zh-TW'];
            }

            if (suUsernameHint) {
                const hintTexts = {
                    'zh-TW': '用戶名可包含字母、數字、底線和連字號',
                    'zh-CN': '用户名可包含字母、数字、底线和连字号',
                    'en': 'Username can contain letters, numbers, underscores and hyphens'
                };
                suUsernameHint.textContent = hintTexts[i18n.currentLang] || hintTexts['zh-TW'];
            }

            if (setUsernameBtn) {
                const btnTexts = {
                    'zh-TW': '設定用戶名',
                    'zh-CN': '设定用户名',
                    'en': 'Set Username'
                };
                setUsernameBtn.textContent = btnTexts[i18n.currentLang] || btnTexts['zh-TW'];
            }

            // 重新加載內容
            loadContent();
        }

        // ========================================
        // 初始化
        // ========================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== DOM Content Loaded ===');
            console.log('i18n object:', window.i18n);
            console.log('Current language:', i18n.currentLang);

            // 註冊訪客並檢查排隊
            await registerVisitor();
            const needsQueue = await checkQueue();

            if (!needsQueue) {
                // 正常載入頁面
                console.log('✓ 訪客已進入網站');
            }

            // 同步語言選擇器的值
            const languageSelector = document.getElementById('languageSelector');
            const loginBtn = document.getElementById('loginBtn');
            const userMenuBtn = document.getElementById('userMenuBtn');

            console.log('languageSelector element:', languageSelector);
            console.log('loginBtn element:', loginBtn);
            console.log('userMenuBtn element:', userMenuBtn);

            if (languageSelector) {
                languageSelector.value = i18n.currentLang;

                // 綁定語言選擇器change事件
                languageSelector.addEventListener('change', (e) => {
                    console.log('Language changed to:', e.target.value);
                    i18n.setLanguage(e.target.value);
                    updateLanguage();
                });
                console.log('✓ Language selector event listener attached');
            } else {
                console.error('✗ languageSelector element not found!');
            }

            // 綁定登入按鈕點擊事件
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    console.log('Login button clicked!');
                    showLoginModal();
                });
                console.log('✓ Login button event listener attached');
            } else {
                console.error('✗ loginBtn element not found!');
            }

            // 綁定用戶菜單點擊事件
            if (userMenuBtn) {
                userMenuBtn.addEventListener('click', () => {
                    console.log('User menu button clicked!');
                    document.getElementById('userDropdown').classList.toggle('hidden');
                });
                console.log('✓ User menu button event listener attached');
            }

            // 點擊外部關閉用戶菜單
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenu');
                if (userMenu && !userMenu.contains(e.target)) {
                    document.getElementById('userDropdown').classList.add('hidden');
                }
            });

            console.log('Initializing theme...');
            initTheme();

            console.log('Updating language...');
            updateLanguage();

            console.log('Loading content...');
            loadContent();

            console.log('=== Initialization Complete ===');
        });
    </script>

    <!-- 版本號顯示 -->
    <div class="fixed bottom-2 right-2 text-xs text-white bg-red-500 px-3 py-1 rounded-full shadow-sm">
        v4.5.5 - 前台 (測試版 - 1分鐘自動登出)
    </div>
</body>
</html>
