<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科技學會管理後台 | Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4a49b8',
                    }
                }
            }
        }
    </script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#181818] text-gray-900 dark:text-gray-100">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg max-w-md w-full">
            <div class="text-center mb-8">
                <svg class="w-16 h-16 mx-auto mb-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <h1 class="text-2xl font-bold">科技學會管理後台</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">請登入以繼續</p>
            </div>

            <form id="loginForm" onsubmit="return handleLogin(event)" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-semibold mb-2">用戶名</label>
                    <input type="text" id="loginEmail" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent outline-none" placeholder="請輸入用戶名" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-semibold mb-2">密碼</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent outline-none" placeholder="請輸入密碼" required>
                </div>
                <button type="submit" id="loginBtn" class="w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                    登入
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40">
            <div class="px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <div>
                        <h1 class="text-xl font-bold">科技學會管理後台</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">歡迎回來，<span id="currentUser"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">返回前台</a>
                    <button id="logoutBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                        登出
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside class="w-64 bg-white dark:bg-gray-800 min-h-screen shadow-sm">
                <nav class="p-4 space-y-2">
                    <button data-section="activities" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>活動管理</span>
                    </button>
                    <button data-section="projects" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <span>專案管理</span>
                    </button>
                    <button data-section="team" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>團隊管理</span>
                    </button>
                    <button data-section="contacts" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3 relative">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span>聯絡訊息</span>
                        <span id="unreadContactsBadge" class="hidden absolute right-2 top-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full min-w-[20px] text-center">0</span>
                    </button>
                    <button data-section="users" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <span>用戶管理</span>
                    </button>
                    <button data-section="hero" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                        </svg>
                        <span>首頁標語</span>
                    </button>
                    <button data-section="announcements" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                        </svg>
                        <span>最新訊息</span>
                    </button>
                    <button data-section="contactSettings" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>聯絡設置</span>
                    </button>
                    <button data-section="anthemSettings" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        <span>會歌設置</span>
                    </button>
                    <button data-section="visitorStats" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>訪客統計</span>
                    </button>
                    <button data-section="profile" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span>個人資料</span>
                    </button>

                    <!-- 分隔線 -->
                    <div class="border-t border-gray-200 dark:border-gray-700 my-3"></div>
                    <p class="px-4 text-xs text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-wider mb-2">進階功能</p>

                    <button data-section="memberProfiles" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>會員檔案</span>
                    </button>
                    <button data-section="pointsSystem" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>積分系統</span>
                    </button>
                    <button data-section="achievements" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                        <span>成就徽章</span>
                    </button>
                    <button data-section="eventRegistration" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <span>活動報名</span>
                    </button>
                    <button data-section="qrCheckin" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        <span>QR簽到</span>
                    </button>
                    <button data-section="calendarView" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>行事曆</span>
                    </button>
                    <button data-section="votingSystem" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span>投票系統</span>
                    </button>
                    <button data-section="surveys" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>問卷調查</span>
                    </button>
                    <button data-section="resourceBooking" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <span>資源預約</span>
                    </button>
                    <button data-section="notificationCenter" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <span>通知中心</span>
                    </button>
                    <button data-section="forum" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path>
                        </svg>
                        <span>討論區</span>
                    </button>
                    <button data-section="photoGallery" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>活動相簿</span>
                    </button>
                    <button data-section="executives" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <span>幹部管理</span>
                    </button>
                    <button data-section="finance" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>財務管理</span>
                    </button>
                    <button data-section="guestbook" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                        <span>訪客留言</span>
                    </button>
                    <button data-section="faq" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>常見問題</span>
                    </button>
                    <button data-section="quickNotes" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span>快速筆記</span>
                    </button>
                    <button data-section="todoList" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <span>待辦事項</span>
                    </button>
                    <button data-section="maintenance" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>維護模式</span>
                    </button>
                    <button data-section="themeSettings" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                        </svg>
                        <span>主題設置</span>
                    </button>

                    <!-- 分隔線 - 更多功能 -->
                    <div class="border-t border-gray-200 dark:border-gray-700 my-3"></div>
                    <p class="px-4 text-xs text-gray-500 dark:text-gray-400 font-semibold uppercase tracking-wider mb-2">更多功能</p>

                    <button data-section="emailTemplates" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span>郵件模板</span>
                    </button>
                    <button data-section="socialLinks" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        <span>社群連結</span>
                    </button>
                    <button data-section="meetingMinutes" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>會議記錄</span>
                    </button>
                    <button data-section="documentLibrary" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>文件庫</span>
                    </button>
                    <button data-section="learningResources" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        <span>教學資源</span>
                    </button>
                    <button data-section="projectTracker" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                        </svg>
                        <span>專案追蹤</span>
                    </button>
                    <button data-section="teamGroups" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>小組管理</span>
                    </button>
                    <button data-section="attendanceRecords" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span>考勤記錄</span>
                    </button>
                    <button data-section="rewardsPenalties" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <span>獎懲記錄</span>
                    </button>
                    <button data-section="sponsors" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <span>贊助商</span>
                    </button>
                    <button data-section="partners" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span>合作夥伴</span>
                    </button>
                    <button data-section="competitions" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <span>比賽記錄</span>
                    </button>
                    <button data-section="certificates" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                        <span>證書生成</span>
                    </button>
                    <button data-section="bugReports" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <span>問題回報</span>
                    </button>
                    <button data-section="suggestionBox" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <span>意見箱</span>
                    </button>
                    <button data-section="knowledgeBase" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        <span>知識庫</span>
                    </button>
                    <button data-section="tagManagement" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        <span>標籤管理</span>
                    </button>
                    <button data-section="dataExport" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span>數據匯出</span>
                    </button>
                    <button data-section="systemLogs" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>系統日誌</span>
                    </button>
                    <button data-section="backupRestore" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                        </svg>
                        <span>備份還原</span>
                    </button>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Activities Section -->
                <div id="activitiesSection" class="section">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">活動管理</h2>
                            <button id="addActivityBtn" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                + 新增活動
                            </button>
                        </div>

                        <!-- Activities List -->
                        <div id="activitiesLoading" class="flex justify-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                        <div id="activitiesList" class="space-y-4 hidden"></div>
                        <div id="activitiesEmptyState" class="text-center py-12 hidden">
                            <p class="text-gray-500 dark:text-gray-400">暫無活動資料</p>
                        </div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div id="projectsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">專案管理</h2>
                            <button id="addProjectBtn" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                + 新增專案
                            </button>
                        </div>

                        <!-- Projects List -->
                        <div id="projectsLoading" class="flex justify-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                        <div id="projectsList" class="space-y-4 hidden"></div>
                        <div id="projectsEmptyState" class="text-center py-12 hidden">
                            <p class="text-gray-500 dark:text-gray-400">暫無專案資料</p>
                        </div>
                    </div>
                </div>

                <!-- Team Section -->
                <div id="teamSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">團隊管理</h2>
                            <button id="addTeamMemberBtn" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                + 新增成員
                            </button>
                        </div>

                        <!-- Team Members List -->
                        <div id="teamList" class="space-y-4">
                            <!-- Team members will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Contacts Section -->
                <div id="contactsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">聯絡訊息</h2>
                            <div class="flex space-x-2 items-center">
                                <button onclick="filterContacts('all')" class="filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    全部
                                </button>
                                <button onclick="filterContacts('unread')" class="filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    未讀
                                </button>
                                <button onclick="filterContacts('replied')" class="filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    已回覆
                                </button>
                                <span class="border-l border-gray-300 dark:border-gray-600 h-6 mx-2"></span>
                                <button onclick="deleteAllContacts()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                    全部刪除
                                </button>
                            </div>
                        </div>

                        <!-- Contacts List -->
                        <div id="contactsLoading" class="flex justify-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                        <div id="contactsList" class="space-y-4 hidden"></div>
                        <div id="contactsEmptyState" class="text-center py-12 hidden">
                            <p class="text-gray-500 dark:text-gray-400">暫無聯絡訊息</p>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="usersSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">用戶管理</h2>
                            <div class="flex space-x-2">
                                <button id="addUserBtn" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                    + 新增用戶
                                </button>
                                <button onclick="filterUsers('all')" class="user-filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    全部
                                </button>
                                <button onclick="filterUsers('admin')" class="user-filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    管理員
                                </button>
                                <button onclick="filterUsers('user')" class="user-filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    普通用戶
                                </button>
                                <button onclick="filterUsers('pending')" class="user-filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    待審核
                                </button>
                                <button onclick="filterUsers('approved')" class="user-filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    已批准
                                </button>
                                <button onclick="filterUsers('rejected')" class="user-filter-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                    已拒絕
                                </button>
                            </div>
                        </div>

                        <!-- Users List -->
                        <div id="usersLoading" class="flex justify-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                        <div id="usersList" class="space-y-4 hidden"></div>
                        <div id="usersEmptyState" class="text-center py-12 hidden">
                            <p class="text-gray-500 dark:text-gray-400">暫無用戶資料</p>
                        </div>
                    </div>
                </div>

                <!-- Hero Section -->
                <div id="heroSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">首頁標語設置</h2>
                        </div>

                        <form id="heroForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold mb-2">主標題（繁體中文）</label>
                                <input type="text" id="heroTitleZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="歡迎來到科技學會">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">副標題（繁體中文）</label>
                                <input type="text" id="heroSubtitleZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="探索科技，創新未來">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">主標題（簡體中文）</label>
                                <input type="text" id="heroTitleZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="欢迎来到科技学会">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">副標題（簡體中文）</label>
                                <input type="text" id="heroSubtitleZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="探索科技，创新未来">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">主標題（English）</label>
                                <input type="text" id="heroTitleEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="Welcome to Tech Society">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">副標題（English）</label>
                                <input type="text" id="heroSubtitleEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="Explore Technology, Innovate the Future">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                    儲存標語
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="announcementsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">最新訊息管理</h2>
                            <button id="addAnnouncementBtn" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                + 新增訊息
                            </button>
                        </div>

                        <!-- Announcements List -->
                        <div id="announcementsLoading" class="flex justify-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                        <div id="announcementsList" class="space-y-4 hidden"></div>
                        <div id="announcementsEmptyState" class="text-center py-12 hidden">
                            <p class="text-gray-500 dark:text-gray-400">暫無訊息資料</p>
                        </div>
                    </div>
                </div>

                <!-- Contact Settings Section -->
                <div id="contactSettingsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">聯絡資訊設置</h2>
                        </div>

                        <form id="contactSettingsForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold mb-2">繁體中文地址</label>
                                <input type="text" id="contactAddressZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: 香港九龍...">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">簡體中文地址</label>
                                <input type="text" id="contactAddressZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: 香港九龙...">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">English Address</label>
                                <input type="text" id="contactAddressEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="e.g., Kowloon, Hong Kong...">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">電話</label>
                                <input type="tel" id="contactPhone" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="+852 1234 5678">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">電子郵件</label>
                                <input type="email" id="contactEmail" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="contact@techsociety.com">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                    儲存聯絡資訊
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Anthem Settings Section -->
                <div id="anthemSettingsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">會歌設置</h2>
                        </div>

                        <form id="anthemSettingsForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">繁體中文標題</label>
                                    <input type="text" id="anthemTitleZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: 科技學會會歌">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">簡體中文標題</label>
                                    <input type="text" id="anthemTitleZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: 科技学会会歌">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">English Title</label>
                                    <input type="text" id="anthemTitleEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="e.g., Science and Technology Club Anthem">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">繁體中文描述</label>
                                    <textarea id="anthemDescZhTW" rows="3" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none" placeholder="例如: 聆聽我們的會歌，感受科技學會的精神與熱情"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">簡體中文描述</label>
                                    <textarea id="anthemDescZhCN" rows="3" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none" placeholder="例如: 聆听我们的会歌，感受科技学会的精神与热情"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">English Description</label>
                                    <textarea id="anthemDescEn" rows="3" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none" placeholder="e.g., Listen to our anthem and feel the spirit and passion"></textarea>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                    儲存會歌設置
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Visitor Stats Section -->
                <div id="visitorStatsSection" class="section hidden">
                    <div class="space-y-6">
                        <!-- Real-time Stats -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">即時訪客數據</h2>
                                <button onclick="refreshVisitorStats()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm font-semibold transition-colors">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    刷新
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Online Visitors -->
                                <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-xl p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm opacity-80">目前在線訪客</p>
                                            <p class="text-4xl font-bold mt-2" id="statOnlineVisitors">-</p>
                                        </div>
                                        <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <!-- Today Visitors -->
                                <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm opacity-80">今日訪問數</p>
                                            <p class="text-4xl font-bold mt-2" id="statTodayVisitors">-</p>
                                        </div>
                                        <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <!-- Total Visitors -->
                                <div class="bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm opacity-80">總訪問數</p>
                                            <p class="text-4xl font-bold mt-2" id="statTotalVisitors">-</p>
                                        </div>
                                        <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Kick Out Actions -->
                            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <h3 class="text-lg font-semibold mb-4">訪客管理操作</h3>
                                <div class="flex flex-wrap gap-3">
                                    <button onclick="kickOutAllVisitors()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                        踢出所有訪客
                                    </button>
                                    <button onclick="sendKickWarning()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold transition-colors flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        發送踢出警告（30秒）
                                    </button>
                                    <button onclick="cancelKickWarning()" id="cancelKickWarningBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors flex items-center hidden">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                        取消警告
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
                                    <span class="text-red-600 dark:text-red-400">踢出所有訪客</span>：立即踢出所有在線訪客。
                                    <span class="text-orange-600 dark:text-orange-400 ml-3">發送踢出警告</span>：訪客需在30秒內點擊確認，否則被踢出。
                                </p>
                            </div>
                        </div>

                        <!-- Website Status Settings -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">網站狀態</h2>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                <div>
                                    <h3 class="font-semibold text-lg">停用網站</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                        停用後，訪客將看到維護頁面。管理員仍可登入進入。
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="websiteDisabledToggle" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 dark:peer-focus:ring-red-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-red-600"></div>
                                </label>
                            </div>

                            <div id="websiteStatusMessage" class="mt-4 p-3 rounded-lg hidden">
                            </div>
                        </div>

                        <!-- Visitor Limit Settings -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">訪客限制設置</h2>
                            </div>

                            <form id="visitorSettingsForm" class="space-y-6">
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-4">
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-300">注意</p>
                                            <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
                                                當設置的最大訪客數超過時，新訪客將看到排隊等候頁面。設置為 0 表示無限制。
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold mb-2">最大同時訪客數</label>
                                    <input type="number" id="visitorMaxLimit" min="0" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: 100（0 表示無限制）">
                                    <p class="text-xs text-gray-500 mt-2">輸入 0 表示不限制訪客數量</p>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                        儲存設置
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- 訪客趨勢圖表 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">📊 訪客趨勢分析</h2>
                                <div class="flex space-x-2">
                                    <button onclick="setChartPeriod('7d')" class="chart-period-btn px-3 py-1 bg-primary text-white rounded text-sm" data-period="7d">7天</button>
                                    <button onclick="setChartPeriod('30d')" class="chart-period-btn px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm" data-period="30d">30天</button>
                                </div>
                            </div>
                            <div id="visitorTrendChart" class="h-64 flex items-end justify-between space-x-1 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                <!-- 圖表將動態生成 -->
                            </div>
                        </div>

                        <!-- 訪問時段分析 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">🕐 訪問時段分析</h2>
                            </div>
                            <div id="hourlyChart" class="grid grid-cols-12 gap-1 h-32">
                                <!-- 24小時圖表將動態生成 -->
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2">
                                <span>0時</span>
                                <span>6時</span>
                                <span>12時</span>
                                <span>18時</span>
                                <span>24時</span>
                            </div>
                        </div>

                        <!-- 設備類型統計 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">📱 設備類型統計</h2>
                            </div>
                            <div class="grid grid-cols-3 gap-4" id="deviceStatsContainer">
                                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 text-center">
                                    <div class="text-3xl mb-2">📱</div>
                                    <p class="text-2xl font-bold text-blue-600" id="mobileCount">0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">手機</p>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 text-center">
                                    <div class="text-3xl mb-2">📟</div>
                                    <p class="text-2xl font-bold text-green-600" id="tabletCount">0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">平板</p>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4 text-center">
                                    <div class="text-3xl mb-2">💻</div>
                                    <p class="text-2xl font-bold text-purple-600" id="desktopCount">0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">電腦</p>
                                </div>
                            </div>
                        </div>

                        <!-- 數據管理 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">📥 數據管理</h2>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                    <h3 class="font-semibold mb-3">導出數據</h3>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="exportVisitorStats()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                            📊 導出訪客統計 CSV
                                        </button>
                                        <button onclick="exportContactMessages()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                            ✉️ 導出聯絡訊息 CSV
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                    <h3 class="font-semibold mb-3">自動清理</h3>
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">自動清理超過30天的訪客記錄</p>
                                        </div>
                                        <button onclick="cleanOldData()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                            🗑️ 立即清理
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 管理員操作日誌 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">📝 管理員操作日誌</h2>
                                <button onclick="loadAdminLogs()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm font-semibold transition-colors">
                                    刷新
                                </button>
                            </div>
                            <div id="adminLogsContainer" class="max-h-64 overflow-y-auto space-y-2">
                                <p class="text-gray-500 dark:text-gray-400 text-center py-4">載入中...</p>
                            </div>
                        </div>

                        <!-- Historical Data -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">歷史訪問數據</h2>
                            </div>

                            <div id="visitorHistoryLoading" class="flex justify-center py-12">
                                <div class="loading-spinner"></div>
                            </div>

                            <div id="visitorHistoryList" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead>
                                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                                <th class="px-4 py-3 text-sm font-semibold text-gray-600 dark:text-gray-400">日期</th>
                                                <th class="px-4 py-3 text-sm font-semibold text-gray-600 dark:text-gray-400">訪問次數</th>
                                            </tr>
                                        </thead>
                                        <tbody id="visitorHistoryTableBody">
                                            <!-- 數據將動態加載 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="visitorHistoryEmpty" class="hidden text-center py-12">
                                <p class="text-gray-500 dark:text-gray-400">暫無歷史數據</p>
                            </div>
                        </div>

                        <!-- 排隊頁面自定義 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">🎫 排隊頁面設置</h2>
                            </div>
                            <form id="queueSettingsForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">自定義排隊訊息</label>
                                    <textarea id="queueCustomMessage" rows="3" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如：感謝您的耐心等待，我們會盡快為您服務..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">排隊頁面圖片 URL</label>
                                    <input type="url" id="queueImageUrl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="https://example.com/image.jpg">
                                    <p class="text-xs text-gray-500 mt-1">留空則使用預設樣式</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">預計每位訪客等待時間（分鐘）</label>
                                    <input type="number" id="queueWaitTimePerPerson" min="1" max="60" value="2" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="2">
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                        儲存排隊設置
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">個人資料</h2>
                        </div>

                        <!-- Current User Info Display -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">當前資料</h3>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">用戶名</p>
                                        <p class="font-semibold" id="profileCurrentUsername">載入中...</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">電子郵件</p>
                                        <p class="font-semibold" id="profileCurrentEmail">載入中...</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">姓名</p>
                                        <p class="font-semibold" id="profileCurrentName">載入中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Update Name Section -->
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">修改姓名</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">修改姓名需要驗證您的電子郵件</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">新姓名</label>
                                    <input type="text" id="profileNewName" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="請輸入新姓名">
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="startUpdateName()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                        發送驗證碼
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Update Username Section -->
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">修改用戶名</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">修改用戶名需要驗證您的電子郵件</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">新用戶名</label>
                                    <input type="text" id="profileNewUsername" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="請輸入新用戶名">
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="startUpdateUsername()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                        發送驗證碼
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Update Email Section -->
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h3 class="text-lg font-semibold mb-4">修改電子郵件</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">修改電子郵件需要驗證舊電郵和新電郵</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">新電子郵件</label>
                                    <input type="email" id="profileNewEmail" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="請輸入新電子郵件">
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="startUpdateEmail()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                                        開始驗證流程
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== 新功能區塊開始 ========== -->

                <!-- 會員檔案 Section -->
                <div id="memberProfilesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">👤 會員檔案管理</h2>
                            <div class="flex space-x-2">
                                <input type="text" id="memberSearchInput" placeholder="搜尋會員..." class="px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                                <button onclick="searchMembers()" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">搜尋</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="memberProfilesList">
                            <p class="text-gray-500 col-span-full text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 積分系統 Section -->
                <div id="pointsSystemSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🪙 積分獎勵系統</h2>
                            <button onclick="showAddPointsRuleDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增積分規則</button>
                        </div>
                        <!-- 積分統計 -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">總發放積分</p>
                                <p class="text-3xl font-bold" id="totalPointsIssued">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">本月發放</p>
                                <p class="text-3xl font-bold" id="monthlyPointsIssued">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">活躍會員</p>
                                <p class="text-3xl font-bold" id="activePointsMembers">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-400 to-pink-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">積分規則數</p>
                                <p class="text-3xl font-bold" id="pointsRulesCount">0</p>
                            </div>
                        </div>
                        <!-- 積分規則列表 -->
                        <h3 class="text-lg font-semibold mb-4">積分規則</h3>
                        <div class="space-y-3" id="pointsRulesList">
                            <p class="text-gray-500 text-center py-4">載入中...</p>
                        </div>
                        <!-- 積分排行榜 -->
                        <h3 class="text-lg font-semibold mb-4 mt-6">🏆 積分排行榜</h3>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4" id="pointsLeaderboard">
                            <p class="text-gray-500 text-center py-4">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 成就徽章 Section -->
                <div id="achievementsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🏅 成就徽章系統</h2>
                            <button onclick="showAddBadgeDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增徽章</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="badgesList">
                            <p class="text-gray-500 col-span-full text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 活動報名 Section -->
                <div id="eventRegistrationSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📝 活動報名管理</h2>
                            <button onclick="showCreateRegistrationDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增報名活動</button>
                        </div>
                        <div class="space-y-4" id="registrationEventsList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- QR簽到 Section -->
                <div id="qrCheckinSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📱 QR Code 簽到</h2>
                            <button onclick="generateQRCode()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">生成簽到碼</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- QR Code 顯示 -->
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 text-center">
                                <h3 class="text-lg font-semibold mb-4">當前簽到 QR Code</h3>
                                <div id="qrCodeDisplay" class="bg-white p-4 rounded-lg inline-block mb-4">
                                    <p class="text-gray-400">請選擇活動生成簽到碼</p>
                                </div>
                                <select id="qrEventSelect" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 mb-4">
                                    <option value="">-- 選擇活動 --</option>
                                </select>
                            </div>
                            <!-- 簽到記錄 -->
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4">今日簽到記錄</h3>
                                <div id="checkinRecordsList" class="space-y-2 max-h-64 overflow-y-auto">
                                    <p class="text-gray-500 text-center py-4">暫無簽到記錄</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 行事曆 Section -->
                <div id="calendarViewSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📅 行事曆</h2>
                            <div class="flex space-x-2">
                                <button onclick="prevMonth()" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">◀</button>
                                <span id="currentMonthDisplay" class="px-4 py-2 font-semibold">2025年1月</span>
                                <button onclick="nextMonth()" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">▶</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center font-semibold py-2 text-red-500">日</div>
                            <div class="text-center font-semibold py-2">一</div>
                            <div class="text-center font-semibold py-2">二</div>
                            <div class="text-center font-semibold py-2">三</div>
                            <div class="text-center font-semibold py-2">四</div>
                            <div class="text-center font-semibold py-2">五</div>
                            <div class="text-center font-semibold py-2 text-blue-500">六</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                            <!-- 動態生成日曆 -->
                        </div>
                    </div>
                </div>

                <!-- 投票系統 Section -->
                <div id="votingSystemSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🗳️ 投票系統</h2>
                            <button onclick="showCreatePollDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增投票</button>
                        </div>
                        <div class="space-y-4" id="pollsList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 問卷調查 Section -->
                <div id="surveysSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📊 問卷調查</h2>
                            <button onclick="showCreateSurveyDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增問卷</button>
                        </div>
                        <div class="space-y-4" id="surveysList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 資源預約 Section -->
                <div id="resourceBookingSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🏢 資源預約</h2>
                            <button onclick="showAddResourceDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增資源</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="resourcesList">
                            <p class="text-gray-500 col-span-full text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 通知中心 Section -->
                <div id="notificationCenterSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🔔 通知中心</h2>
                            <button onclick="showSendNotificationDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 發送通知</button>
                        </div>
                        <div class="flex space-x-4 mb-4">
                            <button onclick="filterNotifications('all')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">全部</button>
                            <button onclick="filterNotifications('unread')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">未讀</button>
                            <button onclick="filterNotifications('read')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">已讀</button>
                        </div>
                        <div class="space-y-3" id="notificationsList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 討論區 Section -->
                <div id="forumSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">💬 討論區管理</h2>
                            <button onclick="showCreateTopicDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增主題</button>
                        </div>
                        <div class="space-y-4" id="forumTopicsList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 活動相簿 Section -->
                <div id="photoGallerySection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📷 活動相簿</h2>
                            <button onclick="showCreateAlbumDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增相簿</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="albumsList">
                            <p class="text-gray-500 col-span-full text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 幹部管理 Section -->
                <div id="executivesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">👔 幹部管理</h2>
                            <button onclick="showAddExecutiveDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增幹部</button>
                        </div>
                        <div class="space-y-4" id="executivesList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 財務管理 Section -->
                <div id="financeSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">💰 財務管理</h2>
                            <button onclick="showAddTransactionDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增交易</button>
                        </div>
                        <!-- 財務概覽 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">總收入</p>
                                <p class="text-3xl font-bold" id="totalIncome">$0</p>
                            </div>
                            <div class="bg-gradient-to-br from-red-400 to-rose-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">總支出</p>
                                <p class="text-3xl font-bold" id="totalExpense">$0</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl p-4 text-white">
                                <p class="text-sm opacity-80">餘額</p>
                                <p class="text-3xl font-bold" id="totalBalance">$0</p>
                            </div>
                        </div>
                        <!-- 交易記錄 -->
                        <h3 class="text-lg font-semibold mb-4">交易記錄</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">日期</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">說明</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">類型</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">金額</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsList">
                                    <tr><td colspan="5" class="text-center py-8 text-gray-500">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 訪客留言 Section -->
                <div id="guestbookSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📝 訪客留言板</h2>
                            <div class="flex space-x-2">
                                <button onclick="filterGuestbook('pending')" class="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm">待審核</button>
                                <button onclick="filterGuestbook('approved')" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm">已通過</button>
                            </div>
                        </div>
                        <div class="space-y-4" id="guestbookList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 常見問題 Section -->
                <div id="faqSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">❓ 常見問題 FAQ</h2>
                            <button onclick="showAddFaqDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增問題</button>
                        </div>
                        <div class="space-y-4" id="faqList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 快速筆記 Section -->
                <div id="quickNotesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📋 快速筆記</h2>
                            <button onclick="showAddNoteDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增筆記</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="notesList">
                            <p class="text-gray-500 col-span-full text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 待辦事項 Section -->
                <div id="todoListSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">✅ 待辦事項</h2>
                            <button onclick="showAddTodoDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增待辦</button>
                        </div>
                        <!-- 進度條 -->
                        <div class="mb-6">
                            <div class="flex justify-between text-sm mb-2">
                                <span>完成進度</span>
                                <span id="todoProgress">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                <div id="todoProgressBar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="space-y-3" id="todoItemsList">
                            <p class="text-gray-500 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 維護模式 Section -->
                <div id="maintenanceSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🔧 維護模式</h2>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-6 mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0">
                                    <svg class="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">維護模式設置</h3>
                                    <p class="text-yellow-600 dark:text-yellow-400">啟用維護模式後，訪客將看到維護頁面，無法訪問網站內容。</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="maintenanceModeToggle" class="sr-only peer" onchange="toggleMaintenanceMode()">
                                    <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                </label>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">維護訊息</label>
                                <textarea id="maintenanceMessage" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none" placeholder="網站正在維護中，請稍後再試...">網站正在維護中，請稍後再試...</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">預計完成時間</label>
                                <input type="datetime-local" id="maintenanceEndTime" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <button onclick="saveMaintenanceSettings()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">儲存設置</button>
                        </div>
                    </div>
                </div>

                <!-- 主題設置 Section -->
                <div id="themeSettingsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🎨 主題設置</h2>
                        </div>
                        <!-- 主色調選擇 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4">主色調</h3>
                            <div class="grid grid-cols-6 gap-3" id="colorPalette">
                                <button onclick="setThemeColor('#8B5CF6')" class="w-12 h-12 rounded-full bg-[#8B5CF6] border-4 border-transparent hover:border-gray-400 transition-all" title="紫色"></button>
                                <button onclick="setThemeColor('#3B82F6')" class="w-12 h-12 rounded-full bg-[#3B82F6] border-4 border-transparent hover:border-gray-400 transition-all" title="藍色"></button>
                                <button onclick="setThemeColor('#10B981')" class="w-12 h-12 rounded-full bg-[#10B981] border-4 border-transparent hover:border-gray-400 transition-all" title="綠色"></button>
                                <button onclick="setThemeColor('#F59E0B')" class="w-12 h-12 rounded-full bg-[#F59E0B] border-4 border-transparent hover:border-gray-400 transition-all" title="橙色"></button>
                                <button onclick="setThemeColor('#EF4444')" class="w-12 h-12 rounded-full bg-[#EF4444] border-4 border-transparent hover:border-gray-400 transition-all" title="紅色"></button>
                                <button onclick="setThemeColor('#EC4899')" class="w-12 h-12 rounded-full bg-[#EC4899] border-4 border-transparent hover:border-gray-400 transition-all" title="粉色"></button>
                            </div>
                        </div>
                        <!-- 自訂顏色 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4">自訂顏色</h3>
                            <div class="flex space-x-4">
                                <input type="color" id="customThemeColor" value="#8B5CF6" class="w-16 h-16 rounded-lg cursor-pointer">
                                <button onclick="applyCustomColor()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">套用</button>
                            </div>
                        </div>
                        <!-- 網站名稱 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4">網站名稱</h3>
                            <input type="text" id="siteNameInput" value="科技學會" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="輸入網站名稱">
                        </div>
                        <button onclick="saveThemeSettings()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">儲存主題設置</button>
                    </div>
                </div>

                <!-- ========== 更多功能區塊 ========== -->

                <!-- 郵件模板 Section -->
                <div id="emailTemplatesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📧 郵件模板</h2>
                            <button onclick="showCreateEmailTemplateDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增模板</button>
                        </div>
                        <div id="emailTemplatesList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 社群連結 Section -->
                <div id="socialLinksSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🔗 社群連結</h2>
                            <button onclick="showAddSocialLinkDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增連結</button>
                        </div>
                        <div id="socialLinksList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-2">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 會議記錄 Section -->
                <div id="meetingMinutesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📝 會議記錄</h2>
                            <button onclick="showCreateMeetingDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增記錄</button>
                        </div>
                        <div id="meetingMinutesList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 文件庫 Section -->
                <div id="documentLibrarySection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📁 文件庫</h2>
                            <button onclick="showUploadDocumentDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 上傳文件</button>
                        </div>
                        <div class="mb-4 flex space-x-2">
                            <input type="text" id="documentSearch" placeholder="搜尋文件..." class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                            <select id="documentCategory" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                <option value="">全部類別</option>
                                <option value="manual">手冊</option>
                                <option value="form">表單</option>
                                <option value="report">報告</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div id="documentLibraryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 教學資源 Section -->
                <div id="learningResourcesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📚 教學資源</h2>
                            <button onclick="showAddResourceDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增資源</button>
                        </div>
                        <div class="mb-4 flex flex-wrap gap-2" id="resourceTags">
                            <button onclick="filterResources('all')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm">全部</button>
                            <button onclick="filterResources('video')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">影片</button>
                            <button onclick="filterResources('article')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">文章</button>
                            <button onclick="filterResources('tutorial')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">教程</button>
                            <button onclick="filterResources('tool')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">工具</button>
                        </div>
                        <div id="learningResourcesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 專案追蹤 Section -->
                <div id="projectTrackerSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📊 專案追蹤</h2>
                            <button onclick="showCreateProjectDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新建專案</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-primary" id="projectsTotal">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">總專案數</p>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="projectsInProgress">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">進行中</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/30 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-green-600" id="projectsCompleted">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">已完成</p>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-yellow-600" id="projectsPending">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">待處理</p>
                            </div>
                        </div>
                        <div id="projectTrackerList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 小組管理 Section -->
                <div id="teamGroupsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">👥 小組管理</h2>
                            <button onclick="showCreateGroupDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 建立小組</button>
                        </div>
                        <div id="teamGroupsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 考勤記錄 Section -->
                <div id="attendanceRecordsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📋 考勤記錄</h2>
                            <button onclick="showAddAttendanceDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增記錄</button>
                        </div>
                        <div class="mb-4 flex space-x-4">
                            <input type="date" id="attendanceDateFilter" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                            <select id="attendanceEventFilter" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                <option value="">全部活動</option>
                            </select>
                            <button onclick="exportAttendance()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">匯出</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <th class="py-3 px-4">會員</th>
                                        <th class="py-3 px-4">活動</th>
                                        <th class="py-3 px-4">簽到時間</th>
                                        <th class="py-3 px-4">狀態</th>
                                        <th class="py-3 px-4">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <tr><td colspan="5" class="text-center py-8 text-gray-500">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 獎懲記錄 Section -->
                <div id="rewardsPenaltiesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">⭐ 獎懲記錄</h2>
                            <button onclick="showAddRewardPenaltyDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增記錄</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-green-50 dark:bg-green-900/30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-green-600 mb-2">🏆 嘉獎</h3>
                                <p class="text-3xl font-bold" id="rewardsCount">0</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-red-600 mb-2">⚠️ 懲處</h3>
                                <p class="text-3xl font-bold" id="penaltiesCount">0</p>
                            </div>
                        </div>
                        <div id="rewardsPenaltiesList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 贊助商 Section -->
                <div id="sponsorsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🏢 贊助商管理</h2>
                            <button onclick="showAddSponsorDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增贊助商</button>
                        </div>
                        <div id="sponsorsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 合作夥伴 Section -->
                <div id="partnersSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🤝 合作夥伴</h2>
                            <button onclick="showAddPartnerDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增夥伴</button>
                        </div>
                        <div id="partnersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 比賽記錄 Section -->
                <div id="competitionsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🏆 比賽記錄</h2>
                            <button onclick="showAddCompetitionDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增比賽</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-yellow-600" id="goldMedals">🥇 0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">金牌</p>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-gray-500" id="silverMedals">🥈 0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">銀牌</p>
                            </div>
                            <div class="bg-orange-50 dark:bg-orange-900/30 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-orange-600" id="bronzeMedals">🥉 0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">銅牌</p>
                            </div>
                        </div>
                        <div id="competitionsList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 證書生成 Section -->
                <div id="certificatesSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📜 證書生成</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-4">證書設定</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">證書類型</label>
                                        <select id="certType" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <option value="participation">參與證書</option>
                                            <option value="completion">完成證書</option>
                                            <option value="excellence">優秀證書</option>
                                            <option value="award">獲獎證書</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">獲獎者姓名</label>
                                        <input type="text" id="certRecipient" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="請輸入姓名">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">活動/比賽名稱</label>
                                        <input type="text" id="certEvent" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="請輸入活動名稱">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">日期</label>
                                        <input type="date" id="certDate" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                    </div>
                                    <button onclick="generateCertificate()" class="w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">生成證書</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-4">證書預覽</h3>
                                <div id="certificatePreview" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-8 min-h-[300px] flex items-center justify-center">
                                    <p class="text-gray-500 dark:text-gray-400">預覽區域</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 問題回報 Section -->
                <div id="bugReportsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🐛 問題回報</h2>
                        </div>
                        <div class="mb-4 flex space-x-2">
                            <select id="bugStatusFilter" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" onchange="filterBugReports()">
                                <option value="">全部狀態</option>
                                <option value="open">待處理</option>
                                <option value="in_progress">處理中</option>
                                <option value="resolved">已解決</option>
                                <option value="closed">已關閉</option>
                            </select>
                            <select id="bugPriorityFilter" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" onchange="filterBugReports()">
                                <option value="">全部優先級</option>
                                <option value="high">高</option>
                                <option value="medium">中</option>
                                <option value="low">低</option>
                            </select>
                        </div>
                        <div id="bugReportsList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 意見箱 Section -->
                <div id="suggestionBoxSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">💡 意見箱</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="suggestionsTotal">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">總建議數</p>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-yellow-600" id="suggestionsPending">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">待審核</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/30 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-green-600" id="suggestionsImplemented">0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">已採納</p>
                            </div>
                        </div>
                        <div id="suggestionsList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 知識庫 Section -->
                <div id="knowledgeBaseSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📖 知識庫</h2>
                            <button onclick="showCreateArticleDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增文章</button>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="knowledgeSearch" placeholder="搜尋知識庫..." class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" oninput="searchKnowledge()">
                        </div>
                        <div class="flex flex-wrap gap-2 mb-4" id="knowledgeTags"></div>
                        <div id="knowledgeBaseList" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 標籤管理 Section -->
                <div id="tagManagementSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">🏷️ 標籤管理</h2>
                            <button onclick="showAddTagDialog()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">+ 新增標籤</button>
                        </div>
                        <div id="tagsList" class="flex flex-wrap gap-3">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8 w-full">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 數據匯出 Section -->
                <div id="dataExportSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📥 數據匯出</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                                <h3 class="font-semibold mb-2">📅 活動資料</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">匯出所有活動資料</p>
                                <button onclick="exportData('activities')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">匯出 CSV</button>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                                <h3 class="font-semibold mb-2">👥 會員資料</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">匯出會員名單</p>
                                <button onclick="exportData('members')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">匯出 CSV</button>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                                <h3 class="font-semibold mb-2">📋 考勤記錄</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">匯出考勤資料</p>
                                <button onclick="exportData('attendance')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">匯出 CSV</button>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                                <h3 class="font-semibold mb-2">💰 財務資料</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">匯出收支記錄</p>
                                <button onclick="exportData('finance')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">匯出 CSV</button>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                                <h3 class="font-semibold mb-2">📊 報名資料</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">匯出活動報名</p>
                                <button onclick="exportData('registrations')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">匯出 CSV</button>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                                <h3 class="font-semibold mb-2">📁 完整備份</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">匯出全部資料</p>
                                <button onclick="exportData('all')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">匯出 JSON</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系統日誌 Section -->
                <div id="systemLogsSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">📋 系統日誌</h2>
                            <button onclick="clearOldLogs()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm">清除舊日誌</button>
                        </div>
                        <div class="mb-4 flex space-x-2">
                            <select id="logTypeFilter" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" onchange="filterLogs()">
                                <option value="">全部類型</option>
                                <option value="login">登入</option>
                                <option value="create">建立</option>
                                <option value="update">更新</option>
                                <option value="delete">刪除</option>
                                <option value="error">錯誤</option>
                            </select>
                            <input type="date" id="logDateFilter" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" onchange="filterLogs()">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <th class="py-3 px-4">時間</th>
                                        <th class="py-3 px-4">類型</th>
                                        <th class="py-3 px-4">用戶</th>
                                        <th class="py-3 px-4">操作</th>
                                        <th class="py-3 px-4">詳情</th>
                                    </tr>
                                </thead>
                                <tbody id="systemLogsTableBody">
                                    <tr><td colspan="5" class="text-center py-8 text-gray-500">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 備份還原 Section -->
                <div id="backupRestoreSection" class="section hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">💾 備份還原</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4">📤 建立備份</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">備份所有系統資料到本地</p>
                                <div class="space-y-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="backupActivities" checked class="rounded">
                                        <span>活動資料</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="backupMembers" checked class="rounded">
                                        <span>會員資料</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="backupSettings" checked class="rounded">
                                        <span>系統設置</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="backupFinance" checked class="rounded">
                                        <span>財務資料</span>
                                    </label>
                                </div>
                                <button onclick="createBackup()" class="w-full mt-4 px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">建立備份</button>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-6">
                                <h3 class="text-lg font-semibold mb-4">📥 還原備份</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">從備份檔案還原系統資料</p>
                                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-8 text-center">
                                    <input type="file" id="restoreFileInput" accept=".json" class="hidden" onchange="handleRestoreFile(event)">
                                    <button onclick="document.getElementById('restoreFileInput').click()" class="px-6 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">選擇備份檔案</button>
                                    <p class="text-sm text-gray-500 mt-2">支援 .json 格式</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-4">📜 備份歷史</h3>
                            <div id="backupHistoryList" class="space-y-2">
                                <p class="text-gray-500 dark:text-gray-400 text-center py-4">尚無備份記錄</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== 更多功能區塊結束 ========== -->

            </main>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold" id="activityModalTitle">新增活動</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="activityForm" class="space-y-4">
                <input type="hidden" id="activityId">

                <!-- 活動標題 - 多語言 -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">活動標題（繁體中文）<span class="text-red-500">*</span></label>
                        <input type="text" id="activityTitleZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">活動標題（簡體中文）</label>
                        <input type="text" id="activityTitleZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">活動標題（English）</label>
                        <input type="text" id="activityTitleEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">活動日期</label>
                    <input type="text" id="activityDate" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: 2024年3月15日" required>
                </div>

                <!-- 活動描述 - 多語言 -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">活動描述（繁體中文）<span class="text-red-500">*</span></label>
                        <textarea id="activityDescriptionZhTW" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">活動描述（簡體中文）</label>
                        <textarea id="activityDescriptionZhCN" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">活動描述（English）</label>
                        <textarea id="activityDescriptionEn" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">活動連結 (選填)</label>
                    <input type="url" id="activityLink" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="https://example.com">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="closeModal px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold" id="projectModalTitle">新增專案</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="projectForm" class="space-y-4">
                <input type="hidden" id="projectId">

                <!-- 專案標題 - 多語言 -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">專案標題（繁體中文）<span class="text-red-500">*</span></label>
                        <input type="text" id="projectTitleZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">專案標題（簡體中文）</label>
                        <input type="text" id="projectTitleZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">專案標題（English）</label>
                        <input type="text" id="projectTitleEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">專案狀態</label>
                    <select id="projectStatus" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        <option value="進行中">進行中</option>
                        <option value="已完成">已完成</option>
                        <option value="計劃中">計劃中</option>
                    </select>
                </div>

                <!-- 專案描述 - 多語言 -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">專案描述（繁體中文）<span class="text-red-500">*</span></label>
                        <textarea id="projectDescriptionZhTW" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">專案描述（簡體中文）</label>
                        <textarea id="projectDescriptionZhCN" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">專案描述（English）</label>
                        <textarea id="projectDescriptionEn" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">使用技術 (用逗號分隔)</label>
                    <input type="text" id="projectTechnologies" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="例如: React, Node.js, MongoDB">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">參與成員數</label>
                    <input type="number" id="projectMembers" min="0" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="0">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">專案連結 (選填)</label>
                    <input type="url" id="projectLink" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="https://github.com/...">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="closeModal px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Member Modal -->
    <div id="teamMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold" id="teamMemberModalTitle">新增團隊成員</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="teamMemberForm" class="space-y-4">
                <input type="hidden" id="teamMemberId">

                <!-- Name in 3 languages -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">成員姓名（繁體中文）<span class="text-red-500">*</span></label>
                        <input type="text" id="memberNameZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="張三">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">成員姓名（簡體中文）</label>
                        <input type="text" id="memberNameZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="张三">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">成員姓名（English）</label>
                        <input type="text" id="memberNameEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="Zhang San">
                    </div>
                </div>

                <!-- Position in 3 languages -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">職位（繁體中文）<span class="text-red-500">*</span></label>
                        <input type="text" id="memberPositionZhTW" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="會長">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">職位（簡體中文）</label>
                        <input type="text" id="memberPositionZhCN" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="会长">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">職位（English）</label>
                        <input type="text" id="memberPositionEn" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="President">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">電子郵件（選填）</label>
                    <input type="email" id="memberEmail" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="example@email.com">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">排序順序<span class="text-red-500">*</span></label>
                    <input type="number" id="memberOrder" min="0" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="0">
                    <p class="text-xs text-gray-500 mt-1">數字越小排序越前</p>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="closeModal px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="replyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">回覆訊息</h3>
                <button onclick="closeReplyModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4 mb-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">發件人</p>
                    <p class="font-semibold" id="replyEmail"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">主旨</p>
                    <p class="font-semibold" id="replySubject"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">內容</p>
                    <p id="replyOriginalMessage" class="whitespace-pre-wrap"></p>
                </div>
            </div>

            <form id="replyForm" onsubmit="handleReply(event)" class="space-y-4">
                <input type="hidden" id="replyContactId">
                <div>
                    <label class="block text-sm font-semibold mb-2">回覆內容</label>
                    <textarea id="replyContent" rows="6" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none" required placeholder="請輸入回覆內容..."></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeReplyModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>發送回覆
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Set Username Modal -->
    <div id="setUsernameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-8">
            <div class="text-center mb-6">
                <svg class="w-16 h-16 mx-auto mb-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <h3 class="text-2xl font-bold">設定用戶名</h3>
                <p class="text-gray-600 dark:text-gray-400 mt-2">請為您的帳號設定一個唯一的用戶名</p>
            </div>

            <form id="setUsernameForm" onsubmit="return handleSetUsername(event)" class="space-y-4">
                <div>
                    <label for="newUsername" class="block text-sm font-semibold mb-2">用戶名</label>
                    <input type="text" id="newUsername" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent outline-none" placeholder="3-20個字符，可包含字母、數字、下劃線和連字符" required pattern="[a-zA-Z0-9_-]{3,20}" title="用戶名必須為3-20個字符，只能包含字母、數字、下劃線和連字符">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">用戶名設定後不可更改</p>
                </div>
                <button type="submit" id="setUsernameBtn" class="w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">
                    確認設定
                </button>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold" id="userModalTitle">編輯用戶</h3>
                <button class="closeUserModal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                <div>
                    <label class="block text-sm font-semibold mb-2">用戶名</label>
                    <input type="text" id="userUsername" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" readonly>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">用戶名不可修改</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">電子郵件</label>
                    <input type="email" id="userEmail" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" readonly>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">電子郵件不可修改</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">姓名</label>
                    <input type="text" id="userName" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">角色</label>
                    <select id="userRole" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        <option value="user">普通用戶</option>
                        <option value="admin">管理員</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">狀態</label>
                    <select id="userStatus" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        <option value="pending">待審核</option>
                        <option value="approved">已批准</option>
                        <option value="rejected">已拒絕</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="closeUserModal px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">新增用戶</h3>
                <button class="closeAddUserModal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">真實姓名 <span class="text-red-500">*</span></label>
                    <input type="text" id="addUserName" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="請輸入真實姓名" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">用戶名 <span class="text-red-500">*</span></label>
                    <input type="text" id="addUserUsername" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="3-20字符，僅字母數字下劃線連字符" required>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">僅允許字母、數字、下劃線(_)和連字符(-)</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">電子郵件 <span class="text-red-500">*</span></label>
                    <input type="email" id="addUserEmail" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="請輸入電子郵件" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">密碼 <span class="text-red-500">*</span></label>
                    <input type="password" id="addUserPassword" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="至少6位" required>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">密碼長度至少6位</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">確認密碼 <span class="text-red-500">*</span></label>
                    <input type="password" id="addUserPasswordConfirm" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="請再次輸入密碼" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">角色 <span class="text-red-500">*</span></label>
                    <select id="addUserRole" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        <option value="user">普通用戶</option>
                        <option value="admin">管理員</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">狀態 <span class="text-red-500">*</span></label>
                    <select id="addUserStatus" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        <option value="approved" selected>已批准</option>
                        <option value="pending">待審核</option>
                        <option value="rejected">已拒絕</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="closeAddUserModal px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                    <button type="submit" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">發送驗證碼</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Verify Modal -->
    <div id="addUserVerifyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">驗證電子郵件</h3>
                <button onclick="closeAddUserVerifyModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        我們已向 <span class="font-semibold" id="addUserVerifyEmail"></span> 發送了驗證碼
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">請輸入驗證碼</label>
                    <input type="text" id="addUserVerifyCode" maxlength="6" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none text-center text-2xl tracking-widest" placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">驗證碼有效期為 10 分鐘</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeAddUserVerifyModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                <button onclick="confirmAddUser()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">確認創建</button>
            </div>
        </div>
    </div>

    <!-- Verify Username Modal -->
    <!-- Verify Name Modal -->
    <div id="verifyNameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">驗證電子郵件</h3>
                <button onclick="closeVerifyNameModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        我們已向 <span class="font-semibold" id="verifyNameEmail"></span> 發送了驗證碼
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">請輸入驗證碼</label>
                    <input type="text" id="nameVerifyCode" maxlength="6" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none text-center text-2xl tracking-widest" placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">驗證碼有效期為 10 分鐘</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeVerifyNameModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                <button onclick="confirmUpdateName()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">確認修改</button>
            </div>
        </div>
    </div>

    <!-- Verify Username Modal -->
    <div id="verifyUsernameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">驗證電子郵件</h3>
                <button onclick="closeVerifyUsernameModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        我們已向 <span class="font-semibold" id="verifyUsernameEmail"></span> 發送了驗證碼
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">請輸入驗證碼</label>
                    <input type="text" id="usernameVerifyCode" maxlength="6" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none text-center text-2xl tracking-widest" placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">驗證碼有效期為 10 分鐘</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeVerifyUsernameModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                <button onclick="confirmUpdateUsername()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">確認修改</button>
            </div>
        </div>
    </div>

    <!-- Verify Old Email Modal -->
    <div id="verifyOldEmailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">驗證舊電子郵件</h3>
                <button onclick="closeVerifyOldEmailModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        我們已向您的舊電郵 <span class="font-semibold" id="verifyOldEmailAddress"></span> 發送了驗證碼
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">請輸入舊電郵驗證碼</label>
                    <input type="text" id="oldEmailVerifyCode" maxlength="6" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none text-center text-2xl tracking-widest" placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">驗證碼有效期為 10 分鐘</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeVerifyOldEmailModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                <button onclick="confirmOldEmail()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">下一步</button>
            </div>
        </div>
    </div>

    <!-- Verify New Email Modal -->
    <div id="verifyNewEmailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">驗證新電子郵件</h3>
                <button onclick="closeVerifyNewEmailModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        我們已向您的新電郵 <span class="font-semibold" id="verifyNewEmailAddress"></span> 發送了驗證碼
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">請輸入新電郵驗證碼</label>
                    <input type="text" id="newEmailVerifyCode" maxlength="6" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none text-center text-2xl tracking-widest" placeholder="000000">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">驗證碼有效期為 10 分鐘</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeVerifyNewEmailModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors">取消</button>
                <button onclick="confirmUpdateEmail()" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">確認修改</button>
            </div>
        </div>
    </div>

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // EmailJS 配置（與 index.html 保持一致）
        const emailJSConfig = {
            publicKey: 'wSb5w9ZOF2-9HGCu1',
            serviceId: 'ats-科技學會',
            templateId: 'template_nhcptbe'  // 用於驗證碼的模板
        };

        // 初始化 EmailJS 並確保全域可用
        emailjs.init(emailJSConfig.publicKey);
        window.emailjs = emailjs; // 確保 emailjs 在全域作用域可用
        window.emailJSConfig = emailJSConfig; // 將配置暴露到全域
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase 配置（與 index.html 保持一致）
        const firebaseConfig = {
            apiKey: "AIzaSyCCXmBJkesxRi3ufdCRucd5vcmg-Ls_3Ks",
            authDomain: "tech-society-566dc.firebaseapp.com",
            projectId: "tech-society-566dc",
            storageBucket: "tech-society-566dc.firebasestorage.app",
            messagingSenderId: "1098408063649",
            appId: "1:1098408063649:web:ec07e23e03c43f92c7f6e0",
            measurementId: "G-05127H92FQ"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 存储到 window 对象以供其他脚本使用
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firestoreModules = { collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy, where, serverTimestamp };
        window.authModules = { signInWithEmailAndPassword, signOut, onAuthStateChanged };

        // 🔥 重要：在 Firebase SDK 加載完成後立即初始化
        console.log('Firebase SDK loaded successfully!');
        window.firebaseReady = true;
        if (window.initAuth) {
            window.initAuth();
        }
    </script>

    <script>
        console.log('=== ADMIN PAGE LOADED ===');

        // 簡單的 alert 函數（不依賴其他代碼）
        function showAlertSimple(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 🔥 直接定義登入函數（inline 方式確保一定能執行）
        window.handleLogin = async function(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('handleLogin called!');

            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn');

            const usernameOrEmail = emailInput.value.trim();
            const password = passwordInput.value;

            console.log('Username or Email:', usernameOrEmail);
            console.log('Password length:', password.length);

            if (!usernameOrEmail || !password) {
                showAlertSimple('請輸入用戶名/電郵和密碼');
                loginBtn.textContent = '登入';
                loginBtn.disabled = false;
                return false;
            }

            loginBtn.textContent = '登入中...';
            loginBtn.disabled = true;

            try {
                console.log('Waiting for Firebase...');
                // 等待 Firebase 加載
                let retries = 0;
                while (!window.authModules && retries < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }

                if (!window.authModules) {
                    throw new Error('Firebase 加載超時');
                }

                let email = usernameOrEmail;

                // 判斷輸入的是電郵還是用戶名
                const isEmail = usernameOrEmail.includes('@');

                if (!isEmail) {
                    // 如果不是電郵，根據用戶名查詢對應的電子郵件
                    console.log('Input is username, looking up email...');
                    const { collection, query, where, getDocs } = window.firestoreModules;
                    const usersQuery = query(collection(window.firebaseDB, 'users'), where('username', '==', usernameOrEmail));
                    const usersSnapshot = await getDocs(usersQuery);

                    if (usersSnapshot.empty) {
                        throw { code: 'auth/user-not-found', message: '用戶名不存在' };
                    }

                    // 獲取用戶的電子郵件
                    const userData = usersSnapshot.docs[0].data();
                    email = userData.email;
                    console.log('Found email for username:', email);
                } else {
                    console.log('Input is email, logging in directly...');
                }

                console.log('Calling signInWithEmailAndPassword...');
                const userCredential = await window.authModules.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                console.log('Login successful:', userCredential.user.email);

                // 檢查用戶是否有設定用戶名
                const user = userCredential.user;
                const userDoc = await window.firestoreModules.getDoc(window.firestoreModules.doc(window.firebaseDB, 'users', user.uid));
                const userData = userDoc.data();

                // 如果用戶沒有用戶名，要求設定
                if (!userData.username) {
                    console.log('User has no username, prompting to set...');
                    // 顯示設定用戶名 Modal （稍後實現）
                    window.pendingUser = user;
                    showSetUsernameModal();
                    loginBtn.textContent = '登入';
                    loginBtn.disabled = false;
                    return false;
                }

                // onAuthStateChanged will handle UI updates
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = '登入失敗';

                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = '帳號不存在';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '密碼錯誤';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '郵箱格式不正確';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage = '帳號或密碼錯誤';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '登入嘗試次數過多，請稍後再試';
                        break;
                    default:
                        errorMessage = `登入失敗：${error.message}`;
                }

                showAlertSimple(errorMessage);
                loginBtn.textContent = '登入';
                loginBtn.disabled = false;
            }

            return false; // 防止表單提交
        };

        // 🔥 顯示設定用戶名 Modal
        window.showSetUsernameModal = function() {
            document.getElementById('setUsernameModal').classList.remove('hidden');
        };

        // 🔥 處理設定用戶名
        window.handleSetUsername = async function(event) {
            event.preventDefault();
            event.stopPropagation();

            const usernameInput = document.getElementById('newUsername');
            const setUsernameBtn = document.getElementById('setUsernameBtn');
            const username = usernameInput.value.trim();

            if (!username) {
                showAlertSimple('請輸入用戶名');
                return false;
            }

            // 驗證用戶名格式
            const usernameRegex = /^[a-zA-Z0-9_-]{3,20}$/;
            if (!usernameRegex.test(username)) {
                showAlertSimple('用戶名必須為3-20個字符，只能包含字母、數字、下劃線和連字符');
                return false;
            }

            setUsernameBtn.textContent = '設定中...';
            setUsernameBtn.disabled = true;

            try {
                // 檢查用戶名是否已存在
                const { collection, query, where, getDocs, doc, updateDoc } = window.firestoreModules;
                const usernameQuery = query(collection(window.firebaseDB, 'users'), where('username', '==', username));
                const usernameSnapshot = await getDocs(usernameQuery);

                if (!usernameSnapshot.empty) {
                    showAlertSimple('用戶名已被使用，請選擇其他用戶名');
                    setUsernameBtn.textContent = '確認設定';
                    setUsernameBtn.disabled = false;
                    return false;
                }

                // 更新用戶名
                const user = window.pendingUser;
                await updateDoc(doc(window.firebaseDB, 'users', user.uid), {
                    username: username
                });

                // 關閉 Modal 並清理
                document.getElementById('setUsernameModal').classList.add('hidden');
                document.getElementById('setUsernameForm').reset();
                window.pendingUser = null;

                // 用戶名設定成功後，onAuthStateChanged 會自動處理後續流程
                showAlertSimple('用戶名設定成功！');
            } catch (error) {
                console.error('Set username error:', error);
                showAlertSimple('設定用戶名時發生錯誤：' + error.message);
                setUsernameBtn.textContent = '確認設定';
                setUsernameBtn.disabled = false;
            }

            return false;
        };

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        // User Management
        let currentUser = null;
        const SUPER_ADMIN_UID = 'vdNBS7qPdRV9qpV7CLgXwBflCf23';

        // 等待 Firebase SDK 加載完成後初始化認證監聽器
        window.initAuth = function() {
            if (!window.authModules || !window.firebaseAuth) {
                console.error('Firebase not ready yet, retrying...');
                setTimeout(window.initAuth, 100);
                return;
            }

            console.log('Initializing auth state observer...');

            // Authentication State Observer
            window.authModules.onAuthStateChanged(window.firebaseAuth, async (user) => {
            if (user) {
                // Check user role in Firestore
                console.log('User logged in:', user.email, 'UID:', user.uid);
                try {
                    const { doc, getDoc } = window.firestoreModules;
                    const userDoc = await getDoc(doc(window.firebaseDB, 'users', user.uid));

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log('User data:', userData);
                        console.log('User role:', userData.role);
                        console.log('User status:', userData.status);
                        console.log('Super Admin UID:', SUPER_ADMIN_UID);
                        console.log('Current UID:', user.uid);
                        console.log('Is admin?', userData.role === 'admin');
                        console.log('Is super admin?', user.uid === SUPER_ADMIN_UID);

                        // Check if user is admin or super admin
                        if (userData.role === 'admin' || user.uid === SUPER_ADMIN_UID) {
                            if (userData.status !== 'approved') {
                                console.log('Status not approved:', userData.status);
                                showAlert('您的帳號尚未被批准訪問管理後台。狀態：' + userData.status);
                                await window.authModules.signOut(window.firebaseAuth);
                                return;
                            }

                            console.log('Access granted! Loading dashboard...');
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                name: userData.name || user.email,
                                role: userData.role
                            };

                            document.getElementById('currentUser').textContent = currentUser.name;
                            document.getElementById('loginScreen').classList.add('hidden');
                            document.getElementById('adminDashboard').classList.remove('hidden');
                            loadActivities();
                        } else {
                            console.log('Role check failed. Role:', userData.role);
                            showAlert('您沒有權限訪問管理後台。您的角色：' + (userData.role || '無'));
                            await window.authModules.signOut(window.firebaseAuth);
                        }
                    } else {
                        console.log('User document does not exist for UID:', user.uid);
                        showAlert('用戶資料不存在（UID: ' + user.uid + '）');
                        await window.authModules.signOut(window.firebaseAuth);
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    showAlert('驗證用戶權限時發生錯誤：' + error.message);
                    await window.authModules.signOut(window.firebaseAuth);
                }
            } else {
                // User is signed out
                console.log('User signed out');
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        });
        };

        // 如果 Firebase 已經加載，立即初始化
        if (window.firebaseReady) {
            window.initAuth();
        }

        // Login Handling 已通過 inline onsubmit 處理（見 window.handleLogin）

        // 初始化所有 UI 事件監聽器
        function initUIHandlers() {
            console.log('Initializing UI handlers...');

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await window.authModules.signOut(window.firebaseAuth);
                        document.getElementById('loginForm').reset();
                    } catch (error) {
                        console.error('Logout error:', error);
                        showAlert('登出時發生錯誤');
                    }
                });
            }

            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;

                    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                    document.getElementById(section + 'Section').classList.remove('hidden');

                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                    });
                    btn.classList.add('bg-primary', 'text-white');

                    if (section === 'activities') {
                        loadActivities();
                    } else if (section === 'projects') {
                        loadProjects();
                    } else if (section === 'team') {
                        loadTeamMembers();
                    } else if (section === 'contacts') {
                        loadContacts();
                    } else if (section === 'users') {
                        loadUsers();
                    } else if (section === 'profile') {
                        loadProfile();
                    }
                });
            });

            // Set default active section
            const firstNavBtn = document.querySelector('.nav-btn');
            if (firstNavBtn) {
                firstNavBtn.click();
            }

            // Modal Handling
            document.querySelectorAll('.closeModal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('activityModal').classList.add('hidden');
                    document.getElementById('projectModal').classList.add('hidden');
                    document.getElementById('teamMemberModal').classList.add('hidden');
                });
            });
        }

        // 當 DOM 載入完成後初始化所有處理器
        function initAllHandlers() {
            initUIHandlers();
            initActivityHandlers();
            initProjectHandlers();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAllHandlers);
        } else {
            initAllHandlers();
        }

        // Activities Management
        function initActivityHandlers() {
            const addActivityBtn = document.getElementById('addActivityBtn');
            if (addActivityBtn) {
                addActivityBtn.addEventListener('click', () => {
                    document.getElementById('activityModalTitle').textContent = '新增活動';
                    document.getElementById('activityForm').reset();
                    document.getElementById('activityId').value = '';
                    document.getElementById('activityModal').classList.remove('hidden');
                });
            }

            const activityForm = document.getElementById('activityForm');
            if (activityForm) {
                activityForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // 取得多語言輸入值
                    const titleZhTW = document.getElementById('activityTitleZhTW').value.trim();
                    const titleZhCN = document.getElementById('activityTitleZhCN').value.trim();
                    const titleEn = document.getElementById('activityTitleEn').value.trim();
                    const descriptionZhTW = document.getElementById('activityDescriptionZhTW').value.trim();
                    const descriptionZhCN = document.getElementById('activityDescriptionZhCN').value.trim();
                    const descriptionEn = document.getElementById('activityDescriptionEn').value.trim();

                    // 驗證：至少需要填寫一個語言版本的標題和描述（建議繁體中文）
                    if (!titleZhTW && !titleZhCN && !titleEn) {
                        showAlert('請至少填寫一個語言版本的活動標題！');
                        return;
                    }
                    if (!descriptionZhTW && !descriptionZhCN && !descriptionEn) {
                        showAlert('請至少填寫一個語言版本的活動描述！');
                        return;
                    }

                    const activityData = {
                        title: {
                            zhTW: titleZhTW,
                            zhCN: titleZhCN,
                            en: titleEn
                        },
                        date: document.getElementById('activityDate').value,
                        description: {
                            zhTW: descriptionZhTW,
                            zhCN: descriptionZhCN,
                            en: descriptionEn
                        },
                        link: document.getElementById('activityLink').value || ''
                    };

                    try {
                        const activityId = document.getElementById('activityId').value;

                        if (activityId) {
                            // Update existing activity
                            const { doc, updateDoc, serverTimestamp } = window.firestoreModules;
                            activityData.updatedAt = serverTimestamp();
                            await updateDoc(doc(window.firebaseDB, 'activities', activityId), activityData);
                            showAlert('活動已更新！');
                        } else {
                            // Add new activity
                            const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                            activityData.createdAt = serverTimestamp();
                            await addDoc(collection(window.firebaseDB, 'activities'), activityData);
                            showAlert('活動已新增！');
                        }

                        document.getElementById('activityModal').classList.add('hidden');
                        loadActivities();
                    } catch (error) {
                        console.error('Error saving activity:', error);
                        showAlert('儲存活動時發生錯誤');
                    }
                });
            }
        }

        async function loadActivities() {
            const loadingEl = document.getElementById('activitiesLoading');
            const listEl = document.getElementById('activitiesList');
            const emptyEl = document.getElementById('activitiesEmptyState');

            loadingEl.classList.remove('hidden');
            listEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'activities'), orderBy('date', 'desc'));
                const querySnapshot = await getDocs(q);

                loadingEl.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                querySnapshot.forEach((docSnapshot) => {
                    const activity = docSnapshot.data();
                    const activityId = docSnapshot.id;

                    // 向後兼容：支持舊格式（字符串）和新格式（對象）
                    const title = typeof activity.title === 'string'
                        ? activity.title
                        : (activity.title?.zhTW || activity.title?.zhCN || activity.title?.en || '');
                    const description = typeof activity.description === 'string'
                        ? activity.description
                        : (activity.description?.zhTW || activity.description?.zhCN || activity.description?.en || '');

                    const activityCard = document.createElement('div');
                    activityCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-6';
                    activityCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="text-sm text-primary font-semibold mb-2">${activity.date || ''}</div>
                                <h3 class="text-lg font-bold mb-2">${title}</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-2">${description}</p>
                                ${activity.link ? `<a href="${activity.link}" target="_blank" class="text-sm text-primary hover:underline">查看連結 →</a>` : ''}
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="editActivity('${activityId}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">編輯</button>
                                <button onclick="deleteActivity('${activityId}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">刪除</button>
                            </div>
                        </div>
                    `;

                    listEl.appendChild(activityCard);
                });

                listEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading activities:', error);
                loadingEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-red-500">載入活動時發生錯誤</p>';
                emptyEl.classList.remove('hidden');
            }
        }

        window.editActivity = async (id) => {
            try {
                const { doc, getDocs, collection } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'activities'));

                let activityData = null;
                querySnapshot.forEach((docSnapshot) => {
                    if (docSnapshot.id === id) {
                        activityData = docSnapshot.data();
                    }
                });

                if (activityData) {
                    document.getElementById('activityId').value = id;

                    // 向後兼容：如果數據是舊格式（字符串），轉換為新格式（對象）
                    const title = typeof activityData.title === 'string'
                        ? { zhTW: activityData.title, zhCN: '', en: '' }
                        : activityData.title;
                    const description = typeof activityData.description === 'string'
                        ? { zhTW: activityData.description, zhCN: '', en: '' }
                        : activityData.description;

                    // 填充多語言表單
                    document.getElementById('activityTitleZhTW').value = title?.zhTW || '';
                    document.getElementById('activityTitleZhCN').value = title?.zhCN || '';
                    document.getElementById('activityTitleEn').value = title?.en || '';

                    document.getElementById('activityDate').value = activityData.date || '';

                    document.getElementById('activityDescriptionZhTW').value = description?.zhTW || '';
                    document.getElementById('activityDescriptionZhCN').value = description?.zhCN || '';
                    document.getElementById('activityDescriptionEn').value = description?.en || '';

                    document.getElementById('activityLink').value = activityData.link || '';
                    document.getElementById('activityModalTitle').textContent = '編輯活動';
                    document.getElementById('activityModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                showAlert('載入活動資料時發生錯誤');
            }
        };

        window.deleteActivity = (id) => {
            showConfirm('確定要刪除此活動嗎？', async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'activities', id));
                    showAlert('活動已刪除！');
                    loadActivities();
                } catch (error) {
                    console.error('Error deleting activity:', error);
                    showAlert('刪除活動時發生錯誤');
                }
            });
        };

        // Projects Management
        function initProjectHandlers() {
            const addProjectBtn = document.getElementById('addProjectBtn');
            if (addProjectBtn) {
                addProjectBtn.addEventListener('click', () => {
                    document.getElementById('projectModalTitle').textContent = '新增專案';
                    document.getElementById('projectForm').reset();
                    document.getElementById('projectId').value = '';
                    document.getElementById('projectModal').classList.remove('hidden');
                });
            }

            const projectForm = document.getElementById('projectForm');
            if (projectForm) {
                projectForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // 取得多語言輸入值
                    const titleZhTW = document.getElementById('projectTitleZhTW').value.trim();
                    const titleZhCN = document.getElementById('projectTitleZhCN').value.trim();
                    const titleEn = document.getElementById('projectTitleEn').value.trim();
                    const descriptionZhTW = document.getElementById('projectDescriptionZhTW').value.trim();
                    const descriptionZhCN = document.getElementById('projectDescriptionZhCN').value.trim();
                    const descriptionEn = document.getElementById('projectDescriptionEn').value.trim();

                    // 驗證：至少需要填寫一個語言版本的標題和描述（建議繁體中文）
                    if (!titleZhTW && !titleZhCN && !titleEn) {
                        showAlert('請至少填寫一個語言版本的專案標題！');
                        return;
                    }
                    if (!descriptionZhTW && !descriptionZhCN && !descriptionEn) {
                        showAlert('請至少填寫一個語言版本的專案描述！');
                        return;
                    }

                    const techInput = document.getElementById('projectTechnologies').value;
                    const technologies = techInput ? techInput.split(',').map(t => t.trim()) : [];

                    const projectData = {
                        title: {
                            zhTW: titleZhTW,
                            zhCN: titleZhCN,
                            en: titleEn
                        },
                        status: document.getElementById('projectStatus').value,
                        description: {
                            zhTW: descriptionZhTW,
                            zhCN: descriptionZhCN,
                            en: descriptionEn
                        },
                        technologies: technologies,
                        members: parseInt(document.getElementById('projectMembers').value) || 0,
                        link: document.getElementById('projectLink').value || ''
                    };

                    try {
                        const projectId = document.getElementById('projectId').value;

                        if (projectId) {
                            // Update existing project
                            const { doc, updateDoc, serverTimestamp } = window.firestoreModules;
                            projectData.updatedAt = serverTimestamp();
                            await updateDoc(doc(window.firebaseDB, 'projects', projectId), projectData);
                            showAlert('專案已更新！');
                        } else {
                            // Add new project
                            const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                            projectData.createdAt = serverTimestamp();
                            await addDoc(collection(window.firebaseDB, 'projects'), projectData);
                            showAlert('專案已新增！');
                        }

                        document.getElementById('projectModal').classList.add('hidden');
                        loadProjects();
                    } catch (error) {
                        console.error('Error saving project:', error);
                        showAlert('儲存專案時發生錯誤');
                    }
                });
            }
        }

        async function loadProjects() {
            const loadingEl = document.getElementById('projectsLoading');
            const listEl = document.getElementById('projectsList');
            const emptyEl = document.getElementById('projectsEmptyState');

            loadingEl.classList.remove('hidden');
            listEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const { collection, getDocs } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'projects'));

                loadingEl.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                querySnapshot.forEach((docSnapshot) => {
                    const project = docSnapshot.data();
                    const projectId = docSnapshot.id;

                    // 向後兼容：支持舊格式（字符串）和新格式（對象）
                    const title = typeof project.title === 'string'
                        ? project.title
                        : (project.title?.zhTW || project.title?.zhCN || project.title?.en || '');
                    const description = typeof project.description === 'string'
                        ? project.description
                        : (project.description?.zhTW || project.description?.zhCN || project.description?.en || '');

                    const statusColors = {
                        '進行中': 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200',
                        '已完成': 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200',
                        '計劃中': 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200'
                    };

                    const statusClass = statusColors[project.status] || statusColors['進行中'];
                    const techTags = (project.technologies || []).map(tech =>
                        `<span class="px-2 py-1 bg-primary/10 text-primary rounded-full text-xs">${tech}</span>`
                    ).join(' ');

                    const projectCard = document.createElement('div');
                    projectCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-6';
                    projectCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-lg font-bold">${title}</h3>
                                    <span class="px-3 py-1 ${statusClass} rounded-full text-xs font-semibold">${project.status || '進行中'}</span>
                                </div>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">${description}</p>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${techTags}
                                </div>
                                <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                                    參與成員: ${project.members || 0} 位
                                </div>
                                ${project.link ? `<a href="${project.link}" target="_blank" class="text-sm text-primary hover:underline">查看專案 →</a>` : ''}
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="editProject('${projectId}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">編輯</button>
                                <button onclick="deleteProject('${projectId}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">刪除</button>
                            </div>
                        </div>
                    `;

                    listEl.appendChild(projectCard);
                });

                listEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading projects:', error);
                loadingEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-red-500">載入專案時發生錯誤</p>';
                emptyEl.classList.remove('hidden');
            }
        }

        window.editProject = async (id) => {
            try {
                const { collection, getDocs } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'projects'));

                let projectData = null;
                querySnapshot.forEach((docSnapshot) => {
                    if (docSnapshot.id === id) {
                        projectData = docSnapshot.data();
                    }
                });

                if (projectData) {
                    document.getElementById('projectId').value = id;

                    // 向後兼容：如果數據是舊格式（字符串），轉換為新格式（對象）
                    const title = typeof projectData.title === 'string'
                        ? { zhTW: projectData.title, zhCN: '', en: '' }
                        : projectData.title;
                    const description = typeof projectData.description === 'string'
                        ? { zhTW: projectData.description, zhCN: '', en: '' }
                        : projectData.description;

                    // 填充多語言表單
                    document.getElementById('projectTitleZhTW').value = title?.zhTW || '';
                    document.getElementById('projectTitleZhCN').value = title?.zhCN || '';
                    document.getElementById('projectTitleEn').value = title?.en || '';

                    document.getElementById('projectStatus').value = projectData.status || '進行中';

                    document.getElementById('projectDescriptionZhTW').value = description?.zhTW || '';
                    document.getElementById('projectDescriptionZhCN').value = description?.zhCN || '';
                    document.getElementById('projectDescriptionEn').value = description?.en || '';

                    document.getElementById('projectTechnologies').value = (projectData.technologies || []).join(', ');
                    document.getElementById('projectMembers').value = projectData.members || 0;
                    document.getElementById('projectLink').value = projectData.link || '';
                    document.getElementById('projectModalTitle').textContent = '編輯專案';
                    document.getElementById('projectModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading project:', error);
                showAlert('載入專案資料時發生錯誤');
            }
        };

        window.deleteProject = (id) => {
            showConfirm('確定要刪除此專案嗎？', async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'projects', id));
                    showAlert('專案已刪除！');
                    loadProjects();
                } catch (error) {
                    console.error('Error deleting project:', error);
                    showAlert('刪除專案時發生錯誤');
                }
            });
        };

        // ========================================
        // Team Management
        // ========================================

        // Add Team Member Button
        const addTeamMemberBtn = document.getElementById('addTeamMemberBtn');
        if (addTeamMemberBtn) {
            addTeamMemberBtn.addEventListener('click', () => {
                document.getElementById('teamMemberModalTitle').textContent = '新增團隊成員';
                document.getElementById('teamMemberForm').reset();
                document.getElementById('teamMemberId').value = '';
                document.getElementById('teamMemberModal').classList.remove('hidden');
            });
        }

        // Team Member Form Submit
        const teamMemberForm = document.getElementById('teamMemberForm');
        if (teamMemberForm) {
            teamMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Get multilingual inputs
                const nameZhTW = document.getElementById('memberNameZhTW').value.trim();
                const nameZhCN = document.getElementById('memberNameZhCN').value.trim();
                const nameEn = document.getElementById('memberNameEn').value.trim();
                const positionZhTW = document.getElementById('memberPositionZhTW').value.trim();
                const positionZhCN = document.getElementById('memberPositionZhCN').value.trim();
                const positionEn = document.getElementById('memberPositionEn').value.trim();

                // Validation
                if (!nameZhTW || !positionZhTW) {
                    showAlert('請至少填寫繁體中文的姓名和職位');
                    return;
                }

                const order = parseInt(document.getElementById('memberOrder').value);
                if (isNaN(order) || order < 0) {
                    showAlert('請填寫有效的排序順序（0或正整數）');
                    return;
                }

                const memberData = {
                    name_zhTW: nameZhTW,
                    name_zhCN: nameZhCN,
                    name_en: nameEn,
                    position_zhTW: positionZhTW,
                    position_zhCN: positionZhCN,
                    position_en: positionEn,
                    email: document.getElementById('memberEmail').value.trim() || '',
                    order: order
                };

                try {
                    const memberId = document.getElementById('teamMemberId').value;

                    if (memberId) {
                        const { doc, updateDoc, serverTimestamp } = window.firestoreModules;
                        memberData.updatedAt = serverTimestamp();
                        await updateDoc(doc(window.firebaseDB, 'team', memberId), memberData);
                        showAlert('團隊成員已更新！');
                    } else {
                        const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                        memberData.createdAt = serverTimestamp();
                        await addDoc(collection(window.firebaseDB, 'team'), memberData);
                        showAlert('團隊成員已新增！');
                    }

                    document.getElementById('teamMemberModal').classList.add('hidden');
                    loadTeamMembers();
                } catch (error) {
                    console.error('Error saving team member:', error);
                    showAlert('儲存團隊成員時發生錯誤');
                }
            });
        }

        async function loadTeamMembers() {
            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'team'), orderBy('order', 'asc'));
                const querySnapshot = await getDocs(q);

                const listEl = document.getElementById('teamList');

                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">暫無團隊成員</p>';
                    return;
                }

                listEl.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const member = doc.data();

                    // Display preferring zhTW version
                    const name = member.name_zhTW || member.name_zhCN || member.name_en || '未命名';
                    const position = member.position_zhTW || member.position_zhCN || member.position_en || '';

                    listEl.innerHTML += `
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-lg font-bold">
                                            ${name[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200">${name}</h3>
                                            <p class="text-sm text-purple-600 dark:text-purple-400">${position}</p>
                                        </div>
                                    </div>
                                    ${member.email ? `<p class="text-sm text-gray-600 dark:text-gray-400 ml-15"><i class="fas fa-envelope mr-2"></i>${member.email}</p>` : ''}
                                    <p class="text-xs text-gray-500 dark:text-gray-500 ml-15 mt-1">排序: ${member.order}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editTeamMember('${doc.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors">編輯</button>
                                    <button onclick="deleteTeamMember('${doc.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors">刪除</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading team members:', error);
                document.getElementById('teamList').innerHTML = '<p class="text-red-500 text-center py-8">載入團隊成員時發生錯誤</p>';
            }
        }

        window.editTeamMember = async (id) => {
            try {
                const { doc, getDocs, collection } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'team'));

                let memberData = null;
                querySnapshot.forEach((doc) => {
                    if (doc.id === id) {
                        memberData = doc.data();
                    }
                });

                if (memberData) {
                    document.getElementById('teamMemberId').value = id;
                    document.getElementById('memberNameZhTW').value = memberData.name_zhTW || '';
                    document.getElementById('memberNameZhCN').value = memberData.name_zhCN || '';
                    document.getElementById('memberNameEn').value = memberData.name_en || '';
                    document.getElementById('memberPositionZhTW').value = memberData.position_zhTW || '';
                    document.getElementById('memberPositionZhCN').value = memberData.position_zhCN || '';
                    document.getElementById('memberPositionEn').value = memberData.position_en || '';
                    document.getElementById('memberEmail').value = memberData.email || '';
                    document.getElementById('memberOrder').value = memberData.order || 0;

                    document.getElementById('teamMemberModalTitle').textContent = '編輯團隊成員';
                    document.getElementById('teamMemberModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading team member:', error);
                showAlert('載入團隊成員時發生錯誤');
            }
        };

        window.deleteTeamMember = (id) => {
            showConfirm('確定要刪除此團隊成員嗎？', async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'team', id));
                    showAlert('團隊成員已刪除！');
                    loadTeamMembers();
                } catch (error) {
                    console.error('Error deleting team member:', error);
                    showAlert('刪除團隊成員時發生錯誤');
                }
            });
        };

        // ========================================
        // Alert and Confirm Functions
        // ========================================
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg transition-colors" onclick="this.closest('.fixed').remove()">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">取消</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition-colors">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());
            modal.querySelector('.confirm-btn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        window.showAlert = showAlert;
        window.showConfirm = showConfirm;

        // ========================================
        // Contacts Management
        // ========================================

        let currentFilter = 'all';
        let allContacts = [];

        async function loadContacts() {
            const loadingEl = document.getElementById('contactsLoading');
            const listEl = document.getElementById('contactsList');
            const emptyEl = document.getElementById('contactsEmptyState');

            loadingEl.classList.remove('hidden');
            listEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'contact_submissions'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);

                loadingEl.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                allContacts = [];
                querySnapshot.forEach((docSnapshot) => {
                    const contact = docSnapshot.data();
                    allContacts.push({
                        id: docSnapshot.id,
                        ...contact
                    });
                });

                renderContacts();
            } catch (error) {
                console.error('Error loading contacts:', error);
                loadingEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-red-500">載入訊息時發生錯誤</p>';
                emptyEl.classList.remove('hidden');
            }
        }

        function renderContacts() {
            const listEl = document.getElementById('contactsList');
            const emptyEl = document.getElementById('contactsEmptyState');

            let filteredContacts = allContacts;
            if (currentFilter === 'unread') {
                filteredContacts = allContacts.filter(c => c.status === 'unread');
            } else if (currentFilter === 'replied') {
                filteredContacts = allContacts.filter(c => c.status === 'replied');
            }

            if (filteredContacts.length === 0) {
                listEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">沒有符合條件的訊息</p>';
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');

            listEl.innerHTML = '';
            filteredContacts.forEach((contact) => {
                const createdDate = contact.createdAt ? new Date(contact.createdAt.seconds * 1000).toLocaleString('zh-TW') : '未知時間';
                const statusBadge = contact.status === 'replied'
                    ? '<span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full text-xs font-semibold">已回覆</span>'
                    : '<span class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-full text-xs font-semibold">未讀</span>';

                const contactCard = document.createElement('div');
                contactCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-6';
                contactCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-lg font-bold">${contact.subject || ''}</h3>
                                ${statusBadge}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                                <i class="fas fa-envelope mr-1"></i>${contact.email || ''}
                                <span class="mx-2">|</span>
                                <i class="fas fa-clock mr-1"></i>${createdDate}
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 mb-3 whitespace-pre-wrap">${contact.message || ''}</p>
                            ${contact.reply ? `
                                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                    <p class="text-sm font-semibold text-blue-800 dark:text-blue-300 mb-2">
                                        <i class="fas fa-reply mr-1"></i>您的回覆
                                    </p>
                                    <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${contact.reply}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                        回覆時間：${contact.repliedAt ? new Date(contact.repliedAt.seconds * 1000).toLocaleString('zh-TW') : ''}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="showReplyModal('${contact.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                <i class="fas fa-reply mr-1"></i>${contact.reply ? '再次回覆' : '回覆'}
                            </button>
                            <button onclick="deleteContact('${contact.id}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                <i class="fas fa-trash mr-1"></i>刪除
                            </button>
                        </div>
                    </div>
                `;

                listEl.appendChild(contactCard);
            });

            listEl.classList.remove('hidden');
        }

        window.filterContacts = function(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            event.target.classList.add('bg-primary', 'text-white');
            renderContacts();
        };

        window.showReplyModal = function(contactId) {
            const contact = allContacts.find(c => c.id === contactId);
            if (!contact) return;

            document.getElementById('replyContactId').value = contactId;
            document.getElementById('replyEmail').textContent = contact.email;
            document.getElementById('replySubject').textContent = contact.subject;
            document.getElementById('replyOriginalMessage').textContent = contact.message;
            document.getElementById('replyContent').value = contact.reply || '';

            document.getElementById('replyModal').classList.remove('hidden');
        };

        window.closeReplyModal = function() {
            document.getElementById('replyModal').classList.add('hidden');
            document.getElementById('replyForm').reset();
        };

        window.handleReply = async function(event) {
            event.preventDefault();

            const contactId = document.getElementById('replyContactId').value;
            const replyContent = document.getElementById('replyContent').value;
            const contact = allContacts.find(c => c.id === contactId);

            if (!contact) return;

            try {
                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'contact_submissions', contactId), {
                    reply: replyContent,
                    repliedAt: new Date(),
                    status: 'replied'
                });

                // 發送電郵回覆
                const mailtoLink = `mailto:${contact.email}?subject=Re: ${encodeURIComponent(contact.subject)}&body=${encodeURIComponent(replyContent)}`;
                window.open(mailtoLink, '_blank');

                showAlert('回覆已保存！請在您的電郵客戶端發送郵件。');
                closeReplyModal();
                loadContacts();
            } catch (error) {
                console.error('Error sending reply:', error);
                showAlert('回覆時發生錯誤');
            }
        };

        window.deleteContact = function(id) {
            showConfirm('確定要刪除此訊息嗎？', async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'contact_submissions', id));
                    showAlert('訊息已刪除！');
                    loadContacts();
                } catch (error) {
                    console.error('Error deleting contact:', error);
                    showAlert('刪除訊息時發生錯誤');
                }
            });
        };

        // 刪除所有聯絡訊息
        window.deleteAllContacts = function() {
            showConfirm('確定要刪除所有聯絡訊息嗎？此操作無法復原！', async () => {
                try {
                    const { collection, getDocs, doc, deleteDoc } = window.firestoreModules;
                    const querySnapshot = await getDocs(collection(window.firebaseDB, 'contact_submissions'));

                    if (querySnapshot.empty) {
                        showAlert('沒有訊息可刪除');
                        return;
                    }

                    const deletePromises = [];
                    querySnapshot.forEach((docSnapshot) => {
                        deletePromises.push(deleteDoc(doc(window.firebaseDB, 'contact_submissions', docSnapshot.id)));
                    });

                    await Promise.all(deletePromises);
                    showAlert(`已刪除 ${deletePromises.length} 條訊息！`);
                    loadContacts();
                } catch (error) {
                    console.error('Error deleting all contacts:', error);
                    showAlert('刪除訊息時發生錯誤');
                }
            });
        };

        // ========================================
        // Hero Section Management
        // ========================================

        // 在導航按鈕事件中添加 hero 和其他新功能的載入
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const originalHandler = btn.onclick;
            btn.addEventListener('click', () => {
                const section = btn.dataset.section;
                if (section === 'hero') {
                    loadHeroSettings();
                } else if (section === 'announcements') {
                    loadAnnouncements();
                } else if (section === 'contactSettings') {
                    loadContactSettings();
                } else if (section === 'anthemSettings') {
                    loadAnthemSettings();
                } else if (section === 'visitorStats') {
                    loadVisitorStats();
                } else if (section === 'profile') {
                    loadProfile();
                }
            });
        });

        async function loadHeroSettings() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const settingsDoc = await getDoc(doc(window.firebaseDB, 'settings', 'hero'));

                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    document.getElementById('heroTitleZhTW').value = data.title?.zhTW || '';
                    document.getElementById('heroSubtitleZhTW').value = data.subtitle?.zhTW || '';
                    document.getElementById('heroTitleZhCN').value = data.title?.zhCN || '';
                    document.getElementById('heroSubtitleZhCN').value = data.subtitle?.zhCN || '';
                    document.getElementById('heroTitleEn').value = data.title?.en || '';
                    document.getElementById('heroSubtitleEn').value = data.subtitle?.en || '';
                }
            } catch (error) {
                console.error('Error loading hero settings:', error);
            }
        }

        const heroForm = document.getElementById('heroForm');
        if (heroForm) {
            heroForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const heroData = {
                    title: {
                        zhTW: document.getElementById('heroTitleZhTW').value,
                        zhCN: document.getElementById('heroTitleZhCN').value,
                        en: document.getElementById('heroTitleEn').value
                    },
                    subtitle: {
                        zhTW: document.getElementById('heroSubtitleZhTW').value,
                        zhCN: document.getElementById('heroSubtitleZhCN').value,
                        en: document.getElementById('heroSubtitleEn').value
                    }
                };

                try {
                    const { doc, setDoc } = window.firestoreModules;
                    await setDoc(doc(window.firebaseDB, 'settings', 'hero'), heroData);
                    showAlert('首頁標語已儲存！');
                } catch (error) {
                    console.error('Error saving hero settings:', error);
                    showAlert('儲存首頁標語時發生錯誤');
                }
            });
        }

        // ========================================
        // Contact Settings Management
        // ========================================

        async function loadContactSettings() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const settingsDoc = await getDoc(doc(window.firebaseDB, 'settings', 'contact'));

                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    document.getElementById('contactAddressZhTW').value = data.address_zh_tw || data.address || '';
                    document.getElementById('contactAddressZhCN').value = data.address_zh_cn || '';
                    document.getElementById('contactAddressEn').value = data.address_en || '';
                    document.getElementById('contactPhone').value = data.phone || '';
                    document.getElementById('contactEmail').value = data.email || '';
                }
            } catch (error) {
                console.error('Error loading contact settings:', error);
            }
        }

        const contactSettingsForm = document.getElementById('contactSettingsForm');
        if (contactSettingsForm) {
            contactSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const contactData = {
                    address_zh_tw: document.getElementById('contactAddressZhTW').value,
                    address_zh_cn: document.getElementById('contactAddressZhCN').value,
                    address_en: document.getElementById('contactAddressEn').value,
                    phone: document.getElementById('contactPhone').value,
                    email: document.getElementById('contactEmail').value
                };

                try {
                    const { doc, setDoc } = window.firestoreModules;
                    await setDoc(doc(window.firebaseDB, 'settings', 'contact'), contactData);
                    showAlert('聯絡資訊已儲存！');
                } catch (error) {
                    console.error('Error saving contact settings:', error);
                    showAlert('儲存聯絡資訊時發生錯誤');
                }
            });
        }

        // ========================================
        // Anthem Settings Management
        // ========================================

        async function loadAnthemSettings() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const settingsDoc = await getDoc(doc(window.firebaseDB, 'settings', 'anthem'));

                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    document.getElementById('anthemTitleZhTW').value = data.title_zh_tw || '';
                    document.getElementById('anthemTitleZhCN').value = data.title_zh_cn || '';
                    document.getElementById('anthemTitleEn').value = data.title_en || '';
                    document.getElementById('anthemDescZhTW').value = data.description_zh_tw || '';
                    document.getElementById('anthemDescZhCN').value = data.description_zh_cn || '';
                    document.getElementById('anthemDescEn').value = data.description_en || '';
                }
            } catch (error) {
                console.error('Error loading anthem settings:', error);
            }
        }

        const anthemSettingsForm = document.getElementById('anthemSettingsForm');
        if (anthemSettingsForm) {
            anthemSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const anthemData = {
                    title_zh_tw: document.getElementById('anthemTitleZhTW').value,
                    title_zh_cn: document.getElementById('anthemTitleZhCN').value,
                    title_en: document.getElementById('anthemTitleEn').value,
                    description_zh_tw: document.getElementById('anthemDescZhTW').value,
                    description_zh_cn: document.getElementById('anthemDescZhCN').value,
                    description_en: document.getElementById('anthemDescEn').value
                };

                try {
                    const { doc, setDoc } = window.firestoreModules;
                    await setDoc(doc(window.firebaseDB, 'settings', 'anthem'), anthemData);
                    showAlert('會歌設置已儲存！');
                } catch (error) {
                    console.error('Error saving anthem settings:', error);
                    showAlert('儲存會歌設置時發生錯誤');
                }
            });
        }

        // ========================================
        // Visitor Stats Management
        // ========================================

        async function loadVisitorStats() {
            await refreshVisitorStats();
            await loadWebsiteStatus();
            await loadVisitorSettings();
            await loadVisitorHistory();
        }

        // 載入網站狀態
        async function loadWebsiteStatus() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const websiteDoc = await getDoc(doc(window.firebaseDB, 'settings', 'website'));

                const toggle = document.getElementById('websiteDisabledToggle');
                if (websiteDoc.exists()) {
                    const data = websiteDoc.data();
                    toggle.checked = data.disabled === true;
                } else {
                    toggle.checked = false;
                }

                updateWebsiteStatusMessage(toggle.checked);
            } catch (error) {
                console.error('Error loading website status:', error);
            }
        }

        // 更新網站狀態訊息
        function updateWebsiteStatusMessage(isDisabled) {
            const messageDiv = document.getElementById('websiteStatusMessage');
            if (isDisabled) {
                messageDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>網站目前已停用，訪客將看到維護頁面。';
                messageDiv.classList.remove('hidden');
            } else {
                messageDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300';
                messageDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>網站正常運作中。';
                messageDiv.classList.remove('hidden');
            }
        }

        // 儲存網站狀態
        async function saveWebsiteStatus(isDisabled) {
            try {
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.firebaseDB, 'settings', 'website'), {
                    disabled: isDisabled,
                    updatedAt: new Date()
                });

                updateWebsiteStatusMessage(isDisabled);
                showNotification(isDisabled ? '網站已停用' : '網站已啟用', 'success');
            } catch (error) {
                console.error('Error saving website status:', error);
                showNotification('儲存失敗: ' + error.message, 'error');
            }
        }

        // ========================================
        // 踢出訪客功能
        // ========================================

        // 顯示確認對話框
        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">取消</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.cancel-btn').addEventListener('click', () => {
                modal.remove();
            });

            modal.querySelector('.confirm-btn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
        }

        // 踢出所有訪客（直接踢出）
        async function kickOutAllVisitors() {
            showConfirmDialog('確定要踢出所有在線訪客嗎？此操作無法撤銷。', async () => {
                await performKickOutAll();
            });
        }

        async function performKickOutAll() {
            try {
                const { collection, query, where, getDocs, updateDoc, doc, serverTimestamp } = window.firestoreModules;

                const visitorsRef = collection(window.firebaseDB, 'visitors');
                const activeQuery = query(visitorsRef, where('active', '==', true));
                const snapshot = await getDocs(activeQuery);

                let kickedCount = 0;
                const batch = [];

                snapshot.forEach(docSnapshot => {
                    batch.push(updateDoc(doc(window.firebaseDB, 'visitors', docSnapshot.id), {
                        active: false,
                        kickedAt: new Date(),
                        kickReason: 'admin_kick_all'
                    }));
                    kickedCount++;
                });

                await Promise.all(batch);

                showNotification(`已踢出 ${kickedCount} 位訪客`, 'success');
                refreshVisitorStats();
            } catch (error) {
                console.error('踢出訪客失敗:', error);
                showNotification('踢出失敗: ' + error.message, 'error');
            }
        }

        // 發送踢出警告（30秒倒數）
        async function sendKickWarning() {
            try {
                const { doc, setDoc } = window.firestoreModules;

                // 設置踢出警告時間戳
                await setDoc(doc(window.firebaseDB, 'settings', 'kick_warning'), {
                    active: true,
                    warningTime: new Date(),
                    kickTime: new Date(Date.now() + 30000) // 30秒後
                });

                showNotification('已發送踢出警告，訪客需在30秒內回應', 'success');
                document.getElementById('cancelKickWarningBtn').classList.remove('hidden');
            } catch (error) {
                console.error('發送警告失敗:', error);
                showNotification('發送失敗: ' + error.message, 'error');
            }
        }

        // 取消踢出警告
        async function cancelKickWarning() {
            try {
                const { doc, setDoc } = window.firestoreModules;

                await setDoc(doc(window.firebaseDB, 'settings', 'kick_warning'), {
                    active: false,
                    cancelledAt: new Date()
                });

                showNotification('已取消踢出警告', 'success');
                document.getElementById('cancelKickWarningBtn').classList.add('hidden');
            } catch (error) {
                console.error('取消警告失敗:', error);
                showNotification('取消失敗: ' + error.message, 'error');
            }
        }

        // 綁定網站停用開關
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('websiteDisabledToggle');
            if (toggle) {
                toggle.addEventListener('change', (e) => {
                    saveWebsiteStatus(e.target.checked);
                });
            }
        });

        window.refreshVisitorStats = async function() {
            try {
                const { collection, query, where, getDocs, orderBy, Timestamp } = window.firestoreModules;

                // Get online visitors (active within last 2 minutes)
                const twoMinutesAgo = new Date(Date.now() - 120000);
                const visitorsRef = collection(window.firebaseDB, 'visitors');

                // Get active visitors
                const activeQuery = query(
                    visitorsRef,
                    where('active', '==', true)
                );
                const activeSnapshot = await getDocs(activeQuery);

                // Filter by lastHeartbeat manually (Firestore compound query limitation)
                let onlineCount = 0;
                activeSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.lastHeartbeat) {
                        const heartbeatTime = data.lastHeartbeat.toDate ? data.lastHeartbeat.toDate() : new Date(data.lastHeartbeat);
                        if (heartbeatTime > twoMinutesAgo) {
                            onlineCount++;
                        }
                    }
                });

                document.getElementById('statOnlineVisitors').textContent = onlineCount;

                // Get today's visitors
                const today = new Date().toISOString().split('T')[0];
                const historyRef = collection(window.firebaseDB, 'visit_history');
                const todayQuery = query(historyRef, where('date', '==', today));
                const todaySnapshot = await getDocs(todayQuery);

                document.getElementById('statTodayVisitors').textContent = todaySnapshot.size;

                // Get total visitors
                const totalSnapshot = await getDocs(collection(window.firebaseDB, 'visit_history'));
                document.getElementById('statTotalVisitors').textContent = totalSnapshot.size;

            } catch (error) {
                console.error('Error refreshing visitor stats:', error);
            }
        };

        async function loadVisitorSettings() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const settingsDoc = await getDoc(doc(window.firebaseDB, 'settings', 'visitor'));

                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    document.getElementById('visitorMaxLimit').value = data.maxVisitors || 0;
                } else {
                    document.getElementById('visitorMaxLimit').value = 0;
                }
            } catch (error) {
                console.error('Error loading visitor settings:', error);
            }
        }

        async function loadVisitorHistory() {
            const loadingEl = document.getElementById('visitorHistoryLoading');
            const listEl = document.getElementById('visitorHistoryList');
            const emptyEl = document.getElementById('visitorHistoryEmpty');
            const tableBody = document.getElementById('visitorHistoryTableBody');

            loadingEl.classList.remove('hidden');
            listEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            tableBody.innerHTML = '';

            try {
                const { collection, getDocs } = window.firestoreModules;
                const historySnapshot = await getDocs(collection(window.firebaseDB, 'visit_history'));

                loadingEl.classList.add('hidden');

                if (historySnapshot.empty) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                // Group by date
                const dateMap = {};
                historySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.date || 'unknown';
                    if (!dateMap[date]) {
                        dateMap[date] = 0;
                    }
                    dateMap[date]++;
                });

                // Sort by date (newest first)
                const sortedDates = Object.keys(dateMap).sort((a, b) => b.localeCompare(a));

                // Only show last 30 days
                const recentDates = sortedDates.slice(0, 30);

                recentDates.forEach(date => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50';
                    row.innerHTML = `
                        <td class="px-4 py-3">${date}</td>
                        <td class="px-4 py-3 font-semibold">${dateMap[date]}</td>
                    `;
                    tableBody.appendChild(row);
                });

                listEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading visitor history:', error);
                loadingEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-red-500">載入歷史數據時發生錯誤</p>';
                emptyEl.classList.remove('hidden');
            }
        }

        // Visitor Settings Form
        const visitorSettingsForm = document.getElementById('visitorSettingsForm');
        if (visitorSettingsForm) {
            visitorSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const maxVisitors = parseInt(document.getElementById('visitorMaxLimit').value) || 0;

                try {
                    const { doc, setDoc } = window.firestoreModules;
                    await setDoc(doc(window.firebaseDB, 'settings', 'visitor'), {
                        maxVisitors: maxVisitors,
                        updatedAt: new Date()
                    });
                    showAlert('訪客限制設置已儲存！');
                } catch (error) {
                    console.error('Error saving visitor settings:', error);
                    showAlert('儲存設置時發生錯誤');
                }
            });
        }

        // ========================================
        // Announcements Management
        // ========================================

        async function loadAnnouncements() {
            const loadingEl = document.getElementById('announcementsLoading');
            const listEl = document.getElementById('announcementsList');
            const emptyEl = document.getElementById('announcementsEmptyState');

            loadingEl.classList.remove('hidden');
            listEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'announcements'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);

                loadingEl.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                // 先按置頂和時間排序
                const sortedDocs = querySnapshot.docs.sort((a, b) => {
                    const aData = a.data();
                    const bData = b.data();
                    // 置頂優先
                    if (aData.pinned && !bData.pinned) return -1;
                    if (!aData.pinned && bData.pinned) return 1;
                    // 時間排序
                    const aTime = aData.createdAt?.seconds || 0;
                    const bTime = bData.createdAt?.seconds || 0;
                    return bTime - aTime;
                });

                sortedDocs.forEach((docSnapshot) => {
                    const announcement = docSnapshot.data();
                    const announcementId = docSnapshot.id;
                    const createdDate = announcement.createdAt ? new Date(announcement.createdAt.seconds * 1000).toLocaleString('zh-TW') : '未知時間';

                    // 分類標籤
                    const categoryLabels = {
                        'general': { icon: '🟢', text: '一般', color: 'bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200' },
                        'important': { icon: '🟡', text: '重要', color: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200' },
                        'urgent': { icon: '🔴', text: '緊急', color: 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' },
                        'event': { icon: '🔵', text: '活動', color: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' }
                    };
                    const category = announcement.category || 'general';
                    const categoryLabel = categoryLabels[category] || categoryLabels['general'];

                    // 定時發布狀態
                    let scheduleInfo = '';
                    const now = new Date();
                    if (announcement.startTime) {
                        const startDate = announcement.startTime.seconds ? new Date(announcement.startTime.seconds * 1000) : new Date(announcement.startTime);
                        if (startDate > now) {
                            scheduleInfo = `<span class="text-orange-500 text-xs"><i class="fas fa-clock mr-1"></i>預定 ${startDate.toLocaleString('zh-TW')} 發布</span>`;
                        }
                    }
                    if (announcement.endTime) {
                        const endDate = announcement.endTime.seconds ? new Date(announcement.endTime.seconds * 1000) : new Date(announcement.endTime);
                        if (endDate < now) {
                            scheduleInfo = `<span class="text-gray-400 text-xs"><i class="fas fa-times-circle mr-1"></i>已於 ${endDate.toLocaleString('zh-TW')} 結束</span>`;
                        } else {
                            scheduleInfo += scheduleInfo ? ' | ' : '';
                            scheduleInfo += `<span class="text-blue-500 text-xs"><i class="fas fa-hourglass-end mr-1"></i>結束於 ${endDate.toLocaleString('zh-TW')}</span>`;
                        }
                    }

                    // 圖片預覽
                    const imagePreview = announcement.imageUrl ? `
                        <div class="mt-3">
                            <img src="${announcement.imageUrl}" alt="公告圖片" class="max-h-32 rounded-lg object-cover cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${announcement.imageUrl}', '_blank')">
                        </div>
                    ` : '';

                    // 準備編輯資料
                    const editDataStr = encodeURIComponent(JSON.stringify({
                        id: announcementId,
                        title: announcement.title || '',
                        content: announcement.content || '',
                        imageUrl: announcement.imageUrl || '',
                        category: announcement.category || 'general',
                        pinned: announcement.pinned || false,
                        startTime: announcement.startTime ? (announcement.startTime.seconds ? new Date(announcement.startTime.seconds * 1000).toISOString().slice(0, 16) : new Date(announcement.startTime).toISOString().slice(0, 16)) : '',
                        endTime: announcement.endTime ? (announcement.endTime.seconds ? new Date(announcement.endTime.seconds * 1000).toISOString().slice(0, 16) : new Date(announcement.endTime).toISOString().slice(0, 16)) : ''
                    }));

                    const announcementCard = document.createElement('div');
                    announcementCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-6';
                    announcementCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center gap-2 mb-2">
                                    ${announcement.pinned ? '<span class="text-lg" title="置頂">📌</span>' : ''}
                                    <h3 class="text-lg font-bold">${announcement.title || ''}</h3>
                                    <span class="px-2 py-0.5 ${categoryLabel.color} rounded-full text-xs font-semibold">
                                        ${categoryLabel.icon} ${categoryLabel.text}
                                    </span>
                                    <span class="px-2 py-0.5 ${announcement.active ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300'} rounded-full text-xs font-semibold">
                                        ${announcement.active ? '啟用中' : '已停用'}
                                    </span>
                                </div>
                                <p class="text-gray-600 dark:text-gray-400 mb-2">${announcement.content || ''}</p>
                                ${imagePreview}
                                <div class="flex flex-wrap items-center gap-3 mt-3 text-sm text-gray-500 dark:text-gray-400">
                                    <span><i class="fas fa-clock mr-1"></i>${createdDate}</span>
                                    ${scheduleInfo}
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 ml-4">
                                <button onclick="editAnnouncement('${editDataStr}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                    <i class="fas fa-edit mr-1"></i>編輯
                                </button>
                                <button onclick="toggleAnnouncement('${announcementId}', ${!announcement.active})" class="px-4 py-2 ${announcement.active ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg text-sm font-semibold transition-colors">
                                    ${announcement.active ? '停用' : '啟用'}
                                </button>
                                <button onclick="deleteAnnouncement('${announcementId}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">刪除</button>
                            </div>
                        </div>
                    `;

                    listEl.appendChild(announcementCard);
                });

                listEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading announcements:', error);
                loadingEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-red-500">載入訊息時發生錯誤</p>';
                emptyEl.classList.remove('hidden');
            }
        }

        const addAnnouncementBtn = document.getElementById('addAnnouncementBtn');
        if (addAnnouncementBtn) {
            addAnnouncementBtn.addEventListener('click', () => {
                showEnhancedAnnouncementDialog();
            });
        }

        // 增強版公告對話框
        function showEnhancedAnnouncementDialog(editData = null) {
            const isEdit = !!editData;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4 overflow-y-auto py-8';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full my-auto">
                    <h3 class="text-xl font-bold mb-4">${isEdit ? '編輯訊息' : '新增訊息'}</h3>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <div>
                            <label class="block text-sm font-semibold mb-2">標題 *</label>
                            <input type="text" id="annTitle" value="${editData?.title || ''}" class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">內容 *</label>
                            <textarea id="annContent" rows="4" class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none">${editData?.content || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">圖片 URL（選填）</label>
                            <input type="url" id="annImageUrl" value="${editData?.imageUrl || ''}" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">分類標籤</label>
                            <select id="annCategory" class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                                <option value="general" ${editData?.category === 'general' ? 'selected' : ''}>🟢 一般</option>
                                <option value="important" ${editData?.category === 'important' ? 'selected' : ''}>🟡 重要</option>
                                <option value="urgent" ${editData?.category === 'urgent' ? 'selected' : ''}>🔴 緊急</option>
                                <option value="event" ${editData?.category === 'event' ? 'selected' : ''}>🔵 活動</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="annPinned" ${editData?.pinned ? 'checked' : ''} class="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                                <span class="text-sm font-semibold">📌 置頂公告</span>
                            </label>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <label class="block text-sm font-semibold mb-2">定時發布（選填）</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">開始時間</label>
                                    <input type="datetime-local" id="annStartTime" value="${editData?.startTime || ''}" class="w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">結束時間</label>
                                    <input type="datetime-local" id="annEndTime" value="${editData?.endTime || ''}" class="w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">留空表示立即發布且永久有效</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-colors">${isEdit ? '更新' : '新增'}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());
            modal.querySelector('.confirm-btn').addEventListener('click', async () => {
                const title = document.getElementById('annTitle').value.trim();
                const content = document.getElementById('annContent').value.trim();
                const imageUrl = document.getElementById('annImageUrl').value.trim();
                const category = document.getElementById('annCategory').value;
                const pinned = document.getElementById('annPinned').checked;
                const startTime = document.getElementById('annStartTime').value;
                const endTime = document.getElementById('annEndTime').value;

                if (!title || !content) {
                    showAlert('請輸入標題和內容');
                    return;
                }

                try {
                    const { collection, addDoc, doc, updateDoc } = window.firestoreModules;
                    const data = {
                        title,
                        content,
                        imageUrl,
                        category,
                        pinned,
                        startTime: startTime ? new Date(startTime) : null,
                        endTime: endTime ? new Date(endTime) : null,
                        active: true,
                        updatedAt: new Date()
                    };

                    if (isEdit) {
                        await updateDoc(doc(window.firebaseDB, 'announcements', editData.id), data);
                        showAlert('訊息已更新！');
                    } else {
                        data.createdAt = new Date();
                        await addDoc(collection(window.firebaseDB, 'announcements'), data);
                        showAlert('訊息已新增！');
                    }

                    modal.remove();
                    loadAnnouncements();
                } catch (error) {
                    console.error('Error saving announcement:', error);
                    showAlert('儲存訊息時發生錯誤');
                }
            });
        }
        window.showEnhancedAnnouncementDialog = showEnhancedAnnouncementDialog;

        // 編輯公告按鈕處理
        window.editAnnouncement = function(encodedData) {
            try {
                const editData = JSON.parse(decodeURIComponent(encodedData));
                showEnhancedAnnouncementDialog(editData);
            } catch (error) {
                console.error('Error parsing announcement data:', error);
                showAlert('無法編輯此公告');
            }
        };

        window.toggleAnnouncement = async (id, active) => {
            try {
                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'announcements', id), { active });
                showAlert(active ? '訊息已啟用！' : '訊息已停用！');
                loadAnnouncements();
            } catch (error) {
                console.error('Error toggling announcement:', error);
                showAlert('更新訊息狀態時發生錯誤');
            }
        };

        window.deleteAnnouncement = (id) => {
            showConfirm('確定要刪除此訊息嗎？', async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'announcements', id));
                    showAlert('訊息已刪除！');
                    loadAnnouncements();
                } catch (error) {
                    console.error('Error deleting announcement:', error);
                    showAlert('刪除訊息時發生錯誤');
                }
            });
        };

        // Prompt Dialog for Announcements
        function showPromptDialog(dialogTitle, label1, label2, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">${dialogTitle}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">${label1}</label>
                            <input type="text" id="promptInput1" class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">${label2}</label>
                            <textarea id="promptInput2" rows="4" class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none resize-none"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-colors">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const input1 = modal.querySelector('#promptInput1');
            const input2 = modal.querySelector('#promptInput2');

            modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());
            modal.querySelector('.confirm-btn').addEventListener('click', () => {
                const value1 = input1.value.trim();
                const value2 = input2.value.trim();
                modal.remove();
                onConfirm(value1, value2);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Focus on first input
            setTimeout(() => input1.focus(), 100);
        }

        // ========================================
        // User Management
        // ========================================

        let currentUserFilter = 'all';
        let allUsers = [];

        async function loadUsers() {
            const loadingEl = document.getElementById('usersLoading');
            const listEl = document.getElementById('usersList');
            const emptyEl = document.getElementById('usersEmptyState');

            loadingEl.classList.remove('hidden');
            listEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const { collection, getDocs } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.firebaseDB, 'users'));

                loadingEl.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                allUsers = [];
                querySnapshot.forEach((docSnapshot) => {
                    const user = docSnapshot.data();
                    allUsers.push({
                        id: docSnapshot.id,
                        ...user
                    });
                });

                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                loadingEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-red-500">載入用戶時發生錯誤</p>';
                emptyEl.classList.remove('hidden');
            }
        }

        function renderUsers() {
            const listEl = document.getElementById('usersList');
            const emptyEl = document.getElementById('usersEmptyState');

            let filteredUsers = allUsers;

            // Filter by role or status
            if (currentUserFilter === 'admin') {
                filteredUsers = allUsers.filter(u => u.role === 'admin');
            } else if (currentUserFilter === 'user') {
                filteredUsers = allUsers.filter(u => u.role === 'user' || !u.role);
            } else if (currentUserFilter === 'pending') {
                filteredUsers = allUsers.filter(u => u.status === 'pending');
            } else if (currentUserFilter === 'approved') {
                filteredUsers = allUsers.filter(u => u.status === 'approved');
            } else if (currentUserFilter === 'rejected') {
                filteredUsers = allUsers.filter(u => u.status === 'rejected');
            }

            if (filteredUsers.length === 0) {
                listEl.classList.add('hidden');
                emptyEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">沒有符合條件的用戶</p>';
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');

            listEl.innerHTML = '';
            filteredUsers.forEach((user) => {
                const roleColors = {
                    'admin': 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200',
                    'user': 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'
                };

                const statusColors = {
                    'pending': 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200',
                    'approved': 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200',
                    'rejected': 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'
                };

                const roleClass = roleColors[user.role] || roleColors['user'];
                const statusClass = statusColors[user.status] || statusColors['pending'];

                const roleText = user.role === 'admin' ? '管理員' : '普通用戶';
                const statusText = {
                    'pending': '待審核',
                    'approved': '已批准',
                    'rejected': '已拒絕'
                }[user.status] || '待審核';

                const userCard = document.createElement('div');
                userCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-6';
                userCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-3">
                                <h3 class="text-lg font-bold">${user.name || '未設定姓名'}</h3>
                                <span class="px-3 py-1 ${roleClass} rounded-full text-xs font-semibold">${roleText}</span>
                                <span class="px-3 py-1 ${statusClass} rounded-full text-xs font-semibold">${statusText}</span>
                            </div>
                            <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                                <p><span class="font-semibold">用戶名:</span> ${user.username || '未設定'}</p>
                                <p><span class="font-semibold">電子郵件:</span> ${user.email || ''}</p>
                                <p><span class="font-semibold">用戶 ID:</span> ${user.id}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editUser('${user.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                編輯
                            </button>
                            <button onclick="deleteUser('${user.id}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                刪除
                            </button>
                        </div>
                    </div>
                `;

                listEl.appendChild(userCard);
            });

            listEl.classList.remove('hidden');
        }

        window.filterUsers = function(filter) {
            currentUserFilter = filter;
            document.querySelectorAll('.user-filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            event.target.classList.add('bg-primary', 'text-white');
            renderUsers();
        };

        window.editUser = async function(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('userId').value = userId;
            document.getElementById('userUsername').value = user.username || '未設定';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userRole').value = user.role || 'user';
            document.getElementById('userStatus').value = user.status || 'pending';

            document.getElementById('userModal').classList.remove('hidden');
        };

        window.deleteUser = function(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            // Prevent deleting super admin
            if (userId === SUPER_ADMIN_UID) {
                showAlert('無法刪除超級管理員帳號');
                return;
            }

            // Prevent deleting yourself
            if (userId === currentUser.uid) {
                showAlert('無法刪除自己的帳號');
                return;
            }

            showConfirm(`確定要刪除用戶 "${user.name || user.username || user.email}" 嗎？`, async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'users', userId));
                    showAlert('用戶已刪除！');
                    loadUsers();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showAlert('刪除用戶時發生錯誤');
                }
            });
        };

        // User Modal Handlers
        document.querySelectorAll('.closeUserModal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('userModal').classList.add('hidden');
            });
        });

        const userForm = document.getElementById('userForm');
        if (userForm) {
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const userId = document.getElementById('userId').value;
                const userData = {
                    name: document.getElementById('userName').value,
                    role: document.getElementById('userRole').value,
                    status: document.getElementById('userStatus').value
                };

                try {
                    const { doc, updateDoc } = window.firestoreModules;
                    await updateDoc(doc(window.firebaseDB, 'users', userId), userData);
                    showAlert('用戶資料已更新！');
                    document.getElementById('userModal').classList.add('hidden');
                    loadUsers();
                } catch (error) {
                    console.error('Error updating user:', error);
                    showAlert('更新用戶資料時發生錯誤');
                }
            });
        }

        // ========================================
        // Profile Management
        // ========================================

        let verificationCodes = {
            username: { code: '', email: '', timestamp: 0, newUsername: '' },
            oldEmail: { code: '', email: '', timestamp: 0 },
            newEmail: { code: '', email: '', timestamp: 0, newEmailAddress: '' }
        };

        // Load and display current user profile
        async function loadProfile() {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, getDoc } = window.firestoreModules;
                const userDoc = await getDoc(doc(window.firebaseDB, 'users', user.uid));

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('profileCurrentUsername').textContent = userData.username || '未設定';
                    document.getElementById('profileCurrentEmail').textContent = userData.email || user.email;
                    document.getElementById('profileCurrentName').textContent = userData.name || '未設定';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Generate 6-digit verification code
        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Send verification email using EmailJS
        async function sendVerificationEmail(email, code, purpose) {
            try {
                // 確保 emailjs 已載入
                if (typeof window.emailjs === 'undefined') {
                    console.error('EmailJS is not loaded');
                    return false;
                }

                const templateParams = {
                    to_email: email,
                    verification_code: code,
                    purpose: purpose
                };

                // 使用與 index.html 相同的配置
                await window.emailjs.send(
                    window.emailJSConfig.serviceId,
                    window.emailJSConfig.templateId,
                    templateParams
                );
                return true;
            } catch (error) {
                console.error('Error sending email:', error);
                return false;
            }
        }

        // Check if username exists
        async function checkUsernameExists(username) {
            try {
                const { collection, query, where, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'users'), where('username', '==', username));
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            } catch (error) {
                console.error('Error checking username:', error);
                return false;
            }
        }

        // Check if email exists
        async function checkEmailExists(email) {
            try {
                const { collection, query, where, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'users'), where('email', '==', email));
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            } catch (error) {
                console.error('Error checking email:', error);
                return false;
            }
        }

        // Start update username process
        // Start update name process
        window.startUpdateName = async function() {
            const newName = document.getElementById('profileNewName').value.trim();

            if (!newName) {
                showAlert('請輸入新姓名');
                return;
            }

            if (newName.length < 2 || newName.length > 50) {
                showAlert('姓名必須為 2-50 個字符');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, getDoc } = window.firestoreModules;
                const userDoc = await getDoc(doc(window.firebaseDB, 'users', user.uid));
                const currentName = userDoc.data().name;

                if (newName === currentName) {
                    showAlert('新姓名與當前姓名相同');
                    return;
                }

                const email = userDoc.data().email || user.email;
                const code = generateVerificationCode();

                // Send verification email
                const sent = await sendVerificationEmail(email, code, '修改姓名');

                if (!sent) {
                    showAlert('發送驗證碼失敗，請稍後再試');
                    return;
                }

                // Store verification code
                verificationCodes.name = {
                    code: code,
                    email: email,
                    timestamp: Date.now(),
                    newName: newName
                };

                // Show verification modal
                document.getElementById('verifyNameEmail').textContent = email;
                document.getElementById('nameVerifyCode').value = '';
                document.getElementById('verifyNameModal').classList.remove('hidden');

                showAlert('驗證碼已發送到您的電子郵件');
            } catch (error) {
                console.error('Error starting name update:', error);
                showAlert('發送驗證碼時發生錯誤');
            }
        };

        // Close verify name modal
        window.closeVerifyNameModal = function() {
            document.getElementById('verifyNameModal').classList.add('hidden');
            document.getElementById('nameVerifyCode').value = '';
        };

        // Confirm update name
        window.confirmUpdateName = async function() {
            const inputCode = document.getElementById('nameVerifyCode').value.trim();

            if (!inputCode) {
                showAlert('請輸入驗證碼');
                return;
            }

            // Check if code is expired (10 minutes)
            const elapsed = Date.now() - verificationCodes.name.timestamp;
            if (elapsed > 10 * 60 * 1000) {
                showAlert('驗證碼已過期，請重新發送');
                closeVerifyNameModal();
                return;
            }

            // Verify code
            if (inputCode !== verificationCodes.name.code) {
                showAlert('驗證碼錯誤');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'users', user.uid), {
                    name: verificationCodes.name.newName
                });

                showAlert('姓名已成功修改！');
                closeVerifyNameModal();
                document.getElementById('profileNewName').value = '';
                loadProfile();
            } catch (error) {
                console.error('Error updating name:', error);
                showAlert('修改姓名時發生錯誤');
            }
        };

        // Start update username process
        window.startUpdateUsername = async function() {
            const newUsername = document.getElementById('profileNewUsername').value.trim();

            if (!newUsername) {
                showAlert('請輸入新用戶名');
                return;
            }

            if (newUsername.length < 3 || newUsername.length > 20) {
                showAlert('用戶名必須為 3-20 個字符');
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(newUsername)) {
                showAlert('用戶名只能包含字母、數字、下劃線和連字符');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, getDoc } = window.firestoreModules;
                const userDoc = await getDoc(doc(window.firebaseDB, 'users', user.uid));
                const currentUsername = userDoc.data().username;

                if (newUsername === currentUsername) {
                    showAlert('新用戶名與當前用戶名相同');
                    return;
                }

                // Check if username already exists
                const exists = await checkUsernameExists(newUsername);
                if (exists) {
                    showAlert('此用戶名已被使用');
                    return;
                }

                const email = userDoc.data().email || user.email;
                const code = generateVerificationCode();

                // Send verification email
                const sent = await sendVerificationEmail(email, code, '修改用戶名');

                if (!sent) {
                    showAlert('發送驗證碼失敗，請稍後再試');
                    return;
                }

                // Store verification code
                verificationCodes.username = {
                    code: code,
                    email: email,
                    timestamp: Date.now(),
                    newUsername: newUsername
                };

                // Show verification modal
                document.getElementById('verifyUsernameEmail').textContent = email;
                document.getElementById('usernameVerifyCode').value = '';
                document.getElementById('verifyUsernameModal').classList.remove('hidden');

                showAlert('驗證碼已發送到您的電子郵件');
            } catch (error) {
                console.error('Error starting username update:', error);
                showAlert('發送驗證碼時發生錯誤');
            }
        };

        // Close verify username modal
        window.closeVerifyUsernameModal = function() {
            document.getElementById('verifyUsernameModal').classList.add('hidden');
            document.getElementById('usernameVerifyCode').value = '';
        };

        // Confirm update username
        window.confirmUpdateUsername = async function() {
            const inputCode = document.getElementById('usernameVerifyCode').value.trim();

            if (!inputCode) {
                showAlert('請輸入驗證碼');
                return;
            }

            // Check if code is expired (10 minutes)
            const elapsed = Date.now() - verificationCodes.username.timestamp;
            if (elapsed > 10 * 60 * 1000) {
                showAlert('驗證碼已過期，請重新發送');
                closeVerifyUsernameModal();
                return;
            }

            // Verify code
            if (inputCode !== verificationCodes.username.code) {
                showAlert('驗證碼錯誤');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'users', user.uid), {
                    username: verificationCodes.username.newUsername
                });

                showAlert('用戶名已成功修改！');
                closeVerifyUsernameModal();
                document.getElementById('profileNewUsername').value = '';
                loadProfile();
            } catch (error) {
                console.error('Error updating username:', error);
                showAlert('修改用戶名時發生錯誤');
            }
        };

        // Start update email process
        window.startUpdateEmail = async function() {
            const newEmail = document.getElementById('profileNewEmail').value.trim();

            if (!newEmail) {
                showAlert('請輸入新電子郵件');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                showAlert('請輸入有效的電子郵件地址');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, getDoc } = window.firestoreModules;
                const userDoc = await getDoc(doc(window.firebaseDB, 'users', user.uid));
                const currentEmail = userDoc.data().email || user.email;

                if (newEmail === currentEmail) {
                    showAlert('新電子郵件與當前電子郵件相同');
                    return;
                }

                // Check if email already exists
                const exists = await checkEmailExists(newEmail);
                if (exists) {
                    showAlert('此電子郵件已被使用');
                    return;
                }

                // Send verification code to old email
                const code = generateVerificationCode();
                const sent = await sendVerificationEmail(currentEmail, code, '驗證舊電子郵件');

                if (!sent) {
                    showAlert('發送驗證碼失敗，請稍後再試');
                    return;
                }

                // Store verification code
                verificationCodes.oldEmail = {
                    code: code,
                    email: currentEmail,
                    timestamp: Date.now()
                };

                verificationCodes.newEmail.newEmailAddress = newEmail;

                // Show old email verification modal
                document.getElementById('verifyOldEmailAddress').textContent = currentEmail;
                document.getElementById('oldEmailVerifyCode').value = '';
                document.getElementById('verifyOldEmailModal').classList.remove('hidden');

                showAlert('驗證碼已發送到您的舊電子郵件');
            } catch (error) {
                console.error('Error starting email update:', error);
                showAlert('發送驗證碼時發生錯誤');
            }
        };

        // Close verify old email modal
        window.closeVerifyOldEmailModal = function() {
            document.getElementById('verifyOldEmailModal').classList.add('hidden');
            document.getElementById('oldEmailVerifyCode').value = '';
        };

        // Confirm old email and send new email verification
        window.confirmOldEmail = async function() {
            const inputCode = document.getElementById('oldEmailVerifyCode').value.trim();

            if (!inputCode) {
                showAlert('請輸入驗證碼');
                return;
            }

            // Check if code is expired (10 minutes)
            const elapsed = Date.now() - verificationCodes.oldEmail.timestamp;
            if (elapsed > 10 * 60 * 1000) {
                showAlert('驗證碼已過期，請重新發送');
                closeVerifyOldEmailModal();
                return;
            }

            // Verify code
            if (inputCode !== verificationCodes.oldEmail.code) {
                showAlert('驗證碼錯誤');
                return;
            }

            // Old email verified, now send code to new email
            try {
                const newEmail = verificationCodes.newEmail.newEmailAddress;
                const code = generateVerificationCode();
                const sent = await sendVerificationEmail(newEmail, code, '驗證新電子郵件');

                if (!sent) {
                    showAlert('發送驗證碼失敗，請稍後再試');
                    return;
                }

                // Store new email verification code
                verificationCodes.newEmail.code = code;
                verificationCodes.newEmail.email = newEmail;
                verificationCodes.newEmail.timestamp = Date.now();

                // Close old email modal and show new email modal
                closeVerifyOldEmailModal();
                document.getElementById('verifyNewEmailAddress').textContent = newEmail;
                document.getElementById('newEmailVerifyCode').value = '';
                document.getElementById('verifyNewEmailModal').classList.remove('hidden');

                showAlert('驗證碼已發送到您的新電子郵件');
            } catch (error) {
                console.error('Error sending new email verification:', error);
                showAlert('發送驗證碼時發生錯誤');
            }
        };

        // Close verify new email modal
        window.closeVerifyNewEmailModal = function() {
            document.getElementById('verifyNewEmailModal').classList.add('hidden');
            document.getElementById('newEmailVerifyCode').value = '';
        };

        // Confirm update email
        window.confirmUpdateEmail = async function() {
            const inputCode = document.getElementById('newEmailVerifyCode').value.trim();

            if (!inputCode) {
                showAlert('請輸入驗證碼');
                return;
            }

            // Check if code is expired (10 minutes)
            const elapsed = Date.now() - verificationCodes.newEmail.timestamp;
            if (elapsed > 10 * 60 * 1000) {
                showAlert('驗證碼已過期，請重新開始');
                closeVerifyNewEmailModal();
                return;
            }

            // Verify code
            if (inputCode !== verificationCodes.newEmail.code) {
                showAlert('驗證碼錯誤');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'users', user.uid), {
                    email: verificationCodes.newEmail.newEmailAddress
                });

                showAlert('電子郵件已成功修改！');
                closeVerifyNewEmailModal();
                document.getElementById('profileNewEmail').value = '';
                loadProfile();
            } catch (error) {
                console.error('Error updating email:', error);
                showAlert('修改電子郵件時發生錯誤');
            }
        };

        // ==================== Add User Functionality ====================

        // Store verification data for new user
        let newUserData = null;

        // Open add user modal
        document.getElementById('addUserBtn').addEventListener('click', () => {
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserStatus').value = 'approved'; // 預設為已批准
            document.getElementById('addUserModal').classList.remove('hidden');
        });

        // Close add user modal
        document.querySelectorAll('.closeAddUserModal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('addUserModal').classList.add('hidden');
                document.getElementById('addUserForm').reset();
            });
        });

        // Close add user verify modal
        window.closeAddUserVerifyModal = function() {
            document.getElementById('addUserVerifyModal').classList.add('hidden');
            document.getElementById('addUserVerifyCode').value = '';
        };

        // Handle add user form submission (send verification code)
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 獲取表單數據
            const name = document.getElementById('addUserName').value.trim();
            const username = document.getElementById('addUserUsername').value.trim();
            const email = document.getElementById('addUserEmail').value.trim();
            const password = document.getElementById('addUserPassword').value;
            const passwordConfirm = document.getElementById('addUserPasswordConfirm').value;
            const role = document.getElementById('addUserRole').value;
            const status = document.getElementById('addUserStatus').value;

            // 驗證用戶名格式
            const usernameRegex = /^[a-zA-Z0-9_-]{3,20}$/;
            if (!usernameRegex.test(username)) {
                showAlert('用戶名格式不正確，僅允許3-20個字母、數字、下劃線(_)或連字符(-)');
                return;
            }

            // 驗證密碼長度
            if (password.length < 6) {
                showAlert('密碼長度至少6位');
                return;
            }

            // 驗證兩次密碼是否一致
            if (password !== passwordConfirm) {
                showAlert('兩次密碼輸入不一致');
                return;
            }

            try {
                // 檢查用戶名是否已存在
                const { collection, getDocs, query, where } = window.firestoreModules;
                const usersRef = collection(window.firebaseDB, 'users');

                const usernameQuery = query(usersRef, where('username', '==', username));
                const usernameSnapshot = await getDocs(usernameQuery);
                if (!usernameSnapshot.empty) {
                    showAlert('此用戶名已被使用');
                    return;
                }

                // 檢查電子郵件是否已存在
                const emailQuery = query(usersRef, where('email', '==', email));
                const emailSnapshot = await getDocs(emailQuery);
                if (!emailSnapshot.empty) {
                    showAlert('此電子郵件已被使用');
                    return;
                }

                // 生成驗證碼
                const verificationCode = generateVerificationCode();

                // 發送驗證碼到新用戶的電子郵件
                await sendVerificationEmail(email, verificationCode, '新用戶註冊');

                // 暫存用戶數據和驗證碼
                newUserData = {
                    name,
                    username,
                    email,
                    password,
                    role,
                    status,
                    verificationCode,
                    timestamp: Date.now()
                };

                // 關閉新增用戶 modal，打開驗證碼 modal
                document.getElementById('addUserModal').classList.add('hidden');
                document.getElementById('addUserVerifyEmail').textContent = email;
                document.getElementById('addUserVerifyCode').value = '';
                document.getElementById('addUserVerifyModal').classList.remove('hidden');

                showAlert('驗證碼已發送到新用戶的電子郵件');
            } catch (error) {
                console.error('Error in add user process:', error);
                showAlert('發送驗證碼時發生錯誤');
            }
        });

        // Confirm add user (verify code and create account)
        window.confirmAddUser = async function() {
            const inputCode = document.getElementById('addUserVerifyCode').value.trim();

            if (!inputCode) {
                showAlert('請輸入驗證碼');
                return;
            }

            if (!newUserData) {
                showAlert('驗證數據已過期，請重新開始');
                closeAddUserVerifyModal();
                return;
            }

            // 檢查驗證碼是否過期（10分鐘）
            const elapsed = Date.now() - newUserData.timestamp;
            if (elapsed > 10 * 60 * 1000) {
                showAlert('驗證碼已過期，請重新開始');
                closeAddUserVerifyModal();
                newUserData = null;
                return;
            }

            // 驗證驗證碼
            if (inputCode !== newUserData.verificationCode) {
                showAlert('驗證碼錯誤');
                return;
            }

            try {
                // 創建新用戶
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'users'), {
                    name: newUserData.name,
                    username: newUserData.username,
                    email: newUserData.email,
                    password: newUserData.password, // 注意：實際應用中應該加密密碼
                    role: newUserData.role,
                    status: newUserData.status,
                    createdAt: new Date().toISOString()
                });

                showAlert('新用戶創建成功！');
                closeAddUserVerifyModal();
                newUserData = null;

                // 刷新用戶列表
                loadUsers();
            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('創建用戶時發生錯誤');
            }
        };

        // ==================== End Add User Functionality ====================

        // ========================================
        // 功能增強 - 訪客統計、圖表、通知等
        // ========================================

        // 圖表週期狀態
        let currentChartPeriod = '7d';

        // 設置圖表週期
        window.setChartPeriod = function(period) {
            currentChartPeriod = period;
            document.querySelectorAll('.chart-period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
            loadVisitorTrendChart();
        };

        // 載入訪客趨勢圖表
        async function loadVisitorTrendChart() {
            const container = document.getElementById('visitorTrendChart');
            if (!container) return;

            const days = currentChartPeriod === '7d' ? 7 : 30;
            const data = [];

            try {
                const { collection, query, where, getDocs } = window.firestoreModules;

                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];

                    const q = query(
                        collection(window.firebaseDB, 'visit_history'),
                        where('date', '==', dateStr)
                    );
                    const snapshot = await getDocs(q);
                    data.push({ date: dateStr, count: snapshot.size });
                }

                const maxCount = Math.max(...data.map(d => d.count), 1);

                container.innerHTML = data.map((d, i) => {
                    const height = (d.count / maxCount) * 100;
                    const shortDate = d.date.slice(5); // MM-DD
                    return `
                        <div class="flex flex-col items-center flex-1" title="${d.date}: ${d.count} 次訪問">
                            <div class="w-full bg-primary/20 rounded-t relative flex-1 flex flex-col justify-end">
                                <div class="bg-primary rounded-t transition-all duration-500" style="height: ${height}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 mt-1 ${days > 7 ? 'hidden md:block' : ''}">${shortDate}</span>
                            <span class="text-xs font-semibold">${d.count}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('載入趨勢圖表失敗:', error);
                container.innerHTML = '<p class="text-gray-500 text-center w-full">載入失敗</p>';
            }
        }

        // 載入訪問時段分析
        async function loadHourlyChart() {
            const container = document.getElementById('hourlyChart');
            if (!container) return;

            try {
                const { collection, query, where, getDocs } = window.firestoreModules;
                const today = new Date().toISOString().split('T')[0];
                const hourCounts = new Array(24).fill(0);

                const q = query(
                    collection(window.firebaseDB, 'visit_history'),
                    where('date', '==', today)
                );
                const snapshot = await getDocs(q);

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.visitedAt) {
                        const hour = new Date(data.visitedAt.seconds * 1000).getHours();
                        hourCounts[hour]++;
                    }
                });

                const maxCount = Math.max(...hourCounts, 1);

                // 顯示雙列（0-11時和12-23時）
                container.innerHTML = hourCounts.map((count, hour) => {
                    const height = (count / maxCount) * 100;
                    return `
                        <div class="flex flex-col items-center justify-end h-full" title="${hour}時: ${count} 次">
                            <div class="w-full bg-blue-500 rounded-t transition-all duration-300" style="height: ${Math.max(height, 5)}%"></div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('載入時段分析失敗:', error);
            }
        }

        // 載入設備統計
        async function loadDeviceStats() {
            try {
                const { collection, query, where, getDocs } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'visitors'),
                    where('active', '==', true)
                );
                const snapshot = await getDocs(q);

                let mobile = 0, tablet = 0, desktop = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const ua = (data.userAgent || '').toLowerCase();

                    if (/ipad|tablet|playbook|silk/i.test(ua)) {
                        tablet++;
                    } else if (/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(ua)) {
                        mobile++;
                    } else {
                        desktop++;
                    }
                });

                document.getElementById('mobileCount').textContent = mobile;
                document.getElementById('tabletCount').textContent = tablet;
                document.getElementById('desktopCount').textContent = desktop;
            } catch (error) {
                console.error('載入設備統計失敗:', error);
            }
        }

        // 載入管理員操作日誌
        async function loadAdminLogs() {
            const container = document.getElementById('adminLogsContainer');
            if (!container) return;

            try {
                const { collection, query, orderBy, limit, getDocs } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'admin_logs'),
                    orderBy('timestamp', 'desc'),
                    limit(50)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">暫無操作日誌</p>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString('zh-TW') : '未知時間';
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-sm';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-semibold">${log.adminName || '管理員'}</span>
                                <span class="text-gray-600 dark:text-gray-400"> ${log.action || '執行操作'}</span>
                            </div>
                            <span class="text-xs text-gray-500">${time}</span>
                        </div>
                        ${log.details ? `<p class="text-gray-500 dark:text-gray-400 text-xs mt-1">${log.details}</p>` : ''}
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('載入操作日誌失敗:', error);
                container.innerHTML = '<p class="text-gray-500 text-center py-4">載入失敗</p>';
            }
        }
        window.loadAdminLogs = loadAdminLogs;

        // 記錄管理員操作
        async function logAdminAction(action, details = '') {
            try {
                const { collection, addDoc } = window.firestoreModules;
                const user = window.firebaseAuth.currentUser;
                await addDoc(collection(window.firebaseDB, 'admin_logs'), {
                    adminId: user?.uid || 'unknown',
                    adminName: user?.displayName || user?.email || '管理員',
                    action: action,
                    details: details,
                    timestamp: new Date()
                });
            } catch (error) {
                console.error('記錄操作日誌失敗:', error);
            }
        }

        // 導出訪客統計 CSV
        window.exportVisitorStats = async function() {
            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'visit_history'), orderBy('date', 'desc'));
                const snapshot = await getDocs(q);

                const dateCounts = {};
                snapshot.forEach(doc => {
                    const date = doc.data().date;
                    dateCounts[date] = (dateCounts[date] || 0) + 1;
                });

                let csv = '日期,訪問次數\n';
                Object.entries(dateCounts).forEach(([date, count]) => {
                    csv += `${date},${count}\n`;
                });

                downloadCSV(csv, 'visitor_stats.csv');
                logAdminAction('導出訪客統計');
                showAlert('訪客統計已導出！');
            } catch (error) {
                console.error('導出失敗:', error);
                showAlert('導出失敗');
            }
        };

        // 導出聯絡訊息 CSV
        window.exportContactMessages = async function() {
            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'contact_submissions'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);

                let csv = '姓名,電郵,主題,訊息,時間,狀態\n';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString('zh-TW') : '';
                    csv += `"${d.name || ''}","${d.email || ''}","${d.subject || ''}","${(d.message || '').replace(/"/g, '""')}","${time}","${d.status || 'unread'}"\n`;
                });

                downloadCSV(csv, 'contact_messages.csv');
                logAdminAction('導出聯絡訊息');
                showAlert('聯絡訊息已導出！');
            } catch (error) {
                console.error('導出失敗:', error);
                showAlert('導出失敗');
            }
        };

        // 下載 CSV 輔助函數
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // 清理舊數據
        window.cleanOldData = function() {
            showConfirm('確定要清理30天前的訪客記錄嗎？此操作無法復原！', async () => {
                try {
                    const { collection, query, where, getDocs, deleteDoc, doc } = window.firestoreModules;
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const dateStr = thirtyDaysAgo.toISOString().split('T')[0];

                    const q = query(
                        collection(window.firebaseDB, 'visit_history'),
                        where('date', '<', dateStr)
                    );
                    const snapshot = await getDocs(q);

                    let count = 0;
                    const deletePromises = [];
                    snapshot.forEach(docSnap => {
                        deletePromises.push(deleteDoc(doc(window.firebaseDB, 'visit_history', docSnap.id)));
                        count++;
                    });

                    await Promise.all(deletePromises);
                    logAdminAction('清理舊數據', `刪除了 ${count} 條記錄`);
                    showAlert(`已清理 ${count} 條舊記錄！`);
                    loadVisitorStats();
                } catch (error) {
                    console.error('清理失敗:', error);
                    showAlert('清理失敗');
                }
            });
        };

        // 載入未讀訊息數量
        async function loadUnreadContactsCount() {
            try {
                const { collection, query, where, getDocs } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'contact_submissions'),
                    where('status', '==', 'unread')
                );
                const snapshot = await getDocs(q);
                const count = snapshot.size;

                const badge = document.getElementById('unreadContactsBadge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('載入未讀數量失敗:', error);
            }
        }

        // 登入失敗計數（安全性）
        let loginAttempts = {};
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOCKOUT_DURATION = 15 * 60 * 1000; // 15分鐘

        function checkLoginAttempts(email) {
            const now = Date.now();
            const attempts = loginAttempts[email];

            if (attempts && attempts.count >= MAX_LOGIN_ATTEMPTS) {
                const timeLeft = LOCKOUT_DURATION - (now - attempts.lastAttempt);
                if (timeLeft > 0) {
                    const minutes = Math.ceil(timeLeft / 60000);
                    return { blocked: true, message: `登入嘗試次數過多，請 ${minutes} 分鐘後再試` };
                } else {
                    delete loginAttempts[email];
                }
            }
            return { blocked: false };
        }

        function recordLoginAttempt(email, success) {
            if (success) {
                delete loginAttempts[email];
            } else {
                if (!loginAttempts[email]) {
                    loginAttempts[email] = { count: 0, lastAttempt: 0 };
                }
                loginAttempts[email].count++;
                loginAttempts[email].lastAttempt = Date.now();
            }
        }

        // 排隊設置表單
        const queueSettingsForm = document.getElementById('queueSettingsForm');
        if (queueSettingsForm) {
            queueSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const { doc, setDoc } = window.firestoreModules;
                    await setDoc(doc(window.firebaseDB, 'settings', 'queue'), {
                        customMessage: document.getElementById('queueCustomMessage').value,
                        imageUrl: document.getElementById('queueImageUrl').value,
                        waitTimePerPerson: parseInt(document.getElementById('queueWaitTimePerPerson').value) || 2
                    }, { merge: true });

                    logAdminAction('更新排隊設置');
                    showAlert('排隊設置已儲存！');
                } catch (error) {
                    console.error('儲存排隊設置失敗:', error);
                    showAlert('儲存失敗');
                }
            });
        }

        // 載入排隊設置
        async function loadQueueSettings() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const docSnap = await getDoc(doc(window.firebaseDB, 'settings', 'queue'));

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const msgEl = document.getElementById('queueCustomMessage');
                    const imgEl = document.getElementById('queueImageUrl');
                    const timeEl = document.getElementById('queueWaitTimePerPerson');

                    if (msgEl) msgEl.value = data.customMessage || '';
                    if (imgEl) imgEl.value = data.imageUrl || '';
                    if (timeEl) timeEl.value = data.waitTimePerPerson || 2;
                }
            } catch (error) {
                console.error('載入排隊設置失敗:', error);
            }
        }

        // 擴展 loadVisitorStats 函數
        const originalLoadVisitorStats = window.loadVisitorStats || loadVisitorStats;
        window.loadVisitorStats = async function() {
            await originalLoadVisitorStats();
            await loadVisitorTrendChart();
            await loadHourlyChart();
            await loadDeviceStats();
            await loadAdminLogs();
            await loadQueueSettings();
        };

        // 初始化時載入未讀數量
        setTimeout(() => {
            loadUnreadContactsCount();
            // 定期更新未讀數量
            setInterval(loadUnreadContactsCount, 30000);
        }, 2000);

        // ========================================
        // 新功能 JavaScript 函數
        // ========================================

        // === 會員檔案系統 ===
        async function loadMemberProfiles() {
            const listEl = document.getElementById('memberProfilesList');
            if (!listEl) return;
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'users'));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">暫無會員資料</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4 flex items-center space-x-4';
                    card.innerHTML = `
                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white text-xl font-bold">
                            ${(user.displayName || user.email || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold truncate">${user.displayName || '未設置'}</p>
                            <p class="text-sm text-gray-500 truncate">${user.email || ''}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-xs">${user.points || 0} 積分</span>
                                <span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded text-xs">${user.level || '普通會員'}</span>
                            </div>
                        </div>
                        <button onclick="viewMemberDetail('${doc.id}')" class="px-3 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm">查看</button>
                    `;
                    listEl.appendChild(card);
                });
            } catch (error) {
                console.error('載入會員資料失敗:', error);
                listEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">載入失敗</p>';
            }
        }
        window.searchMembers = function() {
            const query = document.getElementById('memberSearchInput').value.toLowerCase();
            const cards = document.querySelectorAll('#memberProfilesList > div');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query) ? '' : 'none';
            });
        };
        window.viewMemberDetail = function(userId) {
            showAlert('會員詳情功能開發中');
        };

        // === 積分系統 ===
        async function loadPointsSystem() {
            try {
                const { collection, getDocs, query, orderBy, limit } = window.firestoreModules;
                // 載入積分規則
                const rulesSnapshot = await getDocs(collection(window.firebaseDB, 'points_rules'));
                const rulesEl = document.getElementById('pointsRulesList');
                document.getElementById('pointsRulesCount').textContent = rulesSnapshot.size;
                if (rulesSnapshot.empty) {
                    rulesEl.innerHTML = '<p class="text-gray-500 text-center py-4">暫無積分規則，請新增</p>';
                } else {
                    rulesEl.innerHTML = '';
                    rulesSnapshot.forEach(doc => {
                        const rule = doc.data();
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700 rounded-lg p-4';
                        el.innerHTML = `
                            <div>
                                <p class="font-semibold">${rule.name}</p>
                                <p class="text-sm text-gray-500">${rule.description || ''}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl font-bold text-primary">+${rule.points}</span>
                                <button onclick="deletePointsRule('${doc.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm">刪除</button>
                            </div>
                        `;
                        rulesEl.appendChild(el);
                    });
                }
                // 載入排行榜
                const usersQuery = query(collection(window.firebaseDB, 'users'), orderBy('points', 'desc'), limit(10));
                const usersSnapshot = await getDocs(usersQuery);
                const leaderboardEl = document.getElementById('pointsLeaderboard');
                if (usersSnapshot.empty) {
                    leaderboardEl.innerHTML = '<p class="text-gray-500 text-center py-4">暫無排行資料</p>';
                } else {
                    leaderboardEl.innerHTML = '';
                    let rank = 1;
                    usersSnapshot.forEach(doc => {
                        const user = doc.data();
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between py-2 border-b border-gray-200 dark:border-gray-600 last:border-0';
                        const medals = ['🥇', '🥈', '🥉'];
                        el.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl w-8">${medals[rank-1] || rank}</span>
                                <span class="font-semibold">${user.displayName || user.email || '匿名用戶'}</span>
                            </div>
                            <span class="text-xl font-bold text-primary">${user.points || 0}</span>
                        `;
                        leaderboardEl.appendChild(el);
                        rank++;
                    });
                }
            } catch (error) {
                console.error('載入積分系統失敗:', error);
            }
        }
        window.showAddPointsRuleDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增積分規則</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">規則名稱</label>
                            <input type="text" id="ruleNameInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="例如：參加活動">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">積分數量</label>
                            <input type="number" id="rulePointsInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="10" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">說明（選填）</label>
                            <input type="text" id="ruleDescInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="規則說明">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const name = document.getElementById('ruleNameInput').value.trim();
                const points = parseInt(document.getElementById('rulePointsInput').value) || 0;
                const description = document.getElementById('ruleDescInput').value.trim();
                if (!name || points < 1) { showAlert('請填寫規則名稱和積分數量'); return; }
                try {
                    const { collection, addDoc } = window.firestoreModules;
                    await addDoc(collection(window.firebaseDB, 'points_rules'), { name, points, description, createdAt: new Date() });
                    modal.remove();
                    showAlert('積分規則已新增！');
                    loadPointsSystem();
                } catch (error) { showAlert('新增失敗：' + error.message); }
            };
        };
        window.deletePointsRule = async function(id) {
            showConfirm('確定要刪除此規則嗎？', async () => {
                try {
                    const { doc, deleteDoc } = window.firestoreModules;
                    await deleteDoc(doc(window.firebaseDB, 'points_rules', id));
                    showAlert('規則已刪除');
                    loadPointsSystem();
                } catch (error) { showAlert('刪除失敗'); }
            });
        };

        // === 成就徽章系統 ===
        async function loadAchievements() {
            const listEl = document.getElementById('badgesList');
            if (!listEl) return;
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'badges'));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">暫無徽章，點擊上方按鈕新增</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const badge = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center hover:shadow-lg transition-shadow';
                    el.innerHTML = `
                        <div class="text-5xl mb-2">${badge.icon || '🏆'}</div>
                        <p class="font-semibold">${badge.name}</p>
                        <p class="text-xs text-gray-500 mt-1">${badge.condition || ''}</p>
                        <button onclick="deleteBadge('${doc.id}')" class="mt-2 px-2 py-1 bg-red-500 text-white rounded text-xs">刪除</button>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) {
                listEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">載入失敗</p>';
            }
        }
        window.showAddBadgeDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增徽章</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">徽章圖示</label>
                            <input type="text" id="badgeIconInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-3xl text-center" placeholder="🏆" maxlength="2">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">徽章名稱</label>
                            <input type="text" id="badgeNameInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="活躍會員">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">獲得條件</label>
                            <input type="text" id="badgeCondInput" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="參加10次活動">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const icon = document.getElementById('badgeIconInput').value || '🏆';
                const name = document.getElementById('badgeNameInput').value.trim();
                const condition = document.getElementById('badgeCondInput').value.trim();
                if (!name) { showAlert('請填寫徽章名稱'); return; }
                try {
                    const { collection, addDoc } = window.firestoreModules;
                    await addDoc(collection(window.firebaseDB, 'badges'), { icon, name, condition, createdAt: new Date() });
                    modal.remove();
                    showAlert('徽章已新增！');
                    loadAchievements();
                } catch (error) { showAlert('新增失敗'); }
            };
        };
        window.deleteBadge = async function(id) {
            showConfirm('確定刪除此徽章？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'badges', id));
                showAlert('已刪除');
                loadAchievements();
            });
        };

        // === 活動報名系統 ===
        async function loadEventRegistrations() {
            const listEl = document.getElementById('registrationEventsList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'event_registrations'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無報名活動</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const event = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4';
                    const registered = event.registeredCount || 0;
                    const limit = event.limit || 0;
                    const percentage = limit > 0 ? Math.min((registered / limit) * 100, 100) : 0;
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg">${event.title}</h3>
                                <p class="text-sm text-gray-500">${event.date || ''} | ${event.location || ''}</p>
                            </div>
                            <span class="px-3 py-1 ${event.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} rounded-full text-xs font-semibold">
                                ${event.active ? '開放報名' : '已結束'}
                            </span>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span>報名人數</span>
                                <span>${registered} / ${limit || '無限制'}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="viewRegistrations('${doc.id}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">查看報名</button>
                            <button onclick="deleteEventRegistration('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) {
                listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>';
            }
        }
        window.showCreateRegistrationDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增報名活動</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">活動名稱</label><input type="text" id="regEventTitle" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700"></div>
                        <div><label class="block text-sm font-semibold mb-2">活動日期</label><input type="date" id="regEventDate" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700"></div>
                        <div><label class="block text-sm font-semibold mb-2">地點</label><input type="text" id="regEventLocation" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700"></div>
                        <div><label class="block text-sm font-semibold mb-2">人數上限（0=無限制）</label><input type="number" id="regEventLimit" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" value="0" min="0"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const title = document.getElementById('regEventTitle').value.trim();
                const date = document.getElementById('regEventDate').value;
                const location = document.getElementById('regEventLocation').value.trim();
                const limit = parseInt(document.getElementById('regEventLimit').value) || 0;
                if (!title) { showAlert('請填寫活動名稱'); return; }
                try {
                    const { collection, addDoc } = window.firestoreModules;
                    await addDoc(collection(window.firebaseDB, 'event_registrations'), { title, date, location, limit, registeredCount: 0, active: true, createdAt: new Date() });
                    modal.remove();
                    showAlert('報名活動已建立！');
                    loadEventRegistrations();
                } catch (error) { showAlert('新增失敗'); }
            };
        };
        window.viewRegistrations = function(id) { showAlert('查看報名名單功能開發中'); };
        window.deleteEventRegistration = async function(id) {
            showConfirm('確定刪除此報名活動？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'event_registrations', id));
                showAlert('已刪除');
                loadEventRegistrations();
            });
        };

        // === QR Code 簽到 ===
        let currentCalendarDate = new Date();
        window.generateQRCode = async function() {
            const eventId = document.getElementById('qrEventSelect').value;
            if (!eventId) { showAlert('請先選擇活動'); return; }
            const qrData = `CHECKIN:${eventId}:${Date.now()}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
            document.getElementById('qrCodeDisplay').innerHTML = `<img src="${qrUrl}" alt="QR Code" class="mx-auto">`;
        };
        async function loadQREvents() {
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'activities'));
                const select = document.getElementById('qrEventSelect');
                if (select) {
                    select.innerHTML = '<option value="">-- 選擇活動 --</option>';
                    snapshot.forEach(doc => {
                        const act = doc.data();
                        const title = act.title?.zhTW || act.title?.en || '未命名活動';
                        select.innerHTML += `<option value="${doc.id}">${title}</option>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        // === 行事曆 ===
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('currentMonthDisplay');
            if (!grid || !display) return;
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            display.textContent = `${year}年${month + 1}月`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            grid.innerHTML = '';
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div class="p-2"></div>';
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                grid.innerHTML += `
                    <div class="p-2 text-center rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${isToday ? 'bg-primary text-white' : ''}">
                        ${day}
                    </div>
                `;
            }
        }
        window.prevMonth = function() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); };
        window.nextMonth = function() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); };

        // === 投票系統 ===
        async function loadPolls() {
            const listEl = document.getElementById('pollsList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'polls'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無投票</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const poll = doc.data();
                    const totalVotes = (poll.options || []).reduce((sum, opt) => sum + (opt.votes || 0), 0);
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4';
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-lg">${poll.question}</h3>
                            <span class="px-3 py-1 ${poll.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} rounded-full text-xs">${poll.active ? '進行中' : '已結束'}</span>
                        </div>
                        <div class="space-y-2 mb-3">
                            ${(poll.options || []).map(opt => `
                                <div class="flex items-center">
                                    <span class="w-24 text-sm truncate">${opt.text}</span>
                                    <div class="flex-1 mx-2 bg-gray-200 dark:bg-gray-600 rounded-full h-4">
                                        <div class="bg-primary h-4 rounded-full" style="width: ${totalVotes > 0 ? (opt.votes / totalVotes * 100) : 0}%"></div>
                                    </div>
                                    <span class="text-sm w-12 text-right">${opt.votes || 0}票</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="togglePoll('${doc.id}', ${!poll.active})" class="px-3 py-1 ${poll.active ? 'bg-yellow-500' : 'bg-green-500'} text-white rounded text-sm">${poll.active ? '結束' : '開啟'}</button>
                            <button onclick="deletePoll('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreatePollDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增投票</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">投票問題</label><input type="text" id="pollQuestion" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700"></div>
                        <div><label class="block text-sm font-semibold mb-2">選項（每行一個）</label><textarea id="pollOptions" rows="4" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="選項A\n選項B\n選項C"></textarea></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const question = document.getElementById('pollQuestion').value.trim();
                const optionsText = document.getElementById('pollOptions').value.trim();
                if (!question || !optionsText) { showAlert('請填寫問題和選項'); return; }
                const options = optionsText.split('\n').filter(o => o.trim()).map(text => ({ text: text.trim(), votes: 0 }));
                try {
                    const { collection, addDoc } = window.firestoreModules;
                    await addDoc(collection(window.firebaseDB, 'polls'), { question, options, active: true, createdAt: new Date() });
                    modal.remove();
                    showAlert('投票已建立！');
                    loadPolls();
                } catch (error) { showAlert('新增失敗'); }
            };
        };
        window.togglePoll = async function(id, active) {
            const { doc, updateDoc } = window.firestoreModules;
            await updateDoc(doc(window.firebaseDB, 'polls', id), { active });
            loadPolls();
        };
        window.deletePoll = async function(id) {
            showConfirm('確定刪除此投票？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'polls', id));
                loadPolls();
            });
        };

        // === 問卷調查 ===
        async function loadSurveys() {
            const listEl = document.getElementById('surveysList');
            if (!listEl) return;
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'surveys'));
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無問卷</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const survey = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <h3 class="font-bold">${survey.title}</h3>
                            <p class="text-sm text-gray-500">${survey.responses || 0} 份回覆</p>
                        </div>
                        <button onclick="deleteSurvey('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">刪除</button>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreateSurveyDialog = function() { showAlert('問卷建立功能開發中'); };
        window.deleteSurvey = async function(id) {
            showConfirm('確定刪除？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'surveys', id));
                loadSurveys();
            });
        };

        // === 資源預約 ===
        async function loadResources() {
            const listEl = document.getElementById('resourcesList');
            if (!listEl) return;
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'resources'));
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">暫無可預約資源</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const res = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4';
                    el.innerHTML = `
                        <div class="text-4xl mb-2">${res.icon || '🏢'}</div>
                        <h3 class="font-bold">${res.name}</h3>
                        <p class="text-sm text-gray-500">${res.description || ''}</p>
                        <div class="mt-3 flex justify-between">
                            <span class="px-2 py-1 ${res.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} rounded text-xs">${res.available ? '可預約' : '已預約'}</span>
                            <button onclick="deleteResource('${doc.id}')" class="text-red-500 text-sm">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">載入失敗</p>'; }
        }
        window.showAddResourceDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增資源</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">圖示</label><input type="text" id="resIcon" class="w-full px-4 py-2 rounded-lg border text-3xl text-center" placeholder="🏢" maxlength="2"></div>
                        <div><label class="block text-sm font-semibold mb-2">名稱</label><input type="text" id="resName" class="w-full px-4 py-2 rounded-lg border" placeholder="會議室A"></div>
                        <div><label class="block text-sm font-semibold mb-2">說明</label><input type="text" id="resDesc" class="w-full px-4 py-2 rounded-lg border" placeholder="可容納10人"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const icon = document.getElementById('resIcon').value || '🏢';
                const name = document.getElementById('resName').value.trim();
                const description = document.getElementById('resDesc').value.trim();
                if (!name) { showAlert('請填寫名稱'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'resources'), { icon, name, description, available: true });
                modal.remove();
                loadResources();
            };
        };
        window.deleteResource = async function(id) {
            showConfirm('確定刪除？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'resources', id));
                loadResources();
            });
        };

        // === 通知中心 ===
        async function loadNotifications() {
            const listEl = document.getElementById('notificationsList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'notifications'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無通知</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const notif = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4 flex items-start space-x-3';
                    el.innerHTML = `
                        <div class="text-2xl">${notif.icon || '🔔'}</div>
                        <div class="flex-1">
                            <h4 class="font-semibold">${notif.title}</h4>
                            <p class="text-sm text-gray-500">${notif.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${notif.createdAt?.seconds ? new Date(notif.createdAt.seconds * 1000).toLocaleString('zh-TW') : ''}</p>
                        </div>
                        <button onclick="deleteNotification('${doc.id}')" class="text-red-500 text-sm">刪除</button>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showSendNotificationDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">發送通知</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">標題</label><input type="text" id="notifTitle" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">內容</label><textarea id="notifMessage" rows="3" class="w-full px-4 py-2 rounded-lg border"></textarea></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">發送</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const title = document.getElementById('notifTitle').value.trim();
                const message = document.getElementById('notifMessage').value.trim();
                if (!title) { showAlert('請填寫標題'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'notifications'), { title, message, icon: '🔔', createdAt: new Date() });
                modal.remove();
                showAlert('通知已發送！');
                loadNotifications();
            };
        };
        window.filterNotifications = function(type) { showAlert('篩選功能開發中'); };
        window.deleteNotification = async function(id) {
            const { doc, deleteDoc } = window.firestoreModules;
            await deleteDoc(doc(window.firebaseDB, 'notifications', id));
            loadNotifications();
        };

        // === 討論區 ===
        async function loadForum() {
            const listEl = document.getElementById('forumTopicsList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'forum_topics'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無討論主題</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const topic = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4';
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold">${topic.title}</h3>
                                <p class="text-sm text-gray-500">由 ${topic.author || '匿名'} 發起 | ${topic.replies || 0} 則回覆</p>
                            </div>
                            <button onclick="deleteForumTopic('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreateTopicDialog = function() { showAlert('主題建立功能開發中'); };
        window.deleteForumTopic = async function(id) {
            showConfirm('確定刪除？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'forum_topics', id));
                loadForum();
            });
        };

        // === 活動相簿 ===
        async function loadPhotoGallery() {
            const listEl = document.getElementById('albumsList');
            if (!listEl) return;
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'albums'));
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">暫無相簿</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const album = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-100 dark:bg-gray-700 rounded-xl overflow-hidden cursor-pointer hover:shadow-lg transition-shadow';
                    el.innerHTML = `
                        <div class="aspect-square bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white text-4xl">${album.cover ? `<img src="${album.cover}" class="w-full h-full object-cover">` : '📷'}</div>
                        <div class="p-3">
                            <h4 class="font-semibold truncate">${album.name}</h4>
                            <p class="text-xs text-gray-500">${album.photoCount || 0} 張照片</p>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">載入失敗</p>'; }
        }
        window.showCreateAlbumDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增相簿</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">相簿名稱</label><input type="text" id="albumName" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">封面圖片URL（選填）</label><input type="url" id="albumCover" class="w-full px-4 py-2 rounded-lg border"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const name = document.getElementById('albumName').value.trim();
                const cover = document.getElementById('albumCover').value.trim();
                if (!name) { showAlert('請填寫相簿名稱'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'albums'), { name, cover, photoCount: 0, createdAt: new Date() });
                modal.remove();
                loadPhotoGallery();
            };
        };

        // === 幹部管理 ===
        async function loadExecutives() {
            const listEl = document.getElementById('executivesList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'executives'), orderBy('order', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無幹部資料</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const exec = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4 flex items-center space-x-4';
                    el.innerHTML = `
                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white text-xl font-bold">
                            ${(exec.name || '?').charAt(0)}
                        </div>
                        <div class="flex-1">
                            <p class="font-bold">${exec.name}</p>
                            <p class="text-sm text-primary">${exec.position}</p>
                            <p class="text-xs text-gray-500">${exec.term || ''}</p>
                        </div>
                        <button onclick="deleteExecutive('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">刪除</button>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showAddExecutiveDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增幹部</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">姓名</label><input type="text" id="execName" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">職位</label><input type="text" id="execPosition" class="w-full px-4 py-2 rounded-lg border" placeholder="主席 / 副主席 / 幹事..."></div>
                        <div><label class="block text-sm font-semibold mb-2">任期</label><input type="text" id="execTerm" class="w-full px-4 py-2 rounded-lg border" placeholder="2024-2025"></div>
                        <div><label class="block text-sm font-semibold mb-2">排序（數字越小越前）</label><input type="number" id="execOrder" class="w-full px-4 py-2 rounded-lg border" value="1" min="1"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const name = document.getElementById('execName').value.trim();
                const position = document.getElementById('execPosition').value.trim();
                const term = document.getElementById('execTerm').value.trim();
                const order = parseInt(document.getElementById('execOrder').value) || 1;
                if (!name || !position) { showAlert('請填寫姓名和職位'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'executives'), { name, position, term, order, createdAt: new Date() });
                modal.remove();
                loadExecutives();
            };
        };
        window.deleteExecutive = async function(id) {
            showConfirm('確定刪除？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'executives', id));
                loadExecutives();
            });
        };

        // === 財務管理 ===
        async function loadFinance() {
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'transactions'), orderBy('date', 'desc'));
                const snapshot = await getDocs(q);
                let totalIncome = 0, totalExpense = 0;
                const listEl = document.getElementById('transactionsList');
                if (snapshot.empty) {
                    listEl.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">暫無交易記錄</td></tr>';
                } else {
                    listEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const tx = doc.data();
                        if (tx.type === 'income') totalIncome += tx.amount || 0;
                        else totalExpense += tx.amount || 0;
                        listEl.innerHTML += `
                            <tr class="border-b border-gray-100 dark:border-gray-700">
                                <td class="px-4 py-3">${tx.date || ''}</td>
                                <td class="px-4 py-3">${tx.description || ''}</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 ${tx.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} rounded text-xs">${tx.type === 'income' ? '收入' : '支出'}</span></td>
                                <td class="px-4 py-3 text-right ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}">${tx.type === 'income' ? '+' : '-'}$${tx.amount || 0}</td>
                                <td class="px-4 py-3 text-center"><button onclick="deleteTransaction('${doc.id}')" class="text-red-500 text-sm">刪除</button></td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString()}`;
                document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
                document.getElementById('totalBalance').textContent = `$${(totalIncome - totalExpense).toLocaleString()}`;
            } catch (error) { console.error(error); }
        }
        window.showAddTransactionDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增交易</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">類型</label><select id="txType" class="w-full px-4 py-2 rounded-lg border"><option value="income">收入</option><option value="expense">支出</option></select></div>
                        <div><label class="block text-sm font-semibold mb-2">日期</label><input type="date" id="txDate" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">說明</label><input type="text" id="txDesc" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">金額</label><input type="number" id="txAmount" class="w-full px-4 py-2 rounded-lg border" min="0"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const type = document.getElementById('txType').value;
                const date = document.getElementById('txDate').value;
                const description = document.getElementById('txDesc').value.trim();
                const amount = parseFloat(document.getElementById('txAmount').value) || 0;
                if (!date || amount <= 0) { showAlert('請填寫日期和金額'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'transactions'), { type, date, description, amount, createdAt: new Date() });
                modal.remove();
                loadFinance();
            };
        };
        window.deleteTransaction = async function(id) {
            showConfirm('確定刪除？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'transactions', id));
                loadFinance();
            });
        };

        // === 訪客留言板 ===
        async function loadGuestbook() {
            const listEl = document.getElementById('guestbookList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'guestbook'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無留言</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4';
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-semibold">${msg.name || '訪客'}</span>
                                <span class="text-xs text-gray-500 ml-2">${msg.createdAt?.seconds ? new Date(msg.createdAt.seconds * 1000).toLocaleString('zh-TW') : ''}</span>
                            </div>
                            <span class="px-2 py-1 ${msg.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} rounded text-xs">${msg.approved ? '已通過' : '待審核'}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300">${msg.message}</p>
                        <div class="flex justify-end space-x-2 mt-2">
                            ${!msg.approved ? `<button onclick="approveGuestbook('${doc.id}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">通過</button>` : ''}
                            <button onclick="deleteGuestbook('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.filterGuestbook = function(type) { showAlert('篩選功能開發中'); };
        window.approveGuestbook = async function(id) {
            const { doc, updateDoc } = window.firestoreModules;
            await updateDoc(doc(window.firebaseDB, 'guestbook', id), { approved: true });
            loadGuestbook();
        };
        window.deleteGuestbook = async function(id) {
            const { doc, deleteDoc } = window.firestoreModules;
            await deleteDoc(doc(window.firebaseDB, 'guestbook', id));
            loadGuestbook();
        };

        // === 常見問題 FAQ ===
        async function loadFAQ() {
            const listEl = document.getElementById('faqList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'faq'), orderBy('order', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無常見問題</p>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const faq = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 dark:bg-gray-700 rounded-xl p-4';
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-primary">Q: ${faq.question}</h4>
                                <p class="text-gray-600 dark:text-gray-300 mt-2">A: ${faq.answer}</p>
                            </div>
                            <button onclick="deleteFAQ('${doc.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm ml-4">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showAddFaqDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增問題</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">問題</label><input type="text" id="faqQ" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">答案</label><textarea id="faqA" rows="4" class="w-full px-4 py-2 rounded-lg border"></textarea></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const question = document.getElementById('faqQ').value.trim();
                const answer = document.getElementById('faqA').value.trim();
                if (!question || !answer) { showAlert('請填寫問題和答案'); return; }
                const { collection, addDoc, getDocs } = window.firestoreModules;
                const existing = await getDocs(collection(window.firebaseDB, 'faq'));
                await addDoc(collection(window.firebaseDB, 'faq'), { question, answer, order: existing.size + 1, createdAt: new Date() });
                modal.remove();
                loadFAQ();
            };
        };
        window.deleteFAQ = async function(id) {
            showConfirm('確定刪除？', async () => {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'faq', id));
                loadFAQ();
            });
        };

        // === 快速筆記 ===
        async function loadQuickNotes() {
            const listEl = document.getElementById('notesList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const user = window.firebaseAuth.currentUser;
                if (!user) { listEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">請先登入</p>'; return; }
                const q = query(collection(window.firebaseDB, 'notes'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">暫無筆記</p>'; return; }
                listEl.innerHTML = '';
                const colors = ['bg-yellow-100', 'bg-pink-100', 'bg-blue-100', 'bg-green-100', 'bg-purple-100'];
                let i = 0;
                snapshot.forEach(doc => {
                    const note = doc.data();
                    const el = document.createElement('div');
                    el.className = `${colors[i % colors.length]} dark:bg-opacity-20 rounded-xl p-4 min-h-[150px] flex flex-col`;
                    el.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold mb-2">${note.title || '無標題'}</h4>
                            <p class="text-sm text-gray-600">${note.content || ''}</p>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                            <span>${note.createdAt?.seconds ? new Date(note.createdAt.seconds * 1000).toLocaleDateString('zh-TW') : ''}</span>
                            <button onclick="deleteNote('${doc.id}')" class="text-red-500">刪除</button>
                        </div>
                    `;
                    listEl.appendChild(el);
                    i++;
                });
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">載入失敗</p>'; }
        }
        window.showAddNoteDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增筆記</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-semibold mb-2">標題</label><input type="text" id="noteTitle" class="w-full px-4 py-2 rounded-lg border"></div>
                        <div><label class="block text-sm font-semibold mb-2">內容</label><textarea id="noteContent" rows="5" class="w-full px-4 py-2 rounded-lg border"></textarea></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const title = document.getElementById('noteTitle').value.trim();
                const content = document.getElementById('noteContent').value.trim();
                if (!content) { showAlert('請填寫內容'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'notes'), { title, content, createdAt: new Date() });
                modal.remove();
                loadQuickNotes();
            };
        };
        window.deleteNote = async function(id) {
            const { doc, deleteDoc } = window.firestoreModules;
            await deleteDoc(doc(window.firebaseDB, 'notes', id));
            loadQuickNotes();
        };

        // === 待辦事項 ===
        async function loadTodoList() {
            const listEl = document.getElementById('todoItemsList');
            if (!listEl) return;
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'todos'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-500 text-center py-8">暫無待辦事項</p>'; updateTodoProgress(0, 0); return; }
                listEl.innerHTML = '';
                let completed = 0, total = 0;
                snapshot.forEach(doc => {
                    const todo = doc.data();
                    total++;
                    if (todo.completed) completed++;
                    const el = document.createElement('div');
                    el.className = `flex items-center space-x-3 p-3 rounded-lg ${todo.completed ? 'bg-green-50 dark:bg-green-900/20' : 'bg-gray-50 dark:bg-gray-700'}`;
                    el.innerHTML = `
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${doc.id}', this.checked)" class="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary">
                        <span class="flex-1 ${todo.completed ? 'line-through text-gray-400' : ''}">${todo.text}</span>
                        <button onclick="deleteTodo('${doc.id}')" class="text-red-500 text-sm">刪除</button>
                    `;
                    listEl.appendChild(el);
                });
                updateTodoProgress(completed, total);
            } catch (error) { listEl.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        function updateTodoProgress(completed, total) {
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            const progressEl = document.getElementById('todoProgress');
            const barEl = document.getElementById('todoProgressBar');
            if (progressEl) progressEl.textContent = `${percentage}%`;
            if (barEl) barEl.style.width = `${percentage}%`;
        }
        window.showAddTodoDialog = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">新增待辦</h3>
                    <div><input type="text" id="todoText" class="w-full px-4 py-3 rounded-lg border" placeholder="輸入待辦事項..."></div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="cancel-btn px-4 py-2 text-gray-600 rounded">取消</button>
                        <button class="confirm-btn px-6 py-2 bg-primary text-white rounded">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = async () => {
                const text = document.getElementById('todoText').value.trim();
                if (!text) { showAlert('請輸入待辦事項'); return; }
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'todos'), { text, completed: false, createdAt: new Date() });
                modal.remove();
                loadTodoList();
            };
        };
        window.toggleTodo = async function(id, completed) {
            const { doc, updateDoc } = window.firestoreModules;
            await updateDoc(doc(window.firebaseDB, 'todos', id), { completed });
            loadTodoList();
        };
        window.deleteTodo = async function(id) {
            const { doc, deleteDoc } = window.firestoreModules;
            await deleteDoc(doc(window.firebaseDB, 'todos', id));
            loadTodoList();
        };

        // === 維護模式 ===
        async function loadMaintenanceSettings() {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const docRef = await getDoc(doc(window.firebaseDB, 'settings', 'maintenance'));
                if (docRef.exists()) {
                    const data = docRef.data();
                    document.getElementById('maintenanceModeToggle').checked = data.enabled || false;
                    document.getElementById('maintenanceMessage').value = data.message || '';
                    if (data.endTime?.seconds) {
                        document.getElementById('maintenanceEndTime').value = new Date(data.endTime.seconds * 1000).toISOString().slice(0, 16);
                    }
                }
            } catch (error) { console.error(error); }
        }
        window.toggleMaintenanceMode = async function() {
            const enabled = document.getElementById('maintenanceModeToggle').checked;
            try {
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.firebaseDB, 'settings', 'maintenance'), { enabled }, { merge: true });
                showAlert(enabled ? '維護模式已啟用！' : '維護模式已關閉');
            } catch (error) { showAlert('設置失敗'); }
        };
        window.saveMaintenanceSettings = async function() {
            const message = document.getElementById('maintenanceMessage').value;
            const endTimeStr = document.getElementById('maintenanceEndTime').value;
            const endTime = endTimeStr ? new Date(endTimeStr) : null;
            try {
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.firebaseDB, 'settings', 'maintenance'), { message, endTime }, { merge: true });
                showAlert('維護設置已儲存！');
            } catch (error) { showAlert('儲存失敗'); }
        };

        // === 主題設置 ===
        window.setThemeColor = function(color) {
            document.documentElement.style.setProperty('--color-primary', color);
        };
        window.applyCustomColor = function() {
            const color = document.getElementById('customThemeColor').value;
            setThemeColor(color);
        };
        window.saveThemeSettings = async function() {
            const color = document.getElementById('customThemeColor').value;
            const siteName = document.getElementById('siteNameInput').value.trim();
            try {
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.firebaseDB, 'settings', 'theme'), { primaryColor: color, siteName }, { merge: true });
                showAlert('主題設置已儲存！');
            } catch (error) { showAlert('儲存失敗'); }
        };

        // === 郵件模板 ===
        async function loadEmailTemplates() {
            const container = document.getElementById('emailTemplatesList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'email_templates'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無郵件模板</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                        <div class="flex justify-between items-start">
                            <div><h3 class="font-semibold">${d.name || '未命名模板'}</h3>
                            <p class="text-sm text-gray-500">${d.subject || ''}</p></div>
                            <div class="flex space-x-2">
                                <button onclick="editEmailTemplate('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm">編輯</button>
                                <button onclick="deleteEmailTemplate('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreateEmailTemplateDialog = function() {
            showGenericFormDialog('新增郵件模板', [
                { id: 'tplName', label: '模板名稱', type: 'text', required: true },
                { id: 'tplSubject', label: '郵件主旨', type: 'text', required: true },
                { id: 'tplBody', label: '郵件內容', type: 'textarea', required: true }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'email_templates'), { name: data.tplName, subject: data.tplSubject, body: data.tplBody, createdAt: serverTimestamp() });
                showAlert('模板已建立！'); loadEmailTemplates();
            });
        };
        window.deleteEmailTemplate = async function(id) { await genericDelete('email_templates', id, '郵件模板', loadEmailTemplates); };

        // === 社群連結 ===
        async function loadSocialLinks() {
            const container = document.getElementById('socialLinksList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'social_links'), orderBy('order', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-2">尚無社群連結</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const icons = { facebook: '📘', instagram: '📷', youtube: '🎬', twitter: '🐦', discord: '💬', line: '💚', website: '🌐' };
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${icons[d.platform] || '🔗'}</span>
                            <div><h3 class="font-semibold">${d.name || d.platform}</h3><p class="text-sm text-gray-500 truncate max-w-[200px]">${d.url}</p></div>
                        </div>
                        <button onclick="deleteSocialLink('${doc.id}')" class="text-red-600 hover:text-red-800">刪除</button>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 col-span-2">載入失敗</p>'; }
        }
        window.showAddSocialLinkDialog = function() {
            showGenericFormDialog('新增社群連結', [
                { id: 'slPlatform', label: '平台', type: 'select', options: ['facebook', 'instagram', 'youtube', 'twitter', 'discord', 'line', 'website'], required: true },
                { id: 'slName', label: '顯示名稱', type: 'text', required: true },
                { id: 'slUrl', label: '連結網址', type: 'url', required: true }
            ], async (data) => {
                const { collection, addDoc, getDocs, query: q } = window.firestoreModules;
                const existing = await getDocs(q(collection(window.firebaseDB, 'social_links')));
                await addDoc(collection(window.firebaseDB, 'social_links'), { platform: data.slPlatform, name: data.slName, url: data.slUrl, order: existing.size });
                showAlert('連結已新增！'); loadSocialLinks();
            });
        };
        window.deleteSocialLink = async function(id) { await genericDelete('social_links', id, '社群連結', loadSocialLinks); };

        // === 會議記錄 ===
        async function loadMeetingMinutes() {
            const container = document.getElementById('meetingMinutesList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'meeting_minutes'), orderBy('date', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無會議記錄</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const date = d.date?.seconds ? new Date(d.date.seconds * 1000).toLocaleDateString('zh-TW') : '';
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                        <div class="flex justify-between items-start">
                            <div><h3 class="font-semibold">${d.title || '未命名會議'}</h3>
                            <p class="text-sm text-gray-500">📅 ${date} | 👥 ${d.attendees || 0} 人</p></div>
                            <div class="flex space-x-2">
                                <button onclick="viewMeeting('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm">查看</button>
                                <button onclick="deleteMeeting('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreateMeetingDialog = function() {
            showGenericFormDialog('新增會議記錄', [
                { id: 'mtTitle', label: '會議標題', type: 'text', required: true },
                { id: 'mtDate', label: '會議日期', type: 'date', required: true },
                { id: 'mtAttendees', label: '出席人數', type: 'number', required: true },
                { id: 'mtContent', label: '會議內容', type: 'textarea', required: true }
            ], async (data) => {
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'meeting_minutes'), { title: data.mtTitle, date: new Date(data.mtDate), attendees: parseInt(data.mtAttendees), content: data.mtContent });
                showAlert('會議記錄已建立！'); loadMeetingMinutes();
            });
        };
        window.viewMeeting = async function(id) {
            const { doc, getDoc } = window.firestoreModules;
            const docSnap = await getDoc(doc(window.firebaseDB, 'meeting_minutes', id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                showInfoDialog('會議記錄', `<h3 class="font-bold text-lg mb-2">${d.title}</h3><p class="whitespace-pre-wrap">${d.content}</p>`);
            }
        };
        window.deleteMeeting = async function(id) { await genericDelete('meeting_minutes', id, '會議記錄', loadMeetingMinutes); };

        // === 文件庫 ===
        async function loadDocumentLibrary() {
            const container = document.getElementById('documentLibraryList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'documents'), orderBy('uploadedAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">尚無文件</p>';
                    return;
                }
                const icons = { pdf: '📄', doc: '📝', xls: '📊', ppt: '📊', zip: '📦', img: '🖼️' };
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const ext = (d.filename || '').split('.').pop()?.toLowerCase() || '';
                    const icon = icons[ext] || '📎';
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                        <div class="text-3xl mb-2">${icon}</div>
                        <h3 class="font-semibold text-sm truncate">${d.filename || '未命名文件'}</h3>
                        <p class="text-xs text-gray-500">${d.category || '其他'} | ${d.size || '-'}</p>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs">刪除</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 col-span-3">載入失敗</p>'; }
        }
        window.showUploadDocumentDialog = function() {
            showGenericFormDialog('上傳文件', [
                { id: 'docName', label: '文件名稱', type: 'text', required: true },
                { id: 'docCategory', label: '類別', type: 'select', options: ['manual', 'form', 'report', 'other'], required: true },
                { id: 'docUrl', label: '文件連結', type: 'url', required: true }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'documents'), { filename: data.docName, category: data.docCategory, url: data.docUrl, uploadedAt: serverTimestamp() });
                showAlert('文件已上傳！'); loadDocumentLibrary();
            });
        };
        window.deleteDocument = async function(id) { await genericDelete('documents', id, '文件', loadDocumentLibrary); };

        // === 教學資源 ===
        async function loadLearningResources() {
            const container = document.getElementById('learningResourcesList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'learning_resources'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">尚無教學資源</p>';
                    return;
                }
                const icons = { video: '🎬', article: '📰', tutorial: '📚', tool: '🔧' };
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4 resource-item" data-type="${d.type}">
                        <div class="text-2xl mb-2">${icons[d.type] || '📖'}</div>
                        <h3 class="font-semibold">${d.title || '未命名'}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2">${d.description || ''}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">${d.type}</span>
                            <button onclick="deleteResource('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs">刪除</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 col-span-3">載入失敗</p>'; }
        }
        window.showAddResourceDialog = function() {
            showGenericFormDialog('新增教學資源', [
                { id: 'resTitle', label: '資源標題', type: 'text', required: true },
                { id: 'resType', label: '類型', type: 'select', options: ['video', 'article', 'tutorial', 'tool'], required: true },
                { id: 'resUrl', label: '連結', type: 'url', required: true },
                { id: 'resDesc', label: '描述', type: 'textarea' }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'learning_resources'), { title: data.resTitle, type: data.resType, url: data.resUrl, description: data.resDesc, createdAt: serverTimestamp() });
                showAlert('資源已新增！'); loadLearningResources();
            });
        };
        window.filterResources = function(type) {
            document.querySelectorAll('.resource-item').forEach(item => {
                item.style.display = (type === 'all' || item.dataset.type === type) ? 'block' : 'none';
            });
        };
        window.deleteResource = async function(id) { await genericDelete('learning_resources', id, '教學資源', loadLearningResources); };

        // === 專案追蹤 ===
        async function loadProjectTracker() {
            const container = document.getElementById('projectTrackerList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'project_tracker'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                let total = 0, inProgress = 0, completed = 0, pending = 0;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無專案</p>';
                } else {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        total++;
                        if (d.status === 'in_progress') inProgress++;
                        else if (d.status === 'completed') completed++;
                        else pending++;
                        const statusColors = { pending: 'bg-yellow-100 text-yellow-800', in_progress: 'bg-blue-100 text-blue-800', completed: 'bg-green-100 text-green-800' };
                        const statusLabels = { pending: '待處理', in_progress: '進行中', completed: '已完成' };
                        return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1"><h3 class="font-semibold">${d.name || '未命名專案'}</h3>
                                <p class="text-sm text-gray-500">${d.description || ''}</p>
                                <div class="mt-2"><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-primary h-2 rounded-full" style="width: ${d.progress || 0}%"></div></div>
                                <p class="text-xs text-gray-500 mt-1">${d.progress || 0}% 完成</p></div></div>
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="px-2 py-1 rounded text-xs ${statusColors[d.status] || statusColors.pending}">${statusLabels[d.status] || '待處理'}</span>
                                    <button onclick="deleteProject('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs">刪除</button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
                document.getElementById('projectsTotal').textContent = total;
                document.getElementById('projectsInProgress').textContent = inProgress;
                document.getElementById('projectsCompleted').textContent = completed;
                document.getElementById('projectsPending').textContent = pending;
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreateProjectDialog = function() {
            showGenericFormDialog('新建專案', [
                { id: 'projName', label: '專案名稱', type: 'text', required: true },
                { id: 'projDesc', label: '描述', type: 'textarea' },
                { id: 'projStatus', label: '狀態', type: 'select', options: ['pending', 'in_progress', 'completed'], required: true },
                { id: 'projProgress', label: '進度 (%)', type: 'number', required: true }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'project_tracker'), { name: data.projName, description: data.projDesc, status: data.projStatus, progress: parseInt(data.projProgress), createdAt: serverTimestamp() });
                showAlert('專案已建立！'); loadProjectTracker();
            });
        };
        window.deleteProject = async function(id) { await genericDelete('project_tracker', id, '專案', loadProjectTracker); };

        // === 小組管理 ===
        async function loadTeamGroups() {
            const container = document.getElementById('teamGroupsList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'team_groups'), orderBy('name', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">尚無小組</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center text-primary font-bold">${(d.name || 'G')[0]}</div>
                            <div><h3 class="font-semibold">${d.name || '未命名小組'}</h3>
                            <p class="text-xs text-gray-500">${(d.members || []).length} 位成員</p></div>
                        </div>
                        <p class="text-sm text-gray-500 line-clamp-2">${d.description || ''}</p>
                        <div class="flex justify-end mt-3">
                            <button onclick="deleteGroup('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs">刪除</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 col-span-3">載入失敗</p>'; }
        }
        window.showCreateGroupDialog = function() {
            showGenericFormDialog('建立小組', [
                { id: 'grpName', label: '小組名稱', type: 'text', required: true },
                { id: 'grpDesc', label: '描述', type: 'textarea' },
                { id: 'grpLeader', label: '組長', type: 'text' }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'team_groups'), { name: data.grpName, description: data.grpDesc, leader: data.grpLeader, members: [], createdAt: serverTimestamp() });
                showAlert('小組已建立！'); loadTeamGroups();
            });
        };
        window.deleteGroup = async function(id) { await genericDelete('team_groups', id, '小組', loadTeamGroups); };

        // === 考勤記錄 ===
        async function loadAttendanceRecords() {
            const tbody = document.getElementById('attendanceTableBody');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'attendance_records'), orderBy('checkinTime', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">尚無考勤記錄</td></tr>';
                    return;
                }
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const time = d.checkinTime?.seconds ? new Date(d.checkinTime.seconds * 1000).toLocaleString('zh-TW') : '-';
                    const statusColors = { present: 'bg-green-100 text-green-800', absent: 'bg-red-100 text-red-800', late: 'bg-yellow-100 text-yellow-800' };
                    const statusLabels = { present: '出席', absent: '缺席', late: '遲到' };
                    return `<tr class="border-b border-gray-100 dark:border-gray-700">
                        <td class="py-3 px-4">${d.memberName || '-'}</td>
                        <td class="py-3 px-4">${d.eventName || '-'}</td>
                        <td class="py-3 px-4">${time}</td>
                        <td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs ${statusColors[d.status] || ''}">${statusLabels[d.status] || d.status}</span></td>
                        <td class="py-3 px-4"><button onclick="deleteAttendance('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">刪除</button></td>
                    </tr>`;
                }).join('');
            } catch (error) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">載入失敗</td></tr>'; }
        }
        window.showAddAttendanceDialog = function() {
            showGenericFormDialog('新增考勤記錄', [
                { id: 'attMember', label: '會員名稱', type: 'text', required: true },
                { id: 'attEvent', label: '活動名稱', type: 'text', required: true },
                { id: 'attStatus', label: '狀態', type: 'select', options: ['present', 'absent', 'late'], required: true }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'attendance_records'), { memberName: data.attMember, eventName: data.attEvent, status: data.attStatus, checkinTime: serverTimestamp() });
                showAlert('記錄已新增！'); loadAttendanceRecords();
            });
        };
        window.exportAttendance = function() { showAlert('考勤資料匯出功能開發中...'); };
        window.deleteAttendance = async function(id) { await genericDelete('attendance_records', id, '考勤記錄', loadAttendanceRecords); };

        // === 獎懲記錄 ===
        async function loadRewardsPenalties() {
            const container = document.getElementById('rewardsPenaltiesList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'rewards_penalties'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                let rewards = 0, penalties = 0;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無獎懲記錄</p>';
                } else {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        if (d.type === 'reward') rewards++; else penalties++;
                        const icon = d.type === 'reward' ? '🏆' : '⚠️';
                        const color = d.type === 'reward' ? 'border-green-300 bg-green-50 dark:bg-green-900/20' : 'border-red-300 bg-red-50 dark:bg-red-900/20';
                        return `<div class="border ${color} rounded-xl p-4">
                            <div class="flex justify-between items-start">
                                <div><span class="text-xl mr-2">${icon}</span><span class="font-semibold">${d.memberName || '-'}</span>
                                <p class="text-sm text-gray-600 mt-1">${d.reason || ''}</p></div>
                                <button onclick="deleteRewardPenalty('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                            </div>
                        </div>`;
                    }).join('');
                }
                document.getElementById('rewardsCount').textContent = rewards;
                document.getElementById('penaltiesCount').textContent = penalties;
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showAddRewardPenaltyDialog = function() {
            showGenericFormDialog('新增獎懲記錄', [
                { id: 'rpMember', label: '會員名稱', type: 'text', required: true },
                { id: 'rpType', label: '類型', type: 'select', options: ['reward', 'penalty'], required: true },
                { id: 'rpReason', label: '原因', type: 'textarea', required: true }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'rewards_penalties'), { memberName: data.rpMember, type: data.rpType, reason: data.rpReason, createdAt: serverTimestamp() });
                showAlert('記錄已新增！'); loadRewardsPenalties();
            });
        };
        window.deleteRewardPenalty = async function(id) { await genericDelete('rewards_penalties', id, '獎懲記錄', loadRewardsPenalties); };

        // === 贊助商 ===
        async function loadSponsors() {
            const container = document.getElementById('sponsorsList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'sponsors'), orderBy('tier', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">尚無贊助商</p>';
                    return;
                }
                const tierColors = { platinum: 'border-purple-300 bg-purple-50', gold: 'border-yellow-300 bg-yellow-50', silver: 'border-gray-300 bg-gray-50', bronze: 'border-orange-300 bg-orange-50' };
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border ${tierColors[d.tier] || 'border-gray-200'} rounded-xl p-4">
                        <div class="w-full h-20 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mb-3">${d.logo ? `<img src="${d.logo}" class="max-h-16">` : '🏢'}</div>
                        <h3 class="font-semibold">${d.name || '未命名'}</h3>
                        <p class="text-xs text-gray-500 uppercase">${d.tier || 'standard'}</p>
                        <button onclick="deleteSponsor('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs mt-2">刪除</button>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 col-span-3">載入失敗</p>'; }
        }
        window.showAddSponsorDialog = function() {
            showGenericFormDialog('新增贊助商', [
                { id: 'spName', label: '公司名稱', type: 'text', required: true },
                { id: 'spTier', label: '等級', type: 'select', options: ['platinum', 'gold', 'silver', 'bronze'], required: true },
                { id: 'spLogo', label: 'Logo 連結', type: 'url' },
                { id: 'spWebsite', label: '網站連結', type: 'url' }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'sponsors'), { name: data.spName, tier: data.spTier, logo: data.spLogo, website: data.spWebsite, createdAt: serverTimestamp() });
                showAlert('贊助商已新增！'); loadSponsors();
            });
        };
        window.deleteSponsor = async function(id) { await genericDelete('sponsors', id, '贊助商', loadSponsors); };

        // === 合作夥伴 ===
        async function loadPartners() {
            const container = document.getElementById('partnersList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'partners'), orderBy('name', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-3">尚無合作夥伴</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                        <div class="w-full h-20 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mb-3">${d.logo ? `<img src="${d.logo}" class="max-h-16">` : '🤝'}</div>
                        <h3 class="font-semibold">${d.name || '未命名'}</h3>
                        <p class="text-sm text-gray-500">${d.type || ''}</p>
                        <button onclick="deletePartner('${doc.id}')" class="text-red-600 hover:text-red-800 text-xs mt-2">刪除</button>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 col-span-3">載入失敗</p>'; }
        }
        window.showAddPartnerDialog = function() {
            showGenericFormDialog('新增合作夥伴', [
                { id: 'ptName', label: '名稱', type: 'text', required: true },
                { id: 'ptType', label: '類型', type: 'text', required: true },
                { id: 'ptLogo', label: 'Logo 連結', type: 'url' },
                { id: 'ptWebsite', label: '網站連結', type: 'url' }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'partners'), { name: data.ptName, type: data.ptType, logo: data.ptLogo, website: data.ptWebsite, createdAt: serverTimestamp() });
                showAlert('合作夥伴已新增！'); loadPartners();
            });
        };
        window.deletePartner = async function(id) { await genericDelete('partners', id, '合作夥伴', loadPartners); };

        // === 比賽記錄 ===
        async function loadCompetitions() {
            const container = document.getElementById('competitionsList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'competitions'), orderBy('date', 'desc'));
                const snapshot = await getDocs(q);
                let gold = 0, silver = 0, bronze = 0;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無比賽記錄</p>';
                } else {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        if (d.award === 'gold') gold++;
                        else if (d.award === 'silver') silver++;
                        else if (d.award === 'bronze') bronze++;
                        const awards = { gold: '🥇', silver: '🥈', bronze: '🥉', none: '' };
                        const date = d.date?.seconds ? new Date(d.date.seconds * 1000).toLocaleDateString('zh-TW') : '';
                        return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                            <div class="flex justify-between items-start">
                                <div><span class="text-2xl mr-2">${awards[d.award] || ''}</span><span class="font-semibold">${d.name || '未命名比賽'}</span>
                                <p class="text-sm text-gray-500">📅 ${date} | 👤 ${d.participants || ''}</p></div>
                                <button onclick="deleteCompetition('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                            </div>
                        </div>`;
                    }).join('');
                }
                document.getElementById('goldMedals').textContent = '🥇 ' + gold;
                document.getElementById('silverMedals').textContent = '🥈 ' + silver;
                document.getElementById('bronzeMedals').textContent = '🥉 ' + bronze;
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showAddCompetitionDialog = function() {
            showGenericFormDialog('新增比賽記錄', [
                { id: 'compName', label: '比賽名稱', type: 'text', required: true },
                { id: 'compDate', label: '比賽日期', type: 'date', required: true },
                { id: 'compParticipants', label: '參賽者', type: 'text' },
                { id: 'compAward', label: '獲獎', type: 'select', options: ['gold', 'silver', 'bronze', 'none'] }
            ], async (data) => {
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'competitions'), { name: data.compName, date: new Date(data.compDate), participants: data.compParticipants, award: data.compAward });
                showAlert('比賽記錄已新增！'); loadCompetitions();
            });
        };
        window.deleteCompetition = async function(id) { await genericDelete('competitions', id, '比賽記錄', loadCompetitions); };

        // === 證書生成 ===
        window.generateCertificate = function() {
            const type = document.getElementById('certType').value;
            const recipient = document.getElementById('certRecipient').value;
            const event = document.getElementById('certEvent').value;
            const date = document.getElementById('certDate').value;
            if (!recipient || !event) { showAlert('請填寫獲獎者姓名和活動名稱'); return; }
            const typeLabels = { participation: '參與證書', completion: '完成證書', excellence: '優秀證書', award: '獲獎證書' };
            const preview = document.getElementById('certificatePreview');
            preview.innerHTML = `<div class="w-full bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-700 dark:to-gray-600 p-8 rounded-xl border-4 border-double border-primary text-center">
                <h2 class="text-2xl font-bold text-primary mb-4">${typeLabels[type]}</h2>
                <p class="text-lg mb-2">茲證明</p>
                <p class="text-3xl font-bold my-4">${recipient}</p>
                <p class="text-lg mb-4">參與「${event}」活動表現優異</p>
                <p class="text-sm text-gray-500">日期：${date}</p>
                <p class="text-sm text-gray-500 mt-4">科技學會 敬贈</p>
            </div>`;
        };

        // === 問題回報 ===
        async function loadBugReports() {
            const container = document.getElementById('bugReportsList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'bug_reports'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無問題回報</p>';
                    return;
                }
                const statusColors = { open: 'bg-red-100 text-red-800', in_progress: 'bg-yellow-100 text-yellow-800', resolved: 'bg-green-100 text-green-800', closed: 'bg-gray-100 text-gray-800' };
                const statusLabels = { open: '待處理', in_progress: '處理中', resolved: '已解決', closed: '已關閉' };
                const priorityColors = { high: 'text-red-600', medium: 'text-yellow-600', low: 'text-green-600' };
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4 bug-item" data-status="${d.status}" data-priority="${d.priority}">
                        <div class="flex justify-between items-start">
                            <div><h3 class="font-semibold">${d.title || '未命名問題'}</h3>
                            <p class="text-sm text-gray-500 line-clamp-2">${d.description || ''}</p>
                            <div class="flex space-x-2 mt-2">
                                <span class="px-2 py-1 rounded text-xs ${statusColors[d.status] || ''}">${statusLabels[d.status] || d.status}</span>
                                <span class="text-xs ${priorityColors[d.priority] || ''}">優先級: ${d.priority || 'medium'}</span>
                            </div></div>
                            <button onclick="updateBugStatus('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm">更新狀態</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.filterBugReports = function() {
            const status = document.getElementById('bugStatusFilter').value;
            const priority = document.getElementById('bugPriorityFilter').value;
            document.querySelectorAll('.bug-item').forEach(item => {
                const matchStatus = !status || item.dataset.status === status;
                const matchPriority = !priority || item.dataset.priority === priority;
                item.style.display = (matchStatus && matchPriority) ? 'block' : 'none';
            });
        };
        window.updateBugStatus = async function(id) {
            showGenericFormDialog('更新問題狀態', [
                { id: 'bugStatus', label: '狀態', type: 'select', options: ['open', 'in_progress', 'resolved', 'closed'], required: true }
            ], async (data) => {
                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'bug_reports', id), { status: data.bugStatus });
                showAlert('狀態已更新！'); loadBugReports();
            });
        };

        // === 意見箱 ===
        async function loadSuggestionBox() {
            const container = document.getElementById('suggestionsList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'suggestions'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                let total = 0, pending = 0, implemented = 0;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無建議</p>';
                } else {
                    container.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        total++;
                        if (d.status === 'pending') pending++;
                        else if (d.status === 'implemented') implemented++;
                        const statusLabels = { pending: '待審核', approved: '已批准', implemented: '已採納', rejected: '已拒絕' };
                        return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                            <div class="flex justify-between items-start">
                                <div><p class="text-sm">${d.content || ''}</p>
                                <p class="text-xs text-gray-500 mt-2">- ${d.submitter || '匿名'}</p></div>
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">${statusLabels[d.status] || '待審核'}</span>
                                    <button onclick="updateSuggestionStatus('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-xs">更新狀態</button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
                document.getElementById('suggestionsTotal').textContent = total;
                document.getElementById('suggestionsPending').textContent = pending;
                document.getElementById('suggestionsImplemented').textContent = implemented;
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.updateSuggestionStatus = async function(id) {
            showGenericFormDialog('更新建議狀態', [
                { id: 'sugStatus', label: '狀態', type: 'select', options: ['pending', 'approved', 'implemented', 'rejected'], required: true }
            ], async (data) => {
                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'suggestions', id), { status: data.sugStatus });
                showAlert('狀態已更新！'); loadSuggestionBox();
            });
        };

        // === 知識庫 ===
        async function loadKnowledgeBase() {
            const container = document.getElementById('knowledgeBaseList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'knowledge_base'), orderBy('updatedAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">尚無文章</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4 kb-item" data-title="${(d.title || '').toLowerCase()}" data-tags="${(d.tags || []).join(' ').toLowerCase()}">
                        <div class="flex justify-between items-start">
                            <div><h3 class="font-semibold">${d.title || '未命名文章'}</h3>
                            <p class="text-sm text-gray-500 line-clamp-2">${d.summary || ''}</p>
                            <div class="flex flex-wrap gap-1 mt-2">${(d.tags || []).map(t => `<span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">${t}</span>`).join('')}</div></div>
                            <div class="flex space-x-2">
                                <button onclick="viewArticle('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm">查看</button>
                                <button onclick="deleteArticle('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">刪除</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8">載入失敗</p>'; }
        }
        window.showCreateArticleDialog = function() {
            showGenericFormDialog('新增文章', [
                { id: 'kbTitle', label: '文章標題', type: 'text', required: true },
                { id: 'kbSummary', label: '摘要', type: 'text' },
                { id: 'kbContent', label: '內容', type: 'textarea', required: true },
                { id: 'kbTags', label: '標籤 (逗號分隔)', type: 'text' }
            ], async (data) => {
                const { collection, addDoc, serverTimestamp } = window.firestoreModules;
                const tags = data.kbTags ? data.kbTags.split(',').map(t => t.trim()) : [];
                await addDoc(collection(window.firebaseDB, 'knowledge_base'), { title: data.kbTitle, summary: data.kbSummary, content: data.kbContent, tags, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showAlert('文章已建立！'); loadKnowledgeBase();
            });
        };
        window.searchKnowledge = function() {
            const search = document.getElementById('knowledgeSearch').value.toLowerCase();
            document.querySelectorAll('.kb-item').forEach(item => {
                const title = item.dataset.title || '';
                const tags = item.dataset.tags || '';
                item.style.display = (title.includes(search) || tags.includes(search)) ? 'block' : 'none';
            });
        };
        window.viewArticle = async function(id) {
            const { doc, getDoc } = window.firestoreModules;
            const docSnap = await getDoc(doc(window.firebaseDB, 'knowledge_base', id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                showInfoDialog(d.title, `<div class="prose dark:prose-invert max-w-none">${d.content}</div>`);
            }
        };
        window.deleteArticle = async function(id) { await genericDelete('knowledge_base', id, '文章', loadKnowledgeBase); };

        // === 標籤管理 ===
        async function loadTagManagement() {
            const container = document.getElementById('tagsList');
            try {
                const { collection, getDocs, orderBy, query } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'tags'), orderBy('name', 'asc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 w-full">尚無標籤</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="inline-flex items-center space-x-2 px-4 py-2 rounded-full" style="background-color: ${d.color || '#8B5CF6'}20; color: ${d.color || '#8B5CF6'}">
                        <span>#${d.name || ''}</span>
                        <button onclick="deleteTag('${doc.id}')" class="hover:text-red-600">&times;</button>
                    </div>`;
                }).join('');
            } catch (error) { container.innerHTML = '<p class="text-red-500 text-center py-8 w-full">載入失敗</p>'; }
        }
        window.showAddTagDialog = function() {
            showGenericFormDialog('新增標籤', [
                { id: 'tagName', label: '標籤名稱', type: 'text', required: true },
                { id: 'tagColor', label: '顏色', type: 'color', value: '#8B5CF6' }
            ], async (data) => {
                const { collection, addDoc } = window.firestoreModules;
                await addDoc(collection(window.firebaseDB, 'tags'), { name: data.tagName, color: data.tagColor });
                showAlert('標籤已建立！'); loadTagManagement();
            });
        };
        window.deleteTag = async function(id) { await genericDelete('tags', id, '標籤', loadTagManagement); };

        // === 數據匯出 ===
        window.exportData = async function(type) {
            showAlert(`正在匯出 ${type} 資料...`);
            try {
                const { collection, getDocs } = window.firestoreModules;
                let data = {};
                const collections = type === 'all' ? ['activities', 'users', 'attendance_records', 'transactions', 'event_registrations'] : [type === 'members' ? 'users' : type];
                for (const col of collections) {
                    const snapshot = await getDocs(collection(window.firebaseDB, col));
                    data[col] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `export_${type}_${new Date().toISOString().slice(0,10)}.json`;
                a.click(); URL.revokeObjectURL(url);
                showAlert('匯出完成！');
            } catch (error) { showAlert('匯出失敗：' + error.message); }
        };

        // === 系統日誌 ===
        async function loadSystemLogs() {
            const tbody = document.getElementById('systemLogsTableBody');
            try {
                const { collection, getDocs, orderBy, query, limit } = window.firestoreModules;
                const q = query(collection(window.firebaseDB, 'system_logs'), orderBy('timestamp', 'desc'), limit(100));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">尚無系統日誌</td></tr>';
                    return;
                }
                const typeColors = { login: 'text-blue-600', create: 'text-green-600', update: 'text-yellow-600', delete: 'text-red-600', error: 'text-red-600 font-bold' };
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const time = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000).toLocaleString('zh-TW') : '-';
                    return `<tr class="border-b border-gray-100 dark:border-gray-700 log-item" data-type="${d.type}" data-date="${d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000).toISOString().slice(0,10) : ''}">
                        <td class="py-2 px-4 text-xs">${time}</td>
                        <td class="py-2 px-4 ${typeColors[d.type] || ''}">${d.type || '-'}</td>
                        <td class="py-2 px-4">${d.user || '-'}</td>
                        <td class="py-2 px-4">${d.action || '-'}</td>
                        <td class="py-2 px-4 text-xs text-gray-500 truncate max-w-[200px]">${d.details || '-'}</td>
                    </tr>`;
                }).join('');
            } catch (error) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">載入失敗</td></tr>'; }
        }
        window.filterLogs = function() {
            const type = document.getElementById('logTypeFilter').value;
            const date = document.getElementById('logDateFilter').value;
            document.querySelectorAll('.log-item').forEach(item => {
                const matchType = !type || item.dataset.type === type;
                const matchDate = !date || item.dataset.date === date;
                item.style.display = (matchType && matchDate) ? 'table-row' : 'none';
            });
        };
        window.clearOldLogs = function() { showAlert('清除舊日誌功能開發中...'); };

        // === 備份還原 ===
        window.createBackup = async function() {
            showAlert('正在建立備份...');
            try {
                const { collection, getDocs } = window.firestoreModules;
                const backup = { timestamp: new Date().toISOString(), data: {} };
                const collections = [];
                if (document.getElementById('backupActivities').checked) collections.push('activities');
                if (document.getElementById('backupMembers').checked) collections.push('users');
                if (document.getElementById('backupSettings').checked) collections.push('settings');
                if (document.getElementById('backupFinance').checked) collections.push('transactions');
                for (const col of collections) {
                    const snapshot = await getDocs(collection(window.firebaseDB, col));
                    backup.data[col] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click(); URL.revokeObjectURL(url);
                showAlert('備份完成！');
            } catch (error) { showAlert('備份失敗：' + error.message); }
        };
        window.handleRestoreFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    showAlert(`備份檔案載入成功！包含 ${Object.keys(backup.data || {}).length} 個集合。還原功能開發中...`);
                } catch (error) { showAlert('檔案格式錯誤'); }
            };
            reader.readAsText(file);
        };

        // === 通用表單對話框 ===
        function showGenericFormDialog(title, fields, onSubmit) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">${title}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">&times;</button>
                </div>
                <form id="genericForm" class="space-y-4">
                    ${fields.map(f => {
                        if (f.type === 'select') {
                            return `<div><label class="block text-sm font-semibold mb-2">${f.label}</label>
                                <select id="${f.id}" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" ${f.required ? 'required' : ''}>
                                    ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                                </select></div>`;
                        } else if (f.type === 'textarea') {
                            return `<div><label class="block text-sm font-semibold mb-2">${f.label}</label>
                                <textarea id="${f.id}" rows="4" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" ${f.required ? 'required' : ''}></textarea></div>`;
                        } else {
                            return `<div><label class="block text-sm font-semibold mb-2">${f.label}</label>
                                <input type="${f.type}" id="${f.id}" value="${f.value || ''}" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" ${f.required ? 'required' : ''}></div>`;
                        }
                    }).join('')}
                    <button type="submit" class="w-full px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors">確認</button>
                </form>
            </div>`;
            document.body.appendChild(modal);
            modal.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {};
                fields.forEach(f => { data[f.id] = document.getElementById(f.id).value; });
                try { await onSubmit(data); modal.remove(); } catch (error) { showAlert('操作失敗：' + error.message); }
            });
        }

        function showInfoDialog(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">${title}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">&times;</button>
                </div>
                <div>${content}</div>
            </div>`;
            document.body.appendChild(modal);
        }

        async function genericDelete(collectionName, id, itemName, reloadFunc) {
            if (!window.confirmDialog) {
                window.confirmDialog = function(message) {
                    return new Promise(resolve => {
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                        modal.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                            <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">取消</button>
                                <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">確認</button>
                            </div>
                        </div>`;
                        document.body.appendChild(modal);
                        modal.querySelector('.cancel-btn').onclick = () => { modal.remove(); resolve(false); };
                        modal.querySelector('.confirm-btn').onclick = () => { modal.remove(); resolve(true); };
                    });
                };
            }
            const confirmed = await window.confirmDialog(`確定要刪除此${itemName}嗎？`);
            if (!confirmed) return;
            try {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, collectionName, id));
                showAlert(`${itemName}已刪除！`);
                reloadFunc();
            } catch (error) { showAlert('刪除失敗'); }
        }

        // === 切換功能區塊時載入對應資料 ===
        const originalSwitchSection = window.switchSection || function() {};
        window.switchSection = function(sectionId) {
            // 呼叫原本的切換功能
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(sectionId + 'Section');
            if (target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary/10', 'text-primary', 'font-semibold');
                if (btn.dataset.section === sectionId) {
                    btn.classList.add('bg-primary/10', 'text-primary', 'font-semibold');
                }
            });
            // 載入對應資料
            switch(sectionId) {
                case 'memberProfiles': loadMemberProfiles(); break;
                case 'pointsSystem': loadPointsSystem(); break;
                case 'achievements': loadAchievements(); break;
                case 'eventRegistration': loadEventRegistrations(); break;
                case 'qrCheckin': loadQREvents(); break;
                case 'calendarView': renderCalendar(); break;
                case 'votingSystem': loadPolls(); break;
                case 'surveys': loadSurveys(); break;
                case 'resourceBooking': loadResources(); break;
                case 'notificationCenter': loadNotifications(); break;
                case 'forum': loadForum(); break;
                case 'photoGallery': loadPhotoGallery(); break;
                case 'executives': loadExecutives(); break;
                case 'finance': loadFinance(); break;
                case 'guestbook': loadGuestbook(); break;
                case 'faq': loadFAQ(); break;
                case 'quickNotes': loadQuickNotes(); break;
                case 'todoList': loadTodoList(); break;
                case 'maintenance': loadMaintenanceSettings(); break;
                // 新增功能
                case 'emailTemplates': loadEmailTemplates(); break;
                case 'socialLinks': loadSocialLinks(); break;
                case 'meetingMinutes': loadMeetingMinutes(); break;
                case 'documentLibrary': loadDocumentLibrary(); break;
                case 'learningResources': loadLearningResources(); break;
                case 'projectTracker': loadProjectTracker(); break;
                case 'teamGroups': loadTeamGroups(); break;
                case 'attendanceRecords': loadAttendanceRecords(); break;
                case 'rewardsPenalties': loadRewardsPenalties(); break;
                case 'sponsors': loadSponsors(); break;
                case 'partners': loadPartners(); break;
                case 'competitions': loadCompetitions(); break;
                case 'certificates': break;
                case 'bugReports': loadBugReports(); break;
                case 'suggestionBox': loadSuggestionBox(); break;
                case 'knowledgeBase': loadKnowledgeBase(); break;
                case 'tagManagement': loadTagManagement(); break;
                case 'dataExport': break;
                case 'systemLogs': loadSystemLogs(); break;
                case 'backupRestore': break;
            }
        };

    </script>

    <!-- 版本號顯示 -->
    <div class="fixed bottom-2 right-2 text-xs text-gray-400 dark:text-gray-600 bg-white dark:bg-gray-800 px-3 py-1 rounded-full shadow-sm z-50">
        v5.0.0 - 後台（43項新功能）
    </div>
</body>
</html>
